<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>jrsy</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://jrsy081113-hue.github.io/jrsy/star-icon.png">
    <link rel="apple-touch-icon-precomposed" href="https://jrsy081113-hue.github.io/jrsy/star-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
      <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Long+Cang&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&family=Liu+Jian+Mao+Cao&family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@300&display=swap" rel="stylesheet">

    <style id="customBubblePreviewStyle"></style>
    <style id="customBubbleStyle"></style>
    <link rel="stylesheet" href="style.css">

</head>
<body>

<!<!-- [ÂçáÁ∫ßÁâà] ÂêåÂüéÈõ∑ËææÂú∞ÂõæÂºπÁ™ó -->
<div id="cityMapModal" class="modal">
    <div class="modal-content" style="padding: 0 !important; width: 340px; border-radius: 24px; overflow: hidden; background: #ffffff; box-shadow: 0 20px 50px rgba(0,0,0,0.15);">

        <!-- È°∂ÈÉ®‰ø°ÊÅØÊµÆÂ±Ç (ÂçäÈÄèÊòéÁ£®Á†Ç) -->
        <div class="radar-header-overlay">
            <div class="radar-user-info">
                <div class="radar-user-avatar" id="cityMapHeaderAvatar"></div>
                <div>
                    <div class="radar-user-name" id="cityMapTargetName">Áî®Êà∑Âêç</div>
                    <div class="radar-user-dist">
                        <i class="ri-map-pin-line"></i> Ë∑ù‰Ω† <span id="cityMapDistance">0.0</span> km
                    </div>
                </div>
            </div>
            <!-- ËøõÂÖ•‰∏ªÈ°µÊåâÈíÆ -->
            <button class="radar-profile-btn" id="cityMapProfileBtn">
                ‰∏ªÈ°µ <i class="ri-arrow-right-s-line"></i>
            </button>
        </div>

        <!-- Èõ∑ËææÂèØËßÜÂå∫Âüü -->
        <div id="cityRadarVisual" class="radar-container">
            <!-- ËÉåÊôØÁΩëÊ†º -->
            <div class="radar-grid"></div>
            <!-- ÂêåÂøÉÂúÜÂàªÂ∫¶ -->
            <div class="radar-circle c1"></div>
            <div class="radar-circle c2"></div>
            <div class="radar-circle c3"></div>
            <!-- ÂçÅÂ≠óÂáÜÊòü -->
            <div class="radar-crosshair h"></div>
            <div class="radar-crosshair v"></div>
            <!-- Êâ´ÊèèÊâáÂΩ¢ -->
            <div class="radar-scanner"></div>

            <!-- Êàë (‰∏≠ÂøÉÁÇπ) -->
            <div class="map-point me">
                <div class="point-avatar-ring"></div>
                <div class="point-avatar" id="cityMapMyAvatar"></div>
            </div>

            <!-- ÊâÄÊúâ‰∫∫ÂÆπÂô® -->
            <div id="cityMapPointsContainer"></div>
        </div>

        <!-- Â∫ïÈÉ®ÂÖ≥Èó≠Ê†è -->
        <div class="radar-footer" onclick="closeCityMapModal()">
            <i class="ri-close-circle-line"></i> ÂÖ≥Èó≠Èõ∑Ëææ
        </div>
    </div>
</div>



<!-- [Êñ∞Â¢û] ‰ªéÂàÜÁªÑÂØºÂÖ•NPCÁöÑÂºπÁ™ó -->
<div id="importNpcModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©Êù•Ê∫êÂàÜÁªÑ</div>
        <div style="font-size: 12px; color: #999; margin-bottom: 15px; text-align: center;">
            Â∞ÜËØ•ÂàÜÁªÑ‰∏ãÁöÑÊâÄÊúâ NPC ‰∏ÄÈîÆÊãâÂÖ•ÂΩìÂâçÁæ§ËÅä
        </div>

        <!-- ÂàÜÁªÑÂàóË°®ÂÆπÂô® -->
        <div id="importNpcGroupList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('importNpcModal').classList.remove('show')">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- [Êñ∞Â¢û] Token Ê∑±Â∫¶ÂàÜÊûêÂºπÁ™ó -->
<div id="tokenAnalysisModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 400px; padding: 0; background: #fff; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh;">

        <div class="modal-title" style="padding: 20px 20px 10px; margin: 0; text-align: left; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center;">
            <span>Token Ê∂àËÄó</span>
            <span id="tokenTotalHeader" style="font-size: 14px; color: #007aff; background: rgba(0,122,255,0.1); padding: 4px 8px; border-radius: 6px;">0 Token</span>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 15px;">
            <!-- ÊèêÁ§∫Êù° -->
            <div style="font-size: 11px; color: #999; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <i class="ri-information-line"></i> ‰∏≠Êñá‚âà2 TokenÔºåËã±ÊñáÂçïËØç‚âà1.3 Token„ÄÇ
            </div>

            <!-- ÂàÜÊûêÂàóË°®ÂÆπÂô® -->
            <div id="tokenListContainer" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- JS Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <div class="modal-buttons" style="padding: 15px; border-top: 1px solid #f5f5f5; margin: 0;">
            <button class="modal-btn modal-btn-confirm" onclick="document.getElementById('tokenAnalysisModal').classList.remove('show')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>


<!-- [Êñ∞Â¢û] ËßíËâ≤ÂüéÂ∏ÇÂú∞ÂõæÂºπÁ™ó -->
<div id="spyMapModal" class="modal">
    <div class="modal-content" style="padding: 0 !important; width: 90% !important; max-width: 360px !important; height: 80vh; display: flex; flex-direction: column; overflow: hidden; background: #fff !important; border-radius: 20px !important;">

        <!-- È°∂ÈÉ®Ê†áÈ¢ò -->
        <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div id="mapCityName" style="font-size: 18px; font-weight: 800; color: #000;">CITY MAP</div>
                <div style="font-size: 10px; color: #999;">EXPLORE THE WORLD</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="doujinOpenAddBuildingModal()" style="border: none; background: none; cursor: pointer; color: #000; font-size: 18px;" title="ÊâãÂä®Ê∑ªÂä†Âª∫Á≠ë"><i class="ri-add-circle-line"></i></button>
                <button id="refreshMapBtn" onclick="generateMapFromAI()" style="border: none; background: none; cursor: pointer; color: #000; font-size: 18px;" title="AIÈáçÊñ∞ËßÑÂàí"><i class="ri-refresh-line"></i></button>
                <button onclick="closeSpyMapModal()" style="border: none; background: none; cursor: pointer; color: #999; font-size: 18px;"><i class="ri-close-line"></i></button>
            </div>
        </div>

        <!-- Âú∞ÂõæÂèØËßÜÂåñÂå∫Âüü (Ê®°ÊãüÈõ∑ËææÂõæ/Âπ≥Èù¢Âõæ) -->
        <div id="mapVisualArea" style="width: 100%; aspect-ratio: 1/1; background-color: #f9f9f9; position: relative; overflow: hidden; border-bottom: 1px dashed #eee;">
            <!-- ÁΩëÊ†ºËÉåÊôØË£ÖÈ•∞ -->
            <div style="position: absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5;"></div>
            <div style="position: absolute; top:50%; left:0; width:100%; height:1px; background: rgba(0,0,0,0.05);"></div>
            <div style="position: absolute; top:0; left:50%; width:1px; height:100%; background: rgba(0,0,0,0.05);"></div>

            <!-- JS Â∞ÜÂú®ËøôÈáåÊèíÂÖ•Âª∫Á≠ëÂõæÊ†á -->
            <div id="mapPinsContainer"></div>
        </div>

        <!-- Âª∫Á≠ëÂàóË°®Âå∫Âüü -->
        <div id="mapLocationsList" style="flex: 1; overflow-y: auto; padding: 10px 20px;">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>

    </div>
</div>

<!-- [Êñ∞Â¢û] ÊâãÂä®Ê∑ªÂä†Âª∫Á≠ëÁöÑÂºπÁ™ó -->
<div id="addBuildingModal" class="modal" style="z-index: 10001;">
    <div class="modal-content">
        <div class="modal-title">Ê∑ªÂä†Âú∞ÁÇπ</div>
        <input type="text" class="modal-input" id="newBuildingName" placeholder="Âú∞ÁÇπÂêçÁß∞ (Â¶Ç: ÁßòÂØÜÂü∫Âú∞)">
        <input type="text" class="modal-input" id="newBuildingDesc" placeholder="ÁÆÄ‰ªã (Â¶Ç: Êàë‰ª¨Á¨¨‰∏ÄÊ¨°ËßÅÈù¢ÁöÑÂú∞Êñπ)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('addBuildingModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAddBuilding()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- [ÈªëÁôΩÊûÅÁÆÄÁâà - Â∞èÂ∞∫ÂØ∏] ËßíËâ≤ÂüéÂ∏ÇÂ§©Ê∞îÂºπÁ™ó -->
<div id="spyWeatherModal" class="modal">
    <div class="modal-content" style="
        padding: 0 !important;
        overflow: hidden;
        background-color: #ffffff !important;
        color: #000000 !important;
        border-radius: 16px !important;       /* ÂúÜËßíÁ®çÂæÆÊîπÂ∞è‰∏ÄÁÇπ */
        box-shadow: 0 15px 40px rgba(0,0,0,0.2) !important;
        width: 85% !important;                /* ÂÆΩÂ∫¶Âç†ÊØîÊîπÂ∞è */
        max-width: 300px !important;          /* „ÄêÊ†∏ÂøÉ„ÄëÊúÄÂ§ßÂÆΩÂ∫¶ÊîπÂ∞è */
        display: flex;
        flex-direction: column;
    ">

        <!-- È°∂ÈÉ®ÂüéÂ∏ÇÂêç -->
        <div style="padding: 20px 20px 0; text-align: left;">
            <!-- Â≠ó‰Ωì‰ªé 28px Êîπ‰∏∫ 22px -->
            <div id="spyWeatherFictionalName" style="font-size: 22px; font-weight: 900; letter-spacing: 1px; line-height: 1.2;">CITY NAME</div>
            <div id="spyWeatherRealName" style="font-size: 10px; color: #999; margin-top: 4px; font-family: monospace;">REAL: SOURCE</div>
        </div>

        <!-- Â§©Ê∞îÂÜÖÂÆπÂå∫Âüü -->
        <div id="weatherContentArea" style="padding: 20px; flex: 1;">
            <!-- Âä†ËΩΩÂä®Áîª -->
            <div style="text-align: center; padding: 30px 0; color: #999;">
                <div class="loading-spinner" style="width: 24px; height: 24px; border-width: 2px; border-top-color: #000; border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent; margin: 0 auto 10px;"></div>
                <div style="font-size: 11px;">ËøûÊé•Ê∞îË±°Âç´Êòü...</div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÂÖ≥Èó≠Ê†è -->
        <div onclick="closeSpyWeatherModal()" style="
            border-top: 1px solid #f0f0f0;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            background: #fafafa;
            color: #333;
        ">
            ÂÖ≥ Èó≠
        </div>
    </div>
</div>




<!-- Êñ∞Â¢ûÔºöËá™Âä®ÂÜôÊó•ËÆ∞ËßíËâ≤ÈÄâÊã©ÂºπÁ™ó -->
<div id="diaryRoleSelectModal" class="modal" style="z-index: 2000;">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©ËßíËâ≤</div>

        <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöÂø´Êç∑Êìç‰ΩúÊ†è ‚ñº‚ñº‚ñº -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
            <div style="font-size: 12px; color: #999;">ÁÇπÂáªÂ§¥ÂÉèÈÄâ‰∏≠</div>
            <button class="nav-btn" onclick="toggleDiarySelectAllRoles()" style="font-size: 13px; color: #007aff; border: 1px solid #007aff; padding: 2px 8px; border-radius: 12px;">ÂÖ®ÈÄâ / Ê∏ÖÁ©∫</button>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <div id="diaryRoleSelectList" class="multi-select-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS Â∞ÜÂú®ËøôÈáåÁîüÊàêÁΩëÊ†º -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryRoleSelectModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveDiaryRoleSelection()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>


<!-- [‰øÆÊîπÁâà] Áæ§ÂÖ¨ÂëäÁÆ°ÁêÜÂºπÁ™ó (ÊîØÊåÅÂ§öÊù°) -->
<div id="groupAnnouncementModal" class="modal">
    <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-title">Áæ§ÂÖ¨ÂëäÊùø</div>

        <!-- 1. Áé∞ÊúâÂÖ¨ÂëäÂàóË°®Âå∫ -->
        <div style="flex: 1; overflow-y: auto; margin-bottom: 15px; min-height: 100px; background: #f9f9f9; border-radius: 8px; padding: 10px;">
            <div id="announcementListContainer">
                <!-- JS Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂÖ¨ÂëäÂç°Áâá -->
            </div>
        </div>

        <!-- 2. Êñ∞ÂÖ¨ÂëäËæìÂÖ•Âå∫ -->
        <div style="border-top: 1px solid #eee; padding-top: 15px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä (AI‰ºöËÆ∞‰ΩèÂàóË°®ÈáåÁöÑÊâÄÊúâÂÜÖÂÆπ)</div>
            <textarea class="modal-textarea" id="newAnnouncementInput" placeholder="ËæìÂÖ•Êñ∞ÂÖ¨ÂëäÂÜÖÂÆπ..." style="min-height: 80px; margin-bottom: 10px;"></textarea>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeGroupAnnouncementModal()">ÂÖ≥Èó≠</button>
                <button class="modal-btn modal-btn-confirm" onclick="publishNewAnnouncement()">ÂèëÂ∏É</button>
            </div>
        </div>
    </div>
</div>


<!-- ‰π†ÊÉØÊâìÂç°ÂºπÁ™ó -->
<div id="habitTrackerModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 20px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">

        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span>Ëá™ÂæãÊâìÂç°</span>
            <button class="nav-btn" onclick="createNewHabit()" style="font-size: 24px; padding: 0; color: #333;">+</button>
        </div>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <div class="habit-stats-overview" style="display: flex; justify-content: space-around; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 12px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #000;" id="habitTotalDays">0</div>
                <div style="font-size: 11px; color: #999;">ÂùöÊåÅÂ§©Êï∞</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #d87897;" id="habitTodayCount">0</div>
                <div style="font-size: 11px; color: #999;">‰ªäÊó•Â∑≤Êâì</div>
            </div>
        </div>

        <!-- ‰π†ÊÉØÂàóË°® -->
        <div id="habitListContainer" style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeHabitTracker()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- „Äê„Äê„ÄêËøôÊòØ‰øÆÊîπÂêéÁöÑÊ≠£Á°Æ‰ª£Á†ÅÔºåËØ∑Áî®ÂÆÉÊõøÊç¢ÊóßÁöÑÂä†ËΩΩÂä®Áîª„Äë„Äë„Äë -->
<div id="loadingOverlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 10000; align-items: center; justify-content: center; color: #333333; flex-direction: column; gap: 20px; text-align: center; transition: opacity 0.5s ease;">

    <!-- START: Êñ∞ÁöÑÂºÄÂ±èÂä®ÁîªHTML -->
    <div class="splash-container" id="splash">
        <!-- ÂØπËØùÊ∞îÊ≥°Ë£ÖÈ•∞ -->
        <div class="chat-bubbles">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
        </div>

        <!-- Logo -->
        <div class="logo-section">
            <div class="logo">
                <span>j</span>
                <span>r</span>
                <span>s</span>
                <span>y</span>
            </div>
            <div class="ai-tag">AI ASSISTANT</div>
        </div>

        <!-- ËøõÂ∫¶Êù° -->
        <div class="progress-wrapper">
            <div class="loading-text">
                <span class="typing-text" id="typingText"></span>
            </div>
            <div class="percentage" id="percentage">0%</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-hints" id="hints"></div>
        </div>
    </div>
    <!-- END: Êñ∞ÁöÑÂºÄÂ±èÂä®ÁîªHTML -->
</div>

<!-- „Äê„Äê„ÄêÁ¨¨‰∏ÄÊ≠•ÔºöËØ∑Â∞ÜËøôË°å‰ª£Á†ÅÁ≤òË¥¥Âà∞ <body> Ê†áÁ≠æ‰∏ãÈù¢„Äë„Äë„Äë -->

    <audio id="audioPlayer"></audio>
        <!-- ‚ñº‚ñº‚ñº Êñá‰ª∂‰∏ä‰º†Êéß‰ª∂ÈõÜ‰∏≠ÁÆ°ÁêÜÂå∫ (Â∑≤ÂêàÂπ∂ÂéªÈáç) ‚ñº‚ñº‚ñº -->
    <div id="hidden-upload-controls" style="display: none;">
        <!-- 1. ËÅäÂ§©‰∏éÂ§öÂ™í‰Ωì -->
        <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoUpload(event)">
        <input type="file" id="songFileInput" accept="audio/mp3,audio/*" onchange="handleSongFileSelect(event)">
        <input type="file" id="lrcFileInput" accept=".lrc" onchange="handleLrcFileSelect(event)">

        <!-- 2. Â§ñËßÇ‰∏éËÉåÊôØ -->
        <input type="file" id="wallpaper-upload-input" accept="image/*">
        <input type="file" id="user-photo-upload-input" accept="image/*"> <!-- ÊãçÁ´ãÂæóÁõ∏Ê°Ü -->
        <input type="file" id="listenBgInput" accept="image/*" onchange="handleListenBgUpload(event)">
        <input type="file" id="vinylImageInput" accept="image/*" onchange="handleVinylImageUpload(event)">

        <!-- 3. Ë°®ÊÉÖÂåÖ -->
        <input type="file" id="singleEmojiUploadInput" accept="image/*" onchange="handleSingleEmojiUpload(event)">
        <input type="file" id="batchEmojiUploadInput" accept="image/*" onchange="handleBatchEmojiUpload(event)" multiple>
        <input type="file" id="libraryUploadInput" accept="image/*" multiple onchange="handleLibraryUpload(event)"> <!-- Ë°®ÊÉÖÂ∫ì -->

        <!-- 4. Ê°åÈù¢Â∞èÁªÑ‰ª∂ -->
        <input type="file" id="widgetImageInput" accept="image/*" onchange="handleWidgetImageUpload(event)">
        <input type="file" id="desktopImageUploadInput" accept="image/*" onchange="handleDesktopImageUpload(event)">
        <input type="file" id="desktopAvatarUploadInput" accept="image/*" onchange="handleDesktopAvatarUpload(event)">

        <!-- 5. ÊèêÁ§∫Èü≥ -->
        <input type="file" id="receivedSoundInput" accept="audio/mp3,audio/wav,audio/mpeg" onchange="handleSoundUpload(event, 'received')">
        <input type="file" id="sentSoundInput" accept="audio/mp3,audio/wav,audio/mpeg" onchange="handleSoundUpload(event, 'sent')">

        <!-- 6. ÂÖ∂‰ªñÂäüËÉΩ -->
        <input type="file" id="uploadNovelInput" accept=".txt" onchange="handleNovelUpload(event)"> <!-- Â∞èËØ¥ -->
        <input type="file" id="avatarFrameInput" accept="image/*" onchange="handleAvatarFrameUpload(event)"> <!-- Â§¥ÂÉèÊ°Ü -->
        <input type="file" id="readerBgUpload" accept="image/*" onchange="handleReaderBgUpload(event)"> <!-- ÈòÖËØªÂô®ËÉåÊôØ -->
        <input type="file" id="lovers-bg-input" accept="image/*" onchange="handleLoversBgUpload(event)"> <!-- ÊÉÖ‰æ£Á©∫Èó¥ËÉåÊôØ -->
        <input type="file" id="lovers-post-file" accept="image/*" onchange="previewLoversPostImage(this)"> <!-- ÊÉÖ‰æ£Âä®ÊÄÅÂèëÂõæ -->
        <input type="file" id="friendAvatarUploadInput" accept="image/*"> <!-- È¢ÑÁïôÁªôÂ•ΩÂèãÂ§¥ÂÉè -->
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ ‰∏ä‰º†Êéß‰ª∂Âå∫ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <div id="message-notification">
        <div id="notification-avatar"></div>
        <div id="notification-content">
            <div id="notification-sender"></div>
            <div id="notification-message"></div>
        </div>
    </div>

    <div class="phone">
        <div id="floatingPlayer">
            <div id="floatingPlayerArt"></div>
            <div id="floatingPlayerInfo">
                <span id="floatingPlayerTitle">Ê≠åÊõ≤ÂêçÁß∞</span>
                <span id="floatingPlayerSubtitle">Ê≠£Âú®‰∏ÄËµ∑Âê¨...</span>
            </div>
            <button id="floatingPlayerCloseBtn" onclick="terminateListenTogether(event)">&times;</button>
        </div>

<!-- Â∞èËØ¥ÊÇ¨ÊµÆÁ™ó -->
<div id="floatingNovelWindow" class="floating-novel-window" style="display: none;">
    <!-- 1. È°∂ÈÉ®Ê†èÔºöÊ†áÈ¢ò + ËøõÂ∫¶ + Á™óÂè£ÊéßÂà∂ -->
    <div class="novel-float-header">
        <span id="floatNovelTitle" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">Â∞èËØ¥Âêç</span>

        <div class="novel-float-controls" style="display: flex; align-items: center;">
            <!-- „Äê‰øÆÊîπ„ÄëËøõÂ∫¶ÊòæÁ§∫ÁßªÂà∞ËøôÈáå -->
            <span id="floatPageIndicator" style="font-size: 12px; color: #888; margin-right: 8px;">1 / 10</span>

            <!-- ÂéüÊúâÁöÑÁ™óÂè£ÊéßÂà∂ -->
            <span onclick="expandReaderFromFloat()" title="ÂÖ®Â±èÈòÖËØª" style="cursor: pointer; margin-left: 5px;"><i class="ri-fullscreen-line"></i></span>
            <span onclick="closeFloatingNovel()" title="ÂÖ≥Èó≠" style="cursor: pointer; margin-left: 8px;"><i class="ri-close-line"></i></span>
        </div>
    </div>

    <div id="floatNovelContent" class="novel-float-content">
        <!-- ËøôÈáåÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÊñáÂ≠óÊëòË¶Å -->
    </div>

    <!-- 2. Â∫ïÈÉ®Ê†èÔºö‰∏ä‰∏ÄÈ°µ + Áº©ÊîæÊéßÂà∂ + ‰∏ã‰∏ÄÈ°µ -->
    <div class="novel-float-footer" style="justify-content: space-between; padding: 0 15px;">
        <!-- „Äê‰øÆÊîπ„Äë‰∏ä‰∏ÄÈ°µÂèòÊàêÁÆ≠Â§¥ÂõæÊ†á -->
        <span class="float-nav-btn" onclick="floatPrevPage()" title="‰∏ä‰∏ÄÈ°µ">
            <i class="ri-arrow-left-s-line" style="font-size: 18px;"></i>
        </span>

        <!-- „Äê‰øÆÊîπ„ÄëÂä†Âè∑ÂáèÂè∑ÁßªÂà∞‰∏≠Èó¥ -->
        <div style="display: flex; gap: 15px;">
            <span class="float-nav-btn" onclick="resizeFloatWindow(-1)" title="Áº©Â∞èÁ™óÂè£">
                <i class="ri-subtract-line" style="font-size: 16px;"></i>
            </span>
            <span class="float-nav-btn" onclick="resizeFloatWindow(1)" title="ÊîæÂ§ßÁ™óÂè£">
                <i class="ri-add-line" style="font-size: 16px;"></i>
            </span>
        </div>

        <!-- „Äê‰øÆÊîπ„Äë‰∏ã‰∏ÄÈ°µÂèòÊàêÁÆ≠Â§¥ÂõæÊ†á -->
        <span class="float-nav-btn" onclick="floatNextPage()" title="‰∏ã‰∏ÄÈ°µ">
            <i class="ri-arrow-right-s-line" style="font-size: 18px;"></i>
        </span>
    </div>

    <div class="resize-handle"></div>
</div>

        <!-- ËØ∑Áî®ËøôÊÆµ‰ª£Á†ÅÊõøÊç¢‰Ω†ÂéüÊúâÁöÑ status-bar ÈÉ®ÂàÜ -->
<div class="status-bar">
    <div class="status-left">
        <span id="currentTime">18:29</span>
    </div>
    <div class="status-right">
        <div class="signal-icon">
            <div class="signal-bar"></div>
            <div class="signal-bar"></div>
            <div class="signal-bar"></div>
            <!-- ÁªôÁ¨¨ÂõõÊ†π‰ø°Âè∑Êù°Â¢ûÂä†‰∏Ä‰∏™ "inactive" Á±ª -->
            <div class="signal-bar inactive"></div>
        </div>
        <div class="network-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
            </svg>
        </div>
        <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑÁîµÊ±†ÂõæÊ†áÁªìÊûÑ -->
     <!-- ËøôÊòØÈúÄË¶ÅÊÅ¢Â§çÁöÑ„ÄÅÂåÖÂê´Â≠êÂÖÉÁ¥†ÁöÑÁîµÊ±†ÂõæÊ†áHTMLÁªìÊûÑ -->
<div class="battery-icon">
    <div class="battery-level"></div>
    <div class="battery-tip"></div>
</div>


    </div>
</div>

        <div class="screen">
         <div id="homeScreen" class="page active">
                <!--
                    ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰∏ªÂ±èÂπïÁªìÊûÑ„ÄÇ
                    .home-screen Áé∞Âú®ÊòØÊÄªÂÆπÂô®ÔºåË¥üË¥£Â∫îÁî®Â£ÅÁ∫∏ÂíåFlexÂ∏ÉÂ±Ä„ÄÇ
                    #home-screen-pager ÊòØÊªëÂä®Âå∫Âüü„ÄÇ
                    #home-screen-dots Âíå .bottom-dock Âú®ÊªëÂä®Âå∫Âüü‰πãÂ§ñÔºåÂõ†Ê≠§ÊòØÂõ∫ÂÆöÁöÑ„ÄÇ
                -->
                <div class="home-screen">

                    <!-- ÊªëÂä®Âå∫Âüü -->
                    <div id="home-screen-pager">

                        <!-- Á¨¨1È°µÔºöÂéüÂßãÁöÑjrsy‰∏ªÂ±èÂπïÂÜÖÂÆπ (Áé∞Âú®Ê≤°ÊúâDockÊ†è‰∫Ü) -->
                        <div class="home-screen-page">
                            <div class="profile-widget-container" id="profileWidgetContainer">
                                <div class="profile-widget">
                                    <div class="profile-avatar-widget" id="widgetAvatar" onclick="changeAvatar()"></div>
                                    <div class="widget-info-section">
                                        <div class="profile-name-widget" id="widgetName" onclick="changeName()">ÂèØÁÇπÂáªÁºñËæë</div>
                                        <div class="profile-signature-widget" id="widgetSignature" onclick="changeSignature()">ÂèØÁÇπÂáªÁºñËæë</div>
                                        <div class="profile-location" onclick="changeLocation()">
                                            <svg class="location-icon" viewBox="0 0 24 24">
                                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                            </svg>
                                            <span id="widgetLocation">ÂèØÁÇπÂáªÁºñËæë</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
<!-- ‰∏ªÂ±è‰∏ãÊñπÂå∫Âüü -->
<div class="home-widgets-container">

    <!-- „ÄêÂÖ≥ÈîÆ‰øÆÊ≠£„ÄëÂ∑¶‰æßÂûÇÁõ¥ÂåÖË£ÖÂô®ÔºöÂº∫Âà∂ÂÜÖÈÉ®ÂÖÉÁ¥†‰∏ä‰∏ãÊéíÂàó -->
    <div class="left-vertical-stack">

        <!-- 1. ‰∏äÊñπÔºöÂõõ‰∏™ÊåâÈíÆÁªÑ (‰øùÊåÅÂéüÊúâÈÄªËæë) -->
        <div class="app-grid">
            <div class="app wechat" onclick="openApp('wechat')">
                <div class="app-icon-container" id="icon-wechat"><i class="ri-wechat-fill"></i></div>
                <div class="app-label">ÂæÆ‰ø°</div>
            </div>
            <div class="app settings" onclick="openApp('settings')">
                <div class="app-icon-container" id="icon-settings"><i class="ri-settings-3-fill"></i></div>
                <div class="app-label">ËÆæÁΩÆ</div>
            </div>
            <div class="app worldbook" onclick="openApp('worldbook')">
                <div class="app-icon-container" id="icon-worldbook"><i class="ri-book-3-fill"></i></div>
                <div class="app-label">‰∏ñÁïå‰π¶</div>
            </div>
            <div class="app theme" onclick="openApp('theme')">
                <div class="app-icon-container" id="icon-theme"><i class="ri-palette-fill"></i></div>
                <div class="app-label">‰∏ªÈ¢ò</div>
            </div>
        </div>

        <!-- 2. ‰∏ãÊñπÔºöÊñ∞Ê∂àÊÅØÈÄöÁü•ÁõíÂ≠ê -->
        <div class="notification-box" id="homeNotificationBox">
            <div class="notif-list" id="homeNotificationList">
                <div style="text-align: center; color: #ccc; font-size: 14px; margin-top: 40px;">ÊöÇÊó†Êñ∞Ê∂àÊÅØ</div>
            </div>
        </div>

    </div>

    <!-- Âè≥‰æßÔºöÈïøÊñπÂΩ¢Ê∞îÊ≥°Ê°Ü (È´òÂ∫¶Ëá™Âä®Êãâ‰º∏‰ª•ÂØπÈΩêÂ∑¶‰æß) -->
    <div class="new-widget" id="homeScreenWidget">
        <div class="widget-header-text" id="widgetHeaderText" onclick="editWidgetText('widgetHeaderText', this)">(:::[‚ô°]:::)..?</div>
        <div class="widget-bubble">
            <img id="widgetImage1" src="https://i.imgur.com/example-avatar-1.png" onclick="editWidgetImage('widgetImage1')">
            <span id="widgetText1" onclick="editWidgetText('widgetText1', this)">have a nice day üåü</span>
        </div>
        <div class="widget-bubble">
            <span id="widgetText2" onclick="editWidgetText('widgetText2', this)">.o. HAPPY EVERYDAY ‚òª</span>
            <img id="widgetImage2" src="https://i.imgur.com/example-avatar-2.png" onclick="editWidgetImage('widgetImage2')">
        </div>
    </div>

</div>

                        </div>

                        <!-- Á¨¨2È°µÔºöÊù•Ëá™ Ê°åÈù¢.txt ÁöÑÂÜÖÂÆπ -->
                        <div class="home-screen-page" id="desktop-page-2">
                            <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
<div class="music-search-widget">
    <div class="placeholder music-avatar-placeholder" id="desktop-avatar-2" onclick="openImageUploaderForDesktopAvatar('desktop-avatar-2')"></div>
    <div class="music-input-area">
        <textarea id="desktop-music-textarea" placeholder="üéß ·µî ƒ±llƒ±|lƒ±ll| ‚ô™ Í∑∏Î¶¨ÏõåÌïòÎ©¥ ÏïÑÌîÑÎã§ Search" onchange="saveDesktopTextData()"></textarea>
        <i class="ri-search-line"></i>
    </div>
</div>
                            <!-- 2. ÂõæÁâáÁîªÂªä (Â∑≤‰øÆÊîπ‰∏∫ÂèØÁÇπÂáª‰∏ä‰º†) -->
                        <div class="image-gallery-placeholder">
                            <div class="placeholder placeholder-image" id="desktop-image-1" onclick="openImageUploaderForDesktop('desktop-image-1')">ÂõæÁâá1</div>
                            <div class="placeholder placeholder-image" id="desktop-image-2" onclick="openImageUploaderForDesktop('desktop-image-2')">ÂõæÁâá2</div>
                            <div class="placeholder placeholder-image" id="desktop-image-3" onclick="openImageUploaderForDesktop('desktop-image-3')">ÂõæÁâá3</div>
                        </div>
                            <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->

<!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
<div class="user-profile-area">
    <div class="placeholder placeholder-avatar" id="desktop-avatar-1" onclick="openImageUploaderForDesktopAvatar('desktop-avatar-1')">Â§¥ÂÉè</div>
    <textarea class="bio-textarea" id="desktop-bio-textarea" placeholder="ÂèØÁÇπÂáªÁºñËæë&#10;üñ§&#10;üìç London" onchange="saveDesktopTextData()"></textarea>
</div>

                            <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
<div class="custom-widget">
    <input type="text" class="widget-input" id="desktop-widget-input" placeholder="ÂÆùÂÆùÁîüÊó•‚òÜ¬∑ ¬∞ ËøòÊúâ50Â§©" onchange="saveDesktopTextData()">
    <div class="widget-icons">
        <i class="ri-at-line"></i>
        <i class="ri-chat-3-line"></i>
        <i class="ri-heart-3-line"></i>
    </div>
</div>
                            <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
<div class="icon-grid-placeholder">

    <!-- Á¨¨‰∏Ä‰∏™ÂõæÊ†áÔºöÂêå‰∫∫ -->
    <div class="app" onclick="openApp('doujinForum')">
        <div class="app-icon-container card-style" id="icon-doujin"> <!-- <--- Â¢ûÂä†‰∫Ü id -->
            <i class="ri-quill-pen-line"></i>
        </div>
        <div class="app-label">Âêå‰∫∫</div>
    </div>

    <!-- Ê∏∏Êàè‰∏≠ÂøÉÂÖ•Âè£ -->
<div class="app" onclick="openApp('games')">
    <div class="app-icon-container card-style" id="icon-games">
        <i class="ri-gamepad-line"></i>
    </div>
    <div class="app-label">Ê∏∏Êàè</div>
</div>

    <!-- ÊâæÂà∞Ëøô‰∏ÄÊÆµÂπ∂ÊõøÊç¢ -->
<!-- Á¨¨‰∏â‰∏™ÂõæÊ†áÔºöÂïÜÂ∫ó (ÂéüÈó≤ÁΩÆ2) -->
<div class="app" onclick="openApp('store')"> <!-- ‰øÆÊîπ onclick -->
    <div class="app-icon-container card-style" id="icon-store"> <!-- ‰øÆÊîπ id -->
        <i class="ri-shopping-bag-line"></i> <!-- Êç¢‰∏™ÂõæÊ†á -->
    </div>
    <div class="app-label">ÂïÜÂ∫ó</div> <!-- ‰øÆÊîπÂêçÂ≠ó -->
</div>

    <!-- ÊõøÊç¢ÂéüÊù•ÁöÑ Èó≤ÁΩÆ3 app -->
<div class="app" onclick="openApp('lovers')">
    <div class="app-icon-container card-style" id="icon-lovers">
        <i class="ri-hearts-line"></i>
    </div>
    <div class="app-label">ÊÉÖ‰æ£Á©∫Èó¥</div>
</div>

</div>
                            <div class="spacer"></div>

                        </div>
                    </div>

                    <!-- Âõ∫ÂÆöÂÖÉÁ¥†ÔºöÂàÜÈ°µÂ∞èÂúÜÁÇπ (Áé∞Âú®ÊòØ .home-screen ÁöÑÁõ¥Êé•Â≠êÂÖÉÁ¥†) -->
<div id="home-screen-dots">
    <!-- Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏∫ÊØè‰∏™ÂúÜÁÇπÊ∑ªÂä† onclick ‰∫ã‰ª∂ -->
    <span class="dot active" onclick="navigateToHomePage(0)"></span>
    <span class="dot" onclick="navigateToHomePage(1)"></span>
</div>

                    <!-- Âõ∫ÂÆöÂÖÉÁ¥†ÔºöÂ∫ïÈÉ®DockÊ†è (Áé∞Âú®ÊòØ .home-screen ÁöÑÁõ¥Êé•Â≠êÂÖÉÁ¥†) -->
              <!-- ËøôÊòØ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
<div class="bottom-dock">
    <div class="app"onclick="openApp('phone')">
        <div class="app-icon-container" id="icon-phone">
            <i class="ri-phone-fill"></i>
        </div>
        <div class="app-label">ÊâãÊú∫</div>
    </div>
    <div class="app forum-app" onclick="openApp('forum')">
        <div class="app-icon-container" id="icon-forum">
            <i class="ri-discuss-fill"></i>
        </div>
        <div class="app-label">ËÆ∫Âùõ</div>
    </div>
    <!-- Â≠¶‰π†‰∏≠ÂøÉÂõæÊ†á -->
<div class="app" onclick="openApp('study')">
    <div class="app-icon-container card-style" id="icon-study" style="background-color: #fff;">
        <i class="ri-timer-flash-line" style="font-size: 28px; color: #333;"></i>
    </div>
    <div class="app-label">‰∏ìÊ≥®</div>
</div>

</div>

                </div>
            </div>
            <div id="wechatApp" class="page">
            <div id="wechatAppBackground"></div>
                 <div class="nav-bar">

<button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>

    <div class="nav-title">Ê∂àÊÅØ</div>
    <!-- ‚Üì‚Üì‚Üì ‰øÆÊîπ‰ªéËøôÈáåÂºÄÂßã ‚Üì‚Üì‚Üì -->
    <div id="navRightButtons">
       <button class="nav-btn nav-right-action-btn" id="addMenuBtn" onclick="toggleAddMenu()"><i class="ri-add-line"></i></button>
    </div>
    <!-- ‚Üë‚Üë‚Üë ‰øÆÊîπÂà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë -->
</div>
                <div class="add-menu" id="addMenu">
                    <div class="add-menu-item" onclick="openGroupChatModal()">ÂèëËµ∑Áæ§ËÅä</div>
                    <div class="add-menu-item" onclick="openAddFriend()">Ê∑ªÂä†Â•ΩÂèã</div>
                </div>
                <div class="wechat-content">
                    <div id="wechatMessages" class="friend-list"></div>

<div id="wechatDiscover" class="discover-content bw-style" style="display: none;">

     <!-- Á¨¨‰∏ÄÁªÑÔºöÁ§æ‰∫§Âä®ÊÄÅ -->
    <div class="form-card">
        <!-- ÊúãÂèãÂúà -->
        <div class="form-group-row clickable" onclick="openMoments()">
            <label class="form-label">
                <i class="ri-donut-chart-line" style="font-size: 22px;"></i> ÊúãÂèãÂúà
            </label>
            <div class="form-value-display">
                <i class="ri-arrow-right-s-line"></i>
            </div>
        </div>

        <!-- CharÁ©∫Èó¥ -->
        <div class="form-group-row clickable" onclick="openCharSpaceSelector()">
            <label class="form-label">
                <i class="ri-user-heart-line" style="font-size: 22px;"></i> CharÁ©∫Èó¥
            </label>
            <div class="form-value-display">
                <i class="ri-arrow-right-s-line"></i>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∫åÁªÑÔºöÂÜÖÂÆπ‰∏éÂ∑•ÂÖ∑ -->
    <div class="form-card">
        <!-- Êó•ËÆ∞ -->
        <div class="form-group-row clickable" onclick="openDiary()">
            <label class="form-label">
                <i class="ri-draft-line" style="font-size: 22px;"></i> Êó•ËÆ∞
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>

        <!-- Ë°®ÊÉÖÂåÖÂ∫ì -->
        <div class="form-group-row clickable" onclick="openStickerLibrary()">
            <label class="form-label">
                <i class="ri-emotion-laugh-line" style="font-size: 22px;"></i> Ë°®ÊÉÖÂåÖÂ∫ì
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>

        <!-- Â•ΩÂèãÂàÜÁªÑ -->
        <div class="form-group-row clickable" onclick="openMomentGroupManager()">
            <label class="form-label">
                <i class="ri-group-line" style="font-size: 22px;"></i> Â•ΩÂèãÂàÜÁªÑ
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>
    </div>

</div>

                     <div id="wechatProfile" class="profile-content bw-style" style="display: none;">

    <!-- Âç°Áâá 1Ôºö‰∏™‰∫∫‰ø°ÊÅØ (Ê®™ÂêëÂ∏ÉÂ±Ä) -->
    <div class="form-card" style="padding: 30px 20px; display: flex; align-items: center;">
        <!-- Â§¥ÂÉèÔºöÁÇπÂáªÊõ¥Êç¢ -->
        <div class="profile-avatar-large" id="profileAvatar" onclick="changeAvatar()"
             style="width: 64px; height: 64px; margin: 0 15px 0 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        </div>

        <!-- ‰ø°ÊÅØÂå∫ÔºöÁÇπÂáªÊîπÂêç -->
        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;" onclick="changeName()">
            <div class="profile-name" id="profileName" style="text-align: left; font-size: 20px; font-weight: 600; margin-bottom: 4px;">
                <!-- JSÂ°´ÂÖÖÂêçÂ≠ó -->
            </div>
            <div style="font-size: 12px; color: #999;">ÂæÆ‰ø°Âè∑: wx_id_...</div>
        </div>

        <!-- Âè≥‰æßÁÆ≠Â§¥ -->
        <i class="ri-arrow-right-s-line" style="color: #ccc; font-size: 20px;"></i>
    </div>

    <!-- Âç°Áâá 2ÔºöÂäüËÉΩËèúÂçï -->
    <div class="form-card">
        <div class="form-group-row clickable" onclick="openPersonaList()">
            <label class="form-label">
                <i class="ri-user-star-line" style="font-size: 22px;"></i> ÊàëÁöÑ‰∫∫ËÆæ
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>
        <div class="form-group-row clickable" onclick="openWallet()">
            <label class="form-label">
                <i class="ri-wallet-3-line" style="font-size: 22px;"></i> Èí±ÂåÖ
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>
        <div class="form-group-row clickable" onclick="openFavorites()">
            <label class="form-label">
                <i class="ri-star-line" style="font-size: 22px;"></i> Êî∂Ëóè
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>
        <div class="form-group-row clickable" onclick="openMySettings()">
            <label class="form-label">
                <i class="ri-settings-3-line" style="font-size: 22px;"></i> ËÆæÁΩÆ
            </label>
            <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
        </div>
    </div>

</div>
                </div>
                <div class="wechat-bottom-nav">
                    <div class="wechat-tab active" onclick="switchWechatTab('messages')">
                        <div class="wechat-tab-icon">
                            <i class="ri-chat-3-line" style="font-size: 22px;"></i>
                        </div>
                        <div>Ê∂àÊÅØ</div>
                    </div>
                    <div class="wechat-tab" onclick="switchWechatTab('discover')">
                        <div class="wechat-tab-icon">
                            <i class="ri-compass-3-line" style="font-size: 22px;"></i>
                        </div>
                        <div>ÂèëÁé∞</div>
                    </div>
                    <div class="wechat-tab" onclick="switchWechatTab('profile')">
                        <div class="wechat-tab-icon">
                           <i class="ri-user-line" style="font-size: 22px;"></i>
                        </div>
                        <div>Êàë</div>
                    </div>
                </div>
            </div>

            <div id="chatScreen" class="page">
                <div class="nav-bar">
    <!-- 1. Â∑¶‰æßÔºöËøîÂõûÊåâÈíÆ -->
    <button class="nav-btn" id="navBarBackButton" onclick="backToWechat()"><i class="ri-arrow-left-s-line"></i></button>

    <!-- 2. Â∑¶‰æßÔºöÊÄªÁªìÊåâÈíÆ (Êñ∞Â¢û‰ΩçÁΩÆ) -->
    <!-- style="margin-right: auto;" ÊòØÂÖ≥ÈîÆÔºåÂÆÉË¥üË¥£ÊääÂè≥ËæπÁöÑÊåâÈíÆÁªÑÊé®Âà∞ÊúÄÂè≥ËæπÔºåÂÆûÁé∞‰∏§Á´ØÂØπÈΩê -->
    <button class="nav-btn" onclick="openMemoryScreen()" style="margin-right: auto; margin-left: 0;" title="ÂØπËØùÊÄªÁªì">
        <i class="ri-book-read-line"></i>
    </button>

    <!-- 3. ‰∏≠Èó¥ÔºöÊ†áÈ¢ò (ÁªùÂØπÂÆö‰ΩçÂ±Ö‰∏≠) -->
    <div class="nav-title" id="chatTitle">ËÅäÂ§©</div>

    <!-- 4. Âè≥‰æßÔºöÂäüËÉΩÊåâÈíÆÁªÑ -->
    <div style="display: flex; align-items: center;">
        <!-- Áæ§ÂÖ¨Âëä (Áæ§ËÅäÊòæÁ§∫) -->
        <button class="nav-btn" id="navBarAnnouncementBtn" onclick="openGroupAnnouncementModal()" style="display: none; margin-right: 5px;" title="Áæ§ÂÖ¨Âëä">
            <i class="ri-megaphone-line"></i>
        </button>
        <!-- ÂøÉÂ£∞ (ÁßÅËÅäÊòæÁ§∫) -->
        <button class="nav-btn" id="navBarHeartsVoiceButton" onclick="openHeartsVoiceModal()" title="ÂøÉÂ£∞">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
        </button>
        <!-- Êõ¥Â§öËÆæÁΩÆ -->
        <button class="nav-btn nav-right-action-btn" id="navBarMoreButton" onclick="openChatSettings()">‚ãØ</button>
    </div>
</div>

                <div class="wechat-content" style="position: relative; z-index: 1;">
                    <div class="chat-messages" id="chatMessages"></div>
                </div>
                <div class="multi-select-toolbar" id="multiSelectToolbar">
                    <span class="multi-select-count" id="multiSelectCount">Â∑≤ÈÄâÊã© 0 Êù°Ê∂àÊÅØ</span>
                    <div class="multi-select-actions">
                        <button class="multi-select-btn delete" onclick="deleteSelectedMessages()">Âà†Èô§</button>
                        <button class="multi-select-btn cancel" onclick="exitMultiSelectMode()">ÂèñÊ∂à</button>
                    </div>
                </div>
                <div class="chat-input-area" id="chatInputArea">
                   <!-- ‚Üì‚Üì‚Üì ËøôÊòØÊñ∞ÁöÑ‰ª£Á†ÅÔºåËØ∑Áî®ÂÆÉÊù•ÊõøÊç¢‰∏äÈù¢ÁöÑÊóß‰ª£Á†Å ‚Üì‚Üì‚Üì -->
<div class="chat-input">
    <!-- Êàë‰ª¨Áî®Ëøô‰∏™Êñ∞ÁöÑdivÊääÂõõ‰∏™ÈªòËÆ§ÊåâÈíÆÂåÖ‰∫ÜËµ∑Êù•ÔºåÂπ∂Áªô‰∫ÜÂÆÉ‰∏Ä‰∏™ID -->
    <div id="chatDefaultButtons" style="display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
        <button class="chat-btn" id="chatInputReceiveButton" onclick="requestAIResponse()" title="Êé•Êî∂Ê∂àÊÅØ"> <i class="ri-mail-download-line"></i> </button>
    </div>

   <textarea id="messageInput" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeydown="handleKeyPress(event)" oninput="toggleSendButtonActive(this)" onclick="hideFunctionMenus()"></textarea>

    <!-- Êàë‰ª¨‰πüÁªôÂè≥ËæπÁöÑÊåâÈíÆ‰ª¨‰∏Ä‰∏™‚ÄúÂÆ∂‚Äù -->
    <div id="chatRightButtons" style="display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
         <button class="chat-btn" id="chatInputEmojiButton" onclick="toggleEmojiPicker()" title="Ë°®ÊÉÖ"> <i class="ri-emotion-happy-line"></i> </button>
         <button class="chat-btn plus-btn" id="chatInputPlusButton" onclick="toggleChatFunctions()" title="Êõ¥Â§ö"> <i class="ri-add-line"></i> </button>
    </div>

    <!-- ÂèëÈÄÅÊåâÈíÆÂçïÁã¨ÊîæÂú®Â§ñÈù¢ -->
    <button class="chat-btn send-btn" id="chatInputSendButton" onclick="sendMessage()" title="ÂèëÈÄÅÊ∂àÊÅØ"> <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.4 20.4l17.4-8.4c.8-.4.8-1.6 0-2L3.4 1.6c-.8-.4-1.6.4-1.4 1.2l3.6 7.2c.2.4.2 1 0 1.4L2 19.2c-.2.8.6 1.6 1.4 1.2z"/></svg></button>
</div>
<!-- ‚Üë‚Üë‚Üë Êñ∞‰ª£Á†ÅÂà∞Ê≠§ÁªìÊùü ‚Üë‚Üë‚Üë -->
                    <div class="chat-functions" id="chatFunctions">
                        <div class="function-menu">
                            <div class="function-item" onclick="selectPhoto()"><div class="function-icon"> <i class="ri-image-line"></i> </div><div class="function-label">ÁÖßÁâá</div></div>
                            <div class="function-item" onclick="openCameraModal()"><div class="function-icon"> <i class="ri-camera-line"></i> </div><div class="function-label">ÊãçÊëÑ</div></div>
                            <div class="function-item" onclick="startVoiceCall()"><div class="function-icon"> <i class="ri-phone-line"></i> </div><div class="function-label">ËØ≠Èü≥ÈÄöËØù</div></div>
                            <!-- „ÄêÊñ∞Â¢û„ÄëÂèëÈÄÅËØ≠Èü≥ÊåâÈíÆ (ÊèíÂú®ËøôÈáå) -->
<div class="function-item" onclick="openVoiceModal()">
    <div class="function-icon">
        <i class="ri-mic-line"></i>
    </div>
    <div class="function-label">ÂèëÈÄÅËØ≠Èü≥</div>
</div>
                            <div class="function-item" onclick="openTransferModal()"><div class="function-icon"> <i class="ri-exchange-cny-line"></i> </div><div class="function-label">ËΩ¨Ë¥¶</div></div>
                           <!-- ÊääËøôÊÆµ‰ª£Á†ÅÂä†Âà∞ class="function-menu" ÁöÑ div ÈáåÈù¢ -->
<!-- ËØ∑Áî®ËøôÊÆµ‰ª£Á†ÅÊõøÊç¢ÂéüÊù•ÁöÑ‚ÄúÊóÅËßÇ‚ÄùÊåâÈíÆ -->
<div class="function-item" onclick="toggleSpectatorMode()">
    <div class="function-icon">
        <i class="ri-movie-2-line"></i>
    </div>
    <div class="function-label">ÊóÅËßÇ</div>
</div>


<div class="function-item" onclick="triggerMenuPatPat()">
    <div class="function-icon">
        <i class="ri-notification-3-line"></i>
    </div>
    <div class="function-label">Êãç‰∏ÄÊãç</div>
</div>
                            <div class="function-item" onclick="openListenTogether()"><div class="function-icon"> <i class="ri-music-2-line"></i> </div><div class="function-label">‰∏ÄËµ∑Âê¨</div></div>
                            <div class="function-item" onclick="openLocationModal()"><div class="function-icon"> <i class="ri-map-pin-line"></i> </div><div class="function-label">‰ΩçÁΩÆ</div></div>
                            <!-- Êñ∞Â¢ûÁöÑËÆ∞ÂøÜÂäüËÉΩÊåâÈíÆ -->

<!-- [Êñ∞Â¢û] Á∫ø‰∏ãÊ®°ÂºèÂÖ•Âè£ -->
<div class="function-item" onclick="toggleOfflineMode()">
    <div class="function-icon">
        <i class="ri-edit-line"></i>
    </div>
    <div class="function-label">Á∫ø‰∏ãÊ®°Âºè</div>
</div>

<!-- Âú® chatFunctions ÂÜÖÈÉ®Ê∑ªÂä† -->
<div class="function-item" onclick="openReadTogetherBookshelf()">
    <div class="function-icon"><i class="ri-book-open-line"></i></div>
    <div class="function-label">‰∏ÄËµ∑Áúã‰π¶</div>
</div>

                        </div>
                    </div>
                    <div class="emoji-picker" id="emojiPicker">
                        <div class="emoji-picker-header">
                             <button class="emoji-picker-btn manage" id="manageEmojiBtn" onclick="toggleEmojiManagement()">ÁÆ°ÁêÜ</button>
                        </div>
                        <div class="emoji-grid" id="emojiGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Together Listening Screen -->
            <div id="listenTogetherScreen" class="page">
                <div class="listen-bg" id="listenBg"></div>

                <div class="listen-main">
                     <div class="listen-header">
                        <div style="display: flex;">
                             <button class="nav-btn" id="listenBackBtn">
                                <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="listen-header-title">
                            <div id="listenSongTitle" style="font-weight: bold;">‰∏ÄËµ∑Âê¨</div>
                            <div id="listenSongArtist" style="font-size: 12px; color: rgba(255,255,255,0.7);">...</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                             <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('listenBgInput').click()" title="Êõ¥Êç¢ËÉåÊôØ">BG</button>
                             <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('vinylImageInput').click()" title="Êõ¥Êç¢Âî±ÁâáÂ∞ÅÈù¢">CD</button>
                             <button class="nav-btn" id="listenCloseBtn" style="color: #ff4d4d;"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
                        </div>
                    </div>

                    <div class="listen-avatars-container" id="listenAvatarsContainer">
                        <div class="headphone-arc"></div>
                        <div id="listenFriendAvatar" class="listen-avatar"></div>
                        <div id="listenUserAvatar" class="listen-avatar"></div>
                    </div>

                    <div id="listenTogetherChatOverlay"></div>

                    <div class="vinyl-container">
                        <div id="vinylRecord" class="vinyl-record">
                            <div id="albumArt" class="album-art"></div>
                        </div>
                    </div>

                    <div id="listenTogetherChatWrapper">
                        <button id="listenTogetherChatToggleBtn" onclick="toggleListenChat()">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        </button>
                         <div id="listenTogetherChatInputContainer">
                             <button class="listen-chat-btn" onclick="requestAIResponse()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                             <input type="text" id="listenTogetherChatInput" placeholder="ËÅäÁÇπ‰ªÄ‰πà..." onkeypress="handleListenTogetherKeyPress(event)">
                             <button id="listenTogetherSendBtn" onclick="sendListenTogetherMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                         </div>
                    </div>

                    <div id="songLyrics">
                         <p class="sub-lyric"></p>
                         <p class="active-lyric">... ÁÇπÂáªÂè≥‰∏ãËßíÂàóË°®Ê∑ªÂä†Ê≠åÊõ≤ ...</p>
                         <p class="sub-lyric"></p>
                    </div>
                </div>

                <div class="listen-controls">
                    <div class="listen-progress-bar">
                        <span id="currentTimeLabel">00:00</span>
                        <input type="range" id="songProgressBar" value="0" step="1" oninput="seekSong(this.value)">
                        <span id="durationLabel">00:00</span>
                    </div>
                    <div class="listen-buttons">
                        <button class="listen-btn" id="repeatBtn" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
                        <button class="listen-btn" onclick="prevSong()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                        <button class="listen-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                        <button class="listen-btn" onclick="nextSong()"><svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-8.5 6l8.5 6V6z"/></svg></button>
                        <button class="listen-btn" onclick="openPlaylistModal()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
                    </div>
                </div>
            </div>

                    <!-- [NEW] Diary Full View Screen -->
        <div id="diaryViewScreen" class="page">
            <div class="nav-bar">
                <button class="nav-btn" id="backToDiaryListBtn"><i class="ri-arrow-left-s-line"></i></button>
                <div class="nav-title">Êó•ËÆ∞Ê≠£Êñá</div>
                <div></div>
            </div>
            <div class="wechat-content" id="fullDiaryContent">
                <!-- Êó•ËÆ∞ÁöÑÂÖ®ÈÉ®ÂÜÖÂÆπ‰ºöÊòæÁ§∫Âú®ËøôÈáå -->
            </div>
        </div>

            <!-- [NEW] Voice Call Screen -->
            <div id="voiceCallScreen" class="page">
                <div class="voice-call-bg" id="voiceCallBg"></div>
                <div class="voice-call-header">
                    <div class="voice-call-avatar" id="voiceCallAvatar"></div>
                    <div class="voice-call-name" id="voiceCallName"></div>
                    <div class="voice-call-status" id="voiceCallStatus"></div>
                </div>

                <div class="voice-call-log" id="voiceCallLog">
                    <!-- Call dialogue will be appended here -->
                </div>

                <div class="voice-call-input-area" id="voiceCallInputArea">
                    <button onclick="requestAICallResponse()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                    <input type="text" id="voiceCallUserInput" placeholder="ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...">
                    <button onclick="sendUserCallMessage()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 20.4l17.4-8.4c.8-.4.8-1.6 0-2L3.4 1.6c-.8-.4-1.6.4-1.4 1.2l3.6 7.2c.2.4.2 1 0 1.4L2 19.2c-.2.8.6 1.6 1.4 1.2z"/></svg></button>
                </div>

                <div class="voice-call-controls" id="voiceCallControls">
                    <button class="voice-call-btn" onclick="showAlert('ÂäüËÉΩÊöÇÊú™ÂºÄÊîæ')">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-1.03.83-1.9 1.9-1.9 1.02 0 1.8.84 1.8 1.9l-.01 6.2c0 1.03-.83 1.9-1.9 1.9s-1.8-.84-1.8-1.9L10.8 4.9zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>
                        <span>ÈùôÈü≥</span>
                    </button>
                    <button class="voice-call-btn hangup" onclick="endVoiceCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></div>
                        <span>ÊåÇÊñ≠</span>
                    </button>
                    <button class="voice-call-btn" onclick="showAlert('ÂäüËÉΩÊöÇÊú™ÂºÄÊîæ')">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M3 4l1.41 1.41L12 12.83l7.59-7.59L21 6.64 12 15.64 3.36 7.05 3 7.41V4h.01M3 14v2h18v-2H3z"/></svg></div>
                        <span>ÂÖçÊèê</span>
                    </button>
                </div>
            </div>

            <!-- [NEW] Incoming Call Screen -->
            <div id="incomingCallScreen" class="page">
                <div class="voice-call-bg" id="incomingCallBg"></div>
                <div class="voice-call-header">
                    <div class="voice-call-avatar" id="incomingCallAvatar"></div>
                    <div class="voice-call-name" id="incomingCallName"></div>
                    <div class="voice-call-status">ÈÇÄËØ∑‰Ω†ËøõË°åËØ≠Èü≥ÈÄöËØù</div>
                </div>
                <div class="incoming-call-actions">
                    <button class="voice-call-btn hangup" onclick="declineCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg></div>
                        <span>ÊãíÁªù</span>
                    </button>
                    <button class="voice-call-btn accept incoming-call-btn" onclick="acceptCall()">
                        <div class="voice-call-btn-icon"><svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.27-.27.35-.66.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.75 0 .99-.65.99-.99v-3.45c0-.54-.45-.98-.99-.98z"/></svg></div>
                        <span>Êé•Âê¨</span>
                    </button>
                </div>
            </div>


            <div id="messageMenu" class="message-menu"></div>

            <div id="recalledMessagePopup" class="recalled-message-popup">
                <div class="recalled-message-title">Êí§ÂõûÁöÑÊ∂àÊÅØ</div>
                <div class="recalled-message-content" id="recalledMessageContent"></div>
                <button class="recalled-message-close" onclick="closeRecalledMessagePopup()">ÂÖ≥Èó≠</button>
            </div>

            <div id="chatSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ËÅäÂ§©ËÆæÁΩÆ</div>
        <div></div>
    </div>
    <!-- ‰ΩøÁî®Áõ∏ÂêåÁöÑ bw-style Á±ªÔºåÁªßÊâø‰πãÂâçÁöÑÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöÂ∏∏ËßÑËÆæÁΩÆ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openFriendOrGroupSettings()">
                <label class="form-label">ËÅäÂ§©ËØ¶ÊÉÖ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBackgroundSettings()">
                <label class="form-label">ËÅäÂ§©ËÉåÊôØ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
             <!-- „ÄêÊñ∞Â¢û„ÄëToken ÂàÜÊûêÂÖ•Âè£ -->
            <div class="form-group-row clickable" onclick="openTokenAnalysis()">
                <label class="form-label"><i class="ri-pie-chart-2-line"></i> Token</label>
                <div class="form-value-display">ÂàÜÊûê <i class="ri-arrow-right-s-line"></i></div>
            </div>
                        <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöCharÊó•Á®ãËÆæÁΩÆ (ÊèíÂú®Áª≠ÁÅ´Ëä±‰∏äÈù¢) ‚ñº‚ñº‚ñº -->
            <div class="form-group-row clickable" onclick="openCharScheduleSettings()">
                <label class="form-label">
                    <i class="ri-calendar-event-line" style="margin-right: 5px;"></i> Êó•Á®ã
                </label>
                <div class="form-value-display">
                    <span style="font-size: 12px; color: #999; margin-right: 5px;" id="scheduleStatusText"></span>
                    <i class="ri-arrow-right-s-line"></i>
                </div>
            </div>
            <div style="width: 100%; height: 1px; background-color: #f0f0f0; margin-bottom: 0;"></div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->


<div class="form-group-row clickable" onclick="forceOpenSpyMap()">
    <label class="form-label">
        <i class="ri-footprint-line" style="margin-right: 5px;"></i> Ë∂≥Ëøπ
    </label>
    <div class="form-value-display">
        <i class="ri-arrow-right-s-line"></i>
    </div>
</div>



             <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöÁª≠ÁÅ´Ëä±ËÆæÁΩÆ (ÊèíÂÖ•Âú®ËøôÈáå) ‚ñº‚ñº‚ñº -->
            <div class="form-group-row switch-row" style="border-top: 1px dashed #f0f0f0;">
                <label class="form-label">
                    <i class="ri-fire-line" style="margin-right: 5px;"></i> Áª≠ÁÅ´Ëä±
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="chatSparkToggle" onchange="updateSparkSettingsFromChatMenu()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div id="chatSparkInputGroup" class="form-group-row" style="display: none; justify-content: space-between;">
                 <label class="form-label sub-label" style="font-size: 13px; color: #999;">Â§öÂ∞ëÂ§©‰∏çËÅäÁªìÂÜ∞</label>
                 <div style="display: flex; align-items: center;">
                     <input type="number" id="chatSparkDurationInput" class="form-input"
                            style="width: 60px; text-align: right; height: 30px; padding: 0 5px;"
                            placeholder="3" min="1" onchange="updateSparkSettingsFromChatMenu()">
                     <span style="font-size: 14px; margin-left: 5px;">Â§©</span>
                 </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        </div>

        <!-- Âç°Áâá 2ÔºöËÅäÂ§©ÁÆ°ÁêÜ -->
        <div class="form-card">


            <!-- ÁΩÆÈ°∂ËÅäÂ§©Ôºö‰øùÁïô id="pinChatText" ‰æõJSÊõ¥Êñ∞Áä∂ÊÄÅ -->
            <div class="form-group-row clickable" onclick="togglePinChat()">
                <label class="form-label">ÁΩÆÈ°∂Áä∂ÊÄÅ</label>
                <div class="form-value-display" id="pinChatText">ÁÇπÂáªÂàáÊç¢</div>
            </div>
            <div class="form-group-row clickable" onclick="openChatSearch()">
                <label class="form-label">Êü•ÊâæËÅäÂ§©ËÆ∞ÂΩï</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="clearChatHistory()">
                <label class="form-label">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</label>
                <div class="form-value-display" style="font-size: 12px;">Ê∏ÖÁ©∫</div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆÔºöÂà†Èô§ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-delete" onclick="deleteFriend()">Âà†Èô§Âπ∂ÈÄÄÂá∫</button>
        </div>
    </div>
</div>

            <div id="chatSearchScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
                    <div class="nav-title">Êü•ÊâæËÅäÂ§©ËÆ∞ÂΩï</div>
                    <div></div>
                </div>
                <div class="settings-content" style="position: relative; height: 100%;">
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="form-input" id="searchInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢..." oninput="searchChatHistory()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
            </div>

     <div id="friendSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Â•ΩÂèãËÆæÁΩÆ</div>
        <div></div>
    </div>
    <div class="settings-content bw-style">

        <!-- Â§¥ÂÉèÂå∫Âüü -->
        <div class="form-card centered" id="editFriendAvatarGroup">
            <div class="avatar-upload big-avatar" id="editFriendAvatarUpload">
                <input type="file" accept="image/*" onchange="handleEditFriendAvatarUpload(event)">
                <span id="editFriendAvatarPreview"><i class="ri-camera-line"></i></span>
            </div>
            <div class="hint-text">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</div>
        </div>

        <!-- Âü∫Á°Ä‰ø°ÊÅØ -->
        <div class="form-card">
            <div class="form-group-row">
                <!-- ID ÂøÖÈ°ª‰øùÁïô -->
                <label class="form-label" id="editFriendNameLabel">ÊòµÁß∞</label>
                <input type="text" class="form-input" id="editFriendName" placeholder="ÂøÖÂ°´">
            </div>
            <!-- ID ÂøÖÈ°ª‰øùÁïô -->
            <div class="form-group-row" id="editFriendRemarkGroup">
                <label class="form-label">Â§áÊ≥®</label>
                <input type="text" class="form-input" id="editFriendRemark" placeholder="ËÆæÁΩÆÂ§áÊ≥®Âêç">
            </div>
            <!-- ‚ñº‚ñº‚ñº ËØ∑ÊèíÂÖ•ËøôÊÆµÊñ∞‰ª£Á†Å (ÁºñËæëÊó∂ÁöÑÊÄßÂà´ÈÄâÊã©) ‚ñº‚ñº‚ñº -->
<div class="form-group-row">
    <label class="form-label">ÊÄßÂà´</label>
    <select id="editFriendGenderInput" class="form-select arrow-select" style="direction: ltr;">
        <option value="">Êú™ËÆæÁΩÆ</option>
        <option value="[ÊÄßÂà´:Áî∑] ">Áî∑Áîü</option>
        <option value="[ÊÄßÂà´:Â•≥] ">Â•≥Áîü</option>
        <option value="[ÊÄßÂà´:ÈÄöÁî®] ">ÈÄöÁî®/‰øùÂØÜ</option>
    </select>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊèíÂÖ•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                        <!-- Êñ∞Â¢ûÔºöÂàÜÁªÑÂêçÁß∞ËæìÂÖ•Ê°Ü -->
                        <!-- ‰øÆÊîπÂêéÔºöÂ∏¶‰∏ãÊãâÈÄâÊã©ÁöÑÂàÜÁªÑËæìÂÖ•Ê°Ü -->
            <div class="form-group-row" style="position: relative; z-index: 10;">
                <label class="form-label">ÂàóË°®ÂàÜÁªÑ</label>
                <!-- ËæìÂÖ•Ê°ÜÂÆπÂô® -->
                <div style="flex: 1; position: relative;">
                    <!-- ËæìÂÖ•Ê°ÜÔºöÊ∑ªÂä†‰∫Ü onclick ‰∫ã‰ª∂Êù•Ëß¶ÂèëÂ±ïÁ§∫ÂàóË°® -->
                   <!-- Âú® id="friendSettingsScreen" È°µÈù¢ÂÜÖ -->
<input type="text" class="form-input" id="editFriendGroupInput"
       placeholder="ÁÇπÂáªÈÄâÊã© / ÊâãÂä®ËæìÂÖ•"
       autocomplete="off"
       readonly
       onclick="toggleFriendGroupDropdown(event)"
       oninput="filterFriendGroupDropdown(this.value)">
<!-- Ê≥®ÊÑèÔºö‰∏äÈù¢Ê∑ªÂä†‰∫Ü readonly Â±ûÊÄß -->

                    <!-- ‰∏ãÊãâÁÆ≠Â§¥ÂõæÊ†á -->
                    <i class="ri-arrow-down-s-line"
                       style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: #999; pointer-events: none;"></i>

                    <!-- ‰∏ãÊãâÂàóË°®ÂÆπÂô® (ÈªòËÆ§ÈöêËóè) -->
                    <div id="friendGroupDropdownList" class="bw-dropdown"
                         style="width: 100%; text-align: right; max-height: 150px;">
                        <!-- JS ‰ºöÂú®ËøôÈáåËá™Âä®ÁîüÊàêÈÄâÈ°π -->
                    </div>
                </div>
            </div>


        </div>

        <!-- ËÆæÂÆö‰∏é‰∫íÂä® („ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÔºöÊää id="editFriendRoleGroup" Âä†ÂõûÊù•‰∫Ü) -->
        <div class="form-card">
            <div class="form-group-row column-layout" id="editFriendRoleGroup">
                <label class="form-label">ËßíËâ≤ËÆæÂÆö</label>
                <textarea class="form-textarea large-area" id="editFriendRole" placeholder="ËæìÂÖ•ËØ¶ÁªÜÁöÑËßíËâ≤ËÆæÂÆö..."></textarea>
            </div>
                                    <!-- ÂüéÂ∏ÇËá™ÂÆö‰πâËÆæÁΩÆ (ÂèåÂàóÂπ∂ÊéíÁâà) -->
            <div class="form-card">
                <div class="form-group-row column-layout" style="border-bottom: 1px solid #f2f2f2;">
                    <!-- Ê†áÈ¢òË°å -->
                    <label class="form-label" style="width: 100%; margin-bottom: 10px; margin-right: 10px">
                        <i class="ri-map-pin-line"></i> ÂüéÂ∏ÇÊò†Â∞Ñ
                    </label>

                    <!-- ËæìÂÖ•Ê°ÜË°å (FlexÂ∏ÉÂ±Ä) -->
                    <div style="display: flex; width: 100%; gap: 10px; align-items: center;">
                        <!-- ËôöÊûÑÂüéÂ∏Ç -->
                        <input type="text" class="form-input" id="editFictionalCity"
                               placeholder="ËôöÊûÑÂüéÂ∏Ç"
                               style="flex: 1; background: #f9f9f9; border-radius: 8px; height: 40px; padding: 0 10px; text-align: center; color: #333;">

                        <!-- ÈìæÊé•Á¨¶Âè∑ -->
                        <i class="ri-links-line" style="color: #ccc;"></i>

                        <!-- Áé∞ÂÆûÂüéÂ∏Ç -->
                        <input type="text" class="form-input" id="editRealCity"
                               placeholder="Êò†Â∞ÑÂüéÂ∏Ç"
                               style="flex: 1; background: #f9f9f9; border-radius: 8px; height: 40px; padding: 0 10px; text-align: center; color: #333;">
                    </div>
                </div>
                <div class="form-hint">AIÂ∞ÜËØªÂèñÂè≥‰æßÊò†Â∞ÑÂüéÂ∏ÇÁöÑÂ§©Ê∞î/Êó∂Âå∫ÔºåÊù•ÊºîÁªéÂ±Ö‰ΩèÂú®Â∑¶‰æßËôöÊûÑÂüéÂ∏ÇÁöÑÁîüÊ¥ª„ÄÇ</div>
            </div>


            <div class="form-group-row" id="editFriendPatGroup">
                <label class="form-label">Êãç‰∏ÄÊãç</label>
                <input type="text" class="form-input" id="editFriendPatAction" placeholder="‰æãÂ¶ÇÔºöÁöÑÂ§¥">
            </div>
        </div>

        <!-- È´òÁ∫ßÂäüËÉΩ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openVoiceIdModal()">
                <label class="form-label">Èü≥Ëâ≤ID</label>
                <div id="currentCloneVoiceId" class="form-value-display">Êú™ËÆæÁΩÆ <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" id="worldBookBindingGroup" onclick="openWorldBookBindingModal()">
                <label class="form-label">‰∏ñÁïå‰π¶</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" id="selectPersonaItemGroup_Friend" style="display: none;" onclick="openPersonaSelectModal()">
                <label class="form-label">ÊàëÁöÑ‰∫∫ËÆæ</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- ÂºÄÂÖ≥‰∏éÊ†∑ÂºèÈÄâÊã© -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">ÊòæÁ§∫Êó∂Èó¥Êà≥</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="timestampToggle" onchange="toggleTimestampOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div id="timestampStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                    <label class="form-label sub-label">Ê†∑ÂºèÈÄâÊã©</label>
                    <select class="form-select arrow-select" id="timestampStyleSelect">
                        <option value="below_bubble">Ê∞îÊ≥°‰∏ãÈù¢</option>
                        <option value="below_avatar">Â§¥ÂÉè‰∏ãÈù¢</option>
                    </select>
                </div>
            </div>
             <div id="timestampSecondsGroup" style="display: none;">
                 <div class="form-group-row switch-row">
                    <label class="form-label sub-label">ÊòæÁ§∫ÁßíÊï∞</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timestampSecondsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">ÊòæÁ§∫Â∑≤ËØª</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="readReceiptToggle" onchange="toggleReadReceiptOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
             <div id="readReceiptStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                     <label class="form-label sub-label">Â∑≤ËØªÊ†∑Âºè</label>
                    <select class="form-select arrow-select" id="readReceiptStyleSelect">
                        <option value="below_bubble">Ê∞îÊ≥°‰∏ãÈù¢</option>
                        <option value="below_avatar">Â§¥ÂÉè‰∏ãÈù¢</option>
                    </select>
                </div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">ÈöêËóèÂ§¥ÂÉè</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="avatarHidingToggle" onchange="toggleAvatarHidingOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="avatarHidingModeGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                 <div class="form-group-row">
                    <label class="form-label sub-label">ÈöêËóèÊ®°Âºè</label>
                    <select class="form-select arrow-select" id="avatarHidingModeSelect">
                        <option value="both">ÈöêËóèÂèåÊñπÂ§¥ÂÉè</option>
                        <option value="received">Âè™ÈöêËóèÂ•ΩÂèã</option>
                        <option value="sent">Âè™ÈöêËóèÊàëÁöÑ</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveFriendSettings()">‰øùÂ≠òÊõ¥Êîπ</button>
        </div>
    </div>
</div>

            <!-- ‚Üì‚Üì‚Üì ËØ∑‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì -->

           <div id="groupSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Áæ§ËÅäËÆæÁΩÆ</div>
        <div></div>
    </div>

    <!-- ‰ΩøÁî® bw-style ÁªßÊâøÁªü‰∏ÄÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- 1. Áæ§Â§¥ÂÉèÂç°Áâá -->
        <div class="form-card centered">
            <div class="avatar-upload big-avatar" id="editGroupAvatarUpload">
                <input type="file" accept="image/*" onchange="handleEditGroupAvatarUpload(event)">
                <span id="editGroupAvatarPreview"><i class="ri-group-line"></i></span>
            </div>
            <div class="hint-text">ÁÇπÂáªÊõ¥Êç¢Áæ§Â§¥ÂÉè</div>
        </div>

        <!-- 2. Áæ§ÂêçÁß∞Âç°Áâá -->
        <div class="form-card">
            <div class="form-group-row">
                <label class="form-label">Áæ§ËÅäÂêçÁß∞</label>
                <input type="text" class="form-input" id="editGroupName" placeholder="ÂøÖÂ°´">
            </div>
        </div>

        <!-- 3. Áæ§ÊàêÂëòÂàóË°®Âç°Áâá (‰ºòÂåñÊòæÁ§∫) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label">Áæ§ÊàêÂëòÁÆ°ÁêÜ</label>
            </div>
            <!-- ËøôÈáåÁöÑÂÆπÂô®Ê†∑ÂºèË¢´‰ºòÂåñÔºåÈÄÇÈÖçÂç°ÁâáÂÜÖÈÉ®ÊòæÁ§∫ -->
            <div id="groupMembersList" class="bw-member-list">
                <!-- JS ‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊàêÂëòÂàóË°® -->
            </div>
        </div>

        <!-- 4. È´òÁ∫ßËÆæÁΩÆÂç°Áâá -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openWorldBookBindingModal()">
                <label class="form-label">ÁªëÂÆö‰∏ñÁïå‰π¶</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row clickable" id="selectPersonaItemGroup_Group" style="display: none;" onclick="openPersonaSelectModal()">
                <label class="form-label">ÊàëÁöÑ‰∫∫ËÆæ</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">ËÆ∞ÂøÜ‰∫íÈÄö</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="memorySharingToggle" onchange="toggleMemorySharing()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöÁæ§ËÅä‰∏ªÂä®ÂèëË®ÄÂºÄÂÖ≥ ‚ñº‚ñº‚ñº -->
            <div class="form-group-row switch-row">
                <label class="form-label">ÂÖÅËÆ∏Áæ§Âëò‰∏ªÂä®ÂèëË®Ä</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="groupProactiveToggle" onchange="toggleGroupProactive()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 2. „ÄêÊñ∞Â¢û„ÄëÈó¥ÈöîËÆæÁΩÆËæìÂÖ•Ê°Ü (ÈªòËÆ§ÈöêËóè) -->
<div id="groupProactiveIntervalInputGroup" class="form-group-row" style="display: none; justify-content: space-between;">
     <label class="form-label sub-label" style="font-size: 13px; color: #999;">Ëß¶ÂèëÈó¥Èöî</label>
     <div style="display: flex; align-items: center;">
         <input type="number" id="groupProactiveIntervalInput" class="form-input"
                style="width: 60px; text-align: right; height: 30px; padding: 0 5px;"
                placeholder="60" min="1">
         <span style="font-size: 14px; margin-left: 5px;">ÂàÜÈíü</span>
     </div>
</div>

            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        </div>
        <!-- 5. Â§ñËßÇÊòæÁ§∫ (Êñ∞Â¢ûÔºöÊó∂Èó¥Êà≥ËÆæÁΩÆ) -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">ÊòæÁ§∫Êó∂Èó¥Êà≥</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="groupTimestampToggle" onchange="toggleGroupTimestampOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div id="groupTimestampStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                    <label class="form-label sub-label">Ê†∑ÂºèÈÄâÊã©</label>
                    <select class="form-select arrow-select" id="groupTimestampStyleSelect">
                        <option value="below_bubble">Ê∞îÊ≥°‰∏ãÈù¢</option>
                        <option value="below_avatar">Â§¥ÂÉè‰∏ãÈù¢</option>
                    </select>
                </div>
            </div>
             <div id="groupTimestampSecondsGroup" style="display: none;">
                 <div class="form-group-row switch-row">
                    <label class="form-label sub-label">ÊòæÁ§∫ÁßíÊï∞</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="groupTimestampSecondsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 6. Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveGroupSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>
<!-- ‚Üë‚Üë‚Üë ËØ∑Âú®ËøôÈáåÁªìÊùüÂ§çÂà∂ ‚Üë‚Üë‚Üë -->

          <div id="backgroundSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ËÅäÂ§©ËÉåÊôØ</div>
        <div></div>
    </div>

    <!-- ‰ΩøÁî® bw-style Á±ªÔºåÁªßÊâø‰πãÂâçÁöÑÂÜÖËæπË∑ùÂíåËÉåÊôØËâ≤ -->
    <div class="settings-content bw-style">

        <!-- È¢ÑËßàÈÄâÊã©Âç°Áâá -->
        <div class="form-card">
            <!-- Ê†áÈ¢ò -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">ÈÄâÊã©ËÉåÊôØÂõæ</label>
            </div>

            <!-- ÁΩëÊ†ºÂÆπÂô®ÔºöÂ¢ûÂä†‰∫Ü bw-grid Á±ª -->
            <div class="background-grid bw-grid" id="individualBgGrid">

                <!-- ÈªòËÆ§ÈÄâÈ°π -->
                <div class="background-option default" onclick="selectBackground('default')">
                    <span>ÈªòËÆ§</span>
                </div>

                <!-- ‰∏ä‰º†ÈÄâÈ°π -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleBackgroundUpload(event)">
                    <span>+ ‰∏ä‰º†</span>
                </div>

                <!-- JS Âä®ÊÄÅÁîüÊàêÁöÑËá™ÂÆö‰πâÂõæÁâá‰ºöÊèíÂÖ•Âà∞ËøôÈáå -->
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆÁªÑ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveBackground()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="settings-btn btn-cancel" onclick="backToChatSettings()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
            <div id="personalSettingsScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
                    <div class="nav-title">‰∫∫ËÆæ‰∏éËÉåÊôØ</div>
                    <div></div>
                </div>
                <div class="settings-content">
                    <div class="form-group"><label class="form-label">ÊàëÁöÑ‰∫∫ËÆæ</label><textarea class="form-textarea" id="userPersonality" placeholder="ËØ∑ÊèèËø∞‰Ω†ÁöÑ‰∏™ÊÄß„ÄÅÁâπÁÇπ„ÄÅÂñúÂ•ΩÁ≠â..." style="min-height: 100px;"></textarea></div>
                    <div class="form-group"><label class="form-label">ËÉåÊôØËÆæÂÆö</label><textarea class="form-textarea" id="userBackground" placeholder="ËØ∑ÊèèËø∞‰Ω†ÁöÑËÉåÊôØ„ÄÅÁªèÂéÜ„ÄÅËÅå‰∏öÁ≠â..." style="min-height: 100px;"></textarea></div>
                    <div class="form-group"><label class="form-label">ÊàëÁöÑÊãç‰∏ÄÊãçÂä®‰Ωú</label><input type="text" class="form-input" id="userPatAction" placeholder="‰æãÂ¶ÇÔºöÊãç‰∫ÜÊãç"></div>
                    <div class="settings-buttons"><button class="settings-btn btn-primary" onclick="savePersonalSettings()">‰øùÂ≠òËÆæÁΩÆ</button></div>
                </div>
            </div>

            <div id="mySettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <!-- Â∫îÁî® bw-style ÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöËßÜËßâÂ§ñËßÇ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openGlobalChatBg()">
                <label class="form-label">
                    <i class="ri-image-line"></i> ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ
                </label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">
                    <i class="ri-rounded-corner"></i> ÂúÜËßíÊ®°Âºè
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="roundedToggle" onchange="toggleRoundedCorners()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Âç°Áâá 2ÔºöÁ≥ªÁªüÊòæÁ§∫ -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">
                    <i class="ri-moon-line"></i> Â§úÈó¥Ê®°Âºè
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

    </div>
</div>

          <div id="bubbleSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Ê∞îÊ≥°ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 1. ËßíËâ≤ÈÄâÊã©Âç°Áâá -->
        <div class="form-card">
            <div class="form-group-row">
                <label class="form-label">‰∏∫Ë∞ÅËÆæÁΩÆ</label>
                <select class="form-select arrow-select" id="characterAppearanceSelect" onchange="loadAppearanceSettingsForSelectedCharacter()">
                    <!-- JSÂä®ÊÄÅÁîüÊàê -->
                </select>
            </div>
        </div>

        <!-- 2. ÂÆûÊó∂È¢ÑËßàÂç°Áâá (ÊîæÂú®‰∏äÈù¢Êñπ‰æøÁúãÊïàÊûú) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">ÂÆûÊó∂È¢ÑËßà</label>
            </div>
            <!-- È¢ÑËßàÂÆπÂô® -->
            <div class="bubble-preview-box">
                <div class="bubble-preview-area" id="bubblePreviewArea">
                    <!-- Ê®°ÊãüÊ∂àÊÅØ -->
                    <div class="message received">
                        <div class="chat-avatar">TA</div>
                        <div class="message-content">ÂØπÊñπÁöÑÊ∞îÊ≥°Ê†∑Âºè</div>
                    </div>
                    <div class="message sent">
                        <div class="message-content">‰Ω†ÁöÑÊ∞îÊ≥°Ê†∑Âºè</div>
                        <div class="chat-avatar">Êàë</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Âü∫Á°ÄÂ§ñËßÇ (È¢úËâ≤ & Â§ßÂ∞è) -->
        <div class="form-card">
            <!-- ÂØπÊñπÊ∞îÊ≥°È¢úËâ≤ -->
            <div class="form-group-row">
                <label class="form-label">ÂØπÊñπÊ∞îÊ≥°Ëâ≤</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="receivedBubbleColorInput" placeholder="#E6F2FF" oninput="updateReceivedBubbleColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="receivedBubbleColorPicker" oninput="updateReceivedBubbleColor(this.value)">
                </div>
            </div>
            <!-- ÊàëÁöÑÊ∞îÊ≥°È¢úËâ≤ -->
            <div class="form-group-row">
                <label class="form-label">ÊàëÁöÑÊ∞îÊ≥°Ëâ≤</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="sentBubbleColorInput" placeholder="#FFEEF6" oninput="updateSentBubbleColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="sentBubbleColorPicker" oninput="updateSentBubbleColor(this.value)">
                </div>
            </div>

            <!-- Âø´Êç∑Â§çÂà∂ÊåâÈíÆÁªÑ -->
            <div class="form-group-row" style="justify-content: flex-start; gap: 10px; overflow-x: auto;">
                <button class="bw-chip-btn" onclick="copyBubbleFormat('bubble_only')">Â§çÂà∂Ê∞îÊ≥°Ê†ºÂºè</button>
                <button class="bw-chip-btn" onclick="copyBubbleFormat('bubble_and_avatar')">Â§çÂà∂Â§¥ÂÉèÊ†ºÂºè</button>
                <button class="bw-chip-btn" onclick="copyInterfaceFormat()">Â§çÂà∂ÁïåÈù¢Ê†ºÂºè</button>
            </div>

            <!-- Â§¥ÂÉèÂ§ßÂ∞è -->
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                    <label class="form-label">Â§¥ÂÉèÂ§ßÂ∞è</label>
                    <span id="avatarSizeValue" style="font-size: 12px; color: #666;">45px</span>
                </div>
                <input type="range" class="bw-slider" id="avatarSizeSlider" min="20" max="60" value="45" oninput="updateAvatarSettings('size', this.value)">
            </div>
            <!-- Â§¥ÂÉèÂúÜËßí -->
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px;">
                    <label class="form-label">Â§¥ÂÉèÂúÜËßí</label>
                    <span id="avatarRadiusValue" style="font-size: 12px; color: #666;">8px</span>
                </div>
                <input type="range" class="bw-slider" id="avatarRadiusSlider" min="0" max="50" value="8" oninput="updateAvatarSettings('radius', this.value)">
            </div>
        </div>

        <!-- 4. Â§¥ÂÉèÊ°ÜËÆæÁΩÆ (È´òÁ∫ß) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">Â§¥ÂÉèÊåÇ‰ª∂/ËæπÊ°Ü</label>
            </div>

            <div class="form-group-row">
                <label class="form-label">Â∫îÁî®ÂØπË±°</label>
                <select class="form-select arrow-select" id="avatarFrameTargetSelect" onchange="switchAvatarFrameTarget()">
                    <option value="both">ÂèåÊñπ</option>
                    <option value="sent">Êàë</option>
                    <option value="received">ÂØπÊñπ</option>
                </select>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="form-group-row" style="gap: 10px;">
                <button class="bw-action-btn" onclick="document.getElementById('avatarFrameInput').click()">Êú¨Âú∞‰∏ä‰º†</button>
                <button class="bw-action-btn" onclick="openAvatarFrameUrlModal()">ËæìÂÖ•URL</button>
                <button class="bw-action-btn danger" onclick="resetAvatarFrame()">ÈáçÁΩÆ</button>
            </div>

            <!-- Ë∞ÉÊï¥ÊªëÂùó -->
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>ËæπÊ°ÜÂ§ßÂ∞è</label><span id="avatarFrameSizeValue">3px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameSizeSlider" min="0" max="20" value="3" oninput="updateAvatarSettings('frameSize', this.value)">
            </div>
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>Â∑¶Âè≥ÂÅèÁßª</label><span id="avatarFrameOffsetXValue">0px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameOffsetXSlider" min="-50" max="50" value="0" oninput="updateAvatarSettings('frameOffsetX', this.value)">
            </div>
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>‰∏ä‰∏ãÂÅèÁßª</label><span id="avatarFrameOffsetYValue">0px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameOffsetYSlider" min="-50" max="50" value="0" oninput="updateAvatarSettings('frameOffsetY', this.value)">
            </div>
        </div>

        <!-- 5. È´òÁ∫ß CSS ‰ª£Á†Å -->
        <div class="form-card">
            <div class="form-group-row" style="justify-content: space-between;">
                <label class="form-label">Ê∞îÊ≥° CSS</label>
                <div style="display: flex; gap: 10px;">
                    <span class="text-link" onclick="saveCssPreset('bubble')">‰øùÂ≠òÈ¢ÑËÆæ</span>
                    <span class="text-link" onclick="openPresetSelector('bubble')">ÈÄâÊã©È¢ÑËÆæ</span>
                </div>
            </div>
            <div class="form-group-row column-layout" style="padding-top: 0;">
                <textarea class="form-textarea code-font" id="bubbleCustomCSS" placeholder="Âú®Ê≠§ËæìÂÖ• CSS..." oninput="applyCustomBubbleCSS(this.value)"></textarea>
            </div>
        </div>

        <div class="form-card">
            <div class="form-group-row" style="justify-content: space-between;">
                <label class="form-label">ÁïåÈù¢ CSS</label>
                <div style="display: flex; gap: 10px;">
                    <span class="text-link" onclick="saveCssPreset('interface')">‰øùÂ≠òÈ¢ÑËÆæ</span>
                    <span class="text-link" onclick="openPresetSelector('interface')">ÈÄâÊã©È¢ÑËÆæ</span>
                </div>
            </div>
            <div class="form-group-row column-layout" style="padding-top: 0;">
                <textarea class="form-textarea code-font" id="chatInterfaceCSSInput" placeholder="Âú®Ê≠§ËæìÂÖ• CSS..." oninput="applyChatInterfaceCSS(this.value)"></textarea>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveBubbleSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="settings-btn btn-cancel" onclick="cancelBubbleSettings()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

            <div id="globalChatBgScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToMySettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ</div>
        <div></div>
    </div>

    <!-- Â∫îÁî® bw-styleÔºåÂ§çÁî®‰πãÂâçÁöÑÁΩëÊ†ºÊ†∑Âºè -->
    <div class="settings-content bw-style">

        <!-- ËÉåÊôØÈÄâÊã©Âç°Áâá -->
        <div class="form-card">
            <!-- Ê†áÈ¢ò -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">ÈÄâÊã©ËÉåÊôØÂõæ</label>
            </div>

            <!-- ÁΩëÊ†ºÂÆπÂô®ÔºöÂ§çÁî® bw-grid Ê†∑Âºè -->
            <div class="background-grid bw-grid" id="globalBgGrid">

                <!-- ÈªòËÆ§ÈÄâÈ°π -->
                <div class="background-option default" onclick="selectGlobalChatBg('default')">
                    <span>ÈªòËÆ§</span>
                </div>

                <!-- ‰∏ä‰º†ÈÄâÈ°π -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleGlobalChatBgUpload(event)">
                    <span>+ ‰∏ä‰º†</span>
                </div>

                <!-- JS ‰ºöËá™Âä®Âú®ËøôÈáåÊèíÂÖ•È¢ÑËßàÂõæ -->
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveGlobalChatBg()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="settings-btn btn-cancel" onclick="backToMySettings()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

           <!-- 1. Èí±ÂåÖ‰∏ªÁïåÈù¢ (ÈªëÁôΩÈ£é + Â∏ÉÂ±ÄË∞ÉÊï¥) -->
<div id="walletScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Èí±ÂåÖ</div>
        <div class="nav-btn" style="width: 40px;"></div> <!-- Âç†‰ΩçÔºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠ -->
    </div>

    <div class="settings-content bw-style">
        <!-- ‰ΩôÈ¢ùÂ±ïÁ§∫Âç°Áâá (Êîπ‰∏∫ÈªëÁôΩÈ£éÊ†º) -->
        <div class="wallet-header-card">
            <div class="wallet-icon"><i class="ri-wechat-pay-fill"></i></div>
            <div class="wallet-balance-label">ÊàëÁöÑ‰ΩôÈ¢ù</div>
            <div class="wallet-balance-amount" id="balanceAmount">¬• 0.00</div>
        </div>

        <!-- ÂäüËÉΩËèúÂçï -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openPaymentPasswordModal()">
                <label class="form-label"><i class="ri-lock-password-line" style="color:#333; margin-right:10px;"></i> ÊîØ‰ªòÂØÜÁ†Å</label>
                <div class="form-value-display" id="paymentPasswordStatus">Êú™ËÆæÁΩÆ <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="rechargeWallet()">
                <label class="form-label"><i class="ri-bank-card-line" style="color:#333; margin-right:10px;"></i> ÂÖÖÂÄº</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="withdrawWallet()">
                <label class="form-label"><i class="ri-hand-coin-line" style="color:#333; margin-right:10px;"></i> ÊèêÁé∞</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openFamilyCard()">
                <label class="form-label"><i class="ri-heart-2-line" style="color:#333; margin-right:10px;"></i> ‰∫≤Â±ûÂç°</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <!-- „Äê‰øÆÊîπ„ÄëË¥¶ÂçïÁé∞Âú®ÁßªÂä®Âà∞‰∫ÜËøôÈáå -->
            <div class="form-group-row clickable" onclick="openBillDetail()">
                <label class="form-label"><i class="ri-file-list-3-line" style="color:#333; margin-right:10px;"></i> Ë¥¶Âçï</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- 2. Ë¥¶ÂçïÊòéÁªÜÁïåÈù¢ (ÁßªÈô§Á≠õÈÄâÊ†è) -->
<div id="billDetailScreen" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="backToWallet()"><i class="ri-close-line" style="font-size: 24px;"></i></button>
        <div class="nav-title">Ë¥¶Âçï</div>
        <div class="nav-btn" style="width: 40px;"></div> <!-- ÁßªÈô§‰∏â‰∏™ÁÇπÔºå‰øùÁïôÂç†‰Ωç -->
    </div>
    <div class="wechat-content" style="background-color: #fff; display: flex; flex-direction: column; padding-top: 74px;">
        <!-- ÁßªÈô§‰∫Ü .bill-filter-bar -->

        <!-- Ë¥¶ÂçïÂàóË°®ÂÆπÂô® -->
        <div id="billListContainer" style="flex:1; overflow-y: auto;">
            <!-- JSÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊúà‰ªΩÂíåË¥¶Âçï -->
        </div>
    </div>
</div>

<div id="familyCardScreen" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="backToWallet()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰∫≤Â±ûÂç°</div>
        <div class="nav-btn" style="width: 40px;"></div>
    </div>

    <!-- Â¢ûÂä† overflow-y: auto Á°Æ‰øùÂèØ‰ª•ÊªöÂä® -->
    <div class="wechat-content" style="padding: 15px; padding-top: 74px; background-color: #f7f7f7; height: 100%; overflow-y: auto; box-sizing: border-box;">

        <div style="font-size: 14px; color: #999; margin-bottom: 10px; padding-left: 4px;">ÊàëÊî∂Âà∞ÁöÑ‰∫≤Â±ûÂç°</div>

        <!-- ‰∫≤Â±ûÂç°ÂàóË°® -->
        <div id="familyCardList"></div>

        <!-- Ê∂àË¥πÁïôË®ÄÂºÄÂÖ≥ (ÈªëÁôΩÈ£éÔºåÂçïË°åÂ∏ÉÂ±Ä) -->
        <div class="form-card" style="margin-top: 20px; margin-bottom: 15px; background: #fff; border-radius: 12px; padding: 0 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
            <div class="form-group-row" style="border: none; padding: 18px 0; display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="font-size: 16px; color: #000; font-weight: 500; margin: 0;">Ê∂àË¥πËá™Âä®ÁïôË®Ä</label>
                <!-- ÈªëÁôΩÈ£éÂºÄÂÖ≥ -->
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="fcMessageToggle" checked onchange="toggleFcMessageSetting()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Ëµ†ÈÄÅÊåâÈíÆ -->
        <div class="form-card" style="background: #fff; border-radius: 12px; padding: 0 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
             <div class="form-group-row clickable" style="padding: 18px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: none;" onclick="alert('Ëµ†ÈÄÅÂäüËÉΩÂºÄÂèë‰∏≠')">
                <label class="form-label" style="color: #000; font-size: 16px; font-weight: 500; margin: 0;">Ëµ†ÈÄÅ‰∫≤Â±ûÂç°</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line" style="color: #ccc; font-size: 18px;"></i></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; padding-bottom: 30px; color: #ccc; font-size: 12px;">
            ‰∫≤Â±ûÂç°ÂèØÁî®‰∫éÁ∫¢ÂåÖ„ÄÅËΩ¨Ë¥¶ÂèäÊ∂àË¥π‰ª£‰ªò
        </div>
    </div>
</div>

<!-- „ÄêÊñ∞Â¢û„Äë‰∫≤Â±ûÂç°Ê∂àË¥πËØ¶ÊÉÖÈ°µ (Áã¨Á´ãÈ°µÈù¢ÔºåÈùûÂºπÁ™ó) -->
<div id="familyCardDetailScreen" class="page">
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToFamilyCardList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Ê∂àË¥πÊòéÁªÜ</div>
        <div class="nav-btn" style="width: 40px;"></div>
    </div>
    <div class="wechat-content" style="padding-top: 74px; background-color: #fff;">
        <div id="fcDetailContainer" style="height: 100%; overflow-y: auto;">
            <!-- È°∂ÈÉ®Âç°ÁâáÂÆπÂô® -->
            <div id="fcDetailHeader" style="padding: 20px 15px; background: #f7f7f7;"></div>
            <!-- Ë¥¶Âçï+ÁïôË®Ä ÁÄëÂ∏ÉÊµÅ -->
            <div id="fcDetailList" style="padding: 0 15px 40px;"></div>
        </div>
    </div>
</div>

<!-- 4. Êñ∞Â¢ûÔºöÊîØ‰ªòÂØÜÁ†ÅËÆæÁΩÆÂºπÁ™ó -->
<div id="paymentPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ËÆæÁΩÆÊîØ‰ªòÂØÜÁ†Å</div>
        <input type="password" class="modal-input" id="newPaymentPassword" placeholder="ËØ∑ËæìÂÖ•6‰ΩçÊï∞Â≠óÂØÜÁ†Å" maxlength="6">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePaymentPasswordModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePaymentPassword()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>
            <div id="favoritesScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button> <div class="nav-title">Êî∂Ëóè</div><button class="nav-btn" onclick="toggleSelectMode()">ÈÄâÊã©</button>
    </div>
    <div class="wechat-content">
        <!-- ‚Üì‚Üì‚Üì Êää‚ÄúÈÄâÊã©Ê†è‚ÄùÁßªÂä®Âà∞ËøôÈáåÊù• ‚Üì‚Üì‚Üì -->
        <div class="select-mode" id="selectMode">
            <span id="selectedCount">Â∑≤ÈÄâÊã© 0 È°π</span>
            <button class="select-btn" onclick="deleteSelectedFavorites()">Âà†Èô§</button>
        </div>
        <div class="favorite-list" id="favoriteList"></div>
    </div>
</div>
            <div id="worldBookScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰∏ñÁïå‰π¶</div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <button class="nav-btn" onclick="openAddWorldBookFolderModal()" title="Êñ∞Âª∫Êñá‰ª∂Â§π">
                <i class="ri-folder-add-line" style="font-size: 22px;"></i>
            </button>
            <button class="nav-btn" onclick="openAddWorldBook()" title="Êñ∞Âª∫‰∏ñÁïå‰π¶">
                <i class="ri-file-add-line" style="font-size: 22px;"></i>
            </button>
        </div>
    </div>

    <!-- ‰ΩøÁî® bw-style ÁªßÊâøÁªü‰∏ÄÁöÑÈªëÁôΩÂç°ÁâáÈ£éÊ†º -->
    <div class="settings-content bw-style">
        <div id="worldBookList">
            <!-- JS Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂç°Áâá -->
        </div>
    </div>
</div>
          <div id="momentsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscover()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÊúãÂèãÂúà</div>
        <!-- ‰øÆÊîπÔºöÂè≥‰æßÊåâÈíÆÁªÑ -->
        <div class="nav-right-buttons">

            <button class="nav-btn nav-right-action-btn" onclick="openAddMoment()">+</button>
            <button class="nav-btn nav-right-action-btn" onclick="openMomentsSideMenu()">
        <i class="ri-settings-3-line"></i>
    </button>
        </div>
    </div>
    <div class="wechat-content">
        <div id="momentsList"></div>
    </div>
</div>

            <div id="diaryScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToDiscover()"><i class="ri-arrow-left-s-line"></i></button>
                    <div class="nav-title">Êó•ËÆ∞</div>
                    <div id="diaryNavFriendName"></div>
                </div>
                <!-- ÂéüÊúâÁöÑÂÜÖÂÆπ‰øùÊåÅ‰∏çÂèò -->
    <div class="diary-content-view">
        <div id="diaryFriendList" class="friend-list"></div>
        <div id="diaryContentArea" class="diary-list"></div>
    </div>

    <!-- „ÄêÊñ∞Â¢û„ÄëÊó•ËÆ∞ÊâπÈáèÊìç‰ΩúÊ†è (ÊèíÂÖ•Âà∞ËøôÈáå) -->
    <div id="diaryBatchBar" class="diary-batch-bar">
        <div class="diary-action-item" onclick="toggleDiarySelectAll()">
            <i class="ri-checkbox-circle-line" id="diarySelectAllIcon"></i>
            <span>ÂÖ®ÈÄâ</span>
        </div>
        <div class="diary-batch-info">
            SELECTED: <span id="diarySelectCount">0</span>
        </div>
        <div class="diary-action-item" onclick="deleteSelectedDiaries()">
            <i class="ri-delete-bin-fill"></i>
            <span>Âà†Èô§</span>
        </div>
    </div>
            </div>

            <div id="themeApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰∏ªÈ¢òËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöÂü∫Á°ÄËßÜËßâ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openFontSettings()">
                <label class="form-label"><i class="ri-font-size"></i> Â≠ó‰ΩìËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openWallpaperSettings()">
                <label class="form-label"><i class="ri-image-2-line"></i> ‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- Âç°Áâá 2ÔºöÁ≥ªÁªüÁïåÈù¢ -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label"><i class="ri-layout-top-line"></i> ÊòæÁ§∫Áä∂ÊÄÅÊ†è</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="statusBarToggle" onchange="toggleStatusBar()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Âç°Áâá 3ÔºöÈ´òÁ∫ßÂÆöÂà∂ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openIconSettings()">
                <label class="form-label"><i class="ri-apps-2-line"></i> ÂõæÊ†áËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openComponentSettings()">
                <label class="form-label"><i class="ri-dashboard-line"></i> ÁªÑ‰ª∂ËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBeautificationSettings()">
                <label class="form-label"><i class="ri-magic-line"></i> ÁæéÂåñËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBubbleSettings()">
                <label class="form-label"><i class="ri-chat-smile-2-line"></i> Ê∞îÊ≥°ËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

    </div>
</div>

           <div id="fontSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Â≠ó‰ΩìËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöÂ≠ó‰ΩìÈÄâÊã© -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">ÈÄâÊã©Â≠ó‰Ωì</label>
            </div>

            <div class="font-options-grid">
                <!-- Á≥ªÁªüÈªòËÆ§ -->
                <div class="font-option-card system selected" onclick="selectFont('system')">
                    <div class="font-preview-text" style="font-family: sans-serif;">Aa</div>
                    <div class="font-info">
                        <span class="name">Á≥ªÁªüÈªòËÆ§</span>
                        <span class="desc">ËãπÊñπ / ÂæÆËΩØÈõÖÈªë</span>
                    </div>
                    <div class="check-circle"><i class="ri-check-line"></i></div>
                </div>

                <!-- Ëá™ÂÆö‰πâ -->
                <div class="font-option-card custom" onclick="selectFont('custom')">
                    <div class="font-preview-text" style="font-family: serif;">Aa</div>
                    <div class="font-info">
                        <span class="name">Ëá™ÂÆö‰πâ</span>
                        <span class="desc">‰ΩøÁî®ÁΩëÁªúÂ≠ó‰Ωì</span>
                    </div>
                    <div class="check-circle"><i class="ri-check-line"></i></div>
                </div>
            </div>

<!-- URL ËæìÂÖ•Ê°Ü (Êó†ÁºùË°îÊé•) -->
            <div class="form-group-row column-layout" style="border-top: 1px dashed #eee; margin-top: 15px; padding-top: 15px;">

                <!-- Ê†áÈ¢òÊ†èÂÆπÂô®ÔºöÂ∑¶ËæπÊòØÊñáÂ≠óÔºåÂè≥ËæπÊòØÊåâÈíÆ -->
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px;">
                    <label class="form-label sub-label" style="margin-bottom: 0;">Â≠ó‰ΩìÈìæÊé• (URL)</label>

                    <!-- Âè≥‰æßÊåâÈíÆÁªÑ -->
                    <div style="display: flex; gap: 8px;">
                        <button class="bw-chip-btn" onclick="openFontPresetSelector()">ÈÄâÊã©È¢ÑËÆæ</button>
                        <button class="bw-chip-btn" onclick="saveFontPreset()">‰øùÂ≠ò</button>
                    </div>
                </div>

                <textarea class="form-textarea" id="fontUrlInput" placeholder="ËØ∑ËæìÂÖ• .ttf, .woff Á≠âÂ≠ó‰ΩìÊñá‰ª∂ÈìæÊé•..." oninput="applyCustomFont(this.value)" style="min-height: 60px; background: #f9f9f9;"></textarea>
            </div>

        </div>

        <!-- Âç°Áâá 2ÔºöÂ≠óÂè∑Ë∞ÉÊï¥ -->
        <div class="form-card">
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;">
                    <label class="form-label">ÂÖ®Â±ÄÂ≠óÂè∑</label>
                    <span id="fontSizeValue" class="form-value-display" style="font-weight: bold; color: #000;">14px</span>
                </div>
                <div class="slider-container">
                    <span style="font-size: 12px;">A-</span>
                    <input type="range" class="bw-slider" id="fontSizeSlider" min="12" max="24" value="14" oninput="adjustFontSize(this.value)">
                    <span style="font-size: 16px;">A+</span>
                </div>
            </div>
        </div>

        <!-- Âç°Áâá 3ÔºöÈ¢úËâ≤ËÆæÁΩÆ -->
        <div class="form-card">
            <!-- ÂÖ®Â±ÄÂ≠óËâ≤ -->
            <div class="form-group-row">
                <label class="form-label">ÂÖ®Â±ÄÂ≠óËâ≤</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="fontColorInput" value="#000000" placeholder="#000000" oninput="updateFontColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="fontColorPicker" value="#000000" onchange="updateFontColor(this.value)">
                </div>
            </div>
            <!-- AppÊ†áÁ≠æÈ¢úËâ≤ -->
            <div class="form-group-row">
                <label class="form-label">ÂõæÊ†áÊñáÂ≠óÈ¢úËâ≤</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="appLabelColorInput" value="#333333" placeholder="#333333" oninput="updateAppLabelColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="appLabelColorPicker" value="#333333" onchange="updateAppLabelColor(this.value)">
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveFont()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="settings-btn btn-cancel" onclick="backToTheme()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
            <div id="wallpaperSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</div>
        <div></div>
    </div>

    <!-- Â∫îÁî® bw-style ÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- Â£ÅÁ∫∏ÈÄâÊã©Âç°Áâá -->
        <div class="form-card">
            <!-- Ê†áÈ¢ò -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">ËÆæÁΩÆÂ£ÅÁ∫∏</label>
            </div>

            <!-- ÁΩëÊ†ºÂÆπÂô®ÔºöÊ∑ªÂä† bw-grid Á±ª -->
            <div class="background-grid bw-grid" id="wallpaperGrid">

                <!-- ÈªòËÆ§ÈÄâÈ°π -->
                <div class="background-option default" onclick="selectWallpaper('default')">
                    <span>ÈªòËÆ§</span>
                </div>

                <!-- ‰∏ä‰º†ÈÄâÈ°π -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleWallpaperUpload(event)">
                    <span>+ ‰∏ä‰º†</span>
                </div>

                <!-- JS ‰ºöËá™Âä®Êää‰∏ä‰º†ÁöÑÂõæÁâáÊèíÂÖ•Âà∞ËøôÈáå -->
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveWallpaper()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="settings-btn btn-cancel" onclick="backToTheme()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
         <div id="iconSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂõæÊ†áËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- ÂõæÊ†áÂÆ´Ê†ºÂç°Áâá -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label">ÁÇπÂáªÂõæÊ†áÊõ¥Êç¢</label>
            </div>
            <!-- ËøôÈáåÁöÑÂÆπÂô®Â∞ÜÁî± JS Â°´ÂÖÖ -->
            <div id="iconSettingsList" class="bw-icon-grid"></div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="backToTheme()">ÂÆåÊàê</button>
            <button class="settings-btn btn-cancel" onclick="restoreDefaultIcons()" style="color: #ff3b30; border-color: #ff3b30;">ÊÅ¢Â§çÈªòËÆ§ÂõæÊ†á</button>
        </div>
    </div>
</div>

            <div id="componentSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÁªÑ‰ª∂ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <!-- Áõ¥Êé•Â§çÁî® bw-style Á±ªÔºåËá™Âä®Â∫îÁî®ÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- ËÆæÁΩÆÂç°Áâá -->
        <div class="form-card">
            <!-- ‰∏™‰∫∫‰ø°ÊÅØÁªÑ‰ª∂ÂºÄÂÖ≥ -->
            <div class="form-group-row switch-row">
                <label class="form-label"><i class="ri-id-card-line"></i> ‰∏™‰∫∫‰ø°ÊÅØÈÄèÊòé</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="profileWidgetBgToggle" onchange="toggleProfileWidgetBg()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Â∞èÁªÑ‰ª∂ÂºÄÂÖ≥ -->
            <div class="form-group-row switch-row">
                <label class="form-label"><i class="ri-dashboard-line"></i> Â∞èÁªÑ‰ª∂ÈÄèÊòé</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="smallWidgetBgToggle" onchange="toggleSmallWidgetBg()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊèêÁ§∫ÊñáÂ≠ó (Â¢ûÂä†ÁªÜËäÇÊÑü) -->
        <div style="padding: 0 20px; text-align: center; color: #999; font-size: 12px; line-height: 1.5;">
            ÂºÄÂêØÈÄèÊòéÊ®°ÂºèÂêéÔºåÁªÑ‰ª∂ËÉåÊôØÂ∞ÜÈöêËóèÔºå‰ªÖÊòæÁ§∫ÊñáÂ≠óÂíåÂõæÁâá„ÄÇ<br>ÈÄÇÂêàÊê≠ÈÖçÂ§çÊùÇÁöÑÂ£ÅÁ∫∏‰ΩøÁî®„ÄÇ
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="backToTheme()">ÂÆåÊàê</button>
        </div>
    </div>
</div>

           <div id="settingsApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <!-- Â∫îÁî® bw-style ÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöÊ†∏ÂøÉÊé•Âè£ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openApiSettings()">
                <label class="form-label">API ËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openCloneApiSettings()">
                <label class="form-label">ÂÖãÈöÜÈü≥Ëâ≤ËÆæÁΩÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- Âç°Áâá 2Ôºö‰∏ªÂä®‰∫§‰∫í -->
        <div class="form-card">
        <!-- Âú® id="settingsApp" ÂÜÖÁöÑÊüê‰∏™ .form-card ‰∏≠ÊèíÂÖ• -->
<div class="form-group-row clickable" onclick="openSoundSettings()">
    <label class="form-label">Ê∂àÊÅØÊèêÁ§∫Èü≥</label>
    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
</div>
            <div class="form-group-row switch-row">
                <label class="form-label">ÂºÄÂêØ‰∏ªÂä®ÂèëÊ∂àÊÅØ</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="proactiveMessagingToggle" onchange="toggleProactiveMessaging()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ÈöêËóèÈ°πÔºöÊó∂Èó¥Èó¥Èöî (JSÊéßÂà∂ÊòæÁ§∫) -->
            <div class="form-group-row" id="proactiveIntervalSetting" style="display: none;">
                <label class="form-label">Èó¥Èöî (ÂàÜÈíü)</label>
                <input type="number" id="proactiveIntervalInput" class="form-input" min="1" placeholder="ÈªòËÆ§ 360" onchange="updateProactiveInterval(this.value)">
            </div>

            <!-- ÈöêËóèÈ°πÔºöËßíËâ≤ÈÄâÊã© (JSÊéßÂà∂ÊòæÁ§∫) -->
            <div class="form-group-row clickable" id="proactiveRoleSetting" style="display: none;" onclick="openProactiveRolesModal()">
                <label class="form-label">ÈÄâÊã©ÁîüÊïàËßíËâ≤</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- Âç°Áâá 3ÔºöÊô∫ËÉΩÊÄªÁªì -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">ÂºÄÂêØËá™Âä®ÊÄªÁªì</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSummaryToggle" onchange="toggleAutoSummarySetting()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ÈöêËóèÈ°πÔºöÊÄªÁªìËΩÆÊï∞ (JSÊéßÂà∂ÊòæÁ§∫) -->
            <div class="form-group-row" id="summaryTurnsSetting" style="display: none;">
                <label class="form-label">Ëß¶ÂèëËΩÆÊï∞</label>
                <input type="number" id="memoryGenerationTurnsInput" class="form-input" min="1" placeholder="ÈªòËÆ§ 20" onchange="memoryGenerationTurns = parseInt(this.value, 10) || 20; saveData(); showToast('ÊÄªÁªìËΩÆÊï∞Â∑≤‰øùÂ≠ò');">
            </div>
        </div>

        <!-- Âç°Áâá 4ÔºöÊï∞ÊçÆÁÆ°ÁêÜ -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="importData()">
                <label class="form-label">ÂØºÂÖ•Êï∞ÊçÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openExportModal()">
                <label class="form-label">ÂØºÂá∫ËßíËâ≤‰∏éËÆ∞ÂΩï (ÈÉ®ÂàÜ)</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="exportData()">
                <label class="form-label">ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ (Â§á‰ªΩ)</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openClearDataConfirm()">
                <label class="form-label" style="color: #ff3b30;">Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

    </div>
</div>

            <!-- Êñ∞Â¢ûÁöÑËÆ∞ÂøÜÊü•ÁúãÈ°µÈù¢ -->
<div id="memoryScreen" class="page">

<!-- „Äê„Äê„ÄêËøôÊòØÊàë‰ª¨Êñ∞Â¢ûÁöÑ‚ÄúÊÄªÁªìÂä†ËΩΩ‰∏≠‚ÄùÊèêÁ§∫„Äë„Äë„Äë -->
<div id="summaryLoadingIndicator" style="display: none;">
    Ê≠£Âú®ÁîüÊàêÊÄªÁªìÔºåËØ∑Á®çÂÄô...
</div>

  <!-- „Äê„Äê„ÄêËøôÊòØ‰øÆÊîπÂêéÁöÑÊ≠£Á°Æ‰ª£Á†Å„Äë„Äë„Äë -->
<div class="nav-bar">
    <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
    <div class="nav-title" id="memoryTitle">ÂØπËØùÊÄªÁªì</div>
    <!-- ‚Üì‚Üì‚Üì Êàë‰ª¨Êñ∞Â¢ûÁöÑ‚ÄúÊâãÂä®ÊÄªÁªì‚ÄùÊåâÈíÆÂ∞±Âú®ËøôÈáå ‚Üì‚Üì‚Üì -->
    <button class="nav-btn nav-right-action-btn" onclick="openManualSummaryModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
    </button>
</div>
    <div class="wechat-content">
        <div id="memoryList" class="diary-list">
            <!-- ËÆ∞ÂøÜÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>
</div>

                    <div id="apiSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">API ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöËøûÊé•ÈÖçÁΩÆ -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">ËøûÊé•ÈÖçÁΩÆ</label>
            </div>

            <!-- È¢ÑËÆæÊåâÈíÆÁªÑ -->
            <div class="form-group-row" style="justify-content: flex-start; gap: 10px; padding-top: 0;">
                <button class="bw-chip-btn" onclick="openApiPresetSelector()">ÈÄâÊã©È¢ÑËÆæ</button>
                <button class="bw-chip-btn" onclick="saveApiPreset()">‰øùÂ≠òÂΩìÂâçÈ¢ÑËÆæ</button>
            </div>

            <div class="form-group-row">
                <label class="form-label">API Âú∞ÂùÄ</label>
                <input type="text" class="form-input" id="apiUrl" placeholder="https://...">
            </div>
            <div class="form-group-row">
                <label class="form-label">API Key</label>
                <div style="flex: 1; display: flex; align-items: center;">
                    <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                    <i class="ri-close-circle-fill" style="color: #ccc; margin-left: 8px; cursor: pointer; font-size: 18px;" onclick="document.getElementById('apiKey').value = ''"></i>
                </div>
            </div>
        </div>

        <!-- Âç°Áâá 2ÔºöÊ®°ÂûãËÆæÁΩÆ -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">Ê®°ÂûãÈÄâÊã©</label>
            </div>

            <div class="form-group-row">
                <label class="form-label">Ê®°ÂûãÂêçÁß∞</label>
                <!-- Ê®°ÂûãÈÄâÊã©ÂÆπÂô® -->
                <div class="model-select-container" style="flex: 1; position: relative;">
                    <!-- ËæìÂÖ•Ê°Ü -->
                    <input type="text" class="form-input" id="modelName" placeholder="ÁÇπÂáªÈÄâÊã©ÊàñËæìÂÖ•" readonly onclick="toggleModelDropdown()" style="padding-right: 25px;">

                    <!-- „ÄêÊñ∞Â¢û„Äë‰∏ãÊãâÁÆ≠Â§¥ÂõæÊ†á -->
                    <span class="select-arrow" onclick="toggleModelDropdown()">
                        <i class="ri-arrow-down-s-line"></i>
                    </span>

                    <!-- ‰∏ãÊãâÂàóË°® -->
                    <div class="model-dropdown bw-dropdown" id="modelDropdown">
                        <!-- JS Â°´ÂÖÖÈÄâÈ°π -->
                    </div>
                </div>
            </div>

            <!-- „Äê‰øÆÊîπ„ÄëÊãâÂèñÊåâÈíÆ -->
            <div class="form-group-row" style="padding-top: 0; border-bottom: none;">
                <button class="bw-action-btn solid-outline" onclick="fetchModels()">
                    <i class="ri-download-cloud-2-line" style="margin-right: 5px;"></i> ÊãâÂèñÊ®°ÂûãÂàóË°®
                </button>
            </div>
        </div>

                <!-- Âç°ÁâáÔºöË∞ÉËØïÂ∑•ÂÖ∑ (Êñ∞Â¢û) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">Ë∞ÉËØï‰∏éÁõëÊéß</label>
            </div>

        </div>


        <!-- Âç°Áâá 3ÔºöÂèÇÊï∞Ë∞ÉÊï¥ -->
        <div class="form-card">

            <!-- ËÆ∞ÂøÜÊù°Êï∞ (ÂûÇÁõ¥Â∏ÉÂ±ÄÔºö‰∏äÈù¢ÊòØËæìÂÖ•Ë°åÔºå‰∏ãÈù¢ÊòØÊèêÁ§∫Â≠ó) -->
            <div class="form-group-row column-layout">
                <!-- Á¨¨‰∏ÄË°åÔºöÊ†áÁ≠æÂíåËæìÂÖ•Ê°Ü -->
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <label class="form-label">ËÆ∞ÂøÜÊù°Êï∞</label>
                    <input type="number" class="form-input" id="memoryMessagesCount" placeholder="20">
                </div>
                <!-- Á¨¨‰∫åË°åÔºöËß£ÈáäÂ∞èÂ≠ó -->
                <div class="form-hint">ËÅäÂ§©Êó∂AIËØªÂèñÁöÑÊ∂àÊÅØÊù°Êï∞ÔºåÊúÄÁªàËÆ∞ÂøÜÂèñÂÜ≥‰∫éTokenÊï∞</div>
            </div>

            <!-- Ê∏©Â∫¶ËÆæÁΩÆ (ÂûÇÁõ¥Â∏ÉÂ±Ä) -->
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <label class="form-label">Ê∏©Â∫¶ (0-2)</label>
                    <input type="number" class="form-input" id="apiTemperature" placeholder="0.9" step="0.1">
                </div>
                <div class="form-hint">Ë∂ä‰ΩéË∂äÁ®≥ÂÆöÁ≤æÂáÜÔºåË∂äÈ´òË∂äÊúâÂàõÈÄ†ÊÄßÂíåÈöèÊú∫ÊÄß</div>
            </div>

             <div class="form-group-row switch-row">
                <label class="form-label">AI Êó∂Èó¥ÊÑüÁü•</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="aiTimePerceptionToggle" onchange="toggleTimePerception()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveApiSettings()">‰øùÂ≠òÂÖ®ÈÉ®ËÆæÁΩÆ</button>
        </div>
    </div>
</div>

<div id="beautificationSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÁæéÂåñËÆæÁΩÆ</div>
        <div></div>
    </div>
    <!-- Ê†∏ÂøÉÔºöÂä†‰∏ä bw-style Á±ªÔºåÂÜÖÂÆπÁî± JS Â°´ÂÖÖ -->
    <div class="settings-content bw-style" id="beautificationSettingsList">
        <!-- JS ‰ºöÂú®ËøôÈáåÁîüÊàêÊºÇ‰∫ÆÁöÑÂç°Áâá -->
    </div>
</div>

<!-- ============================================== -->
<!-- Á≤òË¥¥Âú®ËøôÈáåÔºöCharÁ©∫Èó¥È°µÈù¢ (ÂøÖÈ°ªÊîæÂú®ÊâÄÊúâÈ°µÈù¢ÂÆπÂô®ÁöÑÂ§ñÂ±Ç) -->
<!-- ============================================== -->
<div id="charSpaceScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscoverFromCharSpace()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title" id="charSpaceTitle">CharÁ©∫Èó¥</div>
        <div style="width: 40px;"></div>
    </div>
    <div class="wechat-content" style="padding-top: 74px;">
        <!-- Â§¥ÈÉ®Â∞ÅÈù¢Âå∫ -->
        <div class="moments-cover" id="charSpaceCover">
            <div class="moments-cover-user">
                <span class="moments-cover-name" id="charSpaceName">Name</span>
                <div class="moments-cover-avatar" id="charSpaceAvatar"></div>
            </div>
        </div>
        <!-- ÂàóË°®ÂÜÖÂÆπÂå∫ -->
        <div id="charSpaceList"></div>
    </div>
</div>

<!-- CharÁ©∫Èó¥ËßíËâ≤ÈÄâÊã©ÂºπÁ™ó -->
<div id="charSpaceSelectorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©Ë¶ÅÊü•ÁúãÁöÑËßíËâ≤</div>
        <div id="charSpaceSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('charSpaceSelectorModal').classList.remove('show')">ÂèñÊ∂à</button>
        </div>
    </div>
</div>


<!-- ‚Üë‚Üë‚Üë HTML‰ª£Á†ÅÂ§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë -->

            <!-- MODIFIED: Phone App Page -->
            <!-- Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÊõøÊç¢ -->
<div id="phoneApp" class="page">
    <div class="nav-bar" id="phoneAppNavBar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÊâãÊú∫</div>
        <!-- Êñ∞Â¢û‰∫Ü‰∏Ä‰∏™ÈáçÊñ∞ÁîüÊàêÊåâÈíÆÔºåÂπ∂Áªô‰∫à‰∫ÜIDÂíåÁÇπÂáª‰∫ã‰ª∂ -->
        <div>
            <button class="nav-btn" id="regenerateSimContentBtn" style="display: none;" onclick="handleSimRegenerateClick()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    <path d="M22 4v4h-4"/>
                </svg>
            </button>
        </div>
    </div>

                <div class="phone-app-container">
    <div id="phoneCharacterListScreen" class="friend-list"></div>
    <div id="simulatedPhoneScreen" style="display: none;">
        <div class="sim-phone-frame">
            <div class="sim-phone-screen">
                <div class="sim-phone-screen-content" id="sim-home-screen-content" onclick="triggerSimGlobalWallpaperUpload(event)"></div>
                <div class="sim-app-view" id="sim-wechat-view"></div>
                <div class="sim-app-view" id="sim-memo-view"></div>
                <div class="sim-app-view" id="sim-phone_call-view"></div>
                <div class="sim-app-view" id="sim-browser-view"></div>
                <div class="sim-app-view" id="sim-shopping-view"></div>
                <div class="sim-app-view" id="sim-wallet-view"></div>
                <div class="sim-app-view" id="sim-photos-view"></div>
                <div class="sim-app-view" id="sim-forum-view"></div>
                <div class="sim-app-view" id="sim-wechat-detail-view"></div>
                <div class="sim-app-view" id="sim-memo-detail-view"></div>
                <div class="sim-app-view" id="sim-browser-detail-view"></div>
                <div class="sim-app-view" id="sim-shopping-detail-view"></div>
                <div class="sim-app-view" id="sim-photos-detail-view"></div>
                <div class="sim-app-view" id="sim-forum-detail-view"></div>

                <div class="sim-app-view" id="sim-sim_music-view"></div>
                <div class="sim-app-view" id="sim-sim_settings-view"></div>

<div class="sim-app-view" id="sim-sim_recorder-view"></div>
<div class="sim-app-view" id="sim-sim_recorder-detail-view"></div>

<div class="sim-app-view" id="sim-sim_videos-view"></div>
<div class="sim-app-view" id="sim-sim_videos-detail-view"></div>


            </div>
        </div>
    </div>
</div>
            </div>

        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº ‰ªéËøôÈáåÂºÄÂßãÊòØÊñ∞Â¢ûÁöÑË¥≠Áâ©AppÈ°µÈù¢ ‚ñº‚ñº‚ñº -->
<div id="shoppingApp" class="page">
    <!-- Êàë‰ª¨Âè™‰øùÁïôË¥≠Áâ©AppÁöÑÊ†∏ÂøÉÂÜÖÂÆπ -->

    <div class="nav-bar-preview">
    <div class="nav-bar-left"><span class="nav-icon-preview nav-back-btn">‚Üê</span></div>
    <div class="nav-bar-center"><div class="nav-logo-preview">MODOU</div></div>
    <div class="nav-bar-right">
        <!-- „Äê„Äê„ÄêÊñ∞Â¢ûÁöÑÂà∑Êñ∞ÊåâÈíÆ„Äë„Äë„Äë -->
        <span id="shopping-refresh-btn" class="nav-icon-preview" onclick="refreshShoppingProducts()">
            <i class="fa-solid fa-arrows-rotate"></i>
        </span>
        <!-- „Äê„Äê„ÄêÊñ∞Â¢ûÁªìÊùü„Äë„Äë„Äë -->
        <span class="nav-icon-preview nav-more-btn">‚Ä¶</span>
    </div>
</div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="app-content-wrapper">
        <div id="home-page" class="app-page"><div class="hero-carousel"><div class="carousel-track"></div><div class="carousel-dots"></div></div><div class="home-content"><h2 class="section-title">LATEST UPDATE</h2><div class="news-feed"></div></div></div>
        <div id="shopping-page" class="app-page"><div class="category-nav"></div><div id="shopping-page-content"><div class="main-view page-view"><div class="product-shelf"></div></div><div class="private-gallery-view page-view"><div class="gallery-archive-list"></div></div></div></div>
        <div id="logistics-page" class="app-page"><div class="logistics-feed"></div></div>

        <!-- ÊàëÁöÑÈ°µÈù¢ -->
        <div id="me-page" class="app-page active">
            <div class="profile-header">
                <label for="avatar-upload-input" class="profile-avatar-wrapper">
                    <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop&q=80" id="profile-avatar-img" class="profile-avatar" alt="User Avatar">
                </label>
                <input type="file" id="avatar-upload-input" accept="image/*">
                <p class="profile-username">MODOU User</p>
            </div>
            <ul class="profile-nav-list">
                <li class="profile-nav-item" data-page="orders-page" data-title="ÂéÜÂè≤ËÆ¢Âçï">
                    <i class="profile-nav-icon fa-solid fa-receipt"></i><span class="profile-nav-text">ÂéÜÂè≤ËÆ¢Âçï</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="pending-page" data-title="ÂæÖË¥≠Ê∏ÖÂçï">
                    <i class="profile-nav-icon fa-solid fa-rectangle-list"></i><span class="profile-nav-text">ÂæÖË¥≠Ê∏ÖÂçï</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="collection-page" data-title="ÊàëÁöÑËóèÂìÅ">
                    <i class="profile-nav-icon fa-solid fa-box-archive"></i><span class="profile-nav-text">ÊàëÁöÑËóèÂìÅ</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="api-config-page" data-title="API ÈÖçÁΩÆ">
                    <i class="profile-nav-icon fa-solid fa-sliders"></i><span class="profile-nav-text">API ÈÖçÁΩÆ</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
            </ul>
        </div>

        <!-- ÊàëÁöÑÂ≠êÈ°µÈù¢ -->
        <div id="pending-page" class="app-page entering"><div class="pending-list-page"><div class="wooden-desk"><div id="pending-items-container" class="pending-items-grid"></div><button class="confirm-collection-btn" id="confirm-btn"><i class="fa-solid fa-stamp"></i> Á°ÆËÆ§Êî∂Á∫≥</button></div></div></div>
        <div id="collection-page" class="app-page entering"><div class="placeholder-page"><h2>ÊàëÁöÑËóèÂìÅ</h2><div id="collection-container" class="collection-grid"></div></div></div>
        <div id="orders-page" class="app-page entering"><div class="placeholder-page"><h2>ÂéÜÂè≤ËÆ¢Âçï</h2><p>ËøôÈáåÂ∞ÜÂ±ïÁ§∫ÊÇ®ÁöÑÊâÄÊúâÂéÜÂè≤ËÆ¢ÂçïËÆ∞ÂΩï„ÄÇ</p></div></div>
        <div id="api-config-page" class="app-page entering">
    <div class="api-config-form">
        <!-- Server Endpoint ËæìÂÖ•Ê°Ü -->
        <div class="config-section">
            <label for="api-url_shopping">Server Endpoint</label>
            <input type="text" id="api-url_shopping" placeholder="https://api.example.com/v1">
        </div>

        <!-- API Key ËæìÂÖ•Ê°Ü -->
        <div class="config-section">
            <label for="api-key_shopping">API Key</label>
            <input type="password" id="api-key_shopping" placeholder="sk-...">
        </div>

        <!-- „Äê„Äê„ÄêÊñ∞Â¢û„Äë„Äë„ÄëÈ¢ÑËÆæÊåâÈíÆ -->
        <div class="settings-buttons" style="margin-top: 10px; display: flex; gap: 15px;">
            <button class="settings-btn btn-secondary" style="flex: 1;" onclick="openApiPresetSelector_shopping()">ÈÄâÊã©È¢ÑËÆæ</button>
            <button class="settings-btn btn-primary" style="flex: 1;" onclick="saveApiPreset_shopping()">‰øùÂ≠ò‰∏∫È¢ÑËÆæ</button>
        </div>

        <!-- API Ê®°ÂûãÈÄâÊã©Âô® -->
        <div class="config-section" style="margin-top: 25px; border-top: 1px solid #444; padding-top: 25px;">
            <label>API Ê®°Âûã</label>
            <div class="model-select-container">
                <input type="text" class="model-select" id="modelName_shopping" placeholder="ÈÄâÊã©ÊàñËæìÂÖ•Ê®°ÂûãÂêçÁß∞" readonly onclick="toggleModelDropdown_shopping()">
                <span class="dropdown-arrow">‚ñº</span>
                <div class="model-dropdown" id="modelDropdown_shopping"></div>
            </div>
        </div>

        <!-- ÊãâÂèñÊ®°ÂûãÂíå‰øùÂ≠òËÆæÁΩÆÊåâÈíÆ -->
        <div class="settings-buttons" style="margin-top: 20px; display: flex; gap: 15px;">
             <button class="settings-btn btn-secondary" style="flex: 1;" onclick="fetchModels_shopping()">ÊãâÂèñÊ®°Âûã</button>
             <button class="settings-btn btn-primary" style="flex: 1;" onclick="saveApiSettings_shopping()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>
    </div>
    <!-- [Êñ∞Â¢û] Char ËØ¶ÊÉÖÈ°µ -->
    <div id="char-details-page" class="app-page entering">
        <div class="placeholder-page">
            <h2 id="char-page-title">Character's Records</h2>
            <div class="char-records-grid">
                <div class="record-card">
                    <h4>ÊµèËßàËÆ∞ÂΩï</h4>
                    <p>Êü•ÁúãËØ•ËßíËâ≤ÁöÑÊµèËßàÂéÜÂè≤</p>
                </div>
                <div class="record-card">
                    <h4>Ë¥≠‰π∞ËÆ∞ÂΩï</h4>
                    <p>Êü•ÁúãËØ•ËßíËâ≤ÁöÑË¥≠‰π∞ÂéÜÂè≤</p>
                </div>
                <div class="record-card">
                    <h4>Êî∂ËóèËÆ∞ÂΩï</h4>
                    <p>Êü•ÁúãËØ•ËßíËâ≤ÁöÑÊî∂ËóèÂàóË°®</p>
                </div>
                 <div class="record-card">
                    <h4>ÂéÜÂè≤ËÆ¢Âçï</h4>
                    <p>Êü•ÁúãËØ•ËßíËâ≤ÁöÑÊâÄÊúâËÆ¢Âçï</p>
                </div>
            </div>
        </div>
    </div>
    <!-- [Êñ∞Â¢û] ÁªìÊùü -->
    <!-- [Êñ∞Â¢û] Char ÈÄâÊã©ÊµÆÁ™ó -->
    <div class="floating-modal" id="char-modal">
        <div class="modal-content">
            <span class="close-btn" id="close-char-modal">&times;</span>
            <h3>Select a Character</h3>
            <ul class="char-list" id="char-list-container">
                <!-- JS ‰ºöÂú®ËøôÈáåÂ°´ÂÖÖËßíËâ≤ÂàóË°® -->
            </ul>
        </div>
    </div>
    <!-- [Êñ∞Â¢û] ÁªìÊùü -->
    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="bottom-tab-bar">
        <div class="tab-item" data-page="home-page"><i class="tab-icon fa-solid fa-house"></i><span>È¶ñÈ°µ</span></div>
        <div class="tab-item" data-page="shopping-page"><i class="tab-icon fa-solid fa-bag-shopping"></i><span>Ë¥≠Áâ©</span></div>
        <div class="tab-item" data-page="logistics-page"><i class="tab-icon fa-solid fa-truck-fast"></i><span>Áâ©ÊµÅ</span></div>
        <div class="tab-item active" data-page="me-page"><i class="tab-icon fa-solid fa-circle-user"></i><span>ÊàëÁöÑ</span></div>
    </div>

<!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™ÂÖ®Êñ∞ÁöÑÈ°µÈù¢‰ª£Á†ÅÂùóÁ≤òË¥¥Âà∞Ë¥≠Áâ©AppÁöÑÂÖ∂‰ªñÈ°µÈù¢ÊóÅËæπ ‚ñº‚ñº‚ñº -->
<div id="char-records-detail-page" class="app-page entering">
    <!-- È°µÈù¢ÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÂà∞Ê≠§ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº ‰ªéËøôÈáåÂºÄÂßãÊòØÊñ∞Â¢ûÁöÑ‚ÄúÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶‚ÄùÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div class="letter-modal" id="addToCartModal">
    <div class="letter-content">
        <div class="letter-header">
            <!-- Ê†áÈ¢òÊîπ‰∏∫‰∫Ü‚ÄúÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶‚Äù -->
            <h3 class="letter-title">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</h3>
        </div>
        <!-- Ëøô‰∏™divÁî®Êù•ÊòæÁ§∫ÂïÜÂìÅ‰ø°ÊÅØ -->
        <div class="letter-product-preview" id="cart-product-preview"></div>

        <!-- ËøôÈáåÁßªÈô§‰∫ÜÂØÜ‰ø°ÁöÑËæìÂÖ•Ê°Ü -->

        <div class="letter-actions">
            <!-- ÊåâÈíÆÂäüËÉΩÂíåÊñáÂ≠óÈÉΩÂ∑≤‰øÆÊîπ -->
            <button class="letter-btn letter-cancel-btn" onclick="closeAddToCartModal()">ÂèñÊ∂à</button>
            <button class="letter-btn letter-send-btn" onclick="confirmAddToCart()">
                <i class="fa-solid fa-cart-plus"></i> Á°ÆËÆ§Âä†ÂÖ•
            </button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÂà∞Ê≠§ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ÂØÜ‰ø°ÂºπÁ™ó -->
    <div class="letter-modal" id="letter-modal"><div class="letter-content"><div class="letter-header"><h3 class="letter-title">‰º†ÈÄíÂØÜ‰ø°</h3></div><div class="letter-product-preview" id="letter-product"></div><textarea class="letter-message" id="letter-message" placeholder="ËßÅÊ≠§ÁèçÂìÅÔºå‰∏çÂøçÈîôËøáÔºåÊúõÂêõÊàêÂÖ®„ÄÇ"></textarea><input type="text" class="letter-recipient" id="letter-recipient" placeholder="Êî∂‰ø°‰∫∫"><div class="letter-actions"><button class="letter-btn letter-cancel-btn" id="letter-cancel">ÂèñÊ∂à</button><button class="letter-btn letter-send-btn" id="letter-send"><i class="fa-solid fa-paper-plane"></i> ÂØÑÂá∫</button></div></div></div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁöÑË¥≠Áâ©AppÈ°µÈù¢Âà∞Ê≠§ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº Âêå‰∫∫ËÆ∫ÂùõApp - ÂÆåÊï¥HTMLÁªìÊûÑ ‚ñº‚ñº‚ñº -->
<div id="doujinForumApp" class="page">

    <!-- È°∂ÈÉ®ÂØºËà™ÂÆπÂô® -->
    <div class="top-header">
        <div class="header-top">
            <div class="logo"><i class="fas fa-feather-alt"></i> Âêå‰∫∫ËÆ∫Âùõ</div>
            <div class="header-actions">
                <button class="search-btn" onclick="doujinOpenCharSelectModal()"><i class="fas fa-search"></i></button>
                <button class="refresh-btn" onclick="doujinRefreshContent()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
        <div class="top-nav">
            <div class="top-nav-content">
                <a class="tag-item active" data-category="Êé®Ëçê">Êé®Ëçê</a>
                <a class="tag-item" data-category="Á£ïCP">Á£ïCP</a>
                <a class="tag-item" data-category="ÈÉΩÂ∏Ç">ÈÉΩÂ∏Ç</a>
                <a class="tag-item" data-category="Ê†°Âõ≠">Ê†°Âõ≠</a>
                <a class="tag-item" data-category="Êú´‰∏ñ">Êú´‰∏ñ</a>
                <a class="tag-item" data-category="ABO">ABO</a>
                <a class="tag-item" data-category="Âπ¥‰ª£">Âπ¥‰ª£</a>
                <a class="tag-item" data-category="Êó†ÈôêÊµÅ">Êó†ÈôêÊµÅ</a>
                <a class="tag-item" data-category="R18">R18</a>
                <button class="add-tag-btn" onclick="doujinShowAddTagModal()"><i class="fas fa-bars"></i><span>ÁÆ°ÁêÜ</span></button>
            </div>
        </div>
    </div>

    <!-- È¶ñÈ°µÂÜÖÂÆπÂå∫Âüü -->
    <div class="page-container active" id="home-page" style="padding-top: 105px; padding-bottom: 70px;">
       <div class="content" id="doujin-timelines-wrapper">
            <div class="post-card" data-category="ÈÉΩÂ∏Ç" data-characters="ËßíËâ≤A,ËßíËâ≤C" data-fulltext="Â§úÂπïÈôç‰∏¥ÔºåÁπÅÊòüÁÇπÁÇπ„ÄÇ‰ªñÁ´ôÂú®Â§©Âè∞‰∏äÔºåÁ≠âÂæÖÁùÄÈÇ£‰∏™Á∫¶ÂÆöÁöÑË∫´ÂΩ±„ÄÇÂüéÂ∏ÇÁöÑÈúìËôπÂú®ËÑö‰∏ãÊµÅÊ∑åÔºåËÄå‰ªñÁöÑÂøÉÂç¥Âè™‰∏∫‰∏Ä‰∫∫Ë∑≥Âä®... ËøôÊòØÊñáÁ´†ÁöÑÂÆåÊï¥ÂÜÖÂÆπÈÉ®ÂàÜÔºåÊØîÊëòË¶ÅÊõ¥ÈïøÔºåÂèØ‰ª•ÂåÖÂê´ÂæàÂ§öÁªÜËäÇ„ÄÇ">
                <div class="post-header">
                    <div class="avatar">Ê¢¶</div>
                    <div class="user-info">
                        <div class="username">Ê¢¶ÂπªÂÜôÊâã</div>
                        <div class="post-time"><i class="far fa-clock"></i> <span>2Â∞èÊó∂Ââç</span></div>
                    </div>
                    <div class="more-btn"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="post-content">
                    <div class="post-title">„ÄêÂéüÂàõ„ÄëÊòüÊ≤≥‰πãÁ∫¶ Á¨¨‰∏ÄÁ´†</div>
                    <div class="post-text">Â§úÂπïÈôç‰∏¥ÔºåÁπÅÊòüÁÇπÁÇπ„ÄÇ‰ªñÁ´ôÂú®Â§©Âè∞‰∏äÔºåÁ≠âÂæÖÁùÄÈÇ£‰∏™Á∫¶ÂÆöÁöÑË∫´ÂΩ±„ÄÇÂüéÂ∏ÇÁöÑÈúìËôπÂú®ËÑö‰∏ãÊµÅÊ∑å...</div>
                    <div class="post-tags"><span class="tag">#ÂéüÂàõ</span><span class="tag">#ÈÉΩÂ∏Ç</span><span class="tag">#ÁîúÊñá</span></div>
                </div>
                <div class="post-actions">
                    <div class="action-btn"><i class="far fa-heart"></i> <span>328</span></div>
                    <div class="action-btn"><i class="far fa-comment"></i> <span>56</span></div>
                    <div class="action-btn"><i class="far fa-star"></i> <span>128</span></div>
                </div>
            </div>
            <div class="post-card" data-category="Ê†°Âõ≠" data-characters="ËßíËâ≤B" data-fulltext="AlphaÁöÑ‰ø°ÊÅØÁ¥†Âú®Á©∫Ê∞î‰∏≠Âº•Êº´ÔºåOmegaÂ∞ëÂπ¥ÁöÑË∫´‰Ωì‰∏çÁî±Ëá™‰∏ªÂú∞È¢§Êäñ„ÄÇËøôÊòØÂëΩËøêÁöÑÂÆâÊéíÔºåËøòÊòØÁà±ÊÉÖÁöÑÂè¨Âî§... ÂÆåÊï¥ÂÜÖÂÆπÂú®ËøôÈáåÂ±ïÁ§∫ÔºåËøôÊòØ‰∏Ä‰∏™ABOÊ†°Âõ≠È¢òÊùêÁöÑÊïÖ‰∫ãÔºåËÆ≤Ëø∞‰∫ÜÂëΩ‰∏≠Ê≥®ÂÆöÁöÑÁõ∏ÈÅá„ÄÇ">
                <div class="post-header">
                    <div class="avatar" style="background: linear-gradient(135deg, #8ba89d 0%, #a3bfb3 100%);">‰∫å</div>
                    <div class="user-info">
                        <div class="username">‰∫åÊ¨°ÂÖÉÁà±Â•ΩËÄÖ</div>
                        <div class="post-time"><i class="far fa-clock"></i> <span>5Â∞èÊó∂Ââç</span></div>
                    </div>
                    <div class="more-btn"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="post-content">
                    <div class="post-title">„ÄêABO„ÄëÊ≥®ÂÆöÁöÑÂëΩËøê</div>
                    <div class="post-text">AlphaÁöÑ‰ø°ÊÅØÁ¥†Âú®Á©∫Ê∞î‰∏≠Âº•Êº´ÔºåOmegaÂ∞ëÂπ¥ÁöÑË∫´‰Ωì‰∏çÁî±Ëá™‰∏ªÂú∞È¢§Êäñ„ÄÇËøôÊòØÂëΩËøêÁöÑÂÆâÊéí...</div>
                    <div class="post-tags"><span class="tag">#ABO</span><span class="tag">#Ê†°Âõ≠</span><span class="tag">#HE</span></div>
                </div>
                <div class="post-actions">
                    <div class="action-btn active"><i class="fas fa-heart"></i> <span>562</span></div>
                    <div class="action-btn"><i class="far fa-comment"></i> <span>89</span></div>
                    <div class="action-btn"><i class="far fa-star"></i> <span>245</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊàëÁöÑÈ°µÈù¢ÂÆπÂô® -->
    <div class="page-container" id="my-page" style="padding-top: 30px; padding-bottom: 70px;">
        <div class="content">
            <div class="profile-header">
                <label for="avatar-upload" class="profile-avatar-wrapper">
                    <div class="profile-avatar"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iI2VlZSIvPjxwYXRoIGQ9Ik01MCAxNUMzMy40MyAxNSA1MCAzMy40MyA1MCA1MFM2Ni41NyA4NSA1MCA4NVMzMy40MyA2Ni41NyA1MCA1MFoiIGZpbGw9IiNhYWEiLz48cGF0aCBkPSJNNTAgNTBDNTggMzUgODAgMzAgODUgNTBDODAgNzAgNjAgNzUgNTAgNTBaIiBmaWxsPSIjYWFhIi8+PC9zdmc+" alt="Avatar" id="avatar-preview"></div>
                    <div class="profile-avatar-upload-icon"><i class="fas fa-camera"></i></div>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                </label>
                <div class="profile-info">
                    <div class="profile-nickname" id="doujin-profile-nickname-display">‰Ω†ÁöÑÊòµÁß∞</div>
        <!-- ‰øÆÊîπ -->
        <div class="profile-id" id="doujin-profile-id">ID: 12345678</div>
    </div>
    <button class="profile-edit-btn" onclick="doujinShowEditProfileModal()">ÁºñËæëËµÑÊñô</button>
</div>
<div class="profile-stats">
    <div class="stat-item">
        <!-- ‰øÆÊîπ -->
        <div class="stat-value" id="doujin-heat-value">1.2M</div>
        <div class="stat-label">ÁÉ≠Â∫¶</div>
    </div>
    <div class="stat-item">
        <!-- ‰øÆÊîπ -->
        <div class="stat-value" id="doujin-fans-value">35.6k</div>
        <div class="stat-label">Á≤â‰∏ù</div>
    </div>
    <div class="stat-item">
        <!-- ‰øÆÊîπ -->
        <div class="stat-value" id="doujin-following-value">128</div>
        <div class="stat-label">ÂÖ≥Ê≥®</div>
    </div>
</div>
            <div class="profile-nav-cards">
                <div class="nav-card" onclick="doujinNavigateToPage('my-posts-page'); renderMyPostsPage();">
                    <div class="nav-card-icon posts"><i class="fas fa-book-open"></i></div>
                    <div class="nav-card-info">
                        <span class="nav-card-title">ÊàëÂèëÂ∏ÉÁöÑ</span>
                        <span class="nav-card-meta">Êü•ÁúãÊÇ®Âàõ‰ΩúÁöÑÊâÄÊúâ‰ΩúÂìÅ</span>
                    </div>
                    <i class="fas fa-chevron-right nav-card-arrow"></i>
                </div>
                <div class="nav-card" onclick="doujinNavigateToPage('cp-list-page')">
                    <div class="nav-card-icon cp"><i class="fas fa-heart"></i></div>
                    <div class="nav-card-info">
                        <span class="nav-card-title">Á£ïCPÈÄâÊã©</span>
                        <span class="nav-card-meta">ÁÆ°ÁêÜÊÇ®ÂÖ≥Ê≥®ÁöÑCP</span>
                    </div>
                    <i class="fas fa-chevron-right nav-card-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- "ÊàëÂèëÂ∏ÉÁöÑ" Â≠êÈ°µÈù¢ -->
    <div class="page-container" id="my-posts-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>ÊàëÂèëÂ∏ÉÁöÑ</h2>
        </div>
        <div class="content" id="my-posts-list"></div>
    </div>

    <!-- CPÈÄâÊã©Â≠êÈ°µÈù¢ -->
<div class="page-container" id="cp-list-page">
    <div class="subpage-header">
        <!-- Â∑¶‰æßÔºöËøîÂõûÊåâÈíÆ -->
        <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>

        <!-- ‰∏≠Èó¥ÔºöÊ†áÈ¢ò -->
        <h2>Á£ïCPÈÄâÊã©</h2>

        <!-- Âè≥‰æßÔºöÊåâÈíÆÁªÑ (Âä†Âè∑Âú®ÂâçÔºåËÆæÂÆöÂú®Âêé) -->
        <div style="display: flex; align-items: center; gap: 15px; z-index: 10;">
            <!-- Âä†Âè∑ÊåâÈíÆ -->
            <button class="nav-btn" onclick="doujinOpenCpCreatePage()" style="background:none; border:none; font-size: 18px; color: #555;">
                <i class="fas fa-plus"></i>
            </button>
            <!-- ËÆæÂÆö/ÈÄâÊã©ÊåâÈíÆ -->
            <button class="nav-btn" onclick="doujinOpenCpRunModal()" title="CPËÆæÂÆö" style="background:none; border:none; font-size: 18px; color: #555;">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
    <div class="content" id="cp-cards-container"></div>
</div>

    <!-- CPÂàõÂª∫/ÁºñËæëÈ°µÈù¢ -->
<div class="page-container" id="cp-edit-page">
    <div class="subpage-header with-back-btn">
        <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
        <h2 id="cp-edit-page-title">ÂàõÂª∫Êñ∞CP</h2>
    </div>
    <div class="content">
        <input type="hidden" id="editing-cp-id">

        <!-- Â∑¶‰Ωç (ÂéüËßíËâ≤) -->
        <div class="character-editor">
            <h3>Â∑¶‰Ωç (Êîª/Áî∑‰∏ª/Â•≥Êîª)</h3>
            <label for="char-avatar-upload" class="char-avatar-wrapper">
                <img src="..." id="char-avatar-preview" class="char-avatar-preview">
                <div class="char-avatar-upload-icon"><i class="fas fa-camera"></i></div>
            </label>
            <input type="file" id="char-avatar-upload" class="char-avatar-upload-input" accept="image/*">
            <!-- Á¨¨‰∏Ä‰∏™Ê°ÜÔºöÊòµÁß∞ -->
            <!-- ‚ñº‚ñº‚ñº ËØ∑ÊèíÂÖ•ËøôÊÆµÊñ∞‰ª£Á†Å (Â∑¶‰ΩçÊÄßÂà´) ‚ñº‚ñº‚ñº -->
<select id="char-gender-select" class="char-input" style="appearance: auto; -webkit-appearance: auto; background: #f9f9f9;">
    <option value="">ËØ∑ÈÄâÊã©ÊÄßÂà´ (ÂøÖÈÄâ)</option>
    <option value="[ÊÄßÂà´:Áî∑] ">Áî∑Áîü</option>
    <option value="[ÊÄßÂà´:Â•≥] ">Â•≥Áîü</option>
</select>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊèíÂÖ•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <input type="text" id="char-name" class="char-input" placeholder="Â∑¶‰ΩçÊòµÁß∞ (‰æãÂ¶ÇÔºöÈ°æÈ≠è)">
            <!-- Á¨¨‰∫å‰∏™Ê°ÜÔºö‰∫∫ËÆæÂíåËÉåÊôØ -->
            <textarea id="char-bio" class="char-textarea" placeholder="Â∑¶‰Ωç‰∫∫ËÆæ„ÄÅËÉåÊôØËÆæÂÆö..." style="height: 120px;"></textarea>
        </div>

        <!-- ÂàÜÂâ≤ÂõæÊ†á -->
        <div class="cp-vs-icon"><i class="fas fa-times"></i></div>

        <!-- Âè≥‰Ωç (ÂéüÁî®Êà∑) -->
        <div class="character-editor">
            <h3>Âè≥‰Ωç (Âèó/Â•≥‰∏ª/Áî∑Âèó)</h3>
            <label for="user-avatar-upload" class="char-avatar-wrapper">
                <img src="..." id="user-avatar-preview" class="char-avatar-preview">
                <div class="char-avatar-upload-icon"><i class="fas fa-camera"></i></div>
            </label>
            <input type="file" id="user-avatar-upload" class="char-avatar-upload-input" accept="image/*">
            <!-- Á¨¨‰∏Ä‰∏™Ê°ÜÔºöÊòµÁß∞ -->
            <!-- ‚ñº‚ñº‚ñº ËØ∑ÊèíÂÖ•ËøôÊÆµÊñ∞‰ª£Á†Å (Âè≥‰ΩçÊÄßÂà´) ‚ñº‚ñº‚ñº -->
<select id="user-gender-select" class="char-input" style="appearance: auto; -webkit-appearance: auto; background: #f9f9f9;">
    <option value="">ËØ∑ÈÄâÊã©ÊÄßÂà´ (ÂøÖÈÄâ)</option>
    <option value="[ÊÄßÂà´:Áî∑] ">Áî∑Áîü</option>
    <option value="[ÊÄßÂà´:Â•≥] ">Â•≥Áîü</option>
</select>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊèíÂÖ•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

            <input type="text" id="user-name" class="char-input" placeholder="Âè≥‰ΩçÊòµÁß∞ (‰æãÂ¶ÇÔºöÊûó‰πãÊ†°)">
            <!-- Á¨¨‰∫å‰∏™Ê°ÜÔºö‰∫∫ËÆæÂíåËÉåÊôØ -->
            <textarea id="user-bio" class="char-textarea" placeholder="Âè≥‰Ωç‰∫∫ËÆæ„ÄÅËÉåÊôØËÆæÂÆö..." style="height: 120px;"></textarea>
        </div>
    </div>
    <div class="publish-footer">
        <button class="publish-submit-btn" onclick="doujinSaveCpData()">‰øù Â≠ò</button>
    </div>
</div>

    <!-- Â∏ñÂ≠êËØ¶ÊÉÖ Â≠êÈ°µÈù¢ -->
    <div class="page-container" id="post-detail-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>Â∏ñÂ≠êËØ¶ÊÉÖ</h2>
        </div>
        <div class="content" style="padding-bottom: 80px;">
            <div id="detail-post-header-container"></div>
            <h1 class="detail-post-title" id="detail-post-title"></h1>
            <div class="detail-post-full-text" id="detail-post-full-text"></div>
            <div class="detail-post-tags post-tags" id="detail-post-tags"></div>
            <div class="comments-section">
                <h3>ËØÑËÆ∫</h3>
                <div class="comments-list" id="comments-list"></div>
            </div>
        </div>
        <div class="comment-form hidden">
            <input type="text" id="comment-input" class="comment-input" placeholder="Áïô‰∏ã‰Ω†ÁöÑËØÑËÆ∫Âêß...">
            <button class="comment-submit-btn" onclick="doujinSubmitComment('post-detail-page')">ÂèëÈÄÅ</button>
        </div>
    </div>

<!-- ‰π¶Êû∂È°µÈù¢ -->
<div class="page-container" id="bookshelf-page" style="padding-bottom: 70px;">
    <div class="subpage-header">
        <!-- Â∑¶‰æßÂç†‰ΩçÔºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠ -->
        <div style="width: 40px;"></div>
        <h2>ÊàëÁöÑ‰π¶Êû∂</h2>
        <!-- „Äê‰øÆÊîπ„ÄëÁÆ°ÁêÜÊåâÈíÆÊîπ‰∏∫ÂõæÊ†áÊ†∑Âºè -->
        <button class="nav-btn" id="doujinBookshelfManageBtn" onclick="doujinToggleBookshelfManageMode()" style="font-size: 20px; color: #333;">
            <i class="ri-list-check-2"></i>
        </button>
    </div>

    <div class="bookshelf-grid" id="bookshelf-grid">
        <!-- ‰π¶Á±çÂàóË°®Â∞ÜÁî±JSÊ∏≤Êüì -->
    </div>

    <!-- „ÄêÈáçÊûÑ„ÄëÁæéÂåñÂêéÁöÑÂ∫ïÈÉ®ÊâπÈáèÊìç‰ΩúÊ†è -->
    <div id="doujinBookshelfBatchBar" class="doujin-batch-bar">
        <!-- Â∑¶‰æßÔºöÂÖ®ÈÄâ -->
        <div class="batch-action-item" onclick="doujinToggleSelectAll()">
            <i class="ri-checkbox-circle-line" id="doujinSelectAllIcon"></i>
            <span>ÂÖ®ÈÄâ</span>
        </div>

        <!-- ‰∏≠Èó¥ÔºöÊï∞ÈáèÊèêÁ§∫ -->
        <div class="batch-info">
            Â∑≤ÈÄâ <span id="doujinBookSelectCount" style="color: #7d9d8f; font-weight: bold;">0</span> Êú¨
        </div>

        <!-- Âè≥‰æßÔºöÂà†Èô§ -->
        <div class="batch-action-item delete" onclick="doujinDeleteSelectedBooks()">
            <i class="ri-delete-bin-line"></i>
            <span>Âà†Èô§</span>
        </div>
    </div>
</div>

    <!-- Â∞èËØ¥ËØ¶ÊÉÖ/ÁõÆÂΩïÈ°µ -->
    <div class="page-container" id="novel-detail-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>‰π¶Á±çËØ¶ÊÉÖ</h2>
        </div>
        <div class="content">
            <div class="novel-detail-header">
                <div class="novel-detail-cover"><img id="novel-detail-cover" src=""></div>
                <div class="novel-detail-info">
                    <h1 id="novel-detail-title"></h1>
                    <p class="novel-detail-meta" id="novel-detail-author"></p>
                    <span class="novel-detail-status" id="novel-detail-status"></span>
                </div>
            </div>
            <div class="chapters-list" id="chapters-list"></div>
        </div>
    </div>

    <!-- Á´†ËäÇÈòÖËØªÈ°µ -->
    <div class="page-container" id="chapter-reading-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2 id="chapter-title-header"></h2>
        </div>
        <div class="content" style="padding-bottom: 80px;">
            <div class="chapter-body-content"><p id="chapter-body-text"></p></div>
            <div class="comments-section">
                <h3>Êú¨Á´†ËØÑËÆ∫</h3>
                <div class="comments-list" id="chapter-comments-list"></div>
            </div>
        </div>
        <div class="comment-form hidden">
            <input type="text" id="chapter-comment-input" class="comment-input" placeholder="ÂèëË°®‰Ω†ÁöÑËØÑËÆ∫...">
            <button class="comment-submit-btn" onclick="doujinSubmitComment('chapter-reading-page')">ÂèëÈÄÅ</button>
        </div>
    </div>

    <!-- ÂèëÂ∏ÉÈ°µÈù¢ -->
    <div class="page-container" id="publish-page">
        <div class="publish-header">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>ÂàõÂª∫Êñ∞‰ΩúÂìÅ</h2>
            <button class="publish-draft-btn" onclick="alert('ËçâÁ®øÂ∑≤‰øùÂ≠ò')">Â≠òËçâÁ®ø</button>
        </div>
      <div class="publish-main">
    <input type="text" id="publish-title" class="publish-title-input" placeholder="ËØ∑ËæìÂÖ•Ê†áÈ¢ò...">

    <!-- Ê≠£ÊñáËæìÂÖ•Ê°Ü -->
    <textarea id="publish-content" class="publish-content-textarea" placeholder="Â∞ΩÊÉÖÊå•Ê¥í‰Ω†ÁöÑÂàõÊÑèÂêß..." style="height: 30vh;"></textarea>

    <!-- „ÄêÊñ∞Â¢û„Äë‰ΩúËÄÖÊúâËØùËØ¥ËæìÂÖ•Âå∫Âüü -->
    <div style="margin-top: 10px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px dashed #e0e0e0;">
        <div style="font-size: 13px; color: #7d9d8f; font-weight: 600; margin-bottom: 8px;">
            <i class="fas fa-comment-alt"></i> ‰ΩúËÄÖÊúâËØùËØ¥
        </div>
        <textarea id="publish-author-words"
                  style="width: 100%; border: none; background: transparent; outline: none; font-size: 14px; resize: none; height: 60px;"
                  placeholder="ÂíåËØªËÄÖËÅä‰∏§Âè•ÔºåÊàñËÄÖÈ¢ÑÂëä‰∏Ä‰∏ãÂâßÊÉÖ..."></textarea>
    </div>

    <div class="word-count" id="word-count">0 Â≠ó</div>
</div>
        <div class="publish-options">
            <div class="publish-tags-section">
                <label class="publish-option-item-label" style="margin-bottom: 15px; display: block;">Ê∑ªÂä†Ê†áÁ≠æ</label>
                <div class="publish-tags-container" id="publish-tags-container"></div>
                <div class="publish-tag-input-wrapper">
                    <input type="text" id="publish-tag-input-field" placeholder="ËæìÂÖ•ÂêéÊåâEnterÊ∑ªÂä†Ê†áÁ≠æ">
                </div>
            </div>
            <!-- ‰øÆÊîπÔºöÁªôËøô‰∏ÄË°åÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ -->
<div class="publish-option-item" onclick="doujinOpenCategorySelectModal()">
    <span class="publish-option-item-label">ÊñáÁ´†ÂàÜÁ±ª</span>
    <div>
        <!-- ‰øÆÊîπÔºöÁªôËøô‰∏™ span Ê∑ªÂä† ID -->
        <span class="publish-option-item-value" id="selected-publish-category">Êú™ÈÄâÊã©</span>
        <i class="fas fa-chevron-right publish-option-item-arrow"></i>
    </div>
</div>
        </div>
        <div class="publish-footer">
            <button class="publish-submit-btn" onclick="doujinSubmitPost()">Âèë Â∏É</button>
        </div>
    </div>

    <!-- ÊéíË°åÈ°µÈù¢ÂÆπÂô® -->
    <div class="page-container" id="ranking-page" style="padding-bottom: 70px;">
        <div class="subpage-header">
            <h2 style="flex-grow: 1; text-align: center;">ÊéíË°åÊ¶ú</h2>
            <button class="ranking-refresh-btn" onclick="doujinRefreshRankings()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="ranking-tabs">
            <div class="ranking-tab-item active" data-tab="heat">ÁÉ≠Â∫¶Ê¶ú</div>
            <div class="ranking-tab-item" data-tab="new">Êñ∞‰ΩúÊ¶ú</div>
            <div class="ranking-tab-item" data-tab="collection">Êî∂ËóèÊ¶ú</div>
        </div>
        <div class="ranking-content">
            <div class="ranking-panel active" id="heat-panel">
                <div class="ranking-list">
                    <div class="ranking-item">
                        <div class="rank-number rank-1">1</div>
                        <div class="ranking-item-info">
                            <div class="ranking-item-title">„ÄêABO„ÄëÊ≥®ÂÆöÁöÑÂëΩËøê</div>
                            <div class="ranking-item-meta"><span>‰ΩúËÄÖ: ‰∫åÊ¨°ÂÖÉÁà±Â•ΩËÄÖ</span><span>ÁÉ≠Â∫¶: 1.5M</span></div>
                            <div class="ranking-item-tags"><span class="tag">#ABO</span><span class="tag">#Ê†°Âõ≠</span></div>
                        </div>
                    </div>
                    <div class="ranking-item">
                        <div class="rank-number rank-2">2</div>
                        <div class="ranking-item-info">
                            <div class="ranking-item-title">„ÄêÂπ¥‰ª£Êñá„Äë‰∏ÉÂçÅÂπ¥‰ª£ÁöÑÈÇ£‰∫õ‰∫ã</div>
                            <div class="ranking-item-meta"><span>‰ΩúËÄÖ: Êó∂ÂÖâÂÜôÊâã</span><span>ÁÉ≠Â∫¶: 1.2M</span></div>
                            <div class="ranking-item-tags"><span class="tag">#Âπ¥‰ª£</span><span class="tag">#Áü•Èùí</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ranking-panel" id="new-panel"><div class="ranking-list"></div></div>
            <div class="ranking-panel" id="collection-panel"><div class="ranking-list"></div></div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="bottom-nav">
        <a class="nav-item active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">È¶ñÈ°µ</div></a>
        <a class="nav-item" data-page="bookshelf-page"><div class="nav-icon"><i class="fas fa-book-open"></i></div><div class="nav-label">‰π¶Êû∂</div></a>
        <a class="nav-item publish"><div class="nav-icon"><i class="fas fa-plus"></i></div><div class="nav-label">ÂèëÂ∏É</div></a>
        <a class="nav-item" data-page="ranking-page"><div class="nav-icon"><i class="fas fa-trophy"></i></div><div class="nav-label">ÊéíË°å</div></a>
        <a class="nav-item" data-page="my-page"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">ÊàëÁöÑ</div></a>
    </div>

    <!-- ÂºπÁ™óÂÆπÂô® -->
    <div class="modal" id="addTagModal">
        <div class="modal-content">
            <div class="modal-title">Ê∑ªÂä†Ëá™ÂÆö‰πâÊ†áÁ≠æ</div>
            <input type="text" class="modal-input" id="tagInput">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="doujinHideAddTagModal()">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="doujinAddCustomTag()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    <!-- ‰øÆÊîπÂêéÔºöÁºñËæëËµÑÊñôÂºπÁ™ó -->
<div class="modal" id="editProfileModal">
    <div class="modal-content">
        <div class="modal-title">ÁºñËæë‰∏™‰∫∫ËµÑÊñô</div>
        <input type="text" class="modal-input" id="doujin-edit-nickname" placeholder="ÊòµÁß∞">
        <input type="text" class="modal-input" id="doujin-edit-id" placeholder="ID">
        <input type="text" class="modal-input" id="doujin-edit-heat" placeholder="ÁÉ≠Â∫¶ÂÄº">
        <input type="text" class="modal-input" id="doujin-edit-fans" placeholder="Á≤â‰∏ùÊï∞">
        <input type="text" class="modal-input" id="doujin-edit-following" placeholder="ÂÖ≥Ê≥®Êï∞">
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinHideEditProfileModal()">ÂèñÊ∂à</button>
            <button class="modal-btn confirm" onclick="doujinSaveProfile()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
    <div class="modal" id="editStatModal">
        <div class="modal-content">
            <div class="modal-title" id="editStatModalTitle">‰øÆÊîπÊï∞ÂÄº</div>
            <input type="text" class="modal-input" id="statInput">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="doujinHideEditStatModal()">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" onclick="doujinSaveStat()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    <div class="modal" id="charSelectModal">
        <div class="modal-content">
            <div class="modal-title">ÊåâËßíËâ≤Á≠õÈÄâ</div>
            <!-- Êñ∞Â¢ûÔºöÁØáÊï∞ËÆæÁΩÆÊªëÂùó -->
<div class="doujin-modal-setting-group">
    <label for="fic-count-slider">ÁîüÊàêÁØáÊï∞: <span id="fic-count-value">3</span></label>
    <input type="range" id="fic-count-slider" min="1" max="10" value="3" class="doujin-slider">
</div>

<!-- Êñ∞Â¢ûÔºöÂêå‰∫∫Ê¢óÈÄâÊã©Âå∫Âüü -->
<div class="doujin-modal-setting-group">
    <label>
        ÈÄâÊã©Âêå‰∫∫Ê¢ó
        <i class="fas fa-pencil-alt" id="edit-trope-toggle-btn" style="cursor:pointer; color:#999; font-size:14px; margin-left:8px;" onclick="doujinToggleTropeEditMode(this)" title="ÁÇπÂáªÂàáÊç¢ÁºñËæëÊ®°Âºè"></i>
    </label>
    <div class="trope-selection-area" id="trope-selection-area">
        <!-- ‚ÄúÊó†‚ÄùÂíå‚Äú+‚ÄùÊåâÈíÆÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
    </div>
</div>
            <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöÊñáÈ£éÈÄâÊã©Âå∫Âüü ‚ñº‚ñº‚ñº -->
<div class="doujin-modal-setting-group">
    <label>ÈÄâÊã©ÊñáÈ£é</label>
    <div class="trope-selection-area" id="doujin-style-select-container">
        <!-- JS Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊñáÈ£éÊ†áÁ≠æ -->
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div class="char-select-container" id="char-select-container"></div>
            <div class="modal-buttons" style="margin-top: 25px;">
                <button class="modal-btn cancel" onclick="doujinResetCharFilter()">ÈáçÁΩÆ</button>
                <button class="modal-btn confirm" onclick="doujinApplyCharacterFilter()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Âêå‰∫∫ËÆ∫ÂùõApp - ÂÆåÊï¥HTMLÁªìÊûÑÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <div id="addGroupChatModal" class="modal"><div class="modal-content"><div class="modal-title">ÈÄâÊã©ËÅîÁ≥ª‰∫∫</div><div id="groupChatFriendList" class="multi-select-list" style="max-height: 300px;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeGroupChatModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="createGroupChat()">Á°ÆÂÆö</button></div></div></div>
    <div id="addFriendModal" class="modal"><div class="modal-content"><div class="modal-title">Ê∑ªÂä†Â•ΩÂèã</div><div class="avatar-upload" id="friendAvatarUpload"><input type="file" accept="image/*"

onchange="handleFriendAvatarUpload(event)"><span id="friendAvatarPreview">+</span></div><input type="text" class="modal-input" id="friendNameInput" placeholder="Â•ΩÂèãÊòµÁß∞ÔºàÂøÖÂ°´Ôºâ"><input type="text" class="modal-input" id="friendRemarkInput" placeholder="Â§áÊ≥®ÂêçÁß∞ÔºàÂèØÈÄâÔºâ"><textarea class="modal-textarea" id="friendRoleInput" placeholder="ËßíËâ≤ËÆæÂÆöÔºàÂèØÈÄâÔºâ...&#10;‰æãÂ¶ÇÔºö‰Ω†ÊòØ‰∏Ä‰∏™ÂèØÁà±ÁöÑÁå´Â®òÔºåÊÄßÊ†ºÊ¥ªÊ≥ºÂºÄÊúóÔºåÂñúÊ¨¢Áî®'Âñµ'ÁªìÂ∞æËØ¥ËØù..."></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddFriendModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="addNewFriend()">Ê∑ªÂä†</button></div></div></div>
<!-- ‚ñº‚ñº‚ñº ËØ∑ÊèíÂÖ•ËøôÊÆµÊñ∞‰ª£Á†Å (Ê∑ªÂä†Êó∂ÁöÑÊÄßÂà´ÈÄâÊã©) ‚ñº‚ñº‚ñº -->
<select id="newFriendGenderInput" class="modal-input" style="appearance: auto; -webkit-appearance: auto; color: #333; margin-bottom: 10px;">
    <option value="">ËØ∑ÈÄâÊã©TAÁöÑÊÄßÂà´ (AIÂèÇËÄÉÁî®)</option>
    <option value="[ÊÄßÂà´:Áî∑] ">Áî∑Áîü</option>
    <option value="[ÊÄßÂà´:Â•≥] ">Â•≥Áîü</option>
    <option value="[ÊÄßÂà´:ÈÄöÁî®] ">ÈÄöÁî®/‰øùÂØÜ</option>
</select>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊèíÂÖ•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<div id="nameModal" class="modal"><div class="modal-content"><div class="modal-title">‰øÆÊîπÊòµÁß∞</div><input type="text" class="modal-input" id="newNameInput" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÊòµÁß∞"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeNameModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeName()">Á°ÆÂÆö</button></div></div></div>
    <div id="textEditModal" class="modal"><div class="modal-content"><div class="modal-title" id="textEditTitle">ÁºñËæëÊñáÂ≠ó</div><input type="text" class="modal-input" id="newTextInput" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂÜÖÂÆπ"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTextEditModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmTextEdit()">Á°ÆÂÆö</button></div></div></div>
    <div id="avatarModal" class="modal"><div class="modal-content"><div class="modal-title">Êõ¥Êç¢Â§¥ÂÉè</div><div class="avatar-upload" id="userAvatarUpload"><input type="file" accept="image/*" onchange="handleUserAvatarUpload(event)"><span id="userAvatarPreview">+</span></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAvatarModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeAvatar()">Á°ÆÂÆö</button></div></div></div>
    <div id="addWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">Ê∑ªÂä†‰∏ñÁïå‰π¶</div><input type="text" class="modal-input" id="worldBookNameInput" placeholder="‰∏ñÁïå‰π¶ÊòµÁß∞"><div class="form-group"><select class="form-select" id="worldBookFolderSelect"></select></div><textarea class="modal-textarea" id="worldBookContentInput" placeholder="‰∏ñÁïå‰π¶ÂÜÖÂÆπ..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBook()">Ê∑ªÂä†</button></div></div></div>
    <div id="editWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">ÁºñËæë‰∏ñÁïå‰π¶</div><input type="text" class="modal-input" id="editWorldBookNameInput" placeholder="‰∏ñÁïå‰π¶ÊòµÁß∞"><div class="form-group"><select class="form-select" id="editWorldBookFolderSelect"></select></div><textarea class="modal-textarea" id="editWorldBookContentInput" placeholder="‰∏ñÁïå‰π¶ÂÜÖÂÆπ..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeEditWorldBookModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" id="saveWorldBookEditBtn">‰øùÂ≠ò</button></div></div></div>
    <div id="addWorldBookFolderModal" class="modal"><div class="modal-content"><div class="modal-title">Êñ∞Âª∫Êñá‰ª∂Â§π</div><input type="text" class="modal-input" id="worldBookFolderNameInput" placeholder="Êñá‰ª∂Â§πÂêçÁß∞"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookFolderModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBookFolder()">ÂàõÂª∫</button></div></div></div>
    <div id="signatureModal" class="modal"><div class="modal-content"><div class="modal-title">‰øÆÊîπ‰∏™ÊÄßÁ≠æÂêç</div><input type="text" class="modal-input" id="newSignatureInput" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰∏™ÊÄßÁ≠æÂêç"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeSignatureModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeSignature()">Á°ÆÂÆö</button></div></div></div>
    <div id="locationModal" class="modal"><div class="modal-content"><div class="modal-title">‰øÆÊîπÂú∞Âå∫</div><input type="text" class="modal-input" id="newLocationInput" placeholder="ËØ∑ËæìÂÖ•Âú∞Âå∫"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeLocation()">Á°ÆÂÆö</button></div></div></div>
    <div id="cameraModal" class="modal"><div class="modal-content"><div class="modal-title">AIÊãçÊëÑ</div><textarea class="modal-textarea" id="cameraDescInput" placeholder="ËØ∑ÊèèËø∞‰Ω†Ë¶ÅÊãçÊëÑÁöÑÂÜÖÂÆπ...&#10;‰æãÂ¶ÇÔºö‰∏ÄÂè™ÂèØÁà±ÁöÑÂ∞èÁå´Ê≠£Âú®Èò≥Âè∞‰∏äÊôíÂ§™Èò≥" style="min-height: 100px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeCameraModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmCamera()">ÊãçÊëÑ</button></div></div></div>
   <div id="addMomentModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂèëÂ∏ÉÊúãÂèãÂúà</div>

        <!-- 1. ÊñáÊú¨ËæìÂÖ•Ê°Ü -->
        <textarea class="modal-textarea" id="momentContentInput" placeholder="Ëøô‰∏ÄÂàªÁöÑÊÉ≥Ê≥ï..." style="min-height: 120px;"></textarea>

        <!-- 2. È¢ÑËßàÂå∫Âüü (ÂõæÁâáÊàñÊèèËø∞Âç†‰ΩçÂõæÈÉΩ‰ºöÊòæÁ§∫Âú®ËøôÈáå) -->
        <div id="momentMediaPreviewBox" class="moment-preview-box">
            <div class="moment-media-remove" onclick="removeMomentMedia()">√ó</div>
        </div>

        <!-- 3. Êìç‰ΩúÂ∑•ÂÖ∑Ê†è (‰∏§‰∏™Âπ∂ÂàóÁöÑÂõæÊ†áÊåâÈíÆ) -->
        <div class="moment-toolbar">
            <!-- ÊåâÈíÆ A: ‰∏ä‰º†ÂõæÁâá -->
            <label class="media-action-btn" id="btnUploadImage">
                <i class="ri-image-2-line"></i>
                <span>‰∏ä‰º†ÂõæÁâá</span>
                <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
                <input type="file" accept="image/*" style="display:none;" onchange="handleMomentImageUpload(event)">
            </label>

            <!-- ÊåâÈíÆ B: ÊèèËø∞ÂõæÁâá -->
            <div class="media-action-btn" id="btnDescribeImage" onclick="openMomentDescriptionInput()">
                <i class="ri-camera-lens-line"></i>
                <span>ÊèèËø∞ÂõæÁâá</span>
            </div>

<!-- Âú® .moment-toolbar ÂÜÖÈÉ®ÔºåbtnDescribeImage ÂêéÈù¢Ê∑ªÂä† -->
<div class="media-action-btn" style="position: relative;">
    <i class="ri-group-2-line"></i>
    <span>Ë∞ÅÂèØ‰ª•Áúã</span>
    <!-- ‰∏Ä‰∏™Ë¶ÜÁõñÂú®‰∏äÈù¢ÁöÑÈÄèÊòé‰∏ãÊãâÊ°ÜÔºåÂÆûÁé∞ÁÇπÂáªÈÄâÊã© -->
    <select id="momentPostGroupSelect" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="updateGroupSelectLabel(this)">
        <option value="public">ÊâÄÊúâ‰∫∫</option>
        <!-- ÂàÜÁªÑÈÄâÈ°πÁî±JSÂä®ÊÄÅÂ°´ÂÖ• -->
    </select>
    <div id="momentPostGroupLabel" style="font-size: 10px; color: #007aff; margin-top: -2px;">ÊâÄÊúâ‰∫∫</div>
</div>

</div>

        <!-- 4. Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeAddMomentModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="postNewMoment()">ÂèëÂ∏É</button>
        </div>
    </div>
</div>
    <div id="alertModal" class="modal"><div class="modal-content"><div class="modal-title">ÊèêÁ§∫</div><div id="alertMessage"></div><div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="closeAlertModal()">Á°ÆÂÆö</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-title">ËØ∑Á°ÆËÆ§</div><div id="confirmMessage" style="text-align: center; margin-bottom: 20px; line-height: 1.5;"></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" id="confirmCancelBtn">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" id="confirmOkBtn">Á°ÆÂÆö</button></div></div></div>
        <div id="momentCommentInputArea"><input type="text" id="momentCommentInput" placeholder="ËØÑËÆ∫..."><button id="momentCommentSendBtn">ÂèëÈÄÅ</button></div>
    <div id="transferModal" class="modal"><div class="modal-content"><div class="modal-title">ËΩ¨Ë¥¶</div><input type="number" class="modal-input" id="transferAmountInput" placeholder="¬• 0.00"><input type="text" class="modal-input" id="transferRemarkInput" placeholder="Ê∑ªÂä†Â§áÊ≥® (ÂèØÈÄâ)"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTransferModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="sendTransfer()">ËΩ¨Ë¥¶</button></div></div></div>
    <div id="worldBookBindingModal" class="modal"><div class="modal-content"><div class="modal-title">ÁªëÂÆö‰∏ñÁïå‰π¶</div><div id="worldBookBindingList" class="multi-select-list" style="max-height: 40vh; text-align: left;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeWorldBookBindingModal()">ÂèñÊ∂à</button><button class="modal-btn modal-btn-confirm" onclick="confirmWorldBookBinding()">Á°ÆÂÆö</button></div></div></div>

    <!-- NEW: Location Input Modal -->
    <div id="sendLocationModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂèëÈÄÅ‰ΩçÁΩÆ</div>
        <!-- ‰ΩçÁΩÆÂêçÁß∞ (Â¶ÇÔºö‰∏úÊñπÊòéÁè†) -->
        <input type="text" class="modal-input" id="locationNameInput" placeholder="‰ΩçÁΩÆÂêçÁß∞ (ÂøÖÂ°´)">
        <!-- ËØ¶ÁªÜÂú∞ÂùÄ (Â¶ÇÔºö‰∏ñÁ∫™Â§ßÈÅì1Âè∑) -->
        <input type="text" class="modal-input" id="locationAddressInput" placeholder="ËØ¶ÁªÜÂú∞ÂùÄ (ÈÄâÂ°´Ôºå‰∏çÂ°´Âàô‰∏çÊòæÁ§∫)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmSendLocation()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

    <!-- NEW: Image Description Modal -->
    <div id="imageDescriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÂõæÁâáÊèèËø∞</div>
            <div id="imageDescriptionContent"></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-btn modal-btn-confirm" onclick="closeImageDescriptionModal()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- [MODIFIED] New Emoji Modal -->
    <div id="addEmojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-title"> Ê∑ªÂä†Ëá™ÂÆö‰πâË°®ÊÉÖ</div>
            <div class="emoji-modal-tabs">
                <button class="emoji-modal-tab active" onclick="switchEmojiAddMode(this, 'single')">Âçï‰∏™Ê∑ªÂä†</button>
                <button class="emoji-modal-tab" onclick="switchEmojiAddMode(this, 'batch')">ÊâπÈáèÊ∑ªÂä†</button>
            </div>

            <!-- Single Add View -->
            <div id="emojiSingleAddView" class="emoji-modal-content-view active">
                <input type="text" class="modal-input" id="singleEmojiNameInput" placeholder="Ë°®ÊÉÖÂêçÁß∞ (ÂøÖÂ°´)">
                <input type="text" class="modal-input" id="singleEmojiUrlInput" placeholder="Ë°®ÊÉÖURLÈìæÊé•">
                <label for="singleEmojiUploadInput" class="emoji-modal-upload-btn">Êú¨Âú∞‰∏ä‰º†</label>
            </div>

            <!-- Batch Add View -->
            <div id="emojiBatchAddView" class="emoji-modal-content-view">
                <textarea id="batchEmojiInput" class="modal-textarea" placeholder="Âú®Ê≠§Â§ÑÁ≤òË¥¥Ë°®ÊÉÖ‰ø°ÊÅØÔºåÊ†ºÂºè‰∏∫Ôºö&#10;Ë°®ÊÉÖÂêç1ÔºöURL1&#10;Ë°®ÊÉÖÂêç2ÔºöURL2 (URLÂèØÊç¢Ë°å)"></textarea>
                <label for="batchEmojiUploadInput" class="emoji-modal-upload-btn">Êú¨Âú∞‰∏ä‰º†</label>
            </div>

            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddEmojiModal()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmAddEmoji()">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>


     <div id="addMusicModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Ê∑ªÂä†Êñ∞Ê≠åÊõ≤</div>
                <input type="text" class="modal-input" id="songTitleInput" placeholder="Ê≠åÊõ≤Âêç (Ëá™Âä®ËØªÂèñÊàñÊâãÂä®Â°´ÂÜô)">
                <input type="text" class="modal-input" id="songArtistInput" placeholder="Ê≠åÊâã (Ëá™Âä®ËØªÂèñÊàñÊâãÂä®Â°´ÂÜô)">
                <button class="modal-btn" onclick="document.getElementById('songFileInput').click()">Ê∑ªÂä†Ê≠åÊõ≤Êñá‰ª∂</button>
                <span id="songFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">Êú™ÈÄâÊã©Êñá‰ª∂</span>
                <button class="modal-btn" style="margin-top: 10px;" onclick="document.getElementById('lrcFileInput').click()">Ê∑ªÂä†Ê≠åËØçÊñá‰ª∂ (.lrc)</button>
                <span id="lrcFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">Êú™ÈÄâÊã©Êñá‰ª∂</span>
                 <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="modal-btn modal-btn-cancel" onclick="closeAddMusicModal()">ÂèñÊ∂à</button>
                    <button class="modal-btn modal-btn-confirm" onclick="confirmAddSong()">ÂÆåÊàê</button>
                </div>
            </div>
        </div>


    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <div class="playlist-header">
                <span id="playlistTitle">Êí≠ÊîæÂàóË°® (0)</span>
                <button id="openAddMusicBtn" onclick="openAddMusicModal()">+</button>
            </div>
            <div class="playlist-list" id="playlistList"></div>
        </div>
    </div>

    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÂèëÈÄÅËØ≠Èü≥</div>
            <textarea class="modal-textarea" id="voiceInputText" placeholder="Âú®Ê≠§ËæìÂÖ•ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..." style="min-height: 120px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick ="closeVoiceModal()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-confirm" onclick="sendVoiceMessage()">ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>

    <!-- ‚Üì‚Üì‚Üì Á¨¨1Ê≠•Ôºö‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì -->

    <!-- Êñ∞Â¢ûÔºöÂèëÁ∫¢ÂåÖÁöÑÂºπÁ™ó -->
    <div id="redEnvelopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÂèëÁ∫¢ÂåÖ</div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <label style="width: 80px;">ÊÄªÈáëÈ¢ù</label>
                <input type="number" class="modal-input" id="redEnvelopeAmount" placeholder="0.00" style="margin-bottom: 0;">
                <span style="margin-left: 10px;">ÂÖÉ</span>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <label style="width: 80px;">Á∫¢ÂåÖ‰∏™Êï∞</label>
                <input type="number" class="modal-input" id="redEnvelopeCount" placeholder="Â°´ÂÜô‰∏™Êï∞" style="margin-bottom: 0;">
                <span style="margin-left: 10px;">‰∏™</span>
            </div>
             <input type="text" class="modal-input" id="redEnvelopeRemark" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeRedEnvelopeModal()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-confirm" style="background-color: #E64340;" onclick="sendGroupRedEnvelope()">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
            </div>
        </div>
    </div>

       <!-- Êñ∞Â¢ûÔºöÂºÄÁ∫¢ÂåÖÁöÑÂä®ÁîªÂºπÁ™ó -->
    <div id="openRedEnvelopeModal" class="modal">
        <div id="redEnvelopeOpenCard">
            <div id="openRedEnvelopeButton"> <!-- ÁúãÔºåÊàë‰ª¨Êää‚ÄúRed‚ÄùÂä†ÂõûÊù•‰∫ÜÔºÅ -->
                ÂºÄ
            </div>
        </div>
    </div>

<!-- ‚Üë‚Üë‚Üë Á¨¨2Ê≠•ÔºöÂú®ËøôÈáåÁªìÊùüÂ§çÂà∂ ‚Üë‚Üë‚Üë -->

    <!-- Êñ∞Â¢ûÔºöÊü•ÁúãÁ∫¢ÂåÖËØ¶ÊÉÖÁöÑÂºπÁ™ó -->
    <div id="redEnvelopeDetailsModal" class="modal">
        <div class="modal-content" style="background-color: #F7F7F7; padding: 0;">
            <div style="background-color: #E64340; color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center;">
                <div id="redEnvelopeDetailsRemark" style="font-size: 20px; margin-bottom: 5px;"></div>
                <div id="redEnvelopeDetailsFrom"></div>
            </div>
            <div id="redEnvelopeDetailsStatus" style="padding: 10px 15px; font-size: 14px; color: #888; border-bottom: 1px solid #eee;"></div>
            <div id="redEnvelopeClaimList" style="max-height: 50vh; overflow-y: auto;">
                <!-- È¢ÜÂèñËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
             <div class="modal-buttons" style="padding: 15px;">
                <button class="modal-btn modal-btn-confirm" onclick="closeRedEnvelopeDetailsModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

<!-- ‚Üë‚Üë‚Üë Á¨¨1Ê≠•ÔºöÂú®ËøôÈáåÁªìÊùüÂ§çÂà∂ ‚Üë‚Üë‚Üë -->

<!-- ‚Üì‚Üì‚Üì Á¨¨‰∏ÄÊ≠•ÔºöÂ∞ÜËøô‰∏§ÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ <body> Ê†áÁ≠æÁöÑÊú´Â∞æ ‚Üì‚Üì‚Üì -->

<!-- ËøôÊòØÊñ∞Â¢ûÁöÑ‚ÄúÂèëËµ∑ÊäïÁ•®‚ÄùÂäüËÉΩÁöÑÂºπÁ™ó -->
<div id="pollModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂèëËµ∑ÊäïÁ•®</div>
        <input type="text" class="modal-input" id="pollTitleInput" placeholder="ÊäïÁ•®Ê†áÈ¢ò">
        <div id="pollOptionsContainer">
            <!-- ÊäïÁ•®ÈÄâÈ°π‰ºöÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="text" class="form-input poll-option-input" placeholder="ÈÄâÈ°π 1">
                <!-- Á¨¨‰∏Ä‰∏™ÈÄâÈ°π‰∏çÂÖÅËÆ∏Âà†Èô§ -->
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="text" class="form-input poll-option-input" placeholder="ÈÄâÈ°π 2">
                <!-- Á¨¨‰∫å‰∏™ÈÄâÈ°π‰πü‰∏çÂÖÅËÆ∏Âà†Èô§ -->
            </div>
        </div>
        <button class="modal-btn modal-btn-cancel" onclick="addPollOption()" style="margin-top: 10px; background: var(--bg-hover);">+ Ê∑ªÂä†ÈÄâÈ°π</button>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closePollModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="sendPoll()">ÂèëËµ∑ÊäïÁ•®</button>
        </div>
    </div>
</div>

<!-- ËøôÊòØËÅäÂ§©ÁïåÈù¢ÈáåÁöÑ‚ÄúÊäïÁ•®‚ÄùÊåâÈíÆ -->
<!-- Ê≥®ÊÑèÔºöËøôÊÆµ‰ª£Á†ÅÊàë‰ª¨Á®çÂêé‰ºöÁî®JavaScriptÂä®ÊÄÅÊ∑ªÂä†Âà∞‚Äú+‚ÄùËèúÂçïÈáåÔºå‰Ω†ÂÖà‰∏çÁî®Âä® -->
<!-- <div class="function-item" onclick="openPollModal()">
    <div class="function-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-4h2v4zm4 0h-2v-2h2v2zm0-4h-2V7h2v5z"/>
        </svg>
    </div>
    <div class="function-label">ÊäïÁ•®</div>
</div> -->

<!-- ‚Üë‚Üë‚Üë Á¨¨‰∏ÄÊ≠•Ôºö‰ª£Á†ÅÁ≤òË¥¥Âà∞Ê≠§ÁªìÊùü ‚Üë‚Üë‚Üë -->


    <!-- [MODIFIED] Heart's Voice Modal -->
<div id="heartsVoiceModal" class="modal">
    <div class="modal-content">
        <!-- Èù¢ÊùøÂÜÖÂÆπÂ∞ÜÁî± JavaScript Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
    </div>
</div>
    <!-- ‚Üì‚Üì‚Üì Á¨¨2Ê≠•Ôºö‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÊâÄÊúâÊñ∞Â¢ûÁöÑHTML‰ª£Á†Å ‚Üì‚Üì‚Üì -->

<!-- Êñ∞Â¢ûÔºö‰∫∫ËÆæÂàóË°®È°µÈù¢ -->
<div id="personaListScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÊàëÁöÑ‰∫∫ËÆæ</div>
        <button class="nav-btn" onclick="openPersonaEditModal(null)">+</button>
    </div>
    <div class="wechat-content">
        <div id="personaListContainer" class="friend-list">
            <!-- ‰∫∫ËÆæÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÊ∑ªÂä†/ÁºñËæë‰∫∫ËÆæÁöÑÂºπÁ™ó -->
<div id="personaEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="personaEditTitle">Ê∑ªÂä†Êñ∞‰∫∫ËÆæ</div>
        <div class="avatar-upload" id="personaAvatarUpload">
            <input type="file" accept="image/*" onchange="handlePersonaAvatarUpload(event)">
            <span id="personaAvatarPreview">+</span>
        </div>
        <input type="text" class="modal-input" id="personaNameInput" placeholder="ÊòµÁß∞ (ÂøÖÂ°´)">
        <textarea class="modal-textarea" id="personaPersonalityInput" placeholder="‰∏™ÊÄß„ÄÅÁâπÁÇπ„ÄÅÂñúÂ•ΩÁ≠â..."></textarea>
        <textarea class="modal-textarea" id="personaBackgroundInput" placeholder="ËÉåÊôØ„ÄÅÁªèÂéÜ„ÄÅËÅå‰∏öÁ≠â..."></textarea>
        <input type="text" class="modal-input" id="personaPatActionInput" placeholder="‚ÄúÊãç‰∫ÜÊãç‚ÄùÂêéÁºÄÔºåÂ¶ÇÔºöÁöÑÂ§¥ËØ¥‚Äú‰Ω†Â•Ω‚Äù">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePersonaEditModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePersona()">‰øùÂ≠ò</button>
        </div>
        <div style="margin-top: 20px;">
             <button class="settings-btn btn-danger" id="deletePersonaBtn" style="display: none;" onclick="deletePersona()">Âà†Èô§Ëøô‰∏™‰∫∫ËÆæ</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºö‰∏∫‰∫∫ËÆæÈÄâÊã©ÁöÑÂºπÁ™ó -->
<div id="personaSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">‰∏∫ÂΩìÂâçËÅäÂ§©ÈÄâÊã©‚ÄúÊàë‚ÄùÁöÑ‰∫∫ËÆæ</div>
        <div id="personaSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- ÂèØÈÄâÁöÑ‰∫∫ËÆæÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
             <button class="modal-btn modal-btn-cancel" onclick="closePersonaSelectModal()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

    <!-- „Äê„Äê„ÄêÂÖ®Êñ∞ÁöÑÊÄªÁªìÁºñËæëÂºπÁ™ó„Äë„Äë„Äë -->
    <div id="summaryEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ÂØπËØùÊÄªÁªì</div>
            <textarea id="summaryEditTextarea" class="modal-textarea" style="min-height: 250px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeSummaryEditModal()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveSummaryFromModal()">Â≠òÂÖ•ÊÄªÁªì</button>
            </div>
        </div>
    </div>

<!-- „Äê„Äê„ÄêÊñ∞Â¢ûÁöÑ‚ÄúÊâãÂä®ÊÄªÁªì‚ÄùÂºπÁ™ó„Äë„Äë„Äë -->
<div id="manualSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÊâãÂä®ÁîüÊàêÊÄªÁªì</div>
        <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">ËØ∑ËæìÂÖ•ÈúÄË¶ÅÊÄªÁªìÁöÑÊúÄÊñ∞ÂØπËØùËΩÆÊï∞Ôºö</p>
        <input type="number" class="modal-input" id="manualSummaryTurnsInput" placeholder="‰æãÂ¶ÇÔºö20">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeManualSummaryModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmManualSummary()">ÂºÄÂßãÊÄªÁªì</button>
        </div>
    </div>
</div>

<!-- „Äê„Äê„ÄêÊñ∞Â¢ûÁöÑ‚ÄúÁºñËæëÊÄªÁªì‚ÄùÂºπÁ™ó„Äë„Äë„Äë -->
<div id="memoryEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÁºñËæëËÆ∞ÂøÜ</div>
        <textarea id="memoryEditTextarea" class="modal-textarea" style="min-height: 250px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeMemoryEditModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveEditedMemory()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöHTMLÂç°ÁâáÁºñËæëÂºπÁ™ó -->
<div id="htmlCardEditModal" class="modal">
    <div class="modal-content" style="max-width: 90%; width: 600px;">
        <div class="modal-title">ÁºñËæëHTMLÂç°Áâá‰ª£Á†Å</div>
        <textarea id="htmlCardEditTextarea" class="modal-textarea" style="min-height: 60vh; font-family: monospace; font-size: 13px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeHtmlCardEditor()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveHtmlCardEdit()">‰øùÂ≠òÂπ∂Êõ¥Êñ∞</button>
        </div>
    </div>
</div>

<div id="avatarFrameUrlModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ËæìÂÖ•Â§¥ÂÉèÊ°ÜURL</div>
        <input type="text" class="modal-input" id="avatarFrameUrlInput" placeholder="ËØ∑Á≤òË¥¥ÂõæÁâáURLÈìæÊé•...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeAvatarFrameUrlModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAvatarFrameUrl()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÁºñËæëÊ∂àÊÅØÁöÑÂºπÁ™ó -->
<div id="messageEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÁºñËæëÊ∂àÊÅØ</div>
        <textarea class="modal-textarea" id="messageEditInput" style="min-height: 120px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeMessageEditor()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmMessageEdit()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>
<!-- Êñ∞Â¢ûÔºöËá™Âä®ÂèëÊúãÂèãÂúàËßíËâ≤ÈÄâÊã©ÂºπÁ™ó -->
<div id="momentAutoPostRolesModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©ÂÖÅËÆ∏Ëá™Âä®ÂèëÂúàÁöÑËßíËâ≤</div>
        <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-align: center;">Âè™ÊúâË¢´ÈÄâ‰∏≠ÁöÑËßíËâ≤Êâç‰ºöËá™Âä®ÂèëÂ∏ÉÊúãÂèãÂúà</div>

        <div id="momentAutoPostRolesList" class="multi-select-list" style="max-height: 40vh;">
            <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeMomentAutoPostRolesModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveMomentAutoPostRolesSelection()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºö‰∏ªÂä®ÂèëÊ∂àÊÅØÁöÑËßíËâ≤ÈÄâÊã©ÂºπÁ™ó -->
<div id="proactiveRolesModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©‰∏ªÂä®ÂèëÊ∂àÊÅØÁöÑËßíËâ≤</div>
        <div id="proactiveRolesList" class="multi-select-list" style="max-height: 40vh;">
            <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeProactiveRolesModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveProactiveRolesSelection()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- ‚Üì‚Üì‚Üì Êñ∞Â¢ûÔºöÈÄöÁî®ÁöÑÂêçÁß∞ËæìÂÖ•ÂºπÁ™ó ‚Üì‚Üì‚Üì -->
<div id="nameInputModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="nameInputTitle">ËØ∑ËæìÂÖ•ÂêçÁß∞</div>
        <input type="text" class="modal-input" id="nameInputValue" placeholder="Âú®Ê≠§ËæìÂÖ•...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeNameInputModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" id="nameInputConfirmBtn">Á°ÆÂÆö</button>
        </div>
    </div>
</div>
<!-- ‚Üë‚Üë‚Üë Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚Üë‚Üë‚Üë -->

<!-- ‚Üì‚Üì‚Üì Êñ∞Â¢ûÔºöÊ†∑ÂºèÈÄâÊã©ÂºπÁ™ó ‚Üì‚Üì‚Üì -->
<div id="presetSelectorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="presetSelectorTitle">ÈÄâÊã©Ê†∑Âºè</div>
        <div id="presetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- Ê†∑ÂºèÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closePresetSelector()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>
<!-- ‚Üë‚Üë‚Üë Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚Üë‚Üë‚Üë -->

<!-- ‚ñº‚ñº‚ñº Â∞ÜËøôÊÆµÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞ <body> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->

<!-- Êñ∞Â¢ûÔºöAPIÈ¢ÑËÆæÈÄâÊã©ÂºπÁ™ó -->
<div id="apiPresetSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©APIÈ¢ÑËÆæ</div>
        <div id="apiPresetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- È¢ÑËÆæÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeApiPresetSelector()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÂà∞Ê≠§ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº ÊÇ®ÈúÄË¶ÅÂâ™Âàá‰∏ãÈù¢ËøôÊÆµÂÆåÊï¥ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº -->
<div id="exportDataModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂØºÂá∫ËßíËâ≤‰∏éËÆ∞ÂΩï</div>

        <!-- ÂÖ®ÈÄâ/ÂÖ®‰∏çÈÄâÁöÑÂ§çÈÄâÊ°Ü -->
        <div style="padding: 10px; border-bottom: 1px solid var(--border-light, #f0f0f0); margin-bottom: 10px; display: flex; align-items: center;">
            <input type="checkbox" id="exportSelectAllToggle" onchange="toggleSelectAllExport(this.checked)" style="margin-right: 10px;">
            <label for="exportSelectAllToggle">ÂÖ®ÈÄâ / ÂÖ®‰∏çÈÄâ</label>
        </div>

        <!-- ËßíËâ≤ÂàóË°®ÂÆπÂô® -->
        <div id="exportCharacterList" class="multi-select-list" style="max-height: 50vh;">
            <!-- ËßíËâ≤ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeExportModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="exportSelectedData()">ÂØºÂá∫ÈÄâ‰∏≠È°π</button>
        </div>
    </div>
    </div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Ââ™ÂàáÂà∞ËøôÈáåÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->


                <div id="toggle-panel-btn" class="control-btn"><i class="ri-arrow-up-s-line"></i></div>
            </div>
        </div>
        <div id="input-controls">
            <button id="open-bg-modal-btn" class="control-btn" title="Êõ¥Êç¢ËÉåÊôØ"><i class="ri-image-add-line"></i></button>
            <button id="clear-btn" class="control-btn" title="Ê∏ÖÈô§ÊâÄÊúâÂÜÖÂÆπ"><i class="ri-delete-bin-line"></i></button>
            <button id="open-drawing-btn" class="control-btn" title="ÁîªÁîª"><i class="ri-edit-2-line"></i></button>
            <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑËÆæÁΩÆÊåâÈíÆÂ∞±Á≤òË¥¥Âú®ËøôÈáå ‚ñº‚ñº‚ñº -->
    <button id="open-mars-settings-btn" class="control-btn" title="ËÆæÁΩÆ"><i class="ri-user-settings-fill"></i></button>
        </div>
    </div>

    <div id="bg-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">ËÆæÁΩÆËÉåÊôØ</div>
            <ul>
                <li id="upload-top-bg"><i class="ri-upload-cloud-2-line"></i><span>‰∏∫ÂØπÊñπÁöÑÈù¢Êùø‰∏ä‰º†ËÉåÊôØ</span></li>
                <li id="upload-bottom-bg"><i class="ri-upload-cloud-line"></i><span>‰∏∫ÊàëÁöÑÈù¢Êùø‰∏ä‰º†ËÉåÊôØ</span></li>
            </ul>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº ËøôÊòØÊñ∞Â¢ûÁöÑ‚ÄúËÆæÁΩÆ‚ÄùÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="mars-settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ÊòæÁ§∫ËÆæÁΩÆ</div>
        <ul>
            <!-- Â≠ó‰ΩìÈ¢úËâ≤ËÆæÁΩÆ -->
            <li style="justify-content: space-between;">
                <span>Â≠ó‰ΩìÈ¢úËâ≤</span>
                <input type="color" id="mars-font-color-picker" style="border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
            </li>
            <!-- Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ -->
            <li style="flex-direction: column; align-items: stretch; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Â≠ó‰ΩìÂ§ßÂ∞è</span>
                    <span id="mars-font-size-value">22px</span>
                </div>
                <input type="range" id="mars-font-size-slider" min="14" max="32" value="22" style="width: 100%;">
            </li>
        </ul>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <div id="drawing-modal" class="modal-overlay">
        <div id="drawing-board">
            <canvas id="drawing-canvas"></canvas>
            <div class="drawing-controls">
                <button id="clear-canvas-btn">Ê∏ÖÁ©∫</button>
                <button id="send-drawing-btn">ÁîªÂ•Ω‰∫ÜÔºåÂèëÁªôTA</button>
            </div>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Ê≠•È™§‰∏Ä‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<div id="cloneApiSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂÖãÈöÜÈü≥Ëâ≤ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- Âç°Áâá 1ÔºöÂäüËÉΩÂºÄÂÖ≥ -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">ÂºÄÂêØÂÖãÈöÜÈü≥Ëâ≤</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="voiceCloneToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Âç°Áâá 2ÔºöMiniMax ÈÖçÁΩÆ -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">MiniMax Âπ≥Âè∞ÈÖçÁΩÆ</label>
            </div>

            <!-- „ÄêÊñ∞Â¢û„ÄëË∑≥ËΩ¨ÂÆòÁΩëÊåâÈíÆ -->
            <div class="form-group-row clickable" onclick="window.open('https://platform.minimaxi.com/', '_blank')">
                <label class="form-label" style="color: #000;">ÂâçÂæÄÂºÄÊîæÂπ≥Âè∞Ê≥®ÂÜå/Ëé∑Âèñ</label>
                <div class="form-value-display"><i class="ri-external-link-line"></i></div>
            </div>

            <div class="form-group-row">
                <label class="form-label">Group ID</label>
                <input type="text" class="form-input" id="minimaxGroupId" placeholder="ËØ∑ËæìÂÖ• Group ID">
            </div>

            <div class="form-group-row">
                <label class="form-label">API Key</label>
                <div style="flex: 1; display: flex; align-items: center;">
                    <input type="password" class="form-input" id="minimaxApiKey" placeholder="ËØ∑ËæìÂÖ• API Key">
                    <i class="ri-close-circle-fill" style="color: #ccc; margin-left: 8px; cursor: pointer; font-size: 18px;" onclick="document.getElementById('minimaxApiKey').value = ''"></i>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ËØ¥ÊòéÊñáÂ≠ó -->
        <div style="padding: 0 20px; text-align: center; color: #999; font-size: 12px; line-height: 1.5; margin-top: -10px;">
            Êú¨ÂäüËÉΩÂü∫‰∫é MiniMax T2A Êé•Âè£„ÄÇ<br>ÈÖçÁΩÆÂêéÂèØËÆ© AI ‰ΩøÁî®ÊåáÂÆöÁöÑÈü≥Ëâ≤ÂèëÈÄÅËØ≠Èü≥„ÄÇ
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveCloneApiSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>

    <!-- ‚Üì‚Üì‚Üì Á¨¨1Ê≠•ÔºöÂ∞Ü‰ª•‰∏ãÊâÄÊúâÊñ∞Â¢ûÁöÑHTML‰ª£Á†ÅÁ≤òË¥¥Âà∞ <body> ÁöÑÊú´Â∞æ ‚Üì‚Üì‚Üì -->

<!-- Êñ∞Â¢ûÔºöÁî®‰∫éÊ∑ªÂä†/ÁºñËæëÂêå‰∫∫Ê¢óÁöÑÂºπÁ™ó -->
<div class="modal" id="addTropeModal">
    <div class="modal-content">
        <div class="modal-title" id="trope-modal-title">ÂàõÂª∫Êñ∞Âêå‰∫∫Ê¢ó</div>
        <input type="text" class="modal-input" id="trope-name-input" placeholder="Âêå‰∫∫Ê¢óÂêçÁß∞ (‰æãÂ¶ÇÔºö‰ø°ÊÅØÁ¥†Èîô‰π±)">
        <textarea class="modal-textarea" id="trope-content-input" placeholder="Âêå‰∫∫Ê¢óÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ/ËÆæÂÆö..." style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinCloseAddTropeModal()">ÂèñÊ∂à</button>
            <button class="modal-btn confirm" onclick="doujinSaveTrope()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÂàÜ‰∫´Â∏ñÂ≠êÂà∞Â•ΩÂèãÁöÑÂºπÁ™ó -->
<div id="sharePostModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂàÜ‰∫´ÁªôÂ•ΩÂèã</div>
        <div id="shareFriendList" class="multi-select-list" style="max-height: 300px;">
            <!-- Â•ΩÂèãÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeSharePostModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="sharePostConfirm()">ÂàÜ‰∫´</button>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑÂÖ¨ÂëäÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="announcementTitle"></div>
        <div id="announcementContent" style="font-size: 15px; line-height: 1.8; margin-bottom: 25px; white-space: pre-wrap;"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="closeAnnouncement()">ÊàëÂ∑≤Áü•Êôì</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÂÖ¨ÂëäÂºπÁ™óÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->```

<!-- [Êñ∞Â¢û] Âêå‰∫∫AppÂÇ¨Êõ¥ÂºπÁ™ó -->

<!-- [‰øÆÊîπ] Âêå‰∫∫AppÂÇ¨Êõ¥ÂºπÁ™ó (Â∏¶ÂâßÊÉÖËæìÂÖ•Âíå‰ªòË¥πÊèêÁ§∫) -->
<div class="modal" id="doujinUrgeUpdateModal">
    <div class="modal-content">
        <div class="modal-title">ÂÇ¨Êõ¥</div>

        <!-- Á´†ËäÇÊï∞ÊªëÂùó -->
        <div class="doujin-modal-setting-group">
            <label for="chapter-count-slider">
                ÂÇ¨Êõ¥Á´†ËäÇÊï∞: <span id="chapter-count-value" style="color: #7d9d8f; font-weight: bold;">1</span> Á´†
            </label>
            <!-- Ê≥®ÊÑèÔºöËøôÈáåÊ∑ªÂä†‰∫Ü oninput ‰∫ã‰ª∂Êù•ÂÆûÊó∂Êõ¥Êñ∞‰ª∑Ê†º -->
            <input type="range" id="chapter-count-slider" min="1" max="10" value="1" class="doujin-slider" oninput="updateUrgePriceDisplay(this.value)">
        </div>

        <!-- [Êñ∞Â¢û] ÂâßÊÉÖËµ∞ÂêëËæìÂÖ•Ê°Ü -->
        <div class="doujin-modal-setting-group" style="border-bottom: none; padding-bottom: 0;">
            <label style="margin-bottom: 8px;">ÊåáÂÆöÂâßÊÉÖËµ∞Âêë (ÂèØÈÄâ)</label>
            <textarea class="modal-textarea" id="urgePlotInput" placeholder="‰æãÂ¶ÇÔºöËÆ©‰ªñ‰ª¨Ëß£ÂºÄËØØ‰ºö„ÄÅÁî∑‰∫åÂá∫Âú∫„ÄÅÂèëÁîüÊÑèÂ§ñ..." style="min-height: 80px; font-size: 14px; background: #f9f9f9;"></textarea>
        </div>

        <!-- [Êñ∞Â¢û] ‰ª∑Ê†ºÊèêÁ§∫ -->
        <div style="text-align: center; font-size: 12px; color: #999; margin-bottom: 15px;">
            ÈúÄÊîØ‰ªò <span id="urgeTotalPrice" style="color: #ff4d4d; font-weight: bold; font-size: 16px;">5.00</span> ÂÖÉ (ËôöÊãüË¥ßÂ∏Å)
            <br>ËØ∑Á°ÆËÆ§Â•ΩÂÜçÊîØ‰ªò
        </div>

        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinCloseUrgeUpdateModal()">ÂèñÊ∂à</button>
            <!-- ÊåâÈíÆÊñáÂ≠óÊîπ‰∏∫‚ÄúÂéªÊîØ‰ªò‚Äù -->
            <button class="modal-btn confirm" onclick="doujinPayForUpdate()">ÂéªÊîØ‰ªò</button>
        </div>
    </div>
</div>

<!-- ÊÆµËØÑÂçäÂ±èÂºπÁ™ó -->
<div id="paragraphModalOverlay" class="paragraph-modal-overlay" onclick="closeParagraphModal()"></div>
<div id="paragraphModal" class="paragraph-modal">
    <div class="paragraph-modal-header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span>ÊÆµËêΩËØÑËÆ∫</span>
        <!-- Êñ∞Â¢ûÂà∑Êñ∞ÊåâÈíÆ -->
        <i class="fas fa-sync-alt" id="refreshParaBtn" style="font-size: 14px; color: #999; cursor: pointer;" onclick="refreshCurrentParagraphComments()"></i>
    </div>
    <span onclick="closeParagraphModal()" style="cursor: pointer; padding: 5px;">‚úï</span>
</div>
    <div class="paragraph-modal-content" id="paragraphCommentsList">
        <!-- ËØÑËÆ∫ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÁîüÊàê -->
    </div>
</div>

<!-- Ë°®ÊÉÖÂåÖÂ∫ì‰∏ªÁïåÈù¢ -->
<div id="stickerLibraryScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscover()"><i class="ri-arrow-left-s-line"></i></button>
        <!-- ÁÇπÂáªÊ†áÈ¢òËß¶ÂèëÁªëÂÆöÂºπÁ™ó -->
        <div class="nav-title" onclick="openStickerBindingModal()" style="cursor: pointer;">
            <span id="stickerLibraryTitle">ÁªëÂÆöËßíËâ≤ (0)</span> <i class="ri-arrow-down-s-fill" style="font-size: 12px;"></i>
        </div>
        <!-- „Äê‰øÆÊîπ„ÄëËøôÈáåÊç¢Êàê‰∫ÜÂõæÊ†áÊåâÈíÆ -->
        <button class="nav-btn nav-right-action-btn" id="stickerManageBtn" onclick="toggleStickerManageMode()">
            <i class="ri-list-settings-line" style="font-size: 22px;"></i>
        </button>
    </div>
    <div class="wechat-content" style="padding-bottom: 60px;"> <!-- Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÔºåÈò≤Ê≠¢Êå°‰ΩèÂÜÖÂÆπ -->
        <!-- Ë°®ÊÉÖÁΩëÊ†ºÂÆπÂô® -->
        <div id="stickerLibraryGrid" class="sticker-library-grid"></div>
    </div>

    <!-- „ÄêÊñ∞Â¢û„ÄëÂ∫ïÈÉ®ÊâπÈáèÂà†Èô§Ê†è -->
    <div id="stickerBottomBar" class="multi-select-toolbar">
        <span class="multi-select-count" id="stickerSelectCount">Â∑≤ÈÄâ 0 Âº†</span>
        <div class="multi-select-actions">
            <button class="multi-select-btn delete" onclick="deleteSelectedStickers()">Âà†Èô§</button>
        </div>
    </div>
</div>

<!-- ÁªëÂÆöËßíËâ≤ÁöÑÂ§öÈÄâÂºπÁ™ó -->
<div id="stickerBindingModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©‰ΩøÁî®Ë°®ÊÉÖÂ∫ìÁöÑËßíËâ≤</div>
        <div id="stickerBindingList" class="multi-select-list" style="max-height: 300px;">
            <!-- ËßíËâ≤ÂàóË°®Áî±JSÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeStickerBindingModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveStickerBindings()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>


<!-- Ë°®ÊÉÖÂåÖÊ∑ªÂä†ÂºπÁ™ó -->
<div id="stickerAddModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</div>

        <!-- È°∂ÈÉ®ÂàáÊç¢ Tab -->
        <div class="emoji-modal-tabs">
            <button id="tab-sticker-local" class="emoji-modal-tab active" onclick="switchStickerTab('local')">Êú¨Âú∞‰∏ä‰º†</button>
            <button id="tab-sticker-url" class="emoji-modal-tab" onclick="switchStickerTab('url')">URLÈìæÊé•</button>
        </div>

        <!-- ÂÜÖÂÆπÂå∫ÂüüÔºöÊú¨Âú∞‰∏ä‰º† -->
        <div id="view-sticker-local" class="sticker-view-container">
            <div class="avatar-upload" style="width: 100px; height: 100px; margin: 30px auto; border-radius: 8px;" onclick="triggerLocalStickerUpload()">
                <span>+</span>
            </div>
            <p style="text-align: center; color: #999; font-size: 13px;">ÁÇπÂáª‰∏äÊñπÂä†Âè∑ÔºåÈÄâÊã©Êú¨Âú∞ÂõæÁâáÔºàÊîØÊåÅÂ§öÈÄâÔºâ</p>
        </div>

        <!-- ÂÜÖÂÆπÂå∫ÂüüÔºöURL‰∏ä‰º† -->
        <div id="view-sticker-url" class="sticker-view-container" style="display: none;">
            <textarea id="stickerUrlTextarea" class="modal-textarea" placeholder="Âú®Ê≠§Á≤òË¥¥ÂõæÁâáÈìæÊé•...&#10;ÊîØÊåÅÊâπÈáèÊ∑ªÂä†ÔºåËØ∑ÊØèË°åËæìÂÖ•‰∏Ä‰∏™ÈìæÊé•" style="min-height: 150px; white-space: pre;"></textarea>
        </div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeStickerAddModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmStickerAdd()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- Â∞èËØ¥‰π¶Êû∂È°µÈù¢ -->
<div id="readTogetherBookshelfScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂÖ±ËØªÈ•≠Â†Ç</div>
        <button class="nav-btn nav-right-action-btn" onclick="document.getElementById('uploadNovelInput').click()">
            <i class="ri-upload-cloud-2-line"></i>
        </button>
    </div>
    <div class="wechat-content">
        <!-- ‰π¶Êû∂ÁΩëÊ†º -->
        <div id="readTogetherGrid" class="bookshelf-grid" style="padding: 15px;"></div>
    </div>
</div>

<!-- Â∞èËØ¥ÈòÖËØªÈ°µÈù¢ (ÈáçÊûÑÁâà) -->
<div id="readTogetherReaderScreen" class="page">

    <!-- 1. ÈòÖËØªÂÜÖÂÆπÂ±Ç -->
    <div class="wechat-content">
        <!-- „Äê‰øÆÊîπ„ÄëÁªôÂÜÖÂÆπÂ±ÇÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÁî®‰∫éÂî§Âá∫ËèúÂçïÔºåÂêåÊó∂Âà†Èô§‰∏ãÊñπÁöÑÁÇπÂáªÊÑüÂ∫îÂ±Ç -->
        <div id="readerContent" onclick="toggleReaderMenu()">
            <!-- Â∞èËØ¥Ê≠£Êñá -->
        </div>
    </div>

<div class="reader-nav-btn prev" onclick="prevPage()"><i class="ri-arrow-left-s-line"></i></div>
    <div class="reader-nav-btn next" onclick="nextPage()"><i class="ri-arrow-right-s-line"></i></div>

    <!-- „Äê‰øÆÊîπ„ÄëÂ∑≤Âà†Èô§ÂéüÊú¨Âú®ËøôÈáåÁöÑ 3‰∏™ reader-click-zone div -->

    <!-- 3. È°∂ÈÉ®ËèúÂçïÊ†è -->

    <div class="reader-menu-bar reader-top-bar" id="readerTopBar">
        <i class="ri-arrow-left-s-line" style="font-size: 24px; cursor: pointer;" onclick="backToBookshelf()"></i>
        <span id="readerTitle" style="margin-left: 15px; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Â∞èËØ¥ÈòÖËØª</span>
        <div style="flex: 1;"></div>
        <i class="ri-subtract-line" style="font-size: 24px; cursor: pointer;" onclick="minimizeReaderToFloat()"></i>
    </div>

    <!-- 4. Â∫ïÈÉ®ËèúÂçïÊ†è (‰∏ÄÁ∫ß) -->
    <div class="reader-menu-bar reader-bottom-bar" id="readerBottomBar">
        <!-- ËøõÂ∫¶ÊéßÂà∂ -->
        <div class="reader-progress-container">
            <span onclick="prevPage()" style="cursor: pointer;">‰∏ä‰∏ÄÁ´†</span>
            <input type="range" class="reader-slider" id="readerProgressSlider" min="0" max="100" value="0" oninput="handleSliderSeek(this.value)">
            <span onclick="nextPage()" style="cursor: pointer;">‰∏ã‰∏ÄÁ´†</span>
        </div>
        <div style="text-align: center; font-size: 10px; color: #999;">
            <span id="pageIndicator">Á¨¨ 1 È°µ</span>
        </div>

        <!-- ÂäüËÉΩÊåâÈíÆ -->
        <div class="reader-controls-row">
            <div class="reader-btn" onclick="openReaderCatalog()">
                <i class="ri-list-check"></i>
                <span>ÁõÆÂΩï</span>
            </div>
            <div class="reader-btn" onclick="toggleReaderNightMode()">
                <i class="ri-moon-line" id="nightModeIcon"></i>
                <span id="nightModeText">Â§úÈó¥</span>
            </div>
            <div class="reader-btn" onclick="openReaderSettingsPanel()">
                <i class="ri-font-size"></i>
                <span>ËÆæÁΩÆ</span>
            </div>
        </div>
    </div>

    <!-- 5. ËØ¶ÁªÜËÆæÁΩÆÈù¢Êùø (‰∫åÁ∫ß) -->
    <div id="readerSettingsPanel">
        <!-- ‰∫ÆÂ∫¶ (Ê®°ÊãüÔºåË∞ÉÊï¥ËÉåÊôØÈÄèÊòéÂ∫¶) -->
        <div class="setting-row">
            <span class="setting-label">‰∫ÆÂ∫¶</span>
            <div class="setting-options">
                 <i class="ri-sun-line" style="font-size: 14px;"></i>
                 <input type="range" class="reader-slider" style="margin: 0 10px;" oninput="adjustReaderBrightness(this.value)">
                 <i class="ri-sun-fill" style="font-size: 18px;"></i>
            </div>
        </div>
        <!-- Â≠óÂè∑ -->
        <div class="setting-row">
            <span class="setting-label">Â≠óÂè∑</span>
            <div class="setting-options">
                <button class="font-size-btn" onclick="changeReaderFontSize(-2)">A-</button>
                <span id="currentFontSizeDisplay" style="font-size: 14px;">18</span>
                <button class="font-size-btn" onclick="changeReaderFontSize(2)">A+</button>
            </div>
        </div>
        <!-- === Â≠ó‰ΩìÈ¢úËâ≤ËÆæÁΩÆË°å (ÂéüÁîüÁõ¥ËøûÁâà) === -->
<div class="setting-row">
    <span class="setting-label">Â≠óËâ≤</span>
    <div class="setting-options">
        <!-- ÈªëËâ≤ÊåâÈíÆ -->
        <div class="bg-color-btn" style="background: #333; border: 1px solid #555;" onclick="changeReaderFontColor('#333333', this)"></div>

        <!-- ÁôΩËâ≤ÊåâÈíÆ -->
        <div class="bg-color-btn" style="background: #ffffff; border: 1px solid #ccc;" onclick="changeReaderFontColor('#ffffff', this)"></div>

        <!-- Ë∞ÉËâ≤Áõò (Áõ¥Êé•ÊòØ‰∏Ä‰∏™ InputÔºåÊ≤°Êúâ‰ªª‰ΩïÂ•óË∑Ø) -->
        <input type="color"
               class="bg-color-btn"
               style="padding: 0; border: 1px solid #ccc; background: none; cursor: pointer;"
               onchange="changeReaderFontColor(this.value, this)">
    </div>
</div>
        <!-- ËÉåÊôØ -->
        <!-- ËÉåÊôØËÆæÁΩÆË°å (Â∑≤‰øÆÊîπ) -->
<div class="setting-row">
    <span class="setting-label">ËÉåÊôØ</span>
    <div class="setting-options">
        <div class="bg-color-btn active" style="background: #ffffff;" onclick="changeReaderBg('#ffffff', this)"></div>
        <div class="bg-color-btn" style="background: #f6f4ec;" onclick="changeReaderBg('#f6f4ec', this)"></div> <!-- ÁæäÁöÆÁ∫∏ -->
        <div class="bg-color-btn" style="background: #cce8cf;" onclick="changeReaderBg('#cce8cf', this)"></div> <!-- Êä§ÁúºÁªø -->

        <!-- ‰øÆÊîπÔºöÂ∞ÜÊúÄÂêé‰∏Ä‰∏™ÊåâÈíÆÊîπÊàêÂä†Âè∑ÔºåÂπ∂ÁªëÂÆö‰∏ä‰º†‰∫ã‰ª∂ -->
        <div class="bg-color-btn" style="background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="document.getElementById('readerBgUpload').click()">
            <i class="ri-add-line" style="color: white; font-size: 16px;"></i>
        </div>
    </div>
</div>
        <!-- ÁøªÈ°µÊ®°Âºè -->
        <div class="setting-row">
            <span class="setting-label">ÁøªÈ°µ</span>
            <div class="setting-options">
                <button class="turn-mode-btn" id="btnModeScroll" onclick="setPageTurnMode('vertical')">‰∏ä‰∏ãÊªëÂä®</button>
                <button class="turn-mode-btn active" id="btnModePage" onclick="setPageTurnMode('horizontal')">Âπ≥ÁßªÁøªÈ°µ</button>
            </div>
        </div>
        <!-- === [‰øÆÊîπ] ÁºñÁ†ÅÂàáÊç¢ÔºöÊîπ‰∏∫‰∏ãÊãâËèúÂçï‰ª•ÂÆπÁ∫≥Êõ¥Â§öÈÄâÈ°π === -->
<div class="setting-row">
    <span class="setting-label">ÁºñÁ†Å</span>
    <div class="setting-options">
        <!-- ‰ΩøÁî®‰∏ãÊãâÊ°ÜÔºåÊ†∑ÂºèÂ§çÁî®‰πãÂâçÁöÑ form-select -->
        <select id="readerEncodingSelect" class="form-select arrow-select"
                style="background-color: rgba(0,0,0,0.05); border-radius: 8px; padding: 5px 10px; width: 100%; color: inherit; border: 1px solid rgba(128,128,128,0.3);"
                onchange="changeReaderEncoding(this.value)">

            <optgroup label="Â∏∏Áî®‰∏≠Êñá">
                <option value="utf-8">UTF-8 (ÂõΩÈôÖÈÄöÁî®)</option>
                <option value="gb18030">GB18030 (ÁÆÄ‰ΩìÂ¢ûÂº∫)</option>
                <option value="gbk">GBK (ÁÆÄ‰ΩìÈÄöÁî®)</option>
                <option value="big5">Big5 (ÁπÅ‰ΩìÈÄöÁî®)</option>
            </optgroup>

            <optgroup label="Êó•Èü©/ÂÖ∂‰ªñ">
                <option value="shift_jis">Shift_JIS (Êó•Êñá)</option>
                <option value="euc-jp">EUC-JP (Êó•Êñá)</option>
                <option value="euc-kr">EUC-KR (Èü©Êñá)</option>
                <option value="windows-1252">Windows-1252 (Ë•øÊ¨ß/ANSI)</option>
            </optgroup>

            <optgroup label="UnicodeÂèò‰Ωì">
                <option value="utf-16le">UTF-16 LE</option>
                <option value="utf-16be">UTF-16 BE</option>
            </optgroup>
        </select>
    </div>
</div>
        <!-- === Êñ∞Â¢ûÔºöÊØèÈ°µÂ≠óÊï∞ËÆæÁΩÆ === -->
<div class="setting-row">
    <span class="setting-label">ÊØèÈ°µÂ≠óÊï∞</span>
    <div class="setting-options">
        <input type="number"
               id="pageSizeInput"
               style="width: 100%; background: transparent; border: 1px solid #555; color: #fff; border-radius: 4px; padding: 5px 10px; text-align: center;"
               placeholder="ÈªòËÆ§800"
               onchange="changeReaderPageSize(this.value)">
    </div>
</div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÂõæÁâáÊèèËø∞ËæìÂÖ•ÂºπÁ™ó -->
<div id="momentDescriptionInputModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÂõæÁâáÊèèËø∞</div>
        <p style="font-size:13px; color:#999; margin-bottom:10px;">ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‚ÄúÊãçÊëÑ‚ÄùÁöÑÁîªÈù¢ÂÜÖÂÆπÔºåÁ≥ªÁªüÂ∞ÜÁîüÊàê‰∏ÄÂº†Âç†‰ΩçÂõæ„ÄÇ</p>
        <textarea class="modal-textarea" id="momentDescTempInput" placeholder="‰æãÂ¶ÇÔºöÊ≠§Êó∂Ê≠§ÂàªÁöÑÊôöÈúûÔºåÁªö‰∏ΩÂ§öÂΩ©..." style="min-height: 100px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('momentDescriptionInputModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmMomentDescription()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- ÂàÜÁªÑÁÆ°ÁêÜÈ°µÈù¢ -->
<div id="momentGroupManageScreen" class="page">
    <div class="nav-bar" style="background: #fff;">
        <button class="nav-btn" onclick="backToMomentsFromGroup()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Â•ΩÂèãÂàÜÁªÑ</div>
        <div></div>
    </div>
    <div class="wechat-content" style="background: #fff;">
        <!-- È°∂ÈÉ®ÊéßÂà∂Ê†è -->
        <div class="group-control-bar">
            <select id="momentGroupSelect" class="group-select" onchange="switchMomentGroup(this.value)">
                <option value="default">ÈªòËÆ§ (ÂÖ®ÈÉ®)</option>
            </select>
            <div class="add-group-btn-icon" onclick="openCreateGroupModal()">
                <i class="fas fa-plus"></i>
            </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div id="groupActionArea" style="display: none;">
            <div class="group-section-title">Ê∑ªÂä†ÊàêÂëò</div>
            <div class="member-add-actions">
                <div class="action-btn-bw" onclick="openGroupAddFriendModal()">
                    <i class="fas fa-user-plus"></i> Â•ΩÂèã
                </div>
                <div class="action-btn-bw" onclick="openAddNpcModal()">
                    <i class="fas fa-robot"></i> NPC
                </div>
            </div>

            <div class="group-section-title">ÂΩìÂâçÊàêÂëòÂàóË°®</div>
            <div id="groupMemberList" style="padding-bottom: 50px;">
                <!-- ÊàêÂëòÂàóË°®Âä®ÊÄÅÁîüÊàê -->
            </div>



        <div id="groupEmptyState" style="text-align: center; padding: 50px; color: #999;">
            ËØ∑ÈÄâÊã©ÊàñÊñ∞Âª∫‰∏Ä‰∏™ÂàÜÁªÑ<br>ÈÄâÊã©ÂêéÂ∞ÜÂè™ÊòæÁ§∫ËØ•ÂàÜÁªÑÁöÑÂä®ÊÄÅ
        </div>
    </div>
</div>
    </div>

<!-- Êñ∞Âª∫ÂàÜÁªÑÂºπÁ™ó -->
<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Êñ∞Âª∫ÂàÜÁªÑ</div>
        <input type="text" class="modal-input" id="newGroupNameInput" placeholder="ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞ (Â¶Ç: ÁãóÁãóÂàÜÁªÑ)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('createGroupModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmCreateGroup()">ÂàõÂª∫</button>
        </div>
    </div>
</div>

<!-- Ê∑ªÂä†/ÁºñËæë NPC ÂºπÁ™ó (Â∏¶Â§¥ÂÉè‰∏ä‰º†Áâà) -->
<div id="addNpcModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="npcModalTitle">Ê∑ªÂä† NPC ÊàêÂëò</div>

        <!-- Â§¥ÂÉè‰∏ä‰º†Âå∫Âüü -->
        <div class="avatar-upload" id="npcAvatarUpload" style="margin: 0 auto 20px;">
            <input type="file" accept="image/*" onchange="handleNpcAvatarUpload(event)">
            <span id="npcAvatarPreview">+</span>
        </div>

        <input type="text" class="modal-input" id="npcNameInput" placeholder="NPC ÂêçÂ≠ó">
        <textarea class="modal-textarea" id="npcRoleInput" placeholder="NPC ÊÄßÊ†º/‰∫∫ËÆæ (AIËØÑËÆ∫‰ºöÂèÇËÄÉÊ≠§ËÆæÂÆö)" style="min-height: 80px;"></textarea>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('addNpcModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAddNpc()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>


<!-- Ê∑ªÂä†Â•ΩÂèãÂà∞ÂàÜÁªÑÁöÑÈÄâÊã©ÂºπÁ™ó -->
<div id="groupAddFriendModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©Â•ΩÂèã</div>
        <div id="groupFriendSelectList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('groupAddFriendModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmGroupAddFriends()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- ÊúãÂèãÂúà‰æßÊªëËÆæÁΩÆËèúÂçï (Âè≥‰æßÊªëÂá∫Áâà) -->
<div id="momentsSideMenu" class="forum-side-menu right-side">

    <!-- 1. È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
    <div class="side-menu-header">
        <span class="side-menu-title">ÊúãÂèãÂúàËÆæÁΩÆ</span>
        <div class="close-btn-wrapper" onclick="closeMomentsSideMenu()">
            <i class="ri-close-line"></i>
        </div>
    </div>

    <!-- 2. ÂÜÖÂÆπÂå∫Âüü (Â§çÁî® bw-style ÈªëÁôΩÈ£éÊ†º) -->
    <div class="settings-content bw-style" style="padding: 10px 15px !important; height: auto; background: transparent;">

        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">Ëá™Âä®Âåñ</label>
            </div>

            <!-- Ëá™Âä®ËØÑËÆ∫Áî®Êà∑ -->
            <div class="form-group-row switch-row">
                <label class="form-label">Ëá™Âä®ËØÑËÆ∫ÊàëÁöÑÂä®ÊÄÅ</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoCommentUserToggle" onchange="toggleMomentSetting('autoCommentUser')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Ëá™Âä®ÂèëÊúãÂèãÂúà -->
            <div class="form-group-row switch-row">
                <label class="form-label">ËßíËâ≤Ëá™Âä®ÂèëÊúãÂèãÂúà</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoPostAiToggle" onchange="toggleMomentSetting('autoPostAi')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- „ÄêÊñ∞Â¢û„ÄëÈÄâÊã©ÂÖÅËÆ∏ÂèëÂúàÁöÑËßíËâ≤ (ÈªòËÆ§ÈöêËóèÔºåÂè™ÊúâÂºÄÂÖ≥ÂºÄÂêØÊó∂ÊòæÁ§∫) -->
            <div class="form-group-row clickable" id="momentAutoPostRoleSetting" style="display: none;" onclick="openMomentAutoPostRolesModal()">
                <label class="form-label" style="font-size: 14px; color: #666; padding-left: 20px;">ÈÄâÊã©ÂÖÅËÆ∏ÂèëÂúàÁöÑËßíËâ≤</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âú®ÂÆÉ‰∏ãÈù¢ ‚ñº‚ñº‚ñº -->
<div class="form-group-row" id="momentFreqConfigRow" style="display: none; justify-content: space-between; align-items: center; padding-left: 20px;">
    <label class="form-label sub-label" style="font-size: 14px; color: #666;">ÂèëÂ∏ÉÈ¢ëÁéá</label>

    <div style="display: flex; align-items: center; gap: 5px;">
        <!-- ÊØèÂ§öÂ∞ëÂ§© -->
        <span style="font-size: 13px; color: #333;">ÊØè</span>
        <input type="number" id="momentFreqDaysInput" class="form-input"
               style="width: 40px; text-align: center; height: 30px; background: #fff; border: 1px solid #ddd; border-radius: 4px;"
               placeholder="1" min="1" value="1" onchange="saveMomentFreqConfig()">

        <span style="font-size: 13px; color: #333;">Â§©</span>

        <!-- ÂèëÂ§öÂ∞ëÊù° -->
        <input type="number" id="momentFreqCountInput" class="form-input"
               style="width: 40px; text-align: center; height: 30px; background: #fff; border: 1px solid #ddd; border-radius: 4px;"
               placeholder="1" min="1" value="1" onchange="saveMomentFreqConfig()">
        <span style="font-size: 13px; color: #333;">Êù°</span>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            <!-- Ëá™Âä®ËØÑËÆ∫ËßíËâ≤ -->
            <div class="form-group-row switch-row">
                <label class="form-label">ËßíËâ≤Èó¥Ëá™Âä®‰∫íÂä®</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoCommentAiToggle" onchange="toggleMomentSetting('autoCommentAi')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

<!-- Êñ∞Â¢ûÔºöÊâãÂä®ÂÇ¨Êõ¥Âç°Áâá -->
        <div class="form-card" style="margin-top: 15px;">
            <div class="form-group-row" style="border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">ÊâãÂä®ÁîüÊàê (ÊåáÂÆöËßíËâ≤ÂèëÊúãÂèãÂúà)</label>
            </div>

            <!-- Êï∞ÈáèÊªëÂùó -->
            <div class="form-group-row column-layout">
                 <div style="display: flex; justify-content: space-between; width: 100%;">
                    <label class="form-label">ÊØè‰∫∫ÁîüÊàêÁØáÊï∞</label>
                    <span id="manualMomentCountDisplay" style="font-size: 12px; color: #666;">1 ÁØá</span>
                 </div>
                 <input type="range" class="bw-slider" id="manualMomentCount" min="1" max="3" value="1"
                        oninput="document.getElementById('manualMomentCountDisplay').textContent = this.value + ' ÁØá'">
            </div>

            <!-- ËßíËâ≤ÈÄâÊã©ÂàóË°® -->
            <div style="margin: 10px 0;">
                <label class="form-label" style="margin-bottom: 8px; display: block;">ÈÄâÊã©ËßíËâ≤ (ÂèØÂ§öÈÄâ)</label>
                <div id="manualMomentCharList" class="multi-select-list" style="max-height: 180px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fff;">
                    <!-- JS Â∞ÜÂú®ËøôÈáåÁîüÊàêÂàóË°® -->
                </div>
            </div>

            <!-- Á°ÆËÆ§ÊåâÈíÆ -->
            <!-- Á°ÆËÆ§ÊåâÈíÆ (ÂéªÊéâ‰∫ÜÂõæÊ†á) -->
            <button class="settings-btn btn-black" onclick="triggerManualMomentsGeneration()">
                ÂºÄÂßãÁîüÊàê
            </button>
        </div>

    </div>
</div>

<!-- ÊúãÂèãÂúàËèúÂçïÈÅÆÁΩ© (ÁÇπÂáªÁ©∫ÁôΩÂÖ≥Èó≠) -->
<div id="momentsMenuOverlay" class="forum-menu-overlay" onclick="closeMomentsSideMenu()"></div>

<!-- Êñ∞Â¢ûÔºöÂ≠ó‰ΩìÈ¢ÑËÆæÈÄâÊã©ÂºπÁ™ó -->
<div id="fontPresetSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©Â≠ó‰ΩìÈ¢ÑËÆæ</div>
        <div id="fontPresetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- ÂàóË°®Áî± JS ÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeFontPresetSelector()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- [Êñ∞Â¢û] Á∫ø‰∏ãÊ®°ÂºèÂúÜÂΩ¢ÊÇ¨ÊµÆÁ™ó -->
<div id="offlineModeFloat" style="display: none;">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/></svg>
</div>

<!-- ‚ñº‚ñº‚ñº Êñ∞Â¢û‰ª£Á†Å ‚ñº‚ñº‚ñº -->
<div id="characterProfileSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÁºñËæëËßíËâ≤‰∏ªÈ°µ‰ø°ÊÅØ</div>
        <!-- Â∞ÅÈù¢Âõæ‰∏ä‰º† -->
        <div class="form-group">
            <label class="form-label">Â∞ÅÈù¢Âõæ</label>
            <div class="avatar-upload" id="charCoverUpload" style="width: 100%; height: 120px; border-radius: 8px;">
                <input type="file" accept="image/*" onchange="handleCharCoverUpload(event)">
                <span id="charCoverPreview">+</span>
            </div>
        </div>
        <!-- Â§¥ÂÉè‰∏ä‰º† -->
        <div class="form-group">
            <label class="form-label">Â§¥ÂÉè</label>
            <div class="avatar-upload" id="charAvatarUpload" style="width: 80px; height: 80px; margin: 0;">
                <input type="file" accept="image/*" onchange="handleCharAvatarUpload(event)">
                <span id="charAvatarPreview">+</span>
            </div>
        </div>
        <!-- ÂÖ∂‰ªñ‰ø°ÊÅØËæìÂÖ•Ê°Ü -->
        <input type="text" class="modal-input" id="charEditName" placeholder="ÊòµÁß∞">
        <input type="text" class="modal-input" id="charEditHandle" placeholder="@id (Handle)">
        <textarea class="modal-textarea" id="charEditBio" placeholder="‰∏™‰∫∫ÁÆÄ‰ªã"></textarea>
        <input type="number" class="modal-input" id="charEditFollowing" placeholder="Ê≠£Âú®ÂÖ≥Ê≥®Êï∞Èáè">
        <input type="number" class="modal-input" id="charEditFollowers" placeholder="ÂÖ≥Ê≥®ËÄÖÊï∞Èáè">
        <input type="text" class="modal-input" id="charEditJoined" placeholder="Âä†ÂÖ•Êó∂Èó¥ (‰æãÂ¶Ç: 2025Âπ¥1Êúà)">

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeCharacterProfileSettings()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveCharacterProfileSettings()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚Üì‚Üì‚Üì Á¨¨2Ê≠• AÔºöÁî®Ëøô‰∏™Êñ∞‰ª£Á†ÅÂùóÊõøÊç¢ÊóßÁöÑ offlineModeSettingsScreen ‚Üì‚Üì‚Üì -->

<!-- [‰øÆÊîπ] Á∫ø‰∏ãÊ®°ÂºèËÆæÁΩÆÈ°µÈù¢ -> ÂºπÁ™ó -->
<div id="offlineModeSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Á∫ø‰∏ãÊ®°ÂºèËÆæÁΩÆ</div>

        <!-- 1. ËæìÂá∫Â≠óÁ¨¶Êï∞ÊªëÂùó -->
        <div class="form-group">
            <label class="form-label" for="offlineCharCountSlider">ËæìÂá∫Â≠óÁ¨¶Êï∞: <span id="offlineCharCountValue">1000</span>Â≠ó</label>
            <input type="range" class="font-size-slider" id="offlineCharCountSlider" min="1" max="5000" value="5000" oninput="document.getElementById('offlineCharCountValue').textContent = this.value">
        </div>

        <!-- „Äê„Äê„ÄêÊñ∞Â¢û‰ª£Á†ÅÂùóÔºöÊñáÈ£éÈÄâÊã©„Äë„Äë„Äë -->
<div class="form-group">
    <label class="form-label">ÊñáÈ£éÈÄâÊã©</label>
    <div id="currentWritingStyle" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openWritingStyleList()">
        Êú™ÈÄâÊã©ÊñáÈ£é
    </div>
</div>

        <!-- 2. ÂºÄÂú∫ÁôΩËÆæÁΩÆ -->
        <div class="form-group">
            <label class="form-label">ÂºÄÂú∫ÁôΩËÆæÁΩÆ</label>
            <div id="currentOpeningStatement" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openOpeningStatementList()">
                Êú™ÈÄâÊã©ÂºÄÂú∫ÁôΩ
            </div>
        </div>

        <!-- ‚ñº‚ñº‚ñº ‰ªéËøôÈáåÂºÄÂßãÔºåÁ≤òË¥¥‰∏ãÈù¢ÁöÑÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº -->
        <div class="form-group">
            <label class="form-label">Â∞èÂâßÂú∫ËÆæÁΩÆ</label>
            <div id="currentSkit" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openSkitList()">
                ‰∏ç‰ΩøÁî®Â∞èÂâßÂú∫
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥Âà∞ËøôÈáåÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeOfflineSettingsModal()">ÂÖ≥Èó≠</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveOfflineSettings()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- ‚Üë‚Üë‚Üë ÊõøÊç¢Âà∞Ê≠§ÁªìÊùü ‚Üë‚Üë‚Üë -->

<!-- [Êñ∞Â¢û] ÂºÄÂú∫ÁôΩÈÄâÊã©ÂºπÁ™ó -->
<div id="openingStatementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ÈÄâÊã©ÂºÄÂú∫ÁôΩ</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditOpeningStatementModal(null)">+</button>
        </div>
        <div id="openingStatementList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- ÂºÄÂú∫ÁôΩÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeOpeningStatementList()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- [Êñ∞Â¢û] Êñ∞Âª∫/ÁºñËæëÂºÄÂú∫ÁôΩÂºπÁ™ó -->
<div id="editOpeningStatementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="editOpeningStatementTitle">Êñ∞Âª∫ÂºÄÂú∫ÁôΩ</div>
        <input type="text" class="modal-input" id="openingStatementTitleInput" placeholder="ÂºÄÂú∫ÁôΩÊ†áÈ¢ò (ÂøÖÂ°´)">
        <textarea class="modal-textarea" id="openingStatementContentInput" placeholder="ÂºÄÂú∫ÁôΩÂÜÖÂÆπ..." style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeEditOpeningStatementModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveOpeningStatement()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- ‚Üë‚Üë‚Üë HTML‰ª£Á†ÅÂà∞Ê≠§ÁªìÊùü ‚Üë‚Üë‚Üë -->

<!-- „Äê„Äê„ÄêÊñ∞Â¢û‰ª£Á†ÅÂùóÔºöÊñáÈ£éÈÄâÊã©ÂºπÁ™ó„Äë„Äë„Äë -->
<div id="writingStyleModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ÈÄâÊã©ÊñáÈ£é</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditWritingStyleModal(null)">+</button>
        </div>
        <div id="writingStyleList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- ÊñáÈ£éÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeWritingStyleList()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- „Äê„Äê„ÄêÊñ∞Â¢û‰ª£Á†ÅÂùóÔºöÊñ∞Âª∫/ÁºñËæëÊñáÈ£éÂºπÁ™ó„Äë„Äë„Äë -->
<div id="editWritingStyleModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="editWritingStyleTitle">Êñ∞Âª∫ÊñáÈ£é</div>
        <input type="text" class="modal-input" id="writingStyleTitleInput" placeholder="ÊñáÈ£éÊ†áÈ¢ò (ÂøÖÂ°´)">
        <textarea class="modal-textarea" id="writingStyleContentInput" placeholder="ÊñáÈ£éÁöÑÂÖ∑‰ΩìÊåá‰ª§... ‰æãÂ¶ÇÔºöËØ∑‰ΩøÁî®ÁªÜËÖª„ÄÅÂçé‰∏ΩÁöÑËæûËóªÔºåÂ§öÁî®ÊØîÂñªÂíåÊéíÊØî„ÄÇ" style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeEditWritingStyleModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveWritingStyle()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>


<!-- „Äê„Äê„ÄêÊñ∞Â¢û‰ª£Á†ÅÂùóÔºöÂ∞èÂâßÂú∫ÈÄâÊã©ÂºπÁ™ó„Äë„Äë„Äë -->
<div id="skitModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ÈÄâÊã©Â∞èÂâßÂú∫</span>
            <!-- ËøôÈáåÊöÇÊó∂‰∏çÂÅö‚ÄúÊñ∞Â¢û‚ÄùÂäüËÉΩÔºåÊâÄ‰ª•Ê≥®ÈáäÊéâÊåâÈíÆ
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditSkitModal(null)">+</button>
            -->
        </div>
        <div id="skitList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- Â∞èÂâßÂú∫ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeSkitList()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™Êñ∞ÁªìÊûÑÊõøÊç¢ÊóßÁöÑ forumTrendDetailView ‚ñº‚ñº‚ñº -->
<div id="forumTrendDetailView" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="trendDetailBackBtn"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title" id="trendDetailTitle">ÁÉ≠ÊêúËØ¶ÊÉÖ</div>
        <div style="width: 40px;"></div> <!-- Âç†‰ΩçÔºåÁ°Æ‰øùÊ†áÈ¢òÂ±Ö‰∏≠ -->
    </div>
    <div class="wechat-content" id="trendDetailContent" style="padding-top: 74px; overflow-y: auto;">
        <!-- Â∏ñÂ≠êÂàóË°®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- Âú® <body> ÂÜÖ, </div id="forumScreen"> ‰πãÂâç -->

<!-- Êñ∞Â¢ûÔºöÂ∏ñÂ≠êËØ¶ÊÉÖÈ°µ -->
<div id="forumDetailView" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToForumTimeline()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Â∏ñÂ≠ê</div>
        <div></div> <!-- Âç†‰Ωç -->
    </div>
    <div class="wechat-content" id="forumDetailContent" style="padding-top: 74px; overflow-y: auto;">
        <!-- Â∏ñÂ≠êËØ¶ÊÉÖÂíåËØÑËÆ∫Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
    </div>
</div>

<div id="forumCharacterProfileView" class="page">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="nav-bar">
        <!-- ËøîÂõûÊåâÈíÆÔºöÂéªÊéâ‰∫Ü onclickÔºåÁî± JS Âä®ÊÄÅÁªëÂÆö -->
        <button class="nav-btn" id="charProfileBackBtn">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- Ê†áÈ¢ò -->
        <div class="nav-title" id="charProfileNavTitle">ËßíËâ≤‰∏ªÈ°µ</div>

        <!-- Âè≥‰æßÊåâÈíÆÁªÑ -->
        <div class="nav-right-actions">
            <!-- Âà∑Êñ∞ÊåâÈíÆ -->
            <button class="nav-btn" id="refreshCharProfileBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/><path d="M22 4v4h-4"/></svg>
            </button>
            <!-- ËÆæÁΩÆÊåâÈíÆ -->
            <button class="nav-btn" onclick="openCharacterProfileSettings()">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </div>

    <!-- È°µÈù¢‰∏ªË¶ÅÂÜÖÂÆπÂÆπÂô® -->
    <div class="wechat-content" style="padding-top: 74px; overflow-y: auto;">
         <div class="forum-profile-container">
            <!-- Â∞ÅÈù¢Âõæ -->
            <div class="forum-profile-header" id="charProfileCoverHeader"></div>
            <!-- Â§¥ÂÉèÂíåÁºñËæëÊåâÈíÆÂå∫Âüü -->
            <div class="forum-profile-top-actions">
                <div class="forum-profile-avatar-container">
                    <div class="forum-profile-avatar" id="charProfileAvatar"></div>
                </div>
            </div>
            <!-- ËßíËâ≤‰ø°ÊÅØÂå∫ -->
            <div class="forum-profile-info">
                <h3 id="charProfileName"></h3>
                <p id="charProfileHandle"></p>
                <p id="charProfileBio" style="margin-bottom: 10px;"></p>
                <p id="charProfileJoined"></p>
                <div class="forum-profile-stats">
                    <span class="forum-profile-stat-item"><strong id="charProfileFollowing">0</strong><span>Ê≠£Âú®ÂÖ≥Ê≥®</span></span>
                    <span class="forum-profile-stat-item"><strong id="charProfileFollowers">0</strong><span>ÂÖ≥Ê≥®ËÄÖ</span></span>
                </div>
            </div>
            <!-- Tab ÂàáÊç¢ -->
            <div class="forum-profile-tabs" id="charProfileTabs">
                <div class="forum-profile-tab active" data-tab="posts">Â∏ñÂ≠ê</div>
                <div class="forum-profile-tab" data-tab="replies">ÂõûÂ§ç</div>
                <div class="forum-profile-tab" data-tab="likes">ÂñúÊ¨¢</div>
            </div>
            <!-- Â∏ñÂ≠êÂàóË°® -->
            <div id="charProfileTimeline" class="post-list-container">
                <!-- Â∏ñÂ≠ê/ÂõûÂ§ç/ÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
</div>

<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº ÊääËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ <div id="forumScreen" class="page"> ÁöÑ‰∏äÈù¢ ‚ñº‚ñº‚ñº -->

<div id="forumFollowingListView" class="page">
    <div class="nav-bar">
        <!-- ËøîÂõûÊåâÈíÆ -->
        <button class="nav-btn" onclick="backToMyProfile()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">Ê≠£Âú®ÂÖ≥Ê≥®</div>
        <div style="width: 40px;"></div>
    </div>
    <!-- ÂàóË°®ÂÜÖÂÆπÂÆπÂô® -->
    <div id="followingListContent"></div>
</div>

<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- Êñ∞Â¢ûÔºöÊ®°‰ªø Twitter/X ÁöÑËÆ∫ÂùõÈ°µÈù¢ -->
<!-- [Êï¥ÂêàÁâà] ËÆ∫Âùõ App ‰∏ªÁïåÈù¢ (Forum App) -->
<div id="forumScreen" class="page">
    <!-- 1. È°∂ÈÉ®ÂØºËà™Ê†è (Âè™Âú®‚ÄúÂ∏ñÂ≠ê‚ÄùÈ°µÊòæÁ§∫ÔºåÂÖ∂‰ªñÈ°µ‰ºöËá™Âä®ÈöêËóè) -->
    <div class="nav-bar forum-nav-bar" id="forumTopNavBar">
        <!-- Â∑¶‰æßÂ§¥ÂÉè (ÁÇπÂáªÊâìÂºÄ‰æßÊªëËèúÂçï) -->
        <div id="forumNavAvatar" class="nav-btn" style="padding: 0; border-radius: 50%; width: 34px; height: 34px; background-size: cover; background-position: center;"></div>

        <!-- ‰∏≠Èó¥Ê†áÈ¢ò -->
        <div class="nav-title" style="font-weight: 800;">ËÆ∫Âùõ</div>

        <!-- Âè≥‰æßÊåâÈíÆÁªÑ -->
        <div class="nav-right-actions">
            <!-- Âà∑Êñ∞ÊåâÈíÆ -->
            <button class="nav-btn" id="refreshForumBtn" onclick="refreshForumTimeline()">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/><path d="M22 4v4h-4"/></svg>
            </button>
            <!-- ÈÄÄÂá∫ÊåâÈíÆ -->
            <button class="nav-btn" onclick="goHome()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <!-- 2. ËßÜÂõæ A: ‰∏ªÈ°µ (ÂåÖÂê´ ÂÖ≥Ê≥®/Êé®Ëçê/ÂêåÂüé) -->
    <div class="forum-content-view active" id="forumHomeView">
        <!-- Â≠êÁâàÂùóÂàáÊç¢ -->
        <div class="trends-tabs" style="position: sticky; top: 0; z-index: 10;">
            <div class="trends-tab" onclick="switchForumSubTab('following', this)">ÂÖ≥Ê≥®</div>
            <div class="trends-tab active" onclick="switchForumSubTab('recommended', this)">Êé®Ëçê</div>
            <div class="trends-tab" onclick="switchForumSubTab('city', this)">ÂêåÂüé</div>
        </div>
        <!-- ÂÜÖÂÆπÂÆπÂô® -->
        <div id="followingTimeline" class="forum-timeline-container"></div>
        <div id="recommendedTimeline" class="forum-timeline-container active"></div>
        <div id="cityTimeline" class="forum-timeline-container"></div>
    </div>

    <!-- 3. ËßÜÂõæ B: ÊêúÁ¥¢/ÁÉ≠Êêú -->
    <div class="forum-content-view" id="forumSearchView">
        <div class="trends-header">
            <div class="trends-header-avatar" id="trendsAvatar"></div>
            <div class="trends-search-bar">
                <svg viewBox="0 0 24 24"><g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.417-.727 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.83-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.432 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g></svg>
                <input type="text" placeholder="ÊêúÁ¥¢ÁÉ≠Êêú" id="trendSearchInput" oninput="filterTrends(this.value)">
            </div>
            <!-- ‰øÆÊîπÂêéÁöÑ‰ª£Á†Å -->
        <button class="trends-header-refresh" id="refreshTrendsBtn" onclick="refreshTrends()">
                <svg viewBox="0 0 24 24"><g><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></g></svg>
            </button>
        </div>
        <div class="trends-tabs">
            <div class="trends-tab active" onclick="filterTrendsByCategory('all', this)">ÂÖ®ÈÉ®</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('Á§æ‰ºö', this)">Á§æ‰ºö</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('Â®±‰πê', this)">Â®±‰πê</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('ÁîüÊ¥ª', this)">ÁîüÊ¥ª</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('ÁßëÊäÄ', this)">ÁßëÊäÄ</div>
        </div>
        <div class="trends-list-container" id="trendsListContainer"></div>
    </div>

    <!-- 4. ËßÜÂõæ C: ÈÄöÁü•ÁöÑËßíËâ≤ÂàóË°® (Â∑≤Âà†Èô§) -->

    <!-- 5. ËßÜÂõæ D: Êàë (‰∏™‰∫∫‰∏ªÈ°µ) -->
    <div class="forum-content-view" id="forumMeView">
        <div class="forum-profile-container">
            <div class="forum-profile-header" id="forumCoverHeader">
                <div class="forum-profile-cover-upload" onclick="handleForumCoverUpload()"></div>
            </div>
            <div class="forum-profile-top-actions">
                <div class="forum-profile-avatar-container">
                    <div class="forum-profile-avatar" id="forumProfileAvatar" onclick="handleForumAvatarUpload()"></div>
                </div>
                <button class="forum-edit-profile-btn" onclick="openForumEditProfileModal()">ÁºñËæëËµÑÊñô</button>
            </div>
            <div class="forum-profile-info">
                <h3 id="forumProfileName"></h3>
                <p id="forumProfileHandle"></p>
                <p id="forumProfileBio" style="margin-bottom: 10px;"></p>
                <p id="forumProfileJoined"></p>
                <div class="forum-profile-stats">
                    <span class="forum-profile-stat-item" onclick="openFollowingList()">
                        <strong id="forumProfileFollowing">0</strong><span>Ê≠£Âú®ÂÖ≥Ê≥®</span>
                    </span>
                    <span class="forum-profile-stat-item">
                        <strong id="forumProfileFollowers">0</strong><span>ÂÖ≥Ê≥®ËÄÖ</span>
                    </span>
                </div>
            </div>
            <div class="forum-profile-tabs">
                <div class="forum-profile-tab active" data-tab="posts">Â∏ñÂ≠ê</div>
                <div class="forum-profile-tab" data-tab="replies">ÂõûÂ§ç</div>
                <div class="forum-profile-tab" data-tab="likes">ÂñúÊ¨¢</div>
            </div>
            <div id="forumProfileTimeline" class="post-list-container"></div>
        </div>
    </div>

    <!-- 6. ÊÇ¨ÊµÆÂèëÂ∏ÉÊåâÈíÆ -->
    <button id="newPostFab" onclick="openNewPostModal()">+</button>

    <!-- 7. Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="forum-bottom-nav">
        <!-- È¶ñÈ°µ -->
        <div class="forum-tab active" onclick="switchForumTab('home', this)">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><path d="M12.92 22.49h7.32c.45 0 .81-.36.81-.81V10.37a.81.81 0 0 0-.4-.7l-8.13-7.1a.81.81 0 0 0-1.02 0l-8.13 7.1a.81.81 0 0 0-.4.7v11.31c0 .45.36.81.81.81h7.32v-7.32h2.44v7.32z"></path></svg>
        </div>
        <!-- ÊêúÁ¥¢ -->
        <div class="forum-tab" onclick="switchForumTab('search', this)">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <!-- (Â∑≤Âà†Èô§ÈÄöÁü•/ÈìÉÈìõÊåâÈíÆ) -->
        <!-- Êàë -->
        <div class="forum-tab" onclick="switchForumTab('me', this)">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M4.93 19.07l14.14-14.14"></path></svg>
        </div>
    </div>
</div>

<div id="soundSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÊèêÁ§∫Èü≥ËÆæÁΩÆ</div>
        <div></div>
    </div>

    <!-- ‰ΩøÁî® bw-style ÁªßÊâøÁªü‰∏ÄÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- 1. Êé•Êî∂Ê∂àÊÅØÊèêÁ§∫Èü≥ -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">Êé•Êî∂Ê∂àÊÅØ (AIÂèëÊ∂àÊÅØÊó∂)</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">ÂºÄÂêØÊèêÁ§∫Èü≥</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="receivedSoundToggle" onchange="toggleSoundSetting('received')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group-row" id="receivedSoundUploadRow" style="display:none;">
                <label class="form-label">Èü≥È¢ëÊñá‰ª∂</label>
                <div style="display: flex; gap: 10px;">
                    <!-- ËØïÂê¨ÊåâÈíÆ -->
                    <button class="bw-chip-btn" onclick="previewSound('received')">
                        <i class="ri-play-fill"></i> ËØïÂê¨
                    </button>
                    <!-- ‰∏ä‰º†ÊåâÈíÆ -->
                    <button class="bw-chip-btn" onclick="document.getElementById('receivedSoundInput').click()">
                        <i class="ri-upload-2-line"></i> ‰∏ä‰º†
                    </button>
                </div>
            </div>
            <div class="form-hint" id="receivedSoundName" style="text-align: right; padding-bottom: 10px; display:none;">Êú™ËÆæÁΩÆÈü≥È¢ë</div>
        </div>

        <!-- 2. ÂèëÈÄÅÊ∂àÊÅØÊèêÁ§∫Èü≥ -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">ÂèëÈÄÅÊ∂àÊÅØ (ÊàëÂèëÊ∂àÊÅØÊó∂)</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">ÂºÄÂêØÊèêÁ§∫Èü≥</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="sentSoundToggle" onchange="toggleSoundSetting('sent')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group-row" id="sentSoundUploadRow" style="display:none;">
                <label class="form-label">Èü≥È¢ëÊñá‰ª∂</label>
                <div style="display: flex; gap: 10px;">
                    <button class="bw-chip-btn" onclick="previewSound('sent')">
                        <i class="ri-play-fill"></i> ËØïÂê¨
                    </button>
                    <button class="bw-chip-btn" onclick="document.getElementById('sentSoundInput').click()">
                        <i class="ri-upload-2-line"></i> ‰∏ä‰º†
                    </button>
                </div>
            </div>
            <div class="form-hint" id="sentSoundName" style="text-align: right; padding-bottom: 10px; display:none;">Êú™ËÆæÁΩÆÈü≥È¢ë</div>
        </div>

        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveSoundSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>

<!-- Ê∏∏Êàè‰∏≠ÂøÉ‰∏ªÈ°µ (ÈªëÁôΩÊûÅÁÆÄÁâà) -->
<div id="gamesApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Ê∏∏Êàè‰∏≠ÂøÉ</div>
        <div></div>
    </div>

    <!-- ‰ΩøÁî® bw-style ÁªßÊâøÁªü‰∏ÄÁöÑÈªëÁôΩÈ£éÊ†º -->
    <div class="settings-content bw-style">

        <!-- Ê∏∏ÊàèÂç°ÁâáÔºö‰Ω†ÊºîÊàëÁåú -->
        <div class="game-card" onclick="openCharadesGameSelect()">
            <div class="game-card-icon">
                <i class="ri-tv-2-line"></i>
            </div>
            <div class="game-card-title">‰Ω†ÊºîÊàëÁåú</div>
            <div class="game-card-desc">ËÄÉÈ™åÈªòÂ•ëÁöÑÊó∂ÂàªÔºå‰∏Ä‰∫∫ÊèèËø∞‰∏Ä‰∫∫Áåú</div>
        </div>

        <!-- ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Êõ¥Â§öÊ∏∏ÊàèÂç°Áâá (Âç†‰Ωç) -->
        <!--
        <div class="game-card" onclick="showAlert('Êï¨ËØ∑ÊúüÂæÖ')">
            <div class="game-card-icon"><i class="ri-gamepad-line"></i></div>
            <div class="game-card-title">Êñ∞Ê∏∏ÊàèÂºÄÂèë‰∏≠</div>
            <div class="game-card-desc">Êõ¥Â§öÁ≤æÂΩ©Âç≥Â∞Ü‰∏äÁ∫ø</div>
        </div>
        -->

    </div>
</div>

</div>

<!-- ‚Äú‰Ω†ÊºîÊàëÁåú‚Äù Ê∏∏ÊàèÁïåÈù¢ -->
<div id="charadesGameScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="exitCharadesGame()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰Ω†ÊºîÊàëÁåú</div>
        <div style="display: flex; align-items: center; gap: 5px; z-index: 20;">
        <button class="nav-btn" onclick="toggleCharadesRole()" title="ÂàáÊç¢ËßíËâ≤">
            <i class="ri-exchange-line" style="font-size: 20px;"></i>
        </button>
        <button class="nav-btn" onclick="startNewCharadesRound()" title="ÈáçÂºÄ">
            <i class="ri-refresh-line" style="font-size: 20px;"></i>
        </button>
    </div>
    </div>

    <!-- Ê∏∏Êàè‰∏ªÂå∫Âüü -->
    <div class="wechat-content" style="display: flex; flex-direction: column; background: #fdfbf5;">

        <!-- 1. È°∂ÈÉ®Ê∏∏ÊàèÈù¢Êùø (Ê®°‰ªøÂõæÁâáÊ†∑Âºè) -->
        <div class="charades-top-panel">

            <!-- Â∑¶‰æßÔºöÁ≠îÈ¢òÊñπ (AI) -->
            <div class="player-badge ai-side">
                <div class="badge-label">Á≠îÈ¢òÊñπ</div>
                <div class="game-avatar" id="charadesAiAvatar"></div>
            </div>

            <!-- ‰∏≠Èó¥ÔºöÁîµËßÜÊú∫È¢òÁõÆÊòæÁ§∫ -->
            <div class="tv-container">
                <div class="tv-antenna-left"></div>
                <div class="tv-antenna-right"></div>
                <div class="tv-frame">
                    <div class="tv-screen">
                        <div id="charadesTargetWord">È¢òÁõÆÂä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div class="tv-controls">
                        <div class="tv-knob"></div>
                        <div class="tv-knob"></div>
                        <div class="tv-speaker">|||</div>
                    </div>
                </div>
                <div class="tv-legs">
                    <div class="tv-leg-left"></div>
                    <div class="tv-leg-right"></div>
                </div>
            </div>

            <!-- Âè≥‰æßÔºöË°®ÊºîÊñπ (Êàë) -->
            <div class="player-badge user-side">
                <div class="badge-label">Ë°®ÊºîÊñπ</div>
                <div class="game-avatar" id="charadesUserAvatar"></div>
            </div>
        </div>

        <!-- ÊèêÁ§∫Ê†è -->
        <div class="charades-status-bar">
            <span id="charadesStatusText">ËØ∑ÊèèËø∞ÔºåËÆ©ÂØπÊñπÁåúÂá∫Â±èÂπï‰∏äÁöÑËØç</span>
        </div>

        <!-- ... ‰∏äÈù¢ÁöÑ .charades-status-bar ‰øùÊåÅ‰∏çÂèò ... -->

<!-- 2. ‰∏≠Èó¥ËÅäÂ§©ÁåúËØçÂå∫ (‰øùÊåÅÂéüIDÔºåÂêéÈù¢Áî®CSSÂéªËÉåÊôØ) -->
<div id="charadesChatArea" class="chat-messages">
    <!-- Ê∏∏ÊàèËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
</div>

<!-- 3. Â∫ïÈÉ®ËæìÂÖ•Ê°Ü (‰øÆÊîπÁâà) -->
<div class="chat-input" id="charadesInputBar">
     <!-- Êé•Êî∂/ËÆ©AIÁåúÊåâÈíÆ -->
     <!-- ÊâæÂà∞ id="charadesGuessBtn" -->
<button class="chat-btn" id="charadesGuessBtn" onclick="handleCharadesLightbulbClick()" title="ÊèêÁ§∫/ËÆ©TAÁåú">
    <i class="ri-lightbulb-flash-line"></i>
</button>

     <!-- ËæìÂÖ•Ê°Ü -->
     <textarea id="charadesInput" rows="1" placeholder="ÊèèËø∞Ëøô‰∏™ËØç..."></textarea>

     <!-- ÂèëÈÄÅÊåâÈíÆ (Êç¢ÊàêÂõæÊ†á) -->
     <!-- ÂèëÈÄÅÊåâÈíÆ (ÈÄèÊòéËÉåÊôØÔºåÁ∫ØÂõæÊ†á) -->
<button class="chat-btn" onclick="sendCharadesMessage()" style="color: #333; padding: 0 10px;">
   <i class="ri-send-plane-2-fill" style="font-size: 24px;"></i>
</button>
</div>
    </div>
</div>

<!-- Ê∏∏ÊàèÂ•ΩÂèãÈÄâÊã©ÂºπÁ™ó -->
<div id="gameFriendSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©‰∏Ä‰ΩçÂ•ΩÂèã‰∏ÄËµ∑Áé©</div>
        <div id="gameFriendList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('gameFriendSelectModal').classList.remove('show')">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- Ë°•ÂÖ®Áº∫Â§±ÁöÑÈü≥Ëâ≤IDËæìÂÖ•ÂºπÁ™ó -->
<div id="voiceIdModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ËÆæÁΩÆÈü≥Ëâ≤ID</div>
        <input type="text" class="modal-input" id="voiceIdInput" placeholder="ËØ∑ËæìÂÖ•MiniMaxÈü≥Ëâ≤ID">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeVoiceIdModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveVoiceId()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
<!-- CharÊó•Á®ãËÆæÁΩÆÈ°µÈù¢ (ÁªìÊûÑÂåñÁâà) -->
<div id="charScheduleSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">CharÊó•Á®ãËÆæÁΩÆ</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 1. Êó•Â∏∏‰ΩúÊÅØ (Êó©Áù°Êó©Ëµ∑) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 5px;">
                <label class="form-label" style="font-weight: bold;"><i class="ri-sun-line"></i> Êó•Â∏∏‰ΩúÊÅØ</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label sub-label">ÁîüÊ¥ªËßÑÂæã</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="schedDailyRegular" onchange="toggleScheduleSection('daily', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ËßÑÂæãÊó∂ÊòæÁ§∫ÁöÑÂÜÖÂÆπ -->
            <div id="schedDailyDetails" style="display: none; padding-bottom: 15px;">
                <div class="form-group-row" style="border:none; padding: 5px 0;">
                    <label class="form-label sub-label" style="font-size: 13px;">Ëµ∑Â∫äÊó∂Èó¥</label>
                    <input type="time" id="schedWakeTime" class="form-input" style="text-align: right;">
                </div>
                <div class="form-group-row" style="border:none; padding: 5px 0;">
                    <label class="form-label sub-label" style="font-size: 13px;">Áù°ËßâÊó∂Èó¥</label>
                    <input type="time" id="schedSleepTime" class="form-input" style="text-align: right;">
                </div>
            </div>
        </div>

        <!-- 2. ‰∏ÄÊó•‰∏âÈ§ê -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 5px;">
                <label class="form-label" style="font-weight: bold;"><i class="ri-restaurant-2-line"></i> ‰∏ÄÊó•‰∏âÈ§ê</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label sub-label">ÊåâÊó∂ÂêÉÈ•≠</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="schedMealRegular" onchange="toggleScheduleSection('meal', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ËßÑÂæãÊó∂ÊòæÁ§∫ÁöÑÂÜÖÂÆπ -->
            <div id="schedMealDetails" style="display: none; padding-bottom: 15px;">
                <div class="form-group-row" style="border:none; padding: 5px 0;">
                    <label class="form-label sub-label" style="font-size: 13px;">Êó©È§êÊó∂Èó¥</label>
                    <input type="time" id="schedBreakfastTime" class="form-input" style="text-align: right;">
                </div>
                <div class="form-group-row" style="border:none; padding: 5px 0;">
                    <label class="form-label sub-label" style="font-size: 13px;">ÂçàÈ§êÊó∂Èó¥</label>
                    <input type="time" id="schedLunchTime" class="form-input" style="text-align: right;">
                </div>
                <div class="form-group-row" style="border:none; padding: 5px 0;">
                    <label class="form-label sub-label" style="font-size: 13px;">ÊôöÈ§êÊó∂Èó¥</label>
                    <input type="time" id="schedDinnerTime" class="form-input" style="text-align: right;">
                </div>
            </div>
        </div>

 <!-- ... ÂâçÈù¢ÁöÑÊó•Â∏∏‰ΩúÊÅØÂíå‰∏ÄÊó•‰∏âÈ§êÂç°Áâá‰øùÊåÅ‰∏çÂèò ... -->

<!-- 3. Â∑•‰Ωú/Â≠¶‰π†ÂÆâÊéí (Â§öÊù°ÁõÆÁâà) -->
<div class="form-card">
    <div class="form-group-row" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; justify-content: space-between;">
        <label class="form-label" style="font-weight: bold;"><i class="ri-briefcase-line"></i> Â∑•‰Ωú/Â≠¶‰π†</label>
        <button class="nav-btn" style="font-size: 13px; background: #f0f0f0; padding: 4px 10px; border-radius: 12px;" onclick="addScheduleItem('work')">+ Ê∑ªÂä†</button>
    </div>
    <!-- ÂÆπÂô®ÔºöÁî®‰∫éÂ≠òÊîæÂä®ÊÄÅÁîüÊàêÁöÑÂ∑•‰ΩúÊù°ÁõÆ -->
    <div id="schedWorkListContainer"></div>
</div>

<!-- 4. ‰ºëÈó≤Ê¥ªÂä® (Â§öÊù°ÁõÆ + ÊòüÊúüÈÄâÊã©Áâà) -->
<div class="form-card">
    <div class="form-group-row" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; justify-content: space-between;">
        <label class="form-label" style="font-weight: bold;"><i class="ri-gamepad-line"></i> ‰ºëÈó≤Ê¥ªÂä®</label>
        <button class="nav-btn" style="font-size: 13px; background: #f0f0f0; padding: 4px 10px; border-radius: 12px;" onclick="addScheduleItem('leisure')">+ Ê∑ªÂä†</button>
    </div>
    <!-- ÂÆπÂô®ÔºöÁî®‰∫éÂ≠òÊîæÂä®ÊÄÅÁîüÊàêÁöÑ‰ºëÈó≤Êù°ÁõÆ -->
    <div id="schedLeisureListContainer"></div>
</div>

        <!-- 5. ‰∏•Ê†ºÊ®°ÂºèÂºÄÂÖ≥ -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">‰∏•Ê†ºÊâßË°åÊó∂Èó¥Ë°®</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="charScheduleStrictToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-hint">ÂºÄÂêØÂêéÔºåAIÂú®Â∑•‰Ωú/Áù°ËßâÊó∂Èó¥‰ºöË°®Áé∞ÂæóÊó†Ê≥ïÁßíÂõûÔºåÊàñËÄÖËØ≠Ê∞îÂåÜÂøô„ÄÇ</div>
        </div>

        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveCharScheduleSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>


<!-- ÊîØ‰ªòÂØÜÁ†ÅÂçäÂ±èÂºπÁ™ó -->
<div id="paymentInputModal" class="payment-modal-overlay">
    <div class="payment-modal-content">
        <div class="pay-header">
            <div class="pay-close" onclick="closePaymentModal()"><i class="ri-close-line"></i></div>
            <div class="pay-title">ËØ∑ËæìÂÖ•ÊîØ‰ªòÂØÜÁ†Å</div>
        </div>
        <div class="pay-info">
            <div class="pay-to-user" id="payTargetName">ÂêëÊüê‰∫∫ËΩ¨Ë¥¶</div>
            <div class="pay-amount" id="payDisplayAmount">¬• 0.00</div>
        </div>
        <div class="pay-method-row" onclick="openPaymentMethodSelect()">
            <div class="pay-method-label">‰ªòÊ¨æÊñπÂºè</div>
            <div class="pay-method-value" id="currentPayMethodName">
                <i class="ri-wallet-3-fill" style="color:#f2c353; margin-right:5px;"></i>Èõ∂Èí±
            </div>
            <i class="ri-arrow-right-s-line" style="color:#ccc;"></i>
        </div>

        <!-- 6‰ΩçÂØÜÁ†ÅÊ°Ü -->
        <div class="pay-pwd-box">
            <div class="pwd-dot" id="pwd-1"></div>
            <div class="pwd-dot" id="pwd-2"></div>
            <div class="pwd-dot" id="pwd-3"></div>
            <div class="pwd-dot" id="pwd-4"></div>
            <div class="pwd-dot" id="pwd-5"></div>
            <div class="pwd-dot" id="pwd-6"></div>
        </div>

        <!-- Êï∞Â≠óÈîÆÁõò -->
        <div class="pay-keypad">
            <div class="key" onclick="pressPayKey(1)">1</div>
            <div class="key" onclick="pressPayKey(2)">2</div>
            <div class="key" onclick="pressPayKey(3)">3</div>
            <div class="key" onclick="pressPayKey(4)">4</div>
            <div class="key" onclick="pressPayKey(5)">5</div>
            <div class="key" onclick="pressPayKey(6)">6</div>
            <div class="key" onclick="pressPayKey(7)">7</div>
            <div class="key" onclick="pressPayKey(8)">8</div>
            <div class="key" onclick="pressPayKey(9)">9</div>
            <div class="key bg-grey"></div>
            <div class="key" onclick="pressPayKey(0)">0</div>
            <div class="key bg-grey" onclick="pressPayKey('del')"><i class="ri-delete-back-line"></i></div>
        </div>
    </div>
</div>

<!-- ÈÄâÊã©‰ªòÊ¨æÊñπÂºèÂºπÁ™ó -->
<div id="paymentMethodModal" class="modal">
    <div class="modal-content" style="position: absolute; bottom: 0; width: 100%; border-radius: 16px 16px 0 0; padding: 0; max-height: 60vh; overflow-y: auto;">
        <div class="modal-title" style="padding: 15px; border-bottom: 1px solid #eee; margin:0;">ÈÄâÊã©‰ªòÊ¨æÊñπÂºè</div>
        <div id="paymentMethodList" class="friend-list">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="modal-buttons" style="padding: 15px;">
             <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('paymentMethodModal').classList.remove('show')">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºö‰∫≤Â±ûÂç°Ê∂àË¥πÂèçÈ¶àÂºπÁ™ó -->
<div id="fcReactionModal" class="modal">
    <div class="fc-reaction-card">
        <!-- Ë£ÖÈ•∞ËÉåÊôØ -->
        <div class="fc-reaction-bg"></div>

        <!-- Â§¥ÂÉè -->
        <div class="fc-reaction-avatar" id="fcReactionAvatar"></div>

        <!-- Ê†áÈ¢ò -->
        <div class="fc-reaction-title">
            <span id="fcReactionName">ÂØπÊñπ</span> ÁïôÊÑèÂà∞‰∫Ü‰Ω†ÁöÑÊ∂àË¥π
        </div>

        <!-- Ê∂àË¥πÈáëÈ¢ùÊèêÁ§∫ -->
        <div class="fc-reaction-meta" id="fcReactionMeta">
            Ê∂àË¥π ¬•0.00
        </div>

        <!-- ÁïôË®ÄÂÜÖÂÆπ (Ê†∏ÂøÉ) -->
        <div class="fc-reaction-content">
            <i class="ri-double-quotes-l quote-icon-left"></i>
            <span id="fcReactionText">...</span>
            <i class="ri-double-quotes-r quote-icon-right"></i>
        </div>

        <!-- ÊåâÈíÆ -->
        <button class="fc-reaction-btn" onclick="document.getElementById('fcReactionModal').classList.remove('show')">
            ÊàëÁü•ÈÅì‰∫Ü
        </button>
    </div>
</div>

<!-- ÁæéÂåñÂêéÁöÑÂèëÂ∏ÉÂàÜÁ±ªÈÄâÊã©ÂºπÁ™ó -->
<div id="doujinCategorySelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©ÂèëÂ∏ÉÊùøÂùó</div>

        <!-- ‰ΩøÁî® flex Â∏ÉÂ±ÄÁöÑÊ†áÁ≠æÂÆπÂô® -->
        <div id="doujinCategoryList" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 50vh; overflow-y: auto; padding: 5px;">
            <!-- JS Âä®ÊÄÅÁîüÊàêÊºÇ‰∫ÆÁöÑÊ†áÁ≠æ -->
        </div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="document.getElementById('doujinCategorySelectModal').classList.remove('show')">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<!-- ÈÄÅÁ§ºÁâ©ÂºπÁ™ó -->
<div id="doujinGiftModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 450px;">
        <div class="modal-title">ÊâìËµè‰ΩúËÄÖ</div>
        <div class="gift-tip">ËØ•Á§ºÁâ©ÊâìËµèÁöÑÈáëÈ¢ù‰ºöËøõ‰ΩúËÄÖÁöÑË¥¶Êà∑</div>
        <div id="giftListContainer" class="gift-grid-container">
            <!-- JSÁîüÊàêÁ§ºÁâ©ÂàóË°® -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closeDoujinGiftModal()">ÂèñÊ∂à</button>
            <button class="modal-btn confirm" onclick="confirmDoujinGiftSelection()">Á°ÆËÆ§ÊîØ‰ªò</button>
        </div>
    </div>
</div>

<!-- ‰∏¢È∏°ËõãÂºπÁ™ó -->
<div id="doujinEggModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 450px;">
        <div class="modal-title">Á†∏Âú∫Â≠ê</div>
        <div class="gift-tip" style="color: #ff4d4d;">ËØ•ÈáëÈ¢ùÂÖ®ÈÉ®ÂΩíÂπ≥Âè∞ÊâÄÊúâÔºå‰∏ç‰ºöÁªô‰ΩúËÄÖ</div>
        <div id="eggListContainer" class="gift-grid-container">
            <!-- JSÁîüÊàêÈÅìÂÖ∑ÂàóË°® -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closeDoujinEggModal()">ÂèñÊ∂à</button>
            <button class="modal-btn confirm" onclick="confirmDoujinEggSelection()">Á°ÆËÆ§ÊîØ‰ªò</button>
        </div>
    </div>
</div>

<!-- Á§ºÁâ©Âä®ÁîªÂ±Ç -->
<div id="giftAnimationOverlay"></div>

<!-- Êñ∞Â¢ûÔºöÁ£ïCPËÆæÂÆöÂºπÁ™ó -->
<div class="modal" id="cpRunSettingsModal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©CP‰∏éËÆæÂÆö</div>

        <!-- 1. CPÈÄâÊã©Âå∫Âüü -->
        <div class="doujin-modal-setting-group">
            <label>ÈÄâÊã©‰∏ÄÂØπCP (ÂçïÈÄâ)</label>
            <div id="cpRunSelectContainer" class="char-select-container" style="max-height: 150px;">
                <!-- JS Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <!-- 2. Âêå‰∫∫Ê¢óÈÄâÊã©Âå∫Âüü (Â§çÁî®Â∑≤ÊúâÊ†∑Âºè) -->
        <div class="doujin-modal-setting-group">
            <label>
                ÈÄâÊã©Âêå‰∫∫Ê¢ó
                <i class="fas fa-pencil-alt" style="cursor:pointer; color:#999; font-size:14px; margin-left:8px;" onclick="doujinToggleTropeEditMode(this)"></i>
            </label>
            <div id="cpRunTropeContainer" class="trope-selection-area">
                <!-- JS Âä®ÊÄÅÁîüÊàêÔºå‰∏é‰∏ªÈ°µ‰∫íÈÄö -->
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="document.getElementById('cpRunSettingsModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn confirm" onclick="doujinConfirmCpRunSettings()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- ÂïÜÂ∫óApp (Store App) -->
<div id="storeApp" class="page">
    <!-- A. È¶ñÈ°µËßÜÂõæ -->
    <div id="storeHomeView" class="store-page-view active">
        <!-- È°∂ÈÉ®ÊêúÁ¥¢Ê†è -->
       <div class="store-top-bar">
    <!-- „ÄêÊñ∞Â¢û„ÄëËøîÂõûÊåâÈíÆÂú®ËøôÈáå -->
    <button class="store-back-btn" onclick="goHome()">
        <i class="ri-arrow-left-s-line"></i>
    </button>

    <!-- ÂéüÊúâÁöÑÊêúÁ¥¢Ê°Ü -->
    <div class="store-search-box">
    <i class="ri-search-line" style="font-size: 16px;"></i>
    <!-- ËøôÈáåÁöÑ onkeydown ÁªëÂÆö‰∫Ü‰∏ãÈù¢ÁöÑÊñ∞ÂáΩÊï∞ -->
    <input type="text" id="storeSearchInput" class="store-search-input" placeholder="ÊêúÁ¥¢ÂÆùË¥ù..." onkeydown="handleStoreSearchKey(event)">
    <i class="ri-close-circle-fill" id="storeSearchClearBtn" onclick="clearStoreSearch()" style="display:none; color:#ccc; cursor:pointer;"></i>
</div>

    <!-- ÂéüÊúâÁöÑÂà∑Êñ∞ÊåâÈíÆ -->
    <button class="store-refresh-btn" onclick="refreshStoreGoods()">
        <i class="ri-refresh-line"></i>
    </button>
</div>

        <!-- ÂàÜÁ±ªÂØºËà™ -->
        <div class="store-category-tabs">
            <div class="store-cat-item active" onclick="switchStoreCategory(this, 'Êé®Ëçê')">Êé®Ëçê</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'Â§ñÂçñ')">Â§ñÂçñ</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'ÊúçÈ•∞')">ÊúçÈ•∞</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'ÁæéÂ¶Ü')">ÁæéÂ¶Ü</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'Êï∞Á†Å')">Êï∞Á†Å</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'ÂÆ∂ÂÖ∑')">ÂÆ∂ÂÖ∑</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, 'Âá∫Ë°å')">Âá∫Ë°å</div>
    <div class="store-cat-item" onclick="switchStoreCategory(this, 'ÊÉÖË∂£')">ÊÉÖË∂£</div>
        </div>

        <!-- ÂïÜÂìÅÁÄëÂ∏ÉÊµÅÂÆπÂô® -->
        <div class="store-waterfall" id="storeGoodsList">
            <!-- JSÂ∞ÜÂú®ËøôÈáåÁîüÊàêÂç°Áâá -->
        </div>
    </div>

<!-- B. Ë¥≠Áâ©ËΩ¶ËßÜÂõæ -->
    <div id="storeCartView" class="store-page-view">
        <!-- 1. È°∂ÈÉ®ÂØºËà™Ê†è -->
        <div class="nav-bar" style="background: #fff; border-bottom: 1px solid #eee;">
            <div class="nav-title" style="font-weight: bold;">Ë¥≠Áâ©ËΩ¶ (0)</div>
            <!-- Êñ∞Â¢ûÔºöÂàÜ‰∫´‰ª£‰ªòÊåâÈíÆ -->
            <button class="nav-btn" style="position: absolute; right: 15px; color: #333;" onclick="openCartShareModal()">
                <i class="ri-share-forward-line" style="font-size: 24px;"></i>
            </button>
        </div>

        <!-- 2. ÂàóË°®ÂÆπÂô® -->
        <div class="store-cart-list" id="storeCartList">
            <!-- Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫ -->
            <div style="text-align: center; padding: 50px; color: #999;">
                <i class="ri-shopping-cart-2-line" style="font-size: 40px;"></i>
                <p>Ë¥≠Áâ©ËΩ¶Á©∫Á©∫Â¶Ç‰πü</p>
            </div>
        </div>

        <!-- 3. Â∫ïÈÉ®ÁªìÁÆóÊ†è -->
        <div class="store-cart-footer">
            <div style="display:flex; align-items:center; gap:8px; font-size:13px;">
                <div class="store-check-circle"></div> ÂÖ®ÈÄâ
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:14px;">ÂêàËÆ°: <b>¬•0.00</b></span>
                <div class="store-checkout-btn">ÁªìÁÆó (0)</div>
            </div>
        </div>
    </div>

    <!-- C. ÊàëÁöÑËßÜÂõæ -->
    <div id="storeMeView" class="store-page-view">
        <!-- Â§¥ÈÉ® -->
        <div class="store-me-header">
            <div class="store-me-avatar" id="storeUserAvatar" style="background-image: url(''); background-size: cover;"></div>
            <div class="store-me-name" id="storeUserName">Áî®Êà∑Âêç</div>
        </div>

        <!-- ËÆ¢ÂçïÁä∂ÊÄÅ -->
        <div class="store-me-grid">
            <div><i class="store-me-icon ri-wallet-3-line"></i><span class="store-me-label">ÂæÖ‰ªòÊ¨æ</span></div>
            <!-- Ê∑ªÂä† onclick="openStorePendingShipment()" -->
<div onclick="openStorePendingShipment()" style="cursor: pointer;">
    <i class="store-me-icon ri-box-3-line"></i>
    <span class="store-me-label">ÂæÖÂèëË¥ß</span>
</div>
<div onclick="openStoreShippedOrders()" style="cursor: pointer;">
    <i class="store-me-icon ri-truck-line"></i>
    <span class="store-me-label">ÂæÖÊî∂Ë¥ß</span>
</div>
<div onclick="openStorePendingReview()" style="cursor: pointer;">
    <i class="store-me-icon ri-message-2-line"></i>
    <span class="store-me-label">ÂæÖËØÑ‰ª∑</span>
</div>


        </div>

        <!-- Â∑•ÂÖ∑Ê†è -->
        <div class="store-me-grid" style="margin-top: 10px;">
            <div><i class="store-me-icon ri-star-line"></i><span class="store-me-label">Êî∂ËóèÂ§π</span></div>
            <div><i class="store-me-icon ri-footprint-line"></i><span class="store-me-label">Ë∂≥Ëøπ</span></div>
            <div><i class="store-me-icon ri-coupon-2-line"></i><span class="store-me-label">Á∫¢ÂåÖÂç°Âà∏</span></div>
            <div><i class="store-me-icon ri-customer-service-2-line"></i><span class="store-me-label">ÂÆ¢Êúç</span></div>
        </div>
    </div>

<!-- D. Êñ∞Â¢ûÔºöÂæÖÂèëË¥ßËßÜÂõæ -->
    <div id="storePendingShipmentView" class="store-page-view">
        <div class="store-top-bar">
            <button class="store-back-btn" onclick="switchStoreTab('me', document.querySelector('.store-tab-item[onclick*=\'me\']'))">
                <i class="ri-arrow-left-s-line"></i>
            </button>
            <div style="flex:1; text-align:center; font-weight:bold; font-size:16px;">ÂæÖÂèëË¥ß</div>
            <div style="width: 30px;"></div> <!-- Âç†‰ΩçÔºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠ -->
        </div>

        <div class="store-cart-list" id="storePendingShipmentList" style="background: #f5f5f5;">
            <!-- JS Â∞ÜÂú®ËøôÈáåÁîüÊàêËÆ¢ÂçïÂç°Áâá -->
        </div>
    </div>
    <!-- F. Êñ∞Â¢ûÔºöÂæÖËØÑ‰ª∑ËßÜÂõæ -->
<div id="storePendingReviewView" class="store-page-view">
    <div class="store-top-bar">
        <button class="store-back-btn" onclick="switchStoreTab('me', document.querySelector('.store-tab-item:nth-child(3)'))">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div style="flex:1; text-align:center; font-weight:bold; font-size:16px;">ÂæÖËØÑ‰ª∑</div>
        <div style="width: 30px;"></div>
    </div>

    <div class="store-cart-list" id="storePendingReviewList" style="background: #f5f5f5;">
        <!-- JS Â∞ÜÂú®ËøôÈáåÁîüÊàêÂæÖËØÑ‰ª∑Âç°Áâá -->
    </div>
</div>


    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="store-bottom-bar">
        <div class="store-tab-item active" onclick="switchStoreTab('home', this)">
            <i class="store-tab-icon ri-home-smile-2-line"></i>
            <span class="store-tab-label">È¶ñÈ°µ</span>
        </div>
        <div class="store-tab-item" onclick="switchStoreTab('cart', this)">
            <i class="store-tab-icon ri-shopping-cart-2-line"></i>
            <span class="store-tab-label">Ë¥≠Áâ©ËΩ¶</span>
        </div>
        <div class="store-tab-item" onclick="switchStoreTab('me', this)">
            <i class="store-tab-icon ri-user-smile-line"></i>
            <span class="store-tab-label">ÊàëÁöÑ</span>
        </div>
    </div>
</div>

<!-- Êó•ËÆ∞ËÆæÁΩÆÂºπÁ™ó -->

<!-- Êó•ËÆ∞ËÆæÁΩÆÂºπÁ™ó (ÊîØÊåÅÈ¢ëÁéáËÆæÁΩÆÁâà) -->
<div id="diarySettingsModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 30px 25px;">
        <div class="modal-title" style="color: #000; font-weight: 700;">Êó•ËÆ∞ËÆæÁΩÆ</div>

        <!-- Ëá™Âä®ÂÜôÊó•ËÆ∞ÂºÄÂÖ≥ -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">ÂºÄÂêØËá™Âä®ÂÜôÊó•ËÆ∞</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="diaryAutoWriteToggle" onchange="toggleDiaryAutoWrite()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.4;">
                ÂºÄÂêØÂêéÔºåËßíËâ≤‰ºöÊ†πÊçÆ‰Ω†ËÆæÂÆöÁöÑÈ¢ëÁéáËá™Âä®ÁîüÊàêÊó•ËÆ∞„ÄÇ
            </div>
        </div>

        <!-- „ÄêÊñ∞Â¢û„ÄëÈ¢ëÁéáËÆæÁΩÆ (ÈªòËÆ§ÈöêËóèÔºåÂºÄÂêØÂºÄÂÖ≥ÂêéÊòæÁ§∫) -->
        <div class="form-group" id="diaryFreqGroup" style="display: none; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <label class="form-label" style="color: #000; font-weight: 500; margin-bottom: 8px; display:block;">ÁîüÊàêÈ¢ëÁéá (Â§©/ÁØá)</label>
            <input type="number" class="modal-input" id="diaryFreqInput" placeholder="‰æãÂ¶ÇÔºö1 (‰ª£Ë°®ÊØèÂ§©‰∏ÄÁØá)" min="1" style="background-color: #f7f7f7;">
        </div>
         <!-- ‚ñº‚ñº‚ñº ÊèíÂÖ•ÂºÄÂßãÔºöËá™ÂÆö‰πâÊó∂Èó¥ÂíåÂë®ËÆ∞ÂºÄÂÖ≥ ‚ñº‚ñº‚ñº -->

        <!-- ËÆæÂÆöÊØèÂ§©Âá†ÁÇπÂÜôÊó•ËÆ∞ -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <label class="form-label" style="color: #000; font-weight: 500; margin-bottom: 8px; display:block;">ÁîüÊàêÊó∂Èó¥ (ÊØèÊó•/Âë®)</label>
            <input type="time" class="modal-input" id="diaryTimeInput" style="background-color: #f7f7f7;">
            <div style="font-size: 12px; color: #999; margin-top: 5px;">Â¶ÇÊûú‰∏çËÆæÁΩÆÔºåÂ∞ÜÁî±Á≥ªÁªüÈöèÊú∫ÂÜ≥ÂÆö„ÄÇ</div>
        </div>

        <!-- ÂºÄÂêØÂë®ËÆ∞Ê®°Âºè -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">ÂºÄÂêØÂë®ËÆ∞Ê®°Âºè</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="diaryWeeklyToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.4;">
                ÂºÄÂêØÂêéÔºåÊØèÂë®Êó•Êôö‰∏ä‰ºöÈ¢ùÂ§ñÁîüÊàê‰∏ÄÁØá‚ÄúÊú¨Âë®ÊÄªÁªì‚Äù„ÄÇ
            </div>
        </div>

        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊèíÂÖ•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
 <!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºöËá™Âä®Êó•ËÆ∞ËßíËâ≤ÈÄâÊã© (ÊèíÂÖ•Âú®ËøôÈáå) ‚ñº‚ñº‚ñº -->
        <div class="form-group" id="diaryRoleSelectGroup" style="display: none; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="openDiaryRoleSelectModal()">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500; cursor: pointer;">ÈÄâÊã©ÂÖÅËÆ∏ÂÜôÊó•ËÆ∞ÁöÑËßíËâ≤</label>
                <div class="form-value-display">ÁÇπÂáªÈÄâÊã© <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                ÈÄâ‰∏≠ÂêéÔºåÂè™ÊúâËøô‰∫õËßíËâ≤Âú®Êª°Ë∂≥ËÅäÂ§©È¢ëÁéáÊù°‰ª∂Êó∂Êâç‰ºöÂÜôÊó•ËÆ∞„ÄÇ
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ÊñáÈ£éÈÄâÊã© -->
        <div class="form-group" style="margin-bottom: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">ÂÖ®Â±ÄÊó•ËÆ∞ÊñáÈ£é</label>
                <button class="nav-btn" style="font-size: 14px; color: #000; font-weight: bold;" onclick="openDiaryStyleAddModal()">+ Ê∑ªÂä†</button>
            </div>
            <div id="currentDiaryStyleDisplay" class="form-input" style="line-height: 2.5; cursor: pointer; text-align: center; background: #f7f7f7; border-radius: 12px; color: #333; border: none;" onclick="openDiaryStyleSelectModal()">
                Êó† (ÈªòËÆ§)
            </div>
        </div>

        <div class="modal-buttons" style="margin-top: 25px;">
            <button class="modal-btn modal-btn-confirm" onclick="saveAndCloseDiarySettings()" style="background-color: #000; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>


<!-- ÊñáÈ£éÈÄâÊã©ÂàóË°®ÂºπÁ™ó -->
<div id="diaryStyleSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©ÊñáÈ£é</div>
        <div id="diaryStyleList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JSÁîüÊàêÂàóË°® -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryStyleSelectModal').classList.remove('show')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- Ê∑ªÂä†/ÁºñËæëÊñáÈ£éÂºπÁ™ó -->
<div id="diaryStyleEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÁºñËæëÊñáÈ£é</div>
        <input type="text" class="modal-input" id="diaryStyleTitleInput" placeholder="ÊñáÈ£éÂêçÁß∞ (‰æãÂ¶ÇÔºöÂèëÁñØÊñáÂ≠¶)">
        <textarea class="modal-textarea" id="diaryStyleContentInput" placeholder="ÂÖ∑‰ΩìÁöÑÊñáÈ£éÊåá‰ª§... ‰æãÂ¶ÇÔºöÂ§ö‰ΩøÁî®ÊÑüÂèπÂè∑ÔºåÊÉÖÁª™ÊøÄÂä®ÔºåÈÄªËæëË∑≥Ë∑É„ÄÇ" style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryStyleEditModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveDiaryStyle()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥‰∏ªÈ°µ -->
<div id="loversSpaceScreen" class="page">
    <div class="nav-bar">
       <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÊÉÖ‰æ£Á©∫Èó¥</div>
        <button class="nav-btn nav-right-action-btn" onclick="openLoversInviteModal()">+</button>
    </div>
    <div class="wechat-content" style="background: #f7f7f7; padding: 15px; padding-top: 88px;">
        <!-- ËøôÈáåÂ∞ÜÂä®ÊÄÅÊ∏≤ÊüìÂ∑≤ÁªìÊàêÁöÑÊÉÖ‰æ£Âç°Áâá -->
        <div id="loversListContainer" style="display: flex; flex-direction: column; gap: 15px;"></div>
    </div>
</div>

<!-- ÈÇÄËØ∑Â•ΩÂèãÁöÑÂºπÁ™ó -->
<div id="loversInviteModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÇÄËØ∑ÂºÄÂêØÊÉÖ‰æ£Á©∫Èó¥</div>
        <div id="loversInviteFriendList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('loversInviteModal').classList.remove('show')">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmLoversInvite()">ÂèëÈÄÅÈÇÄËØ∑</button>
        </div>
    </div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥ËØ¶ÊÉÖÈ°µ (ÁßªÊ§çËá™ 29.txt) -->
<div id="loversDetailScreen" class="page">
    <!-- È°∂ÈÉ®ËÉåÊôØÂõæÂå∫Âüü -->
    <div class="lovers-header-bg" onclick="document.getElementById('lovers-bg-input').click()">
        <img src="https://via.placeholder.com/500x220/ffb6d9/ffffff?text=ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ" alt="ËÉåÊôØÂ∞ÅÈù¢" id="lovers-home-bg-img">
        <input type="file" id="lovers-bg-input" accept="image/*" style="display: none;" onchange="handleLoversBgUpload(event)">
              <div class="lovers-nav-bar">
            <!-- „Äê‰øÆÂ§ç„ÄëÊ∑ªÂä† event.stopPropagation(); ÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂Á©øÈÄèÂà∞ËÉåÊôØÂõæ -->
            <button class="lovers-icon-btn-round" onclick="event.stopPropagation(); backToLoversList()">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>


        <div class="lovers-avatar-section">
            <div class="lovers-avatar-wrapper">
                <!-- ÂØπÊñπÂ§¥ÂÉè -->
                <div id="lovers-friend-avatar" class="lovers-avatar" style="background-color: #eee;"></div>
            </div>
            <div class="lovers-avatar-wrapper">
                <!-- ÊàëÁöÑÂ§¥ÂÉè -->
                <div id="lovers-user-avatar" class="lovers-avatar" style="background-color: #eee;"></div>
            </div>
        </div>
    </div>

    <!--‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="lovers-main-content">
        <div class="lovers-couple-row">
            <div class="lovers-couple-info">
                <span class="lovers-together-text">Âú®‰∏ÄËµ∑</span>
                <span class="lovers-days-count" id="lovers-total-days">0</span>
                <span class="lovers-days-text">Â§©</span>
            </div>
            <button class="lovers-check-in-btn" onclick="alert('ÊâìÂç°ÊàêÂäüÔºÅÁîúËúúÂÄº+1')">
                <i class="fas fa-heart"></i> ÊâìÂç°
            </button>
        </div>

        <!-- ÂäüËÉΩËèúÂçï (Âç†‰ΩçÔºåÂêéÁª≠ÂèØÈÄêÊ≠•ÂÆûÁé∞Ë∑≥ËΩ¨) -->
        <div class="lovers-function-menu">
            <div class="lovers-function-item" onclick="openLoversAnniversary()">
    <div class="lovers-function-icon"><i class="far fa-calendar-alt"></i></div>
    <div class="lovers-function-title">Á∫™ÂøµÊó•</div>
    <div class="lovers-function-desc">ÈáçË¶ÅÊó∂Âàª</div>
</div>
           <div class="lovers-function-item" onclick="openLoversLetterList()">
    <div class="lovers-function-icon"><i class="far fa-envelope"></i></div>
    <div class="lovers-function-title">ÊÉÖ‰π¶</div>
    <div class="lovers-function-desc">ÂÜôÁªôTA</div>
</div>
            <div class="lovers-function-item" onclick="openLoversAccountPage()">
    <div class="lovers-function-icon"><i class="fas fa-wallet"></i></div>
    <div class="lovers-function-title">ËÆ∞Ë¥¶Êú¨</div>
    <div class="lovers-function-desc">ËÆ∞ÂΩïËä±ÈîÄ</div>
</div>

            <div class="lovers-function-item" onclick="openLoversMoodScreen()">
    <div class="lovers-function-icon" style="color: #333;"><i class="far fa-calendar-check"></i></div>
    <div class="lovers-function-title">ÂøÉÊÉÖÊó•ÂéÜ</div>
    <div class="lovers-function-desc">‰∫§Êç¢ÂøÉÊÉÖ</div>
</div>
          <div class="lovers-function-item" onclick="openLoversWhisperScreen()">
    <div class="lovers-function-icon"><i class="fas fa-comment-dots"></i></div>
    <div class="lovers-function-title">ÊÇÑÊÇÑËØù</div>
    <div class="lovers-function-desc">ÁßÅÂØÜÊ∂àÊÅØ</div>
</div>
        </div>

        <div class="lovers-tabs">
            <div class="lovers-tab active">Âä®ÊÄÅ</div>

        </div>

        <!-- ÊÉÖ‰æ£Á©∫Èó¥Âä®ÊÄÅÂÜÖÂÆπÂå∫ -->
        <div class="lovers-content-home">

            <!-- Âä®ÊÄÅÂàóË°®ÂÆπÂô® -->
            <div id="lovers-moments-list">
                <!-- JS ‰ºöÂú®ËøôÈáåÁîüÊàêÂä®ÊÄÅÔºåÂ¶ÇÊûúÊ≤°ÊúâÂä®ÊÄÅÔºå‰ºöÊòæÁ§∫Á§∫‰æã -->
            </div>

            <!-- ÊÇ¨ÊµÆÂèëÂ∏ÉÊåâÈíÆ (Ê†∑ÂºèÊù•Ëá™ 29.txt) -->
            <button class="lovers-fab" onclick="openLoversPostModal()">
                <i class="fas fa-plus"></i>
            </button>

        </div>
    </div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥ÂèëÂ∏ÉÂä®ÊÄÅÂºπÁ™ó -->
<div class="modal" id="loversPostModal">
    <div class="modal-content">
        <div class="modal-title">ÂèëÂ∏ÉÁîúËúúÊó•Â∏∏</div>

        <!-- ÊñáÊú¨ËæìÂÖ•Ê°Ü -->
        <div class="form-group">
            <textarea id="lovers-post-text" class="lovers-post-textarea" placeholder="Ëøô‰∏ÄÂàªÁöÑÊÉ≥Ê≥ï..."></textarea>
        </div>

        <!-- ÂõæÁâá‰∏ä‰º†Âå∫Âüü -->
        <div class="lovers-post-image-upload" onclick="document.getElementById('lovers-post-file').click()">
            <i class="fas fa-camera"></i>
            <span id="lovers-post-file-text">Ê∑ªÂä†ÂõæÁâá (ÂèØÈÄâ)</span>
        </div>

        <!-- ÂõæÁâáÈ¢ÑËßàÂå∫Âüü -->
        <div id="lovers-post-img-preview-box" style="display:none; margin-top:10px; text-align: center;">
            <img id="lovers-post-img-preview" src="" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size: 12px; color: #ff4d4d; margin-top: 5px; cursor: pointer;" onclick="clearLoversPostImage()">Âà†Èô§ÂõæÁâá</div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversPostModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" style="background: #ff69b4; color: white;" onclick="submitLoversPost()">ÂèëÂ∏É</button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- 1. Á∫™ÂøµÊó•ÂàóË°®È°µ (Â§çÂàª 29.txt Page 2) -->
<!-- ========================================= -->
<div id="loversAnniversaryScreen" class="page">
    <div class="lovers-anni-header">
        <button class="lovers-icon-btn-round" style="margin-bottom: 20px;" onclick="backToLoversHome()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="lovers-avatars-small">
            <!-- Â§¥ÂÉè‰ºöÁî± JS Âä®ÊÄÅÂ°´ÂÖÖ -->
            <div id="anni-header-avatar-friend" class="lovers-avatar-s"></div>
            <div id="anni-header-avatar-user" class="lovers-avatar-s"></div>
        </div>
        <div class="lovers-days-header-info">
            <div class="lovers-days-header-title">Â∑≤Áõ∏ÊÅã <span class="lovers-days-header-num" id="anni-total-days">0</span> Â§©</div>
            <div class="lovers-days-header-date" id="anni-start-date">----.--.--</div>
        </div>
    </div>

    <div class="lovers-content-anni">
        <h2 class="lovers-section-title">Á∫™ÂøµÊó•</h2>

        <!-- Ê∑ªÂä†ÊåâÈíÆÂùó -->
        <div class="lovers-add-row" onclick="openLoversAnniModal()">
            <div class="lovers-anniversary-info">
                <h3>Ê∑ªÂä†Á∫™ÂøµÊó•</h3>
                <p>ËÆ∞ÂΩïÊØè‰∏Ä‰∏™ÁâπÂà´ÁöÑÊó•Â≠ê</p>
            </div>
            <button class="lovers-add-circle-btn"><i class="fas fa-plus"></i></button>
        </div>

        <!-- ÂàóË°®ÂÆπÂô® -->
        <div id="lovers-anniversary-list">
            <!-- JS ÁîüÊàê -->
        </div>


    </div>
</div>

<!-- ========================================= -->
<!-- 2. ÂÄíÊï∞Êó•ËØ¶ÊÉÖÈ°µ (Â§çÂàª 29.txt Page 3) -->
<!-- ========================================= -->
<div id="loversAnniDetailScreen" class="page">
    <div class="lovers-dm-nav">
        <button class="lovers-dm-btn" onclick="backToAnniversaryList()">ËøîÂõû</button>
        <div class="lovers-dm-nav-title">Days Matter</div>
        <button class="lovers-dm-btn" onclick="editCurrentAnniversary()">ÁºñËæë</button>
    </div>

    <div class="lovers-dm-card">
        <div class="lovers-dm-card-header" id="dm-card-header">
            <span id="dm-title">Title</span> <span id="dm-suffix">ËøòÊúâ</span>
        </div>
        <div class="lovers-dm-card-body">
            <div class="lovers-dm-big-number" id="dm-number">0</div>
        </div>
        <div class="lovers-dm-card-footer">
            ÁõÆÊ†áÊó•Ôºö<span id="dm-date-str">2025-01-01 ÊòüÊúüX</span>
        </div>
    </div>

    <div class="lovers-dm-tools">
        <button class="lovers-dm-tool-btn" onclick="changeDmCardColor()">
            <i class="fas fa-palette"></i> Êç¢ËÇ§
        </button>
        <button class="lovers-dm-tool-btn secondary" onclick="deleteCurrentAnniversary()">
            <i class="far fa-trash-alt"></i> Âà†Èô§
        </button>
    </div>
</div>

<!-- ========================================= -->
<!-- 3. Ê∑ªÂä†/ÁºñËæëÁ∫™ÂøµÊó•ÂºπÁ™ó -->
<!-- ========================================= -->
<div class="modal" id="loversAnniInputModal">
    <div class="modal-content">
        <div class="modal-title" id="anniInputModalTitle">Ê∑ªÂä†Á∫™ÂøµÊó•</div>
        <div class="form-group">
            <label class="form-label">ÂêçÁß∞</label>
            <input type="text" class="modal-input" id="anni-input-name" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁîüÊó•">
        </div>
        <div class="form-group">
            <label class="form-label">Êó•Êúü</label>
            <input type="date" class="modal-input" id="anni-input-date">
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversAnniModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" style="background:#ff69b4;" onclick="saveLoversAnniversary()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<div id="loversLetterListScreen" class="page">
    <div class="letter-header">
        <div style="display: flex; align-items: center;">
            <button class="lovers-icon-btn-round" onclick="backToLoversDetail()"><i class="fas fa-chevron-left"></i></button>
            <h2>Êàë‰ª¨ÁöÑÊÉÖ‰π¶</h2>
        </div>
        <!-- Êñ∞Â¢ûÂè≥‰æßÊåâÈíÆÁªÑ -->
        <div class="letter-header-right">
            <button class="letter-icon-btn" onclick="openLetterWriteModal()">
                <i class="fas fa-plus"></i>
            </button>
            <button class="letter-icon-btn" onclick="openLoversLetterSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
    <div class="wechat-content" style="padding-top: 0;">
        <div class="timeline-container" id="letterTimelineList">
            <!-- JS Âä®ÊÄÅÁîüÊàê -->
        </div>
    </div>
</div>

<!-- ÊãÜ‰ø°Âä®Áîª‰∏éÈòÖËØªÈ°µ -->
<div id="loversLetterAnimationScreen" class="page" style="background: #fff;">
    <!-- ÊÇ¨ÊµÆËøîÂõûÊåâÈíÆ -->
    <div class="back-btn-float" onclick="closeLetterAnimation()"><i class="fas fa-chevron-left"></i></div>

    <!-- Â§ß‰ø°Â∞ÅÂä®ÁîªÂÆπÂô® -->
    <div class="big-envelope-container" id="anim-envelope">
        <div class="env-back"></div>
        <div class="anim-paper"></div>
        <div class="env-body"></div>
        <div class="env-flap"></div>
        <div class="env-seal"></div>
    </div>

    <!-- ËØª‰ø°ÂÜÖÂÆπÂå∫ -->
    <div class="letter-read-view" id="read-view">
        <div class="paper-content">
            <h2 id="letter-title-display">Ê†áÈ¢ò</h2>
            <div id="letter-body-display"></div>
        </div>
    </div>
</div>

<!-- 4. ÊÉÖ‰æ£ËÆ∞Ë¥¶Êú¨È°µÈù¢ (ÁßªÊ§çÁâà) -->
<div id="account-page" class="page">
    <!-- Â§¥ÈÉ® -->
    <div class="account-header">
        <button class="lovers-icon-btn-round" onclick="backToLoversDetail()"><i class="fas fa-chevron-left"></i></button>
        <div class="account-title" id="acc-page-title">ÊÅãÁà±Ë¥¶Êú¨</div>
        <button class="theme-btn" onclick="toggleLoversAccountTheme()"><i class="fas fa-palette"></i> ÁöÆËÇ§</button>
    </div>

    <!-- ËßÜÂõæ1ÔºöË¥¶ÂçïÊòéÁªÜ -->
    <div id="acc-bill-view">
        <div class="account-card">
            <div class="acc-total-label">ËµÑ‰∫ßÁªì‰Ωô</div>
            <div class="acc-total-amount" id="acc-balance">0.00</div>
            <div class="acc-row">
                <div class="acc-col">
                    <div class="acc-sub-label">Êú¨ÊúàÊî∂ÂÖ•</div>
                    <div class="acc-sub-amount" id="acc-month-income">0.00</div>
                </div>
                <div class="acc-col">
                    <div class="acc-sub-label">Êú¨ÊúàÊîØÂá∫</div>
                    <div class="acc-sub-amount" id="acc-month-expense">0.00</div>
                </div>
            </div>
        </div>
        <div class="account-list" id="account-transaction-list">
            <!-- JSÁîüÊàêÂàóË°® -->
        </div>
        <!-- ÊÇ¨ÊµÆÊåâÈíÆ -->
        <button class="acc-fab-add" onclick="openLoversAccountModal()"><i class="fas fa-plus"></i></button>
    </div>

    <!-- ËßÜÂõæ2ÔºöÁªüËÆ°Êä•Ë°® -->
    <div id="acc-stats-view">
        <div class="stats-header">
            <!-- Êúà‰ªΩÈÄâÊã©Âô® -->
            <div class="stats-month-selector" style="position: relative; display: inline-flex; align-items: center;">
                <span id="stat-month-display">2025Âπ¥11Êúà</span>
                <i class="fas fa-chevron-down" style="font-size:12px; color:#999; margin-left: 5px;"></i>
                <input type="month" id="stat-month-input" onchange="onLoversMonthChange(this)"
                       style="position: absolute; top:0; left:0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
            </div>

            <!-- ÊîØÂá∫/Êî∂ÂÖ• ÂàáÊç¢ -->
            <div class="stats-type-switch">
                <div class="type-switch-item active" id="stat-btn-exp" onclick="switchLoversStatType('expense')">ÊîØÂá∫</div>
                <div class="type-switch-item" id="stat-btn-inc" onclick="switchLoversStatType('income')">Êî∂ÂÖ•</div>
            </div>
        </div>

        <div class="chart-container">
            <!-- ECharts ÊåÇËΩΩÁÇπ -->
            <div id="main-chart" style="width: 100%; height: 100%;"></div>
        </div>
        <!-- ÊéíË°åÊ¶úÂàóË°® -->
        <div class="rank-list" id="stat-rank-list">
            <!-- JS ÁîüÊàê -->
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="acc-bottom-nav">
        <div class="acc-nav-item active" id="nav-bill" onclick="switchLoversAccTab('bill')">
            <i class="fas fa-file-invoice"></i>
            <span>Ë¥¶Âçï</span>
        </div>
        <div class="acc-nav-item" id="nav-stats" onclick="switchLoversAccTab('stats')">
            <i class="fas fa-chart-pie"></i>
            <span>Êä•Ë°®</span>
        </div>
    </div>
</div>

<!-- ËÆ∞Ë¥¶ÂºπÁ™ó (Áã¨Á´ãID) -->
<div class="modal" id="lovers-account-modal">
    <div class="modal-content">
        <!-- 1. È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
        <div class="acc-modal-header">
            <button class="acc-close-btn" onclick="closeLoversAccountModal()"><i class="fas fa-times"></i></button>
            <div class="acc-tabs">
                <div class="acc-tab-item active" id="tab-expense" onclick="setLoversAccountType('expense')">ÊîØÂá∫</div>
                <div class="acc-tab-item" id="tab-income" onclick="setLoversAccountType('income')">Êî∂ÂÖ•</div>
            </div>
            <div style="width: 30px;"></div>
        </div>

        <!-- 2. ‰∏≠Èó¥ÂõæÊ†áÂå∫Âüü -->
        <div class="category-scroll-area">
            <div class="category-grid" id="category-grid">
                <!-- JS ÁîüÊàêÂàÜÁ±ªÂõæÊ†á -->
            </div>
        </div>

        <!-- 3. Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü -->
        <div class="acc-input-panel">
            <!-- ÈáëÈ¢ùË°å -->
            <div class="acc-amount-display" id="acc-amount-wrap">
                <span style="font-size: 24px; margin-right: 5px;">¬•</span>
                <input type="number" id="acc-input-amount" class="acc-amount-input" placeholder="0.00" inputmode="decimal" step="0.01">
            </div>

            <!-- Êó•ÊúüÂíåÂ§áÊ≥®Ë°å -->
            <div class="acc-meta-row">
                <input type="date" class="acc-meta-input" id="acc-input-date">
                <input type="text" class="acc-meta-input acc-note-input" id="acc-input-note" placeholder="ÁÇπÂáªÂ°´ÂÜôÂ§áÊ≥®...">
            </div>

            <!-- ÊåâÈíÆ -->
            <button class="acc-save-btn" onclick="submitLoversAccountForm()">ÂÆåÊàê</button>
        </div>

        <input type="hidden" id="acc-input-type" value="expense">
        <input type="hidden" id="acc-input-category" value="">
    </div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥ÔºöËßÜÂ•∏/Ë∂≥ËøπÈ°µÈù¢ (Lovers Spy Screen) -->
<div id="loversSpyScreen" class="page">
    <div class="spy-header">
        <!-- ‚Üì‚Üì‚Üì Á°Æ‰øù onclick ÊòØ backFromSpyScreen() ‚Üì‚Üì‚Üì -->
        <button class="lovers-icon-btn-round" onclick="forceBackFromSpy()">
            <i class="fas fa-arrow-left" style="color: #000;"></i>
        </button>
        <h2 style="font-weight: 800; letter-spacing: 1px; font-size: 18px;">TAÁöÑÂä®ÊÄÅ</h2>
        <div class="spy-status-dot"></div> <!-- Âú®Á∫øÁä∂ÊÄÅÁÇπ -->
    </div>

    <div class="spy-container">
        <!-- Â§¥ÈÉ®Ê¶ÇËßà -->
        <div class="spy-overview">
            <div class="spy-avatar-box">
                <!-- Â§¥ÂÉèÂ∞ÜÁî±JSÂä®ÊÄÅÂ°´ÂÖÖ -->
                <div id="spy-page-avatar" class="spy-avatar" style="background-color: #eee; background-size: cover; background-position: center;"></div>
                <div class="spy-online-badge">Online</div>
            </div>
            <p class="spy-intro">‰∏äÊ¨°Ê¥ªË∑É‰∫é <span style="font-weight:bold;">1 ÂàÜÈíüÂâç</span><br>iPhone 16 Pro Max ¬∑ 5G</p>
        </div>

        <!-- Êó∂Èó¥ËΩ¥ÂàóË°®ÂÆπÂô® -->
        <div id="spy-timeline-list" class="spy-list-wrap">
            <!-- JS Ëá™Âä®ÁîüÊàêÂÜÖÂÆπ -->
        </div>
    </div>
</div>

<!-- 1. ÂøÉÊÉÖÊó•ÂéÜÈ°µÈù¢ -->
<div id="loversMoodScreen" class="page">
    <div class="mood-header">
        <!-- Â∑¶‰æßÔºöËøîÂõû -->
        <button class="lovers-icon-btn-round" onclick="backToLoversDetail()">
            <i class="fas fa-chevron-left"></i>
        </button>

        <!-- ‰∏≠Èó¥ÔºöÊúà‰ªΩÂàáÊç¢ -->
        <div class="mood-month-switcher">
            <button class="month-nav-btn" onclick="changeLoversMoodMonth(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="mood-month-title" id="mood-month-display">2025Âπ¥12Êúà</div>
            <button class="month-nav-btn" onclick="changeLoversMoodMonth(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- Âè≥‰æßÔºöÁªüËÆ°ÊÄªÁªì -->
        <button class="lovers-icon-btn-round" onclick="openLoversMoodSummary()">
            <i class="fas fa-chart-bar" style="color: #666;"></i>
        </button>
    </div>

    <div class="mood-calendar-container">
        <div class="week-header">
            <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
        </div>
        <div class="days-grid" id="mood-days-grid">
            <!-- JS ÁîüÊàêÊó•ÊúüÊ†ºÂ≠ê -->
        </div>
    </div>

    <div class="mood-legend">
        <div class="legend-item"><span class="legend-dot" style="background:#ffb6d9"></span> Êàë</div>
        <div class="legend-item"><span class="legend-dot" style="background:#81d4fa"></span> TA</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ffcdd2"></span> ÁîüÁêÜÊúü</div>
    </div>
</div>

<!-- 2. ÂøÉÊÉÖÊÄªÁªì/ÁΩêÂ≠êÈ°µÈù¢ -->
<div id="loversMoodSummaryScreen" class="page">
    <div class="mood-header">
        <button class="lovers-icon-btn-round" onclick="backToLoversMoodCalendar()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="mood-month-title">Êú¨ÊúàÂøÉÊÉÖÁΩêÂ§¥</div>
        <div style="width: 40px;"></div> <!-- Âç†‰Ωç‰øùÊåÅÂπ≥Ë°° -->
    </div>

    <div class="summary-scroll-content">
        <!-- 1. ÂøÉÊÉÖÁΩêÂ≠êÂå∫Âüü -->
        <div class="jar-section">
            <div class="mood-jar-container">
                <div class="jar-lid"></div>
                <div class="jar-body" id="jar-content">
                    <!-- JS ‰ºöÂú®ËøôÈáåÁîüÊàêÈöèÊú∫Êï£ËêΩÁöÑÂøÉÊÉÖÂõæÊ†á -->
                </div>
                <div class="jar-bottom-shine"></div>
            </div>
        </div>

        <!-- 2. ÊúÄÂ§öÂøÉÊÉÖÁªüËÆ° -->
        <div class="summary-section-title">Êú¨ÊúàÊúÄÂ§öÂøÉÊÉÖ</div>
        <div class="most-frequent-card">
            <!-- ÊàëÁöÑÁªüËÆ° -->
            <div class="freq-item">
                <div class="freq-avatar" id="summary-my-avatar"></div>
                <div class="freq-info">
                    <img src="" id="summary-my-top-mood-img" class="freq-mood-icon">
                    <span class="freq-count" id="summary-my-top-mood-count">x0</span>
                </div>
            </div>
            <!-- ÂàÜÂâ≤Á∫ø -->
            <div style="width: 1px; height: 40px; background: #eee;"></div>
            <!-- TAÁöÑÁªüËÆ° -->
            <div class="freq-item">
                <div class="freq-avatar" id="summary-ta-avatar"></div>
                <div class="freq-info">
                    <img src="" id="summary-ta-top-mood-img" class="freq-mood-icon">
                    <span class="freq-count" id="summary-ta-top-mood-count">x0</span>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊèêÁ§∫ -->
        <div style="text-align: center; color: #ccc; font-size: 12px; margin-top: 20px;">
            Êî∂ÈõÜ‰∫ÜÊàë‰ª¨ÁÇπÁÇπÊª¥Êª¥ÁöÑÊÉÖÁª™
        </div>
    </div>
    <!-- ÁîüÁêÜÊúüÊèêÈÜíËÆæÁΩÆÂÖ•Âè£ -->
<div class="period-setting-entry" onclick="openPeriodSettingsModal()">
    <i class="fas fa-bell"></i> ËÆæÁΩÆÁîüÁêÜÊúüË¥¥ÂøÉÊèêÈÜí
</div>
</div>

<!-- 3. ÂøÉÊÉÖÁ≠æÂà∞ÂºπÁ™ó -->
<div id="loversMoodCheckInModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-title">‰ªäÊó•ÂøÉÊÉÖ</div>

        <div class="mood-grid-select" id="mood-selector">
            <!-- JS ÁîüÊàêÂøÉÊÉÖÈÄâÈ°π -->
        </div>

        <div class="period-toggle" onclick="toggleLoversPeriodSwitch()">
            <span><i class="fas fa-tint"></i> ËÆ∞ÂΩïÁîüÁêÜÊúü</span>
            <div class="period-toggle-switch" id="lovers-period-switch"></div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversMoodCheckInModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" style="background: #ff69b4;" onclick="saveLoversMood()">ÊâìÂç°</button>
        </div>
    </div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥ÔºöÊÇÑÊÇÑËØùÈ°µÈù¢ (‰øÆÊîπÁâà) -->
<div id="loversWhisperScreen" class="page">
    <div class="whisper-header">
        <div style="display: flex; align-items: center;">
            <button class="lovers-icon-btn-round" onclick="backToLoversDetail()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2>ÊÇÑÊÇÑËØù</h2>
        </div>

        <!-- Êñ∞Â¢ûÂè≥‰æßÊåâÈíÆÁªÑ -->
        <div class="whisper-header-right">
          <button class="whisper-icon-btn" onclick="openWriteWhisperScreen()">
                <i class="fas fa-plus"></i>
            </button>
            <button class="whisper-icon-btn" onclick="openLoversWhisperSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <div class="whisper-board" id="lovers-whisper-list">
        <!-- JS ÁîüÊàê‰æøÁ≠æ -->
    </div>
</div>

<!-- ÊÉÖ‰π¶ËÆæÁΩÆÂºπÁ™ó -->
<div id="loversLetterSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÊÉÖ‰π¶ËÆæÁΩÆ</div>

        <!-- Ëá™Âä®ÁîüÊàêÂºÄÂÖ≥ -->
        <div class="form-group" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin:0;">Ëá™Âä®ÂÜôÊÉÖ‰π¶</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="autoLetterToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">ÂºÄÂêØÂêéÔºåTA‰ºö‰∏çÂÆöÊúüÁªô‰Ω†ÂÜô‰ø°„ÄÇ</div>
        </div>

        <!-- È¢ëÁéáËÆæÁΩÆ -->
        <div class="form-group" id="autoLetterFreqGroup" style="display: none;">
            <label class="form-label">ÁîüÊàêÈ¢ëÁéá (Â§©/ÁØá)</label>
            <input type="number" class="modal-input" id="autoLetterFreqInput" placeholder="‰æãÂ¶ÇÔºö7" min="1">
        </div>

<!-- „ÄêÊñ∞Â¢û„ÄëÂ≠ó‰ΩìËÆæÁΩÆ -->
        <div class="form-group" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
            <label class="form-label">‰ø°Á∫∏Â≠ó‰Ωì</label>
            <select class="form-select arrow-select" id="letterFontSelect" onchange="toggleLetterCustomFontInput(this.value)">
                <option value="auto">üé≤ Êô∫ËÉΩ/ÈöèÊú∫ÂàÜÈÖç (ÈªòËÆ§)</option>
                <option value="font-mashanzheng">È©¨ÂñÑÊîø (Ê†áÂáÜÊØõÁ¨î)</option>
                <option value="font-zhimangxing">ÂøóËéΩË°å (Èú∏Ê∞îË°å‰π¶)</option>
                <option value="font-longcang">ÈæôËãç (ÁãÇËçâ)</option>
                <option value="font-liujianmaocao">ÊµÅÂÖâÊØõËçâ (ÊΩ¶Ëçâ)</option>
                <option value="font-zcoolkuaile">Á´ôÈÖ∑Âø´‰πê (ÂèØÁà±)</option>
                <option value="font-xiaowei">Â∞èËñá‰Ωì (Ê∏©Êüî)</option>
                <option value="font-notoserif">ÊÄùÊ∫êÁªÜÂÆã (È´òÂÜ∑)</option>
                <option value="custom">üîó Ëá™ÂÆö‰πâÂ≠ó‰Ωì (URL)</option>
            </select>

            <!-- Ëá™ÂÆö‰πâÂ≠ó‰ΩìURLËæìÂÖ•Ê°Ü (ÈªòËÆ§ÈöêËóè) -->
            <input type="text" class="modal-input" id="letterCustomFontUrlInput" placeholder="Á≤òË¥¥Â≠ó‰ΩìÊñá‰ª∂URL (.ttf/.woff)" style="display: none; margin-top: 10px;">
        </div>

        <!-- ÊâãÂä®ÁîüÊàê -->
        <div class="doujin-modal-setting-group">
            <label>ÊâãÂä®ÁîüÊàê (Á´ãÂç≥Êî∂Âà∞)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="manualLetterCountSlider" min="1" max="3" value="1" class="doujin-slider" style="flex:1;" oninput="document.getElementById('manualLetterCountDisplay').innerText = this.value">
                <span id="manualLetterCountDisplay" style="width: 30px; text-align: center;">1</span> ÁØá
            </div>
            <button class="settings-btn btn-black" style="margin-top: 10px; height: 36px; font-size: 14px;" onclick="triggerManualLetterGeneration()">ÂºÄÂßãÁîüÊàê</button>

</div>



        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="saveLoversLetterSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>

<!-- Áî®Êà∑ÂÜôÊÉÖ‰π¶È°µÈù¢ -->
<div id="loversWriteLetterScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToLetterList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂÜôÊÉÖ‰π¶</div>
        <button class="nav-btn" onclick="submitUserLetter()" style="font-weight: bold; color: #ff69b4;">ÂèëÈÄÅ</button>
    </div>

    <!-- Ê≥®ÊÑèÔºöËøôÈáåÂéªÊéâ‰∫Ü style="padding: 20px;"Ôºå‰∫§Áî±‰∏äÈù¢ÁöÑ CSS ÊéßÂà∂ -->
    <div class="wechat-content">
        <div class="write-letter-container">
            <!-- ËøôÈáåÂ∞±ÊòØÈÇ£‰∏™‰πãÂâçË¢´Êå°‰ΩèÁöÑÊ†áÈ¢òÊ°Ü -->
            <input type="text" id="userLetterTitle" class="write-letter-title" placeholder="ËØ∑ËæìÂÖ•‰ø°‰ª∂Ê†áÈ¢ò (ÂøÖÂ°´)">

            <div class="write-letter-paper">
                <textarea id="userLetterContent" class="write-letter-body" placeholder="ÊúÄÁà±ÁöÑÂë®ÈÅáÔºö&#10;&#10;Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπTAËØ¥ÁöÑËØù..."></textarea>
                <div class="write-letter-footer">
                    <span>From: Êàë</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÊÇÑÊÇÑËØùËÆæÁΩÆÂºπÁ™ó (ÈªëÁôΩÊûÅÁÆÄÈ£é & ‰∏äÈôê10Êù°) -->
<div id="loversWhisperSettingsModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 30px 25px; width: 85%; max-width: 360px;">
        <div class="modal-title" style="color: #000; font-weight: 700; font-size: 20px; margin-bottom: 25px; text-align: center;">ÊÇÑÊÇÑËØùËÆæÁΩÆ</div>

        <!-- 1. Ëá™Âä®ÁîüÊàêÂºÄÂÖ≥ -->
        <div class="form-group" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f5f5f5;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 600; font-size: 15px;">ËÅäÂ§©Ëá™Âä®ÁîüÊàê</label>
                <!-- ÈªëÁôΩÈ£éÊ†ºÂºÄÂÖ≥ -->
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="autoWhisperToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.5;">
                ÂºÄÂêØÂêéÔºåËßíËâ≤‰ºöÂú®‰∏é‰Ω†ËÅäÂ§©Êó∂ÔºåÊ†πÊçÆËÅäÂ§©ÂÜÖÂÆπËá™Âä®Ëß¶ÂèëÂÜÖÂøÉÁã¨ÁôΩ„ÄÇ<br>
                (ÊØèÊó•‰∏äÈôê 5 Êù°)
            </div>
        </div>

        <!-- 2. ÊâãÂä®ÁîüÊàêÂå∫Âüü -->
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label" style="color: #000; font-weight: 600; font-size: 15px; display: block; margin-bottom: 15px;">ÊâãÂä®ÁîüÊàê (Á´ãÂç≥Êü•Áúã)</label>

            <!-- ÊªëÂä®Êù°Âå∫Âüü -->
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <!-- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞Ü max Êîπ‰∏∫ 10ÔºåÂπ∂Ê∑ªÂä† accent-color: #000 Âº∫Âà∂ÈªëËâ≤ -->
                <input type="range" id="manualWhisperCountSlider" min="1" max="10" value="1"
                       style="flex: 1; height: 4px; background: #eee; border-radius: 2px; outline: none; accent-color: #000;"
                       oninput="document.getElementById('manualWhisperCountDisplay').innerText = this.value">

                <span style="font-weight: bold; color: #000; font-size: 16px; min-width: 40px; text-align: right;">
                    <span id="manualWhisperCountDisplay">1</span> Êù°
                </span>
            </div>

            <!-- ÈªëËâ≤ÁîüÊàêÊåâÈíÆ -->
            <button class="settings-btn btn-black" style="
                background-color: #000;
                color: #fff;
                border-radius: 30px;
                height: 44px;
                font-weight: 600;
                font-size: 14px;
                width: 100%;
                border: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                cursor: pointer;
                transition: transform 0.1s;"
                onclick="triggerManualWhisperGeneration()"
                onmousedown="this.style.transform='scale(0.98)'"
                onmouseup="this.style.transform='scale(1)'">
                Á´ãÂç≥ÁîüÊàê
            </button>
        </div>

        <!-- 3. Â∫ïÈÉ®‰øùÂ≠òÊåâÈíÆ -->
        <div class="modal-buttons" style="margin-top: 30px;">
            <!-- ËøôÈáåÁöÑ‰øùÂ≠òÊåâÈíÆ‰∏ªË¶ÅÁî®‰∫é‰øùÂ≠òËá™Âä®ÁîüÊàêÁöÑÂºÄÂÖ≥Áä∂ÊÄÅ -->
            <button class="modal-btn modal-btn-confirm" onclick="saveLoversWhisperSettings()"
                    style="background-color: #f7f7f7; color: #333; border-radius: 30px; font-weight: 600; border: none;">
                ‰øùÂ≠òËÆæÁΩÆ
            </button>
        </div>
    </div>
</div>

<!-- Êñ∞Â¢ûÔºöÊÇÑÊÇÑËØùËØ¶ÊÉÖÈ°µ (‰º†Á∫∏Êù°Ê®°Âºè) -->
<div id="loversWhisperDetailScreen" class="page">
    <div class="nav-bar" style="background: transparent; z-index: 100;">
        <button class="nav-btn" onclick="backToWhisperList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">Á∫∏Êù°</div>
        <div style="width: 40px;"></div>
    </div>

    <!-- Á∫∏Êù°ÂÆπÂô®ÔºöÁî®‰∫éÂ±Ö‰∏≠ÊòæÁ§∫ÊîæÂ§ßÁâà‰æøÁ≠æ -->
    <div class="whisper-detail-container">
        <div id="bigWhisperNote" class="note-paper big-note">
            <!-- ÂéüÂßãÂÜÖÂÆπ -->
            <div id="bigWhisperContent" class="note-content original-text"></div>
            <!-- ÂêéÁª≠ÂØπËØùÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            <div id="whisperDialogueContainer"></div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ËæìÂÖ•Ê°Ü -->
    <div class="whisper-reply-bar">
        <input type="text" id="whisperReplyInput" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÂõûÂ§ç..." onkeydown="handleWhisperReplyEnter(event)">
        <button class="whisper-send-btn" onclick="sendWhisperReply()">
            <i class="ri-pencil-fill"></i>
        </button>
    </div>
</div>

<!-- ÂÜôÊÇÑÊÇÑËØùÈ°µÈù¢ -->
<div id="loversWriteWhisperScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToWhisperList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">ÂÜôÊÇÑÊÇÑËØù</div>
        <button class="nav-btn" onclick="submitUserWhisper()" style="font-weight: bold; color: #ff69b4;">Ë¥¥‰∏ä</button>
    </div>

  <div class="wechat-content" style="background-color: #f2f2f2; padding-top: 84px; padding-left: 20px; padding-right: 20px; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center;">

        <!-- Ê†∑ÂºèÈÄâÊã©Âå∫ -->
        <div style="width: 100%; margin-bottom: 20px;">
            <div style="font-size: 14px; color: #999; margin-bottom: 10px; padding-left: 5px;">ÈÄâÊã©‰æøÁ≠æÊ†∑Âºè</div>
            <div id="whisperStyleSelector" style="display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none;">
                <!-- JS ‰ºöÂú®ËøôÈáåÁîüÊàêÊ†∑ÂºèÈÄâÈ°π -->
            </div>
        </div>

        <!-- ÂÜô‰ΩúÂå∫Âüü (ÂÆûÊó∂È¢ÑËßà) -->
        <div id="whisperWritePreview" class="note-paper big-note note-pink" style="width: 90%; min-height: 300px; cursor: default; transform: none;">
            <textarea id="whisperWriteInput"
                style="width: 100%; height: 100%; background: transparent; border: none; outline: none; resize: none; font-family: inherit; font-size: 24px; text-align: center; color: inherit;"
                placeholder="ÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπTAËØ¥ÁöÑËØù..."></textarea>
        </div>

    </div>
</div>

<!-- ËßÜÂ•∏ËØ¶ÊÉÖÂºπÁ™ó (ÁæéÂåñÁâà) -->
<div id="spyDetailModal" class="spy-modal-overlay" onclick="closeSpyDetailModal()">
    <div class="spy-detail-card" onclick="event.stopPropagation()">
        <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
        <div class="spy-close-btn" onclick="closeSpyDetailModal()">√ó</div>

        <!-- Â§¥ÈÉ®ÔºöÂõæÊ†á‰∏éÊó∂Èó¥ -->
        <div class="spy-card-header">
            <div class="spy-card-icon" id="spyModalIcon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="spy-card-meta">
                <div class="spy-card-time" id="spyModalTime">12:00</div>
                <div class="spy-card-summary" id="spyModalSummary">ÊëòË¶Å</div>
            </div>
        </div>

        <!-- Ê≠£ÊñáÔºöËØ¶ÁªÜÂä®‰ΩúÊèèÂÜô -->
        <div class="spy-card-content" id="spyModalDetail" style="margin-bottom: 20px; min-height: 60px;">
            ËøôÈáåÊòØËØ¶ÁªÜÁöÑÂä®‰ΩúÊèèÂÜô...
        </div>

        <!-- Â∫ïÈÉ®ÂÖÉÊï∞ÊçÆÂå∫Âüü (‰ΩçÁΩÆ) -->
        <div style="width: 100%; display: flex; align-items: center; margin-bottom: 10px;">
            <div id="spyModalLocationContainer" style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #888; background: transparent; padding: 0;">
                <i class="ri-map-pin-2-fill" style="color: #999;"></i>
                <span id="spyModalLocationText">Êú™Áü•Âú∞ÁÇπ</span>
            </div>
        </div>

        <!-- ÂøÉÂ£∞Âå∫Âüü (ÁæéÂåñÂêé) -->
        <div id="spyModalThought" class="spy-thought-area">
            <!-- Ë£ÖÈ•∞ÊÄßÂ∑¶ÂºïÂè∑ -->
            <i class="ri-double-quotes-l spy-thought-icon"></i>
            <!-- ÂøÉÂ£∞ÂÜÖÂÆπ -->
            <span id="spyModalThoughtContent" class="spy-thought-text">...</span>
        </div>
    </div>
</div>

<!-- ËÆæÁΩÆÂºπÁ™óÔºöÈÄâÊã©Êó•ÊúüÂíåËßíËâ≤ -->
<div id="periodSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÁîüÁêÜÊúüÊèêÈÜíËÆæÁΩÆ</div>

        <div class="form-group">
            <label class="form-label">ÈÄâÊã©ÊèêÈÜíÊó• (ÊØèÊúà)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="font-size:14px;">Á¨¨</span>
                <input type="number" id="periodDay1" class="modal-input" style="text-align:center; margin:0;" placeholder="1-31" min="1" max="31">
                <span style="font-size:14px;">Êó• Âíå Á¨¨</span>
                <input type="number" id="periodDay2" class="modal-input" style="text-align:center; margin:0;" placeholder="1-31" min="1" max="31">
                <span style="font-size:14px;">Êó•</span>
            </div>
            <div class="form-hint">ÊèêÁ§∫ÔºöËØ∑ÈÄâÊã©ÁîüÁêÜÊúüÈ¢ÑËÆ°Âà∞Êù•ÁöÑÂâç2Â§©„ÄÇ</div>
        </div>

        <div class="form-group">
            <label class="form-label">ÈÄâÊã©ÊèêÈÜí‰Ω†ÁöÑËßíËâ≤</label>
            <div id="periodRoleList" class="multi-select-list" style="max-height: 200px;">
                <!-- JS Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePeriodSettingsModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePeriodSettings()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- ÊèêÈÜíÂºπÁ™óÔºöÈªëÁôΩÈ£éÂ±ïÁ§∫ÁîüÊàêÁöÑÂÜÖÂÆπ -->
<div id="periodReminderModal" class="modal" style="z-index: 11000;">
    <div class="period-popup-content">
        <div class="period-popup-header">
            MONTHLY REMINDER
        </div>
        <!-- Â§¥ÂÉèÊ†è -->
        <div class="period-avatar-bar" id="periodPopupAvatars">
            <!-- JS Âä®ÊÄÅÊèíÂÖ•Â§¥ÂÉè -->
        </div>
        <!-- ÂÜÖÂÆπÂå∫ -->
        <div class="period-message-area">
            <span class="period-role-name" id="periodPopupName">Role Name</span>
            <div id="periodPopupText">Loading...</div>
        </div>
        <div class="period-popup-footer">
            <button class="period-confirm-btn" onclick="closePeriodReminderModal()">Êàë Êî∂ Âà∞ ‰∫Ü</button>
        </div>
    </div>
</div>

<!-- ÁîüÁêÜÊúüÊèêÈÜíÁöÑÊÇ¨ÊµÆÂä†ËΩΩÁêÉ -->
<div id="periodFloatingLoader">
    <div class="spinner"></div>
</div>

<!-- ÊÉÖ‰æ£Á©∫Èó¥ÊâπÈáèÂà†Èô§Êìç‰ΩúÊ†è -->
<div id="loversSelectionToolbar" class="multi-select-toolbar">
    <span class="multi-select-count" id="loversSelectCount">Â∑≤ÈÄâÊã© 0 È°π</span>
    <div class="multi-select-actions">
        <button class="multi-select-btn delete" onclick="confirmDeleteLoversItems()">Âà†Èô§</button>
        <button class="multi-select-btn cancel" onclick="exitLoversMultiSelectMode()">ÂèñÊ∂à</button>
    </div>
</div>
<!-- Â≠¶‰π†‰∏ìÊ≥® App -->
<div id="studyApp" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">‰∏ìÊ≥®Êó∂Âàª</div>
        <div style="width: 40px;"></div>
    </div>

        <!-- ËßÜÂõæ1ÔºöÁï™ËåÑÈíü (ÂçáÁ∫ßÁâà) -->
    <div id="studyTimerView" class="study-view active">
        <div class="study-content-center">

            <!-- Êñ∞Â¢ûÔºöÊ®°ÂºèÂàáÊç¢ -->
            <div class="study-mode-switch">
                <div id="modeBtnCountdown" class="mode-btn active" onclick="switchStudyMode('countdown')">ÂÄíËÆ°Êó∂</div>
                <div id="modeBtnCountup" class="mode-btn" onclick="switchStudyMode('countup')">Ê≠£ËÆ°Êó∂</div>
            </div>

            <!-- ËøõÂ∫¶ÁéØ -->
            <div class="timer-ring-container">
                <div class="timer-ring" id="studyTimerRing"></div>
                <div class="timer-inner">
                    <div class="timer-time" id="studyTimeDisplay">25:00</div>
                    <div class="timer-label" id="studyStatusLabel">ÂáÜÂ§á‰∏ìÊ≥®</div>
                </div>
            </div>

            <!-- ‰ªªÂä°ËæìÂÖ• -->
            <div class="study-input-box">
                <input type="text" id="studyTaskInput" placeholder="Êú¨Ê¨°‰∏ìÊ≥®ÁöÑÁõÆÊ†áÊòØ..." class="study-task-input">
            </div>

            <!-- ÊéßÂà∂ÊåâÈíÆ -->
            <div class="study-controls">
                <button class="study-btn-main" id="studyStartBtn" onclick="toggleStudyTimer()">ÂºÄÂßã‰∏ìÊ≥®</button>
                <!-- ËøôÈáåÁöÑÊåâÈíÆÊñáÂ≠óÂíåÈÄªËæëÁ®çÂêéÁî±JSÊéßÂà∂ -->
                <div style="display:flex; gap:10px; margin-top:10px;">
                     <button class="study-btn-sub" id="studyResetBtn" onclick="resetStudyTimer()" style="display:none; flex:1;">ÊîæÂºÉ</button>
                     <button class="study-btn-sub" id="studyFinishBtn" onclick="manualFinishStudy()" style="display:none; flex:1; border-color:#000; color:#000; font-weight:bold;">ÂÆåÊàê</button>
                </div>
            </div>

            <!-- Êó∂ÈïøÈÄâÊã© (‰ªÖÂÄíËÆ°Êó∂ÊòæÁ§∫) -->
            <div class="study-duration-select" id="studyDurationSelect">
                <span onclick="setStudyDuration(10)" class="duration-pill">10ÂàÜÈíü</span>
                <span onclick="setStudyDuration(25)" class="duration-pill active">25ÂàÜÈíü</span>
                <span onclick="setStudyDuration(45)" class="duration-pill">45ÂàÜÈíü</span>
                <span onclick="setStudyDuration(60)" class="duration-pill">60ÂàÜÈíü</span>
            </div>
        </div>
    </div>


        <!-- ËßÜÂõæ2ÔºöÁªüËÆ°ËÆ∞ÂΩï (Âê´ÁÉ≠ÂäõÂõæ) -->
    <div id="studyStatsView" class="study-view" style="display: none;">
        <div class="wechat-content" style="padding-top: 0; background: #f7f7f7;">

            <!-- È°∂ÈÉ®ÁªüËÆ°Âç° -->
            <div class="study-stat-header">
                <div class="stat-box">
                    <div class="stat-num" id="studyTotalTime">0</div>
                    <div class="stat-label">ÊÄª‰∏ìÊ≥®(ÂàÜÈíü)</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-box">
                    <div class="stat-num" id="studyTotalCount">0</div>
                    <div class="stat-label">ÂÆåÊàêÊ¨°Êï∞</div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÔºöÂ≠¶‰π†ÊúàÂéÜÁÉ≠ÂäõÂõæ -->
            <div style="margin: 0 15px 15px 15px; background: #fff; border-radius: 16px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; font-weight:bold; color:#333;">
                    <span id="heatmapMonthLabel">Êú¨ÊúàÁÉ≠ÂäõÂõæ</span>
                </div>
                <!-- ÊòüÊúüÂ§¥ -->
                <div class="heatmap-week-header">
                    <span>Êó•</span><span>‰∏Ä</span><span>‰∫å</span><span>‰∏â</span><span>Âõõ</span><span>‰∫î</span><span>ÂÖ≠</span>
                </div>
                <!-- Êó•ÊúüÊ†ºÂ≠ê -->
                <div id="studyHeatmapGrid" class="heatmap-grid"></div>
                <!-- Âõæ‰æã -->
                <div class="heatmap-legend">
                    <span>Â∞ë</span>
                    <div class="legend-dot l1"></div>
                    <div class="legend-dot l2"></div>
                    <div class="legend-dot l3"></div>
                    <span>Â§ö</span>
                </div>
            </div>
<!-- ‚ñº‚ñº‚ñº Êñ∞Â¢ûÔºö‰π†ÊÉØÂùöÊåÅÊ¶ú (ÊèíÂÖ•Âú®ËøôÈáå) ‚ñº‚ñº‚ñº -->
            <div style="margin: 0 15px 15px 15px; background: #fff; border-radius: 16px; padding: 15px;">
                <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:10px; border-bottom:1px solid #f5f5f5; padding-bottom:8px;">
                    ‰π†ÊÉØÂùöÊåÅÊ¶ú
                </div>
                <div id="studyHabitStatsList">
                    <!-- JSÂ∞ÜÂú®ËøôÈáåÁîüÊàêÊï∞ÊçÆ -->
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div style="padding: 0 15px 10px; font-size: 14px; font-weight: bold; color: #333;">ÊúÄËøëËÆ∞ÂΩï</div>
            <!-- ËÆ∞ÂΩïÂàóË°® -->
            <div id="studyRecordsList" style="padding-bottom: 20px;"></div>
        </div>
    </div>
        <!-- ËßÜÂõæ3ÔºöÊó•Â∏∏ÊâìÂç° (Êñ∞Â¢û) -->
    <div id="studyHabitsView" class="study-view" style="display: none;">
        <div class="wechat-content" style="padding-top: 0; background: #f7f7f7;">

            <!-- Â§¥ÈÉ®Ê∑ªÂä†Âå∫ -->
            <div style="background: #fff; padding: 20px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">Êó•Â∏∏‰π†ÊÉØ</div>
                <div class="study-add-habit-row">
                    <input type="text" id="newHabitName" placeholder="‰π†ÊÉØÂêçÁß∞ (Â¶Ç: ÂñùÊ∞¥)" class="habit-input">
                    <input type="number" id="newHabitTarget" placeholder="Ê¨°Êï∞" class="habit-input-num" value="1">
                    <button class="habit-add-btn" onclick="addStudyHabit()">
                        <i class="ri-add-line"></i>
                    </button>
                </div>
            </div>

            <!-- ‰π†ÊÉØÂàóË°® -->
            <div id="studyHabitsList" style="padding: 10px 15px; padding-bottom: 30px;">
                <!-- JSÁîüÊàê -->
            </div>
        </div>
    </div>


        <!-- Â∫ïÈÉ®ÂØºËà™ (Êõ¥Êñ∞Áâà) -->
    <div class="store-bottom-bar" style="height: 70px; padding-top: 10px;">
        <div class="store-tab-item active" onclick="switchStudyTab('timer', this)">
            <i class="ri-time-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">ËÆ°Êó∂</span>
        </div>
        <div class="store-tab-item" onclick="switchStudyTab('habits', this)">
            <i class="ri-checkbox-circle-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">ÊâìÂç°</span>
        </div>
        <div class="store-tab-item" onclick="switchStudyTab('stats', this)">
            <i class="ri-bar-chart-box-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">ÁªüËÆ°</span>
        </div>
    </div>

</div>
<!-- ‚ñº‚ñº‚ñº ËÆ∫Âùõ‰æßÊªëËèúÂçï (Êó†ÂõæÊ†áÁ∫ØÂáÄÁâà) ‚ñº‚ñº‚ñº -->
<div id="forumMenuOverlay" class="forum-menu-overlay" onclick="closeForumSideMenu()"></div>
<div id="forumSideMenu" class="forum-side-menu">
    <!-- 1. ËèúÂçïÂ§¥ÈÉ® (‰øùÊåÅ‰∏çÂèòÔºåÂè™Â±ïÁ§∫‰ø°ÊÅØ) -->
    <div style="padding: 30px 20px 20px; background: #f7f7f7; border-bottom: 1px solid #eee;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div id="forumMenuAvatar" style="width: 60px; height: 60px; border-radius: 50%; background-color: #ddd; background-size: cover; background-position: center; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            <div>
                <div id="forumMenuName" style="font-size: 18px; font-weight: bold; color: #333;">Áî®Êà∑Âêç</div>
                <div id="forumMenuHandle" style="font-size: 13px; color: #999;">@userid</div>
            </div>
        </div>
        <div style="display: flex; gap: 20px; font-size: 14px;">
            <div><strong id="forumMenuFollowing" style="color:#333;">0</strong> <span style="color:#999;">ÂÖ≥Ê≥®</span></div>
            <div><strong id="forumMenuFollowers" style="color:#333;">0</strong> <span style="color:#999;">Á≤â‰∏ù</span></div>
        </div>
    </div>

    <!-- 2. ÂäüËÉΩËèúÂçïÂå∫Âüü (Á∫ØÊñáÂ≠óÔºåÊó†ÂõæÊ†á) -->
    <div style="padding: 10px 0;">

        <!-- [1] ËÆ∫Âùõ-ËßíËâ≤ÈÄâÊã© -->
        <div class="forum-menu-item" onclick="openForumCharacterSelect()">
            ËßíËâ≤ÈÄâÊã©
        </div>

        <!-- [2] ‰∏ñÁïåËßÇËÆæÁΩÆ -->
        <div class="forum-menu-item" onclick="openWorldviewManagement()">
            ‰∏ñÁïåËßÇËÆæÁΩÆ
        </div>

        <!-- [3] ËÆ∫ÂùõËßÑÂàô -->
        <div class="forum-menu-item" onclick="openForumRules()">
            ËÆ∫ÂùõËßÑÂàô
        </div>

        <!-- [4] Ëá™Âä®ÂèëÂ∏ñÂºÄÂÖ≥ -->
        <div class="forum-menu-item" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ËßíËâ≤Ëá™Âä®ÂèëÂ∏ñ</span>
            <label class="toggle-switch bw-switch" style="transform: scale(0.8);">
                <input type="checkbox" id="forumAutoPostToggle" onchange="toggleForumAutoPost()">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- [4-Â≠êÈ°π] ÂèëÂ∏ñÈ¢ëÁéáËÆæÁΩÆ -->
        <div class="forum-menu-item" id="forumFreqConfigRow" style="display: none; background: #f9f9f9; padding: 10px 20px; font-size: 13px;">
            <span style="color:#666; margin-right: 5px;">È¢ëÁéá: ÊØè</span>
            <input type="number" id="forumFreqDaysInput" value="1" min="1" style="width: 30px; text-align: center; border: 1px solid #ddd; border-radius: 4px;" onchange="saveForumFreqConfig()">
            <span style="color:#666; margin: 0 5px;">Â§©Âèë</span>
            <input type="number" id="forumFreqCountInput" value="1" min="1" style="width: 30px; text-align: center; border: 1px solid #ddd; border-radius: 4px;" onchange="saveForumFreqConfig()">
            <span style="color:#666; margin-left: 5px;">Â∏ñ</span>
        </div>

        <!-- [5] ÂåøÂêçÊ®°ÂºèÂºÄÂÖ≥ -->
        <div class="forum-menu-item" style="display: flex; justify-content: space-between; align-items: center;">
            <span>ÂåøÂêçÊ®°Âºè</span>
            <label class="toggle-switch bw-switch" style="transform: scale(0.8);">
                <input type="checkbox" id="forumAnonymousToggle" onchange="toggleForumAnonymity()">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- [6] Ê∏ÖÁ©∫ÊåâÈíÆ -->
        <div class="forum-menu-item" onclick="clearForumHistoryConfirm()" style="color: #ff3b30;">
            Ê∏ÖÁ©∫ÊâÄÊúâÂ∏ñÂ≠ê
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ‰æßÊªëËèúÂçï‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº 1. ËßíËâ≤ÂÖ•È©ªÈÄâÊã©ÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="forumCharacterSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">ÈÄâÊã©ÂÖ•È©ªËßíËâ≤</div>
        <div id="forumCharacterSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS‰ºöËá™Âä®Â°´ÂÖÖ -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeForumCharacterSelect()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveForumCharacterSelect()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº 2. ‰∏ñÁïåËßÇÂàóË°®ÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="worldviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display:flex; justify-content:space-between; align-items:center;">
            <span>‰∏ñÁïåËßÇÁÆ°ÁêÜ</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openWorldviewEditor(null)">+</button>
        </div>
        <div id="worldviewList" class="friend-list" style="max-height: 50vh; overflow-y: auto;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('worldviewModal').classList.remove('show')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>
<!-- ‰∏ñÁïåËßÇÁºñËæëÂô® -->
<div id="worldviewEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="worldviewEditorTitle">Êñ∞Âª∫‰∏ñÁïåËßÇ</div>
        <input type="text" class="modal-input" id="worldviewNameInput" placeholder="‰∏ñÁïåËßÇÂêçÁß∞ (Â¶Ç: ËµõÂçöÊúãÂÖã)">
        <textarea class="modal-textarea" id="worldviewDescInput" placeholder="ËØ¶ÁªÜÊèèËø∞..." style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeWorldviewEditor()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveWorldview()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>


<!-- ËßÑÂàôÁºñËæëÂô® -->
<div id="forumRuleEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="forumRuleEditorTitle">Êñ∞Âª∫ËßÑÂàô</div>
        <input type="text" class="modal-input" id="forumRuleNameInput" placeholder="ËßÑÂàôÂêçÁß∞ (Â¶Ç: Á¶ÅÊ≠¢Âà∑Â±è)">
        <textarea class="modal-textarea" id="forumRuleDescInput" placeholder="ËßÑÂàôËØ¶ÊÉÖ..." style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeForumRuleEditor()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveForumRule()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>


<script src="script.js"></script>

 <script src="https://unpkg.com/pinyin-pro"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- „ÄêËßÜÂ•∏ÂäüËÉΩ V25.0 - Áâ©ÁêÜÈîöÁÇπ‰øÆÊ≠£Áâà (Â§¥ÂÉèË∏©ÁÇπ+ÊñáÂ≠ó‰∏ãÊ≤â+ËÆæÁΩÆÂè≥ÁΩÆ)„Äë -->
<script>
    // --- 0. Ê≥®ÂÖ•Ê†∑Âºè (CSS Áâ©ÁêÜÈîöÁÇπÈáçÊûÑ) ---
    (function injectV25Styles() {
        const styleId = 'v25-anchor-styles';
        if (document.getElementById(styleId)) return;
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
            /* 1. Âú∞ÂõæÂÆπÂô® */
            .spy-map-box {
                background-color: #f7f9fc !important;
                background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px) !important;
                background-size: 50px 50px !important;
                border-bottom: 2px solid #333;
                position: relative;
                overflow: hidden;
            }

            /* 2. Âú∞ÁÇπÊ†áËÆ∞ (Ê†∏ÂøÉ‰øÆÂ§çÔºö0Â∞∫ÂØ∏ÂÆπÂô®ÔºåÁªùÂØπÂÆö‰ΩçÂü∫ÂáÜ) */
            .bw-mini-pin {
                position: absolute;
                width: 0; height: 0; /* ÂÖ≥ÈîÆÔºö‰∏çÂç†Á©∫Èó¥Ôºå‰Ωú‰∏∫ÂùêÊ†áÂéüÁÇπ */
                overflow: visible;   /* ÂÖÅËÆ∏ÂÜÖÂÆπÊ∫¢Âá∫ */
                z-index: 50;
                pointer-events: auto !important;
                cursor: pointer;
            }
            /* ÂõæÊ†áÔºöÁªùÂØπÂ±Ö‰∏≠‰∫éÂùêÊ†áÁÇπ */
            .bw-pin-icon {
                position: absolute;
                left: -7px; top: -7px; /* 14pxÁöÑ‰∏ÄÂçäÔºåÂÆåÂÖ®Â±Ö‰∏≠ */
                width: 14px; height: 14px;
                background: #333; border: 2px solid #fff;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            /* Ê†áÁ≠æÔºöÂº∫Âà∂‰Ωç‰∫éÂùêÊ†áÁÇπ‰∏ãÊñπ */
            .bw-pin-label {
                position: absolute;
                top: 10px; /* Ë∑ùÁ¶ªÂùêÊ†áÁÇπÂêë‰∏ã 10px */
                left: 50%;
                transform: translateX(-50%); /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
                font-size: 10px; color: #333;
                background: rgba(255,255,255,0.95);
                padding: 2px 6px; border-radius: 4px;
                border: 1px solid #ddd; white-space: nowrap;
                font-weight: bold; pointer-events: none;
                z-index: 60;
                text-shadow: none;
            }
            /* ÊÇ¨ÂÅúÊîæÂ§ß */
            .bw-mini-pin:hover .bw-pin-icon { transform: scale(1.3); background: #007aff; border-color: #fff; }

            /* 3. Â§¥ÂÉè Pin (Ê†∏ÂøÉ‰øÆÂ§çÔºöÈíàÂ∞ñÂØπÂáÜÂùêÊ†áÁÇπ) */
            .bw-avatar-pin {
                position: absolute;
                width: 44px; height: 44px;
                border: 3px solid #ff4757; border-radius: 50%;
                background-color: #fff; background-size: cover; background-position: center;
                z-index: 100;
                box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
                /* ÂÖ≥ÈîÆÔºö-50%Â±Ö‰∏≠Ôºå-100%ËÆ©Â∫ïÈÉ®ËæπÁºòË¥¥‰ΩèÂùêÊ†áÁÇπÔºå-10pxÊòØ‰∏∫‰∫ÜÁïôÂá∫Â∞è‰∏âËßíÁöÑÁ©∫Èó¥ÔºåËÆ©‰∏âËßíÂ∞ñÂØπÂáÜÁÇπ */
                transform: translate(-50%, calc(-100% - 10px));
                transition: left 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), top 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            /* Â∞è‰∏âËßí (ËøûÊé•Â§¥ÂÉèÂíåÂùêÊ†áÁÇπ) */
            .bw-avatar-pin::after {
                content: ''; position: absolute;
                bottom: -9px; left: 50%;
                transform: translateX(-50%);
                border-width: 9px 7px 0;
                border-style: solid;
                border-color: #ff4757 transparent transparent transparent;
            }

            /* 4. È°∂ÈÉ®ÂØºËà™Ê†è (Flex Â∏ÉÂ±Ä‰øÆÂ§ç) */
            .spy-header-flex {
                display: flex !important;
                justify-content: space-between !important; /* Â∑¶Âè≥Ë¥¥Ëæπ */
                align-items: center !important;
                padding: 0 15px !important;
                height: 50px !important;
                background: #fff !important;
                border-bottom: 1px solid #eee !important;
                position: relative;
            }
            /* Ê†áÈ¢òÁªùÂØπÂ±Ö‰∏≠Ôºå‰∏çË¢´ÊåâÈíÆÊå§Ê≠™ */
            .spy-header-title-center {
                position: absolute; left: 50%; transform: translateX(-50%);
                font-weight: 800; font-size: 16px; color: #000;
            }
            /* ËÆæÁΩÆÊåâÈíÆÊ†∑Âºè */
            .nav-settings-pill {
                display: flex; align-items: center; gap: 4px;
                padding: 5px 12px; border-radius: 20px;
                background: #f5f5f5; color: #333; font-size: 12px; font-weight: bold;
                border: 1px solid #e0e0e0; cursor: pointer; text-decoration: none;
            }
            .nav-settings-pill:active { background: #e0e0e0; }

            /* 5. ÊÇ¨ÊµÆÊåâÈíÆÁªÑ (‰øùÊåÅ V21) */
            .map-fab-group { position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 99999 !important; pointer-events: none; }
            .map-fab { width: auto; height: 32px; padding: 0 12px; background: #fff; border: 1px solid #ddd; border-radius: 16px; display: flex; align-items: center; justify-content: center; gap: 6px; color: #333; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 12px; font-weight: bold; pointer-events: auto !important; transition: all 0.2s; }
            .map-fab:active { transform: scale(0.95); background: #f0f0f0; }
            .map-fab i { font-size: 14px; }
            .map-fab.loading i { animation: spin 1s linear infinite; color: #007aff; }
            .map-fab.add-active { background: #333; color: #fff; border-color: #000; }
            @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

            /* 6. ÂÖ∂‰ªñÈÄöÁî®Ê†∑Âºè */
            .spy-settings-row { margin-bottom: 15px; } .spy-settings-label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; font-weight: bold; } .spy-settings-input { width: 100%; padding: 10px; background: #f5f5f5; border: 1px solid #eee; border-radius: 8px; font-size: 14px; color: #333; box-sizing: border-box; }
            #spySettingsModal .modal-content { background: #fff !important; width: 85% !important; max-width: 320px !important; border-radius: 16px !important; padding: 20px !important; }
            .map-info-bubble { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border-radius: 20px; padding: 12px 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 1px solid #fff; z-index: 500; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; gap: 12px; pointer-events: auto !important; min-width: 200px; max-width: 80%; } .map-info-bubble.show { transform: translateX(-50%) translateY(0); }
            .map-popup-icon { width: 36px; height: 36px; background: #333; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
            .map-popup-text h4 { margin: 0; font-size: 14px; font-weight: 700; color: #333; } .map-popup-text p { margin: 2px 0 0; font-size: 12px; color: #888; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .luck-dashboard { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.8); color: #fff; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 5px; z-index: 400; pointer-events: none; } .luck-dot { width: 8px; height: 8px; border-radius: 50%; } .luck-high { background: #4cd964; box-shadow: 0 0 5px #4cd964; } .luck-mid { background: #ffcc00; box-shadow: 0 0 5px #ffcc00; } .luck-low { background: #ff3b30; box-shadow: 0 0 5px #ff3b30; }
            .timeline-box { padding: 25px 20px; background: #fff; min-height: 100%; } .time-row { display: flex; gap: 15px; margin-bottom: 30px; } .t-left { width: 50px; text-align: right; position: relative; flex-shrink: 0; display:flex; flex-direction:column; align-items:flex-end; } .t-time { font-size: 14px; font-weight: 800; color: #333; font-family: monospace; } .t-weather { font-size: 10px; color: #999; margin-top: 2px; font-family: sans-serif; } .t-line { position: absolute; top: 25px; right: -8px; bottom: -45px; width: 2px; background: #f0f0f0; } .t-dot { position: absolute; top: 5px; right: -13px; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 3px solid #ccc; z-index: 1; transition: border-color 0.3s; } .time-row.lucky .t-dot { border-color: #ff9500; background: #fff8e1; } .time-row.unlucky .t-dot { border-color: #ff3b30; background: #ffebee; } .t-card { flex: 1; background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); position: relative; cursor: pointer; transition: background 0.2s; } .t-card:active { background: #fafafa; } .t-card::before { content: ''; position: absolute; left: -6px; top: 15px; width: 10px; height: 10px; background: inherit; border-left: 1px solid #eee; border-bottom: 1px solid #eee; transform: rotate(45deg); } .t-summary { font-size: 15px; font-weight: bold; color: #222; margin-bottom: 4px; } .t-detail { font-size: 13px; color: #666; line-height: 1.5; } .t-thought { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 12px; color: #888; font-style: italic; } .t-card.expanded .t-thought { display: block; animation: fadeIn 0.3s; } .t-loc-tag { display: inline-block; background: #f0f2f5; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-top: 6px; } #addLocationTip { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 2000; } #addLocationTip.show { opacity: 1; }
        `;
        document.head.appendChild(style);
    })();

    // ÂÖ®Â±ÄÁä∂ÊÄÅ
    window.spyState = { scale: 1, currentX: 0, currentY: 0, startX: 0, startY: 0, lastX: 0, lastY: 0, isDragging: false, isAddingMode: false, friendId: null };
    window.currentLoversFriendId = null;

    // ==========================================
    // 1. ÂàùÂßãÂåñÂÖ•Âè£
    // ==========================================
    window.forceOpenSpyMap = function() {
        if (typeof friends === 'undefined' || !currentChatFriendId) return alert("ËØ∑ÂÖàËøõÂÖ•ËÅäÂ§©Á™óÂè£ÔºÅ");
        const friend = friends.find(f => f.id === currentChatFriendId);
        window.spyState.friendId = currentChatFriendId;
        window.currentLoversFriendId = currentChatFriendId;

        // ÂàùÂßãÂåñ
        if (!friend.spyLogs) friend.spyLogs = [];
        if (!friend.mapLocations) friend.mapLocations = [];
        if (typeof friend.luckValue === 'undefined') friend.luckValue = 50;
        if (!friend.spySettings) friend.spySettings = { logInterval: 30, luckInterval: 120, mapInterval: 0, mapCount: 8 };

        window.checkAllAutoUpdates(friend);

        const container = document.querySelector('#loversSpyScreen .spy-container');
        const header = document.querySelector('#loversSpyScreen .spy-header');

        // (A) Â§¥ÈÉ®Ôºö„ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëFlex Â∏ÉÂ±ÄÔºåËÆæÁΩÆÊåâÈíÆÂú®ÊúÄÂè≥‰æßÔºåÊ†áÈ¢òÁªùÂØπÂ±Ö‰∏≠
        if (header) {
            header.className = 'spy-header-flex'; // Â∫îÁî®Êñ∞Ê†∑Âºè
            header.innerHTML = `
                <button class="lovers-icon-btn-round" onclick="forceBackFromSpy()" style="background:#fff; border:1px solid #eee;">
                    <i class="fas fa-arrow-left" style="color: #333;"></i>
                </button>

                <div class="spy-header-title-center">${friend.remark||friend.name}</div>

                <!-- ËÆæÁΩÆÊåâÈíÆÔºöÂõæÊ†á+ÊñáÂ≠ó -->
                <div class="nav-settings-pill" onclick="window.openAdvancedSpySettings()">
                    <i class="fas fa-cog"></i> <span>ËÆæÁΩÆ</span>
                </div>
            `;
        }

        // (B) Ê≥®ÂÖ•ÂÜÖÂÆπ
        if (container) {
            const avatarUrl = friend.avatarImage ? `background-image:url('${friend.avatarImage}')` : `background-color:#000;color:#fff;display:flex;align-items:center;justify-content:center;`;
            const avatarContent = friend.avatarImage ? '' : (friend.name[0]);

            container.innerHTML = `
                <div class="spy-bw-container" style="background:#fff; height:100%; display:flex; flex-direction:column;">
                    <div class="spy-map-container spy-map-box" id="spyEmbeddedMap" style="height: 320px; flex-shrink:0; cursor: grab; touch-action: none;">

                        <div id="spyMapMovableLayer" style="width:100%; height:100%; position:absolute; top:0; left:0; transform-origin: center center;">
                            <div style="width:100%; height:100%;"></div>
                            <div id="spyMapPinsLayer"></div>
                            <!-- Â§¥ÂÉè -->
                            <div id="spyMapAvatarPin" class="bw-avatar-pin" style="left: 50%; top: 50%; ${avatarUrl}">
                                ${avatarContent}
                            </div>
                        </div>

                        <!-- ÊÇ¨ÊµÆÊåâÈíÆÁªÑ (ÁßªÈô§‰∫ÜËÆæÁΩÆÊåâÈíÆ) -->
                        <div class="map-fab-group">
                            <div class="map-fab" id="btnAddSpot" onclick="window.startAddLocationMode()" title="ÁÇπÊ≠§ÁÑ∂ÂêéÂú®Âú∞Âõæ‰∏äÈÄâÁÇπ">
                                <i class="ri-map-pin-add-line"></i> <span>Ê∑ªÂä†</span>
                            </div>
                            <div class="map-fab" id="btnWeather" onclick="window.refreshWeather()" title="Êõ¥Êñ∞Â§©Ê∞î">
                                <i class="ri-sun-cloudy-line"></i> <span>Â§©Ê∞î</span>
                            </div>
                            <div class="map-fab" id="btnRedrawMap" onclick="window.generateMapFromAI()" title="ÈáçÁªòÂú∞Âõæ">
                                <i class="ri-map-2-line"></i> <span>ÈáçÁªò</span>
                            </div>
                            <div class="map-fab" id="btnRefreshLog" onclick="window.forceRefreshLogs(false)" title="ÊâãÂä®Âà∑Êñ∞">
                                <i class="fas fa-sync-alt"></i> <span>Âà∑Êñ∞</span>
                            </div>
                        </div>

                        <!-- Âπ∏ËøêÂÄº -->
                        <div class="luck-dashboard" id="luckDashboard">
                            <div class="luck-dot luck-mid" id="luckDot"></div>
                            <span>ËøêÂäø: <span id="luckText">Âπ≥Âπ≥</span> (<span id="luckNum">50</span>)</span>
                        </div>

                        <!-- ÊèêÁ§∫Â±Ç -->
                        <div id="addLocationTip">üëá ËØ∑Âú®Âú∞Âõæ‰∏äÁÇπÂáªÊ∑ªÂä†‰ΩçÁΩÆ</div>

                        <!-- Ê∞îÊ≥° -->
                        <div class="map-info-bubble" id="mapInfoBubble">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div class="map-popup-icon"><i class="ri-map-pin-2-fill"></i></div>
                                <div class="map-popup-text">
                                    <h4 id="bubbleTitle">Âú∞ÁÇπ</h4>
                                    <p id="bubbleDesc">ÊèèËø∞</p>
                                </div>
                            </div>
                            <i class="ri-close-circle-fill" onclick="window.hideMapPopup()" style="color:#ccc; font-size:20px; cursor:pointer;"></i>
                        </div>
                    </div>

                    <div class="bw-scroll-view" style="flex:1; overflow-y:auto; background:#fff;">
                        <div id="spy-timeline-list" class="timeline-box"></div>
                    </div>
                </div>
            `;
        }

        if (typeof setActivePage === 'function') setActivePage('loversSpyScreen');
        else document.getElementById('loversSpyScreen').classList.add('active');

        setTimeout(() => {
            if (!friend.mapLocations || friend.mapLocations.length === 0) window.generateMapFromAI();
            window.renderSpyUI();
            window.initMapInteraction();
        }, 150);
    };

    // ==========================================
    // 2. UI Ê∏≤Êüì (ÂåÖÂê´ÂÆö‰ΩçÂíåÂàóË°®)
    // ==========================================
    window.renderSpyUI = function() {
        const friend = friends.find(f => f.id === window.spyState.friendId);
        if(!friend) return;

        // A. Âπ∏ËøêÂÄº
        const luck = friend.luckValue || 50;
        const luckDot = document.getElementById('luckDot');
        const luckText = document.getElementById('luckText');
        document.getElementById('luckNum').innerText = luck;
        if(luck > 70) { luckDot.className='luck-dot luck-high'; luckText.innerText='Â§ßÂêâ'; }
        else if(luck < 30) { luckDot.className='luck-dot luck-low'; luckText.innerText='Âá∂Èô©'; }
        else { luckDot.className='luck-dot luck-mid'; luckText.innerText='Âπ≥Á®≥'; }

        // B. Âú∞Âõæ Pins (‰ΩøÁî®Áâ©ÁêÜÈîöÁÇπ‰øÆÊ≠£ÂêéÁöÑÊ†∑Âºè)
        const pinsLayer = document.getElementById('spyMapPinsLayer');
        pinsLayer.innerHTML = '';
        if (friend.mapLocations) {
            friend.mapLocations.forEach((loc) => {
                const safeName = loc.name.replace(/'/g, "\\'");
                const safeDesc = (loc.desc || "").replace(/'/g, "\\'");

                pinsLayer.insertAdjacentHTML('beforeend', `
                    <div class="bw-mini-pin" style="left:${loc.x}%; top:${loc.y}%;"
                         onclick="window.showMapPopup(event, '${safeName}', '${safeDesc}', this)">
                        <div class="bw-pin-icon"></div>
                        <div class="bw-pin-label">${loc.name}</div>
                    </div>
                `);
            });
        }

        // C. ÂàóË°®
        const listContainer = document.getElementById('spy-timeline-list');
        listContainer.innerHTML = '';

        let lastLog = null;
        if (friend.spyLogs && friend.spyLogs.length > 0) {
            const logs = [...friend.spyLogs].sort((a, b) => (a.time > b.time ? -1 : 1));
            lastLog = logs[0];

            logs.forEach((log, index) => {
                const isLast = index === logs.length - 1;
                let rowClass = "time-row";
                if (log.isLucky) rowClass += " lucky";
                if (log.isUnlucky) rowClass += " unlucky";

                // Ê∏©Â∫¶ËÆ°ÁÆó
                let baseTemp = 25;
                if (friend.weatherCache && friend.weatherCache.data) baseTemp = parseInt(friend.weatherCache.data.current_condition[0].temp_C);
                const hour = parseInt(log.time.split(':')[0]);
                let tempOffset = (hour >= 12 && hour <= 16) ? 2 : ((hour >= 6 && hour < 10) ? -3 : ((hour >= 18 && hour < 22) ? -2 : -5));
                const displayTemp = log.weather && log.weather.includes('¬∞') ? log.weather : `${baseTemp + tempOffset}¬∞C`;

                const html = `
                    <div class="${rowClass}">
                        <div class="t-left">
                            <div class="t-time">${log.time}</div>
                            <div class="t-weather">${displayTemp}</div>
                            ${!isLast ? '<div class="t-line"></div>' : ''}
                            <div class="t-dot"></div>
                        </div>
                        <div class="t-card" onclick="this.classList.toggle('expanded')">
                            <div class="t-summary">${log.summary}</div>
                            <div class="t-detail">${log.detail}</div>
                            ${log.location ? `<span class="t-loc-tag"><i class="ri-map-pin-line"></i> ${log.location}</span>` : ''}
                            <div class="t-thought">üí≠ ${log.thought || '...'}</div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        } else {
            listContainer.innerHTML = '<div style="text-align:center; color:#ccc; padding-top:40px;">ÊöÇÊó†Âä®ÊÄÅ</div>';
        }

        // D. Êõ¥Êñ∞Â§¥ÂÉè‰ΩçÁΩÆ
        if (lastLog) {
            const pos = calculateAvatarPos(friend, lastLog);
            const pin = document.getElementById('spyMapAvatarPin');
            if(pin) {
                pin.style.left = pos.x + '%';
                pin.style.top = pos.y + '%';
            }
        }
    };

    function calculateAvatarPos(friend, lastLog) {
        let pos = { x: 50, y: 50 };
        if (!friend.mapLocations || !lastLog) return pos;
        const text = (lastLog.summary + lastLog.detail).toLowerCase();
        const sortedLocs = [...friend.mapLocations].sort((a,b)=>b.name.length-a.name.length);
        const matched = sortedLocs.find(loc => text.includes(loc.name.toLowerCase()));
        if (matched) {
            pos.x = matched.x; pos.y = matched.y;
            window.showMapPopup(null, matched.name, `ÂΩìÂâç‰ΩçÁΩÆ (${lastLog.time})`, null);
        } else {
            const h = parseInt(lastLog.time.split(':')[0]);
            if (h >= 22 || h < 8) { const l = friend.mapLocations.find(x=>x.type==='home'); if(l){pos.x=l.x;pos.y=l.y;} }
            else if (h >= 9 && h < 18) { const l = friend.mapLocations.find(x=>x.type==='work'); if(l){pos.x=l.x;pos.y=l.y;} }
        }
        return pos;
    }

    // ‰∫§‰∫íÈÄªËæë (‰øùÊåÅ‰∏çÂèò)
    window.showMapPopup = function(e, name, desc, el) { if(e)e.stopPropagation(); if(window.spyState.isAddingMode)return; document.querySelectorAll('.bw-mini-pin').forEach(p=>p.classList.remove('active')); if(el)el.classList.add('active'); document.getElementById('bubbleTitle').innerText=name; document.getElementById('bubbleDesc').innerText=desc; document.getElementById('mapInfoBubble').classList.add('show'); };
    window.hideMapPopup = function() { document.getElementById('mapInfoBubble').classList.remove('show'); document.querySelectorAll('.bw-mini-pin').forEach(p=>p.classList.remove('active')); };
    window.startAddLocationMode = function() { window.spyState.isAddingMode=true; document.getElementById('spyEmbeddedMap').style.cursor='crosshair'; document.getElementById('btnAddSpot').classList.add('add-active'); document.getElementById('addLocationTip').classList.add('show'); window.hideMapPopup(); };
    window.initMapInteraction = function() { const c=document.getElementById('spyEmbeddedMap'),l=document.getElementById('spyMapMovableLayer'); if(!c||!l)return; let d=false,sx,sy; const uv=()=>l.style.transform=`translate(${window.spyState.currentX}px,${window.spyState.currentY}px) scale(${window.spyState.scale})`; c.onmousedown=c.ontouchstart=(e)=>{if(e.target.closest('.map-fab')||e.target.closest('.map-info-bubble'))return; if(window.spyState.isAddingMode){e.stopPropagation();handleAddLocationClick(e);return;} d=true; const p=e.touches?e.touches[0]:e; sx=p.clientX-window.spyState.currentX; sy=p.clientY-window.spyState.currentY; c.style.cursor='grabbing';}; document.onmousemove=document.ontouchmove=(e)=>{if(!d)return; e.preventDefault(); const p=e.touches?e.touches[0]:e; window.spyState.currentX=p.clientX-sx; window.spyState.currentY=p.clientY-sy; uv();}; document.onmouseup=document.ontouchend=()=>{d=false; c.style.cursor='grab';}; c.onwheel=(e)=>{e.preventDefault(); window.spyState.scale=Math.min(Math.max(0.5,window.spyState.scale+e.deltaY*-0.001),3); uv();}; };
    async function handleAddLocationClick(e) { const l=document.getElementById('spyMapMovableLayer'),r=l.getBoundingClientRect(),c=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY,x=(c-r.left)/r.width*100,y=(cy-r.top)/r.height*100; window.spyState.isAddingMode=false; document.getElementById('spyEmbeddedMap').style.cursor='grab'; document.getElementById('btnAddSpot').classList.remove('add-active'); document.getElementById('addLocationTip').classList.remove('show'); if(typeof openNameInputModal==='function'){openNameInputModal("Âú∞ÁÇπÂêçÁß∞",async(n)=>{if(n){const d=prompt("ÊèèËø∞:")||"Ëá™ÂÆö‰πâ";const f=friends.find(x=>x.id===window.spyState.friendId);f.mapLocations.push({name:n,type:'leisure',x,y,desc:d});await saveData();window.renderSpyUI();}});}else{const n=prompt("ÂêçÁß∞:");if(n){const f=friends.find(x=>x.id===window.spyState.friendId);f.mapLocations.push({name:n,type:'leisure',x,y,desc:"Ëá™ÂÆö‰πâ"});await saveData();window.renderSpyUI();}} }

    // ËÆ∞ÂøÜ‰∫íÈÄö (‰øùÊåÅ‰∏çÂèò)
    window.getSpyContextForAI = function(friend) { if (!friend.spyLogs || friend.spyLogs.length === 0) return ""; const sortedLogs = [...friend.spyLogs].sort((a, b) => (a.time > b.time ? -1 : 1)); const recent = sortedLogs.slice(0, 3); let context = `„ÄêËßÜÂ•∏ÊÉÖÊä•„Äë:\n`; recent.forEach(log => { context += `- ${log.time} Âú®„Äê${log.location || 'Êú™Áü•Âú∞ÁÇπ'}„Äë: ${log.summary} (${log.detail})„ÄÇÂøÉÂ£∞: "${log.thought || ''}"\n`; }); return context; };

    // Ëá™Âä®ÁîüÊàê (‰øùÊåÅ‰∏çÂèò)
    window.checkAllAutoUpdates = async function(f) { const n=Date.now(),s=f.spySettings; if(n-new Date(f.lastSpyLogTime||0).getTime()>s.logInterval*60000) await window.forceRefreshLogs(false); if(n-new Date(f.lastWeatherTime||0).getTime()>s.weatherInterval*60000) await window.refreshWeather(); if(n-new Date(f.lastLuckTime||0).getTime()>s.luckInterval*60000){f.luckValue=Math.floor(Math.random()*100);f.lastLuckTime=new Date().toISOString();await saveData();} if(s.mapInterval>0 && n-new Date(f.lastMapTime||0).getTime()>s.mapInterval*60000) await window.generateMapFromAI(); };
    window.forceRefreshLogs = async function(r=false) { const f=friends.find(x=>x.id===window.spyState.friendId),b=document.getElementById('btnRefreshLog'); if(b){b.classList.add('loading');b.querySelector('i').className='ri-loader-4-line';} const s=await dbManager.get('apiSettings','settings'); if(!s.apiKey)return alert("APIÊú™ÈÖçÁΩÆ"); const n=new Date(),t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`,l=f.luckValue,w=f.weatherCache?`${f.weatherCache.data.current_condition[0].temp_C}¬∞C`:"Êú™Áü•",ln=f.mapLocations.map(x=>x.name).join('„ÄÅ'),st=r?"08:00":(f.spyLogs.length>0?f.spyLogs[f.spyLogs.length-1].time:"08:00"),c=f.citySettings?.fictionalCity||"ÂüéÂ∏Ç"; const p=`„Äê‰ªªÂä°„Äë: ‰∏∫Â±Ö‰ΩèÂú®"${c}"ÁöÑËßíËâ≤"${f.name}"ÁîüÊàê1-3Êù°ÁîüÊ¥ªÂä®ÊÄÅ„ÄÇ„ÄêÊó∂Èó¥„Äë:${st}Âà∞${t}„ÄÇ„ÄêÂú∞ÁÇπÂ∫ì„Äë:[${ln}]„ÄÇÂøÖÈ°ªÂéªËøô‰∫õÂú∞Êñπ„ÄÇ„ÄêÂ§©Ê∞î„Äë:${w}„ÄÇ„ÄêËøêÂäø„Äë:${l}„ÄÇ„ÄêË¶ÅÊ±Ç„Äë:Êó∂Èó¥ÈÄíÂ¢û„ÄÇ JSON: {"logs":[{"time":"HH:MM","summary":"Ê†áÈ¢ò","detail":"ÂÜÖÂÆπ","location":"Âú∞ÁÇπÂêç","weather":"25¬∞C","thought":"ÂøÉÂ£∞"}]}`; try{const rs=await fetch(`${s.apiUrl}/chat/completions`,{method:'POST',headers:{'Authorization':`Bearer ${s.apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:s.modelName,messages:[{role:'user',content:p}],temperature:0.7})});const j=JSON.parse((await rs.json()).choices[0].message.content.match(/\{[\s\S]*\}/)[0]);if(r)f.spyLogs=[];j.logs.forEach(x=>f.spyLogs.push(x));const u=[],sn=new Set();f.spyLogs.forEach(x=>{if(!sn.has(x.time)){sn.add(x.time);u.push(x);}});f.spyLogs=u.sort((a,b)=>a.time>b.time?1:-1);f.lastSpyLogTime=new Date().toISOString();await saveData();window.renderSpyUI();}catch(e){console.error(e);}finally{if(b){b.classList.remove('loading');b.querySelector('i').className='fas fa-sync-alt';}} };
    window.refreshWeather = async function() { const b=document.getElementById('btnWeather'); if(b){b.classList.add('loading');b.querySelector('i').className='ri-loader-4-line';} const f=friends.find(x=>x.id===window.spyState.friendId),c=f.citySettings?.realCity||"Beijing"; try{const r=await fetch(`https://wttr.in/${c}?format=j1&lang=zh`);f.weatherCache={date:new Date().toDateString(),data:await r.json()};f.lastWeatherTime=new Date().toISOString();await saveData();alert("Â§©Ê∞îÂ∑≤Êõ¥Êñ∞ÔºÅ");window.renderSpyUI();}catch(e){alert("Â§±Ë¥•");}finally{if(b){b.classList.remove('loading');b.querySelector('i').className='ri-sun-cloudy-line';}} };
    window.generateMapFromAI = async function() { const b=document.getElementById('btnRedrawMap'); if(b){b.classList.add('loading');b.querySelector('i').className='ri-loader-4-line';} const f=friends.find(x=>x.id===window.spyState.friendId),c=f.citySettings?.fictionalCity||"ÂüéÂ∏Ç",n=f.spySettings?.mapCount||8,s=await dbManager.get('apiSettings','settings'); try{const p=`ÁîüÊàê${n}‰∏™‰Ωç‰∫é"${c}"ÁöÑÂú∞ÁÇπ„ÄÇJSON: [{"name":"Âú∞ÁÇπ","type":"type","desc":"ÊèèËø∞"}]`;const r=await fetch(`${s.apiUrl}/chat/completions`,{method:'POST',headers:{'Authorization':`Bearer ${s.apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:s.modelName,messages:[{role:'user',content:p}]})});const j=JSON.parse((await r.json()).choices[0].message.content.match(/\[[\s\S]*\]/)[0]),fl=[];j.forEach(l=>{let x,y,sf;for(let i=0;i<50;i++){x=Math.random()*80+10;y=Math.random()*70+15;sf=true;for(let o of fl)if(Math.hypot(o.x-x,o.y-y)<15)sf=false;if(sf)break;}l.x=x;l.y=y;fl.push(l);});f.mapLocations=fl;f.lastMapTime=new Date().toISOString();await saveData();window.renderSpyUI();alert("Âú∞ÂõæÈáçÁªòÂÆåÊàêÔºÅ");}catch(e){alert("Â§±Ë¥•");}finally{if(b){b.classList.remove('loading');b.querySelector('i').className='ri-map-2-line';}} };
    window.openAdvancedSpySettings = function() { const f=friends.find(x=>x.id===window.spyState.friendId),s=f.spySettings; let m=document.getElementById('spySettingsModal'); if(!m){m=document.createElement('div');m.id='spySettingsModal';m.className='modal';m.innerHTML='<div class="modal-content"><div class="modal-title">ÂäüËÉΩËÆæÁΩÆ</div><div id="spySettingsForm"></div></div>';document.body.appendChild(m);} document.getElementById('spySettingsForm').innerHTML=`<div class="spy-settings-row"><label class="spy-settings-label">ÁîüÊàêÂú∞ÁÇπÊï∞Èáè</label><input type="number" id="setMapCount" class="spy-settings-input" value="${s.mapCount}" min="4" max="12"></div><div class="spy-settings-row"><label class="spy-settings-label">Âä®ÊÄÅÊ£ÄÊü•Èó¥Èöî(ÂàÜ)</label><input type="number" id="setLogInt" class="spy-settings-input" value="${s.logInterval}" min="10"></div><div class="spy-settings-row"><label class="spy-settings-label">Â§©Ê∞îÊõ¥Êñ∞Èó¥Èöî(ÂàÜ)</label><input type="number" id="setWeatherInt" class="spy-settings-input" value="${s.weatherInterval}" min="60"></div><div class="spy-settings-row"><label class="spy-settings-label">Âπ∏ËøêÂÄºÈáçÁΩÆÈó¥Èöî(ÂàÜ)</label><input type="number" id="setLuckInt" class="spy-settings-input" value="${s.luckInterval}" min="60"></div><div class="spy-settings-row"><label class="spy-settings-label">Âú∞ÂõæËá™Âä®ÈáçÁªòÈó¥Èöî(0ÂÖ≥Èó≠)</label><input type="number" id="setMapInt" class="spy-settings-input" value="${s.mapInterval}" min="0"></div><div style="display:flex;gap:10px;margin-top:20px;"><button onclick="document.getElementById('spySettingsModal').classList.remove('show')" style="flex:1;padding:10px;background:#f5f5f5;border:none;border-radius:8px;">ÂèñÊ∂à</button><button onclick="window.saveAdvancedSpySettings()" style="flex:1;padding:10px;background:#000;color:#fff;border:none;border-radius:8px;">‰øùÂ≠ò</button></div>`; m.classList.add('show'); };
    window.saveAdvancedSpySettings = function() { const f=friends.find(x=>x.id===window.spyState.friendId); f.spySettings={mapCount:parseInt(document.getElementById('setMapCount').value),logInterval:parseInt(document.getElementById('setLogInt').value),weatherInterval:parseInt(document.getElementById('setWeatherInt').value),luckInterval:parseInt(document.getElementById('setLuckInt').value),mapInterval:parseInt(document.getElementById('setMapInt').value)}; saveData(); document.getElementById('spySettingsModal').classList.remove('show'); alert("ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ"); };
    window.openSpyWeatherModal = async function() { document.getElementById('spyWeatherModal').classList.add('show'); };
    window.closeSpyWeatherModal = function() { document.getElementById('spyWeatherModal').classList.remove('show'); };
    window.forceBackFromSpy = function() { if(typeof setActivePage==='function') setActivePage('chatSettingsScreen'); else location.reload(); };
</script>

</body>
</html>
