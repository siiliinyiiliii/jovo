<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>jovo</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://JOVO081113-hue.github.io/JOVO/star-icon.png">
    <link rel="apple-touch-icon-precomposed" href="https://JOVO081113-hue.github.io/JOVO/star-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
      <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Long+Cang&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&family=Liu+Jian+Mao+Cao&family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@300&display=swap" rel="stylesheet">

    <style id="customBubblePreviewStyle"></style>
    <style id="customBubbleStyle"></style>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-shopping.css">
    <link rel="stylesheet" href="spy.css">

</head>
<body>
<!-- [修改版] 里世界战术雷达 (白底现代版 & 去除缩放按钮) -->
<div id="iwMapModal" class="modal" style="z-index: 20000;">
    <!-- 修改1: 背景改为白色 (#ffffff)，文字改为黑色 (#333) -->
    <div class="modal-content" style="padding: 0 !important; width: 340px; border-radius: 24px; overflow: hidden; background: #ffffff; border: 1px solid #e0e0e0; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative;">

        <!-- 顶部信息栏 -->
        <div style="position: absolute; top: 20px; left: 0; width: 100%; z-index: 20; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none;">
            <!-- 修改2: 文字颜色改为深色，去除荧光绿特效 -->
            <div style="color: #333; font-family: sans-serif; font-weight: bold;">
                <div id="iwCurrentLocDisplay" style="font-size: 18px;">正在扫描区域...</div>
                <div style="font-size: 11px; opacity: 0.5; margin-top: 2px;">RADAR ONLINE</div>
            </div>
            <!-- 关闭按钮: 改为灰色圆形背景 -->
            <div onclick="closeIwMapModal()" style="width: 30px; height: 30px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; pointer-events: auto;">
                ✕
            </div>
        </div>

        <!-- 雷达可视区域 -->
                <!-- 雷达可视区域 (修改版：扩大范围) -->
        <div id="iwMapContainer" class="radar-container" style="width: 100%; height: 400px; background: radial-gradient(circle, #f9f9f9 0%, #eeeeee 100%); position: relative; overflow: hidden; cursor: grab;">

            <!-- 可移动/缩放层 -->
                        <div id="iwMapLayer" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-origin: center center;">
                <!-- 装饰圈: 【修改】改小尺寸，视觉更聚焦 -->
                <div class="radar-circle c1" style="border-color: rgba(0,0,0,0.05); width: 100px; height: 100px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 1px solid;"></div>
                <div class="radar-circle c2" style="border-color: rgba(0,0,0,0.05); width: 200px; height: 200px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 1px solid;"></div>
                <div class="radar-circle c3" style="border-color: rgba(0,0,0,0.05); width: 300px; height: 300px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 1px solid;"></div>

                <!-- 地点渲染容器 -->

                <div id="iwMapPins" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>
            </div>

            <!-- 扫描光束 -->
            <div class="radar-scanner" style="background: linear-gradient(45deg, transparent 50%, rgba(0, 122, 255, 0.1) 100%); position: absolute; top: 50%; left: 50%; width: 250px; height: 250px; transform-origin: top left; animation: radarSpin 4s linear infinite; pointer-events: none;"></div>
        </div>


        <!-- 底部：交互列表 -->
                <!-- 底部：交互列表 (可折叠版) -->
        <div style="background: #ffffff; border-top: 1px solid #f0f0f0;">
            <!-- 标题栏 (点击可折叠) -->
            <div onclick="toggleIwMapFooter()" style="padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fafafa;">
                <div style="font-size: 12px; color: #666; font-weight: bold;">
                    <span>可执行操作</span>
                    <span style="color: #007aff; font-family: monospace; margin-left: 5px;">SCANNING...</span>
                </div>
                <!-- 箭头图标 -->
                <i id="iwFooterArrow" class="ri-arrow-down-s-line" style="color: #999; font-size: 16px; transition: transform 0.3s;"></i>
            </div>

            <!-- 列表容器 (默认隐藏 style="display: none;") -->
            <div id="iwInteractablesList" class="iw-items-grid" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; border-top: 1px solid #eee;">
                <!-- JS 动态生成 -->
            </div>
        </div>

    </div>
</div>

<!-- [重构版] 里世界任务分配弹窗 (头像网格 + 详情页) -->
<div id="iwMissionModal" class="modal">
    <div class="modal-content" style="background: #1a1a1a; color: #eee; border: 1px solid #444; min-height: 400px; display: flex; flex-direction: column;">

        <!-- 1. 顶部标题栏 -->
        <div class="modal-title" style="color: #ff4d4d; font-family: 'Courier New', monospace; letter-spacing: 2px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; position: relative;">
            <!-- 返回按钮 (默认隐藏) -->
            <div id="iwMissionBackBtn" onclick="hideMissionDetail()" style="position: absolute; left: 0; cursor: pointer; display: none; font-size: 20px;">
                <i class="ri-arrow-left-s-line"></i>
            </div>
            <span id="iwMissionTitleText">💀 幸存者名单</span>
        </div>

        <div id="iwMissionSubtitle" style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center;">
            点击头像查看详细任务与禁忌
        </div>

        <!-- 2. 视图 A: 头像网格 (默认显示) -->
        <div id="iwMissionGrid" class="iw-mission-grid-view">
            <!-- JS 动态生成头像 -->
        </div>

        <!-- 3. 视图 B: 任务详情 (默认隐藏) -->
        <div id="iwMissionDetail" class="iw-mission-detail-view" style="display: none; flex: 1; overflow-y: auto;">
            <!-- JS 动态填充详情 -->
        </div>

        <!-- 底部按钮 -->
        <div class="modal-buttons" style="margin-top: auto; padding-top: 20px;">
            <button class="modal-btn" onclick="document.getElementById('iwMissionModal').classList.remove('show')" style="background: #333; color: #fff;">关闭</button>
            <!-- 只有在网格视图才显示重新分配按钮 -->
            <button id="iwRedistributeBtn" class="modal-btn" onclick="generateInnerWorldMissions()" style="background: #b71c1c; color: #fff; font-weight: bold;">🎲 重新分配</button>
        </div>
    </div>
</div>

   <!-- [新增] 纯阅读用的里世界信息悬浮球 -->
<div id="iw-info-float" style="display: none;">
    <!-- 折叠状态：一个小胶囊按钮 -->
    <div class="iw-float-header" onclick="toggleIWFloatContent()">
        <span>🪐 世界设定</span>
        <i class="ri-arrow-down-s-line" id="iw-float-icon"></i>
    </div>

        <!-- 展开状态：显示详细信息 -->
    <div class="iw-float-content" id="iw-float-body">

        <!-- 1. 世界观部分 -->
        <div class="iw-section-title foldable" onclick="toggleIWInnerSection('desc')">
            <span>🌍 世界观</span>
            <i class="ri-arrow-up-s-line" id="arrow-desc"></i>
        </div>
        <div id="iw-float-desc" class="iw-text-block">暂无数据</div>

        <!-- 2. 生存规则部分 -->
        <div class="iw-section-title foldable" style="margin-top:10px;" onclick="toggleIWInnerSection('rules')">
            <span>⚖️ 生存规则</span>
            <i class="ri-arrow-up-s-line" id="arrow-rules"></i>
        </div>
        <ul id="iw-float-rules" class="iw-text-block" style="padding-left: 20px; margin: 5px 0;">
            <li>暂无规则</li>
        </ul>

        <!-- 3. 当前剧情部分 -->
        <div class="iw-section-title foldable" style="margin-top:10px; color: #ff9a9e;" onclick="toggleIWInnerSection('plot')">
            <span>🔥 当前状态 / 剧情</span>
            <i class="ri-arrow-up-s-line" id="arrow-plot"></i>
        </div>
        <div id="iw-float-plot" class="iw-text-block" style="border-left: 2px solid #ff9a9e; padding-left: 8px; margin-top: 5px; font-style: italic;">
            暂无最新剧情，请点击控制台推进...
        </div>

    </div>

</div>
<!-- 里世界配置弹窗 -->
<div id="innerWorldModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">构建里世界</div>

        <div class="form-group">
            <label class="form-label">设定世界观</label>
            <textarea class="modal-textarea" id="innerWorldPrompt" placeholder="例如：丧尸围城的末日世界，原本的朋友都变成了幸存者或丧尸..." style="min-height: 120px;"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">选择保留的角色 (作为NPC带入)</label>
            <div id="innerWorldCharList" class="multi-select-list" style="max-height: 200px;">
                <!-- JS 动态生成 -->
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeInnerWorldModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="startInnerWorldTransition()">开始穿越</button>
        </div>
    </div>
</div>

<!-- [新增] 存档/读档管理弹窗 -->
<div id="worldArchiveModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="archiveModalTitle">世界存档管理</div>

        <!-- 新建存档输入框 (仅存档模式显示) -->
        <div id="newArchiveInputArea" style="margin-bottom: 15px; display: none;">
            <input type="text" class="modal-input" id="newArchiveName" placeholder="输入存档名称 (如: 丧尸围城-第3天)">
            <button class="modal-btn modal-btn-confirm" onclick="confirmSaveWorld()">新建存档</button>
        </div>

        <!-- 存档列表 -->
        <div id="worldArchiveList" class="friend-list" style="max-height: 300px; overflow-y: auto;">
            <!-- JS 动态生成 -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('worldArchiveModal').classList.remove('show')">关闭</button>
        </div>
    </div>
</div>



<!-- 新增：论坛私信详情页 (独立页面 - 修复版) -->
<div id="forumDMDetailScreen" class="page">
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <!-- 修复点1：确保返回按钮绑定了正确的函数 -->
        <button class="nav-btn" onclick="backToForumMessages()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title" id="forumDMTargetName">私信对话</div>
        <div style="width: 40px;"></div>
    </div>

    <!-- 聊天内容区 -->
    <div class="wechat-content" id="forumDMChatContainer" style="padding-top: 74px; padding-bottom: 80px; background: #fff;">
        <!-- 动态生成 -->
    </div>

    <!-- 底部回复栏 -->
    <div class="bottom-reply-bar" style="position:fixed; bottom:0; left:0; width:100%; background:#fff; border-top:1px solid #eee; padding:10px; z-index:1000; box-sizing:border-box;">
        <!-- 修复点2：确保输入框ID为 forumDMInput -->
        <input type="text" id="forumDMInput" placeholder="回复私信..." style="flex:1; background:#f5f5f5; border:none; padding:10px 15px; border-radius:20px; outline:none; font-size:15px;">
        <!-- 修复点3：确保发送按钮绑定了 sendForumDMReply -->
        <button onclick="sendForumDMReply()" style="background:none; border:none; margin-left:10px; color:#1d9bf0; font-weight:bold; font-size:15px;">
            发送
        </button>
    </div>
</div>

<!-- 新增：论坛私信生成器弹窗 (带性别版) -->
<div id="forumDMGenerateModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">接收新私信</div>

        <!-- 1. 身份输入框 -->
        <div class="form-group">
            <label class="form-label">你的论坛身份</label>
            <input type="text" class="modal-input" id="forumDMUserRole" placeholder="例如：新人画手、争议网红">
        </div>

        <!-- 2. 【新增】性别选择框 -->
        <div class="form-group">
            <label class="form-label">你的性别 (决定称呼)</label>
            <select class="modal-input" id="forumDMUserGender">
                <option value="女">女</option>
                <option value="男">男</option>
                <option value="通用">保密</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">私信类型偏好 (可多选)</label>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <label class="dm-type-tag"><input type="checkbox" value="fan" checked> 粉丝/表白</label>
                <label class="dm-type-tag"><input type="checkbox" value="business"> 商务/约稿</label>
                <label class="dm-type-tag"><input type="checkbox" value="hate"> 网暴/黑粉</label>
                <label class="dm-type-tag"><input type="checkbox" value="spam"> 垃圾/广告</label>
                <label class="dm-type-tag"><input type="checkbox" value="harass"> 骚扰/搭讪</label>
                <label class="dm-type-tag"><input type="checkbox" value="chat"> 路人闲聊</label>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">生成数量</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="forumDMCount" min="1" max="10" value="3" style="flex:1;" oninput="this.nextElementSibling.innerText = this.value">
                <span style="font-weight:bold; width: 30px; text-align: center;">3</span> 封
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('forumDMGenerateModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmGenerateForumDMs()">开始接收</button>
        </div>
    </div>
</div>



<!-- 新增：邮件生成设置弹窗 -->
<div id="emailGenerateModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">收件箱设置</div>

        <!-- 1. 你的称呼 -->
        <div class="form-group" style="margin-bottom: 15px;">
            <label class="form-label" style="font-size:14px; color:#666;">收件人姓名</label>
            <input type="text" class="modal-input" id="emailUserName" placeholder="例如：阿强">
        </div>

        <!-- 2. 你的性别 -->
        <div class="form-group" style="margin-bottom: 15px;">
            <label class="form-label" style="font-size:14px; color:#666;">收件人性别</label>
            <select class="modal-input" id="emailUserGender">
                <option value="男">男</option>
                <option value="女">女</option>
                <option value="保密">保密</option>
            </select>
        </div>

        <!-- 3. 你的当前人设 -->
        <div class="form-group" style="margin-bottom: 15px;">
            <label class="form-label" style="font-size:14px; color:#666;">当前身份/状态</label>
            <textarea class="modal-textarea" id="emailUserPersona" placeholder="例如：刚入职的实习生、被催婚的单身狗、欠债的赌徒..." style="min-height: 60px;"></textarea>
        </div>

        <!-- 4. 生成数量 -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label class="form-label" style="font-size:14px; color:#666;">生成随机邮件数量</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="emailGenCountSlider" min="1" max="5" value="3" style="flex:1; accent-color: #333;" oninput="document.getElementById('emailGenCountDisplay').innerText = this.value">
                <span id="emailGenCountDisplay" style="font-weight:bold; width: 30px; text-align: center;">3</span> 封
            </div>
            <div style="font-size: 10px; color: #999; margin-top: 5px;">(注：如果有被拉黑的好友，会自动额外生成求饶信)</div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeEmailGenerateModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmEmailGeneration()">开始接收</button>
        </div>
    </div>
</div>


<!-- 【新增】加载遮罩层 -->
<div id="loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #f7f7f7;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease;
">
    <!-- 这里是一个简单的微信风格转圈动画 -->
    <div style="
        width: 40px;
        height: 40px;
        border: 4px solid #e0e0e0;
        border-top: 4px solid #07c160;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    "></div>
    <div style="color: #999; font-size: 14px;">正在载入数据...</div>
</div>
<!-- 【修复】补全缺失的 API 拉取加载层 -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;"></div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<!-- 清空朋友圈选择弹窗 -->
<div id="clearMomentsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择要清空的对象</div>
        <div style="font-size: 12px; color: #999; text-align: center; margin-bottom: 15px;">
            勾选后，该角色的所有朋友圈将被永久删除
        </div>

        <!-- 列表容器 -->
        <div id="clearMomentsList" class="multi-select-list" style="max-height: 300px;">
            <!-- JS 会在这里生成名单 -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('clearMomentsModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmClearMoments()" style="background-color: #ff3b30; color: white;">确认删除</button>
        </div>
    </div>
</div>


<!<!-- [升级版] 同城雷达地图弹窗 -->
<div id="cityMapModal" class="modal">
    <div class="modal-content" style="padding: 0 !important; width: 340px; border-radius: 24px; overflow: hidden; background: #ffffff; box-shadow: 0 20px 50px rgba(0,0,0,0.15);">

        <!-- 顶部信息浮层 (半透明磨砂) -->
        <div class="radar-header-overlay">
            <div class="radar-user-info">
                <div class="radar-user-avatar" id="cityMapHeaderAvatar"></div>
                <div>
                    <div class="radar-user-name" id="cityMapTargetName">用户名</div>
                    <div class="radar-user-dist">
                        <i class="ri-map-pin-line"></i> 距你 <span id="cityMapDistance">0.0</span> km
                    </div>
                </div>
            </div>
            <!-- 进入主页按钮 -->
            <button class="radar-profile-btn" id="cityMapProfileBtn">
                主页 <i class="ri-arrow-right-s-line"></i>
            </button>
        </div>

        <!-- 雷达可视区域 -->
        <div id="cityRadarVisual" class="radar-container">
            <!-- 背景网格 -->
            <div class="radar-grid"></div>
            <!-- 同心圆刻度 -->
            <div class="radar-circle c1"></div>
            <div class="radar-circle c2"></div>
            <div class="radar-circle c3"></div>
            <!-- 十字准星 -->
            <div class="radar-crosshair h"></div>
            <div class="radar-crosshair v"></div>
            <!-- 扫描扇形 -->
            <div class="radar-scanner"></div>

            <!-- 我 (中心点) -->
            <div class="map-point me">
                <div class="point-avatar-ring"></div>
                <div class="point-avatar" id="cityMapMyAvatar"></div>
            </div>

            <!-- 所有人容器 -->
            <div id="cityMapPointsContainer"></div>
        </div>

        <!-- 底部关闭栏 -->
        <div class="radar-footer" onclick="closeCityMapModal()">
            <i class="ri-close-circle-line"></i> 关闭雷达
        </div>
    </div>
</div>



<!-- [新增] 从分组导入NPC的弹窗 -->
<div id="importNpcModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择来源分组</div>
        <div style="font-size: 12px; color: #999; margin-bottom: 15px; text-align: center;">
            将该分组下的所有 NPC 一键拉入当前群聊
        </div>

        <!-- 分组列表容器 -->
        <div id="importNpcGroupList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS 动态生成 -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('importNpcModal').classList.remove('show')">取消</button>
        </div>
    </div>
</div>

<!-- [新增] Token 深度分析弹窗 -->
<div id="tokenAnalysisModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 400px; padding: 0; background: #fff; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh;">

        <div class="modal-title" style="padding: 20px 20px 10px; margin: 0; text-align: left; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center;">
            <span>Token 消耗</span>
            <span id="tokenTotalHeader" style="font-size: 14px; color: #007aff; background: rgba(0,122,255,0.1); padding: 4px 8px; border-radius: 6px;">0 Token</span>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 15px;">
            <!-- 提示条 -->
            <div style="font-size: 11px; color: #999; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <i class="ri-information-line"></i> 中文≈2 Token，英文单词≈1.3 Token。
            </div>

            <!-- 分析列表容器 -->
            <div id="tokenListContainer" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- JS 动态生成 -->
            </div>
        </div>

        <div class="modal-buttons" style="padding: 15px; border-top: 1px solid #f5f5f5; margin: 0;">
            <button class="modal-btn modal-btn-confirm" onclick="document.getElementById('tokenAnalysisModal').classList.remove('show')">关闭</button>
        </div>
    </div>
</div>


<!-- [新增] 角色城市地图弹窗 -->
<div id="spyMapModal" class="modal">
    <div class="modal-content" style="padding: 0 !important; width: 90% !important; max-width: 360px !important; height: 80vh; display: flex; flex-direction: column; overflow: hidden; background: #fff !important; border-radius: 20px !important;">

        <!-- 顶部标题 -->
        <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div id="mapCityName" style="font-size: 18px; font-weight: 800; color: #000;">CITY MAP</div>
                <div style="font-size: 10px; color: #999;">EXPLORE THE WORLD</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="doujinOpenAddBuildingModal()" style="border: none; background: none; cursor: pointer; color: #000; font-size: 18px;" title="手动添加建筑"><i class="ri-add-circle-line"></i></button>
                <button id="refreshMapBtn" onclick="generateMapFromAI()" style="border: none; background: none; cursor: pointer; color: #000; font-size: 18px;" title="AI重新规划"><i class="ri-refresh-line"></i></button>
                <button onclick="closeSpyMapModal()" style="border: none; background: none; cursor: pointer; color: #999; font-size: 18px;"><i class="ri-close-line"></i></button>
            </div>
        </div>

        <!-- 地图可视化区域 (模拟雷达图/平面图) -->
        <div id="mapVisualArea" style="width: 100%; aspect-ratio: 1/1; background-color: #f9f9f9; position: relative; overflow: hidden; border-bottom: 1px dashed #eee;">
            <!-- 网格背景装饰 -->
            <div style="position: absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; opacity: 0.5;"></div>
            <div style="position: absolute; top:50%; left:0; width:100%; height:1px; background: rgba(0,0,0,0.05);"></div>
            <div style="position: absolute; top:0; left:50%; width:1px; height:100%; background: rgba(0,0,0,0.05);"></div>

            <!-- JS 将在这里插入建筑图标 -->
            <div id="mapPinsContainer"></div>
        </div>

        <!-- 建筑列表区域 -->
        <div id="mapLocationsList" style="flex: 1; overflow-y: auto; padding: 10px 20px;">
            <!-- JS 动态生成 -->
        </div>

    </div>
</div>

<!-- [新增] 手动添加建筑的弹窗 -->
<div id="addBuildingModal" class="modal" style="z-index: 10001;">
    <div class="modal-content">
        <div class="modal-title">添加地点</div>
        <input type="text" class="modal-input" id="newBuildingName" placeholder="地点名称 (如: 秘密基地)">
        <input type="text" class="modal-input" id="newBuildingDesc" placeholder="简介 (如: 我们第一次见面的地方)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('addBuildingModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAddBuilding()">确定</button>
        </div>
    </div>
</div>

<!-- [黑白极简版 - 小尺寸] 角色城市天气弹窗 -->
<div id="spyWeatherModal" class="modal">
    <div class="modal-content" style="
        padding: 0 !important;
        overflow: hidden;
        background-color: #ffffff !important;
        color: #000000 !important;
        border-radius: 16px !important;       /* 圆角稍微改小一点 */
        box-shadow: 0 15px 40px rgba(0,0,0,0.2) !important;
        width: 85% !important;                /* 宽度占比改小 */
        max-width: 300px !important;          /* 【核心】最大宽度改小 */
        display: flex;
        flex-direction: column;
    ">

        <!-- 顶部城市名 -->
        <div style="padding: 20px 20px 0; text-align: left;">
            <!-- 字体从 28px 改为 22px -->
            <div id="spyWeatherFictionalName" style="font-size: 22px; font-weight: 900; letter-spacing: 1px; line-height: 1.2;">CITY NAME</div>
            <div id="spyWeatherRealName" style="font-size: 10px; color: #999; margin-top: 4px; font-family: monospace;">REAL: SOURCE</div>
        </div>

        <!-- 天气内容区域 -->
        <div id="weatherContentArea" style="padding: 20px; flex: 1;">
            <!-- 加载动画 -->
            <div style="text-align: center; padding: 30px 0; color: #999;">
                <div class="loading-spinner" style="width: 24px; height: 24px; border-width: 2px; border-top-color: #000; border-right-color: transparent; border-bottom-color: transparent; border-left-color: transparent; margin: 0 auto 10px;"></div>
                <div style="font-size: 11px;">连接气象卫星...</div>
            </div>
        </div>

        <!-- 底部关闭栏 -->
        <div onclick="closeSpyWeatherModal()" style="
            border-top: 1px solid #f0f0f0;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            background: #fafafa;
            color: #333;
        ">
            关 闭
        </div>
    </div>
</div>




<!-- 新增：自动写日记角色选择弹窗 -->
<div id="diaryRoleSelectModal" class="modal" style="z-index: 2000;">
    <div class="modal-content">
        <div class="modal-title">选择角色</div>

        <!-- ▼▼▼ 新增：快捷操作栏 ▼▼▼ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
            <div style="font-size: 12px; color: #999;">点击头像选中</div>
            <button class="nav-btn" onclick="toggleDiarySelectAllRoles()" style="font-size: 13px; color: #007aff; border: 1px solid #007aff; padding: 2px 8px; border-radius: 12px;">全选 / 清空</button>
        </div>
        <!-- ▲▲▲ 新增结束 ▲▲▲ -->

        <div id="diaryRoleSelectList" class="multi-select-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS 将在这里生成网格 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryRoleSelectModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveDiaryRoleSelection()">确定</button>
        </div>
    </div>
</div>


<!-- [修改版] 群公告管理弹窗 (支持多条) -->
<div id="groupAnnouncementModal" class="modal">
    <div class="modal-content" style="max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-title">群公告板</div>

        <!-- 1. 现有公告列表区 -->
        <div style="flex: 1; overflow-y: auto; margin-bottom: 15px; min-height: 100px; background: #f9f9f9; border-radius: 8px; padding: 10px;">
            <div id="announcementListContainer">
                <!-- JS 将在这里动态生成公告卡片 -->
            </div>
        </div>

        <!-- 2. 新公告输入区 -->
        <div style="border-top: 1px solid #eee; padding-top: 15px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">发布新公告 (AI会记住列表里的所有内容)</div>
            <textarea class="modal-textarea" id="newAnnouncementInput" placeholder="输入新公告内容..." style="min-height: 80px; margin-bottom: 10px;"></textarea>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeGroupAnnouncementModal()">关闭</button>
                <button class="modal-btn modal-btn-confirm" onclick="publishNewAnnouncement()">发布</button>
            </div>
        </div>
    </div>
</div>


<!-- 习惯打卡弹窗 -->
<div id="habitTrackerModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 20px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">

        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span>自律打卡</span>
            <button class="nav-btn" onclick="createNewHabit()" style="font-size: 24px; padding: 0; color: #333;">+</button>
        </div>

        <!-- 统计概览 -->
        <div class="habit-stats-overview" style="display: flex; justify-content: space-around; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 12px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #000;" id="habitTotalDays">0</div>
                <div style="font-size: 11px; color: #999;">坚持天数</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #d87897;" id="habitTodayCount">0</div>
                <div style="font-size: 11px; color: #999;">今日已打</div>
            </div>
        </div>

        <!-- 习惯列表 -->
        <div id="habitListContainer" style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
            <!-- JS 动态生成 -->
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeHabitTracker()">关闭</button>
        </div>
    </div>
</div>


<!-- 【【【第一步：请将这行代码粘贴到 <body> 标签下面】】】 -->

    <audio id="audioPlayer"></audio>
        <!-- ▼▼▼ 文件上传控件集中管理区 (已合并去重) ▼▼▼ -->
    <div id="hidden-upload-controls" style="display: none;">
        <!-- 1. 聊天与多媒体 -->
        <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoUpload(event)">
        <input type="file" id="songFileInput" accept="audio/mp3,audio/*" onchange="handleSongFileSelect(event)">
        <input type="file" id="lrcFileInput" accept=".lrc" onchange="handleLrcFileSelect(event)">

        <!-- 2. 外观与背景 -->
        <input type="file" id="wallpaper-upload-input" accept="image/*">
        <input type="file" id="user-photo-upload-input" accept="image/*"> <!-- 拍立得相框 -->
        <input type="file" id="listenBgInput" accept="image/*" onchange="handleListenBgUpload(event)">
        <input type="file" id="vinylImageInput" accept="image/*" onchange="handleVinylImageUpload(event)">

        <!-- 3. 表情包 -->
        <input type="file" id="singleEmojiUploadInput" accept="image/*" onchange="handleSingleEmojiUpload(event)">
        <input type="file" id="batchEmojiUploadInput" accept="image/*" onchange="handleBatchEmojiUpload(event)" multiple>
        <input type="file" id="libraryUploadInput" accept="image/*" multiple onchange="handleLibraryUpload(event)"> <!-- 表情库 -->

        <!-- 4. 桌面小组件 -->
        <input type="file" id="widgetImageInput" accept="image/*" onchange="handleWidgetImageUpload(event)">
        <input type="file" id="desktopImageUploadInput" accept="image/*" onchange="handleDesktopImageUpload(event)">
        <input type="file" id="desktopAvatarUploadInput" accept="image/*" onchange="handleDesktopAvatarUpload(event)">

        <!-- 5. 提示音 -->
        <input type="file" id="receivedSoundInput" accept="audio/mp3,audio/wav,audio/mpeg" onchange="handleSoundUpload(event, 'received')">
        <input type="file" id="sentSoundInput" accept="audio/mp3,audio/wav,audio/mpeg" onchange="handleSoundUpload(event, 'sent')">

        <!-- 6. 其他功能 -->
        <input type="file" id="uploadNovelInput" accept=".txt" onchange="handleNovelUpload(event)"> <!-- 小说 -->
        <input type="file" id="avatarFrameInput" accept="image/*" onchange="handleAvatarFrameUpload(event)"> <!-- 头像框 -->
        <input type="file" id="readerBgUpload" accept="image/*" onchange="handleReaderBgUpload(event)"> <!-- 阅读器背景 -->
        <input type="file" id="lovers-bg-input" accept="image/*" onchange="handleLoversBgUpload(event)"> <!-- 情侣空间背景 -->
        <input type="file" id="lovers-post-file" accept="image/*" onchange="previewLoversPostImage(this)"> <!-- 情侣动态发图 -->
        <input type="file" id="friendAvatarUploadInput" accept="image/*"> <!-- 预留给好友头像 -->
    </div>
    <!-- ▲▲▲ 上传控件区结束 ▲▲▲ -->

    <div id="message-notification">
        <div id="notification-avatar"></div>
        <div id="notification-content">
            <div id="notification-sender"></div>
            <div id="notification-message"></div>
        </div>
    </div>

    <div class="phone">
        <div id="floatingPlayer">
            <div id="floatingPlayerArt"></div>
            <div id="floatingPlayerInfo">
                <span id="floatingPlayerTitle">歌曲名称</span>
                <span id="floatingPlayerSubtitle">正在一起听...</span>
            </div>
            <button id="floatingPlayerCloseBtn" onclick="terminateListenTogether(event)">&times;</button>
        </div>

<!-- 小说悬浮窗 -->
<div id="floatingNovelWindow" class="floating-novel-window" style="display: none;">
    <!-- 1. 顶部栏：标题 + 进度 + 窗口控制 -->
    <div class="novel-float-header">
        <span id="floatNovelTitle" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">小说名</span>

        <div class="novel-float-controls" style="display: flex; align-items: center;">
            <!-- 【修改】进度显示移到这里 -->
            <span id="floatPageIndicator" style="font-size: 12px; color: #888; margin-right: 8px;">1 / 10</span>

            <!-- 原有的窗口控制 -->
            <span onclick="expandReaderFromFloat()" title="全屏阅读" style="cursor: pointer; margin-left: 5px;"><i class="ri-fullscreen-line"></i></span>
            <span onclick="closeFloatingNovel()" title="关闭" style="cursor: pointer; margin-left: 8px;"><i class="ri-close-line"></i></span>
        </div>
    </div>

    <div id="floatNovelContent" class="novel-float-content">
        <!-- 这里显示当前页的文字摘要 -->
    </div>

    <!-- 2. 底部栏：上一页 + 缩放控制 + 下一页 -->
    <div class="novel-float-footer" style="justify-content: space-between; padding: 0 15px;">
        <!-- 【修改】上一页变成箭头图标 -->
        <span class="float-nav-btn" onclick="floatPrevPage()" title="上一页">
            <i class="ri-arrow-left-s-line" style="font-size: 18px;"></i>
        </span>

        <!-- 【修改】加号减号移到中间 -->
        <div style="display: flex; gap: 15px;">
            <span class="float-nav-btn" onclick="resizeFloatWindow(-1)" title="缩小窗口">
                <i class="ri-subtract-line" style="font-size: 16px;"></i>
            </span>
            <span class="float-nav-btn" onclick="resizeFloatWindow(1)" title="放大窗口">
                <i class="ri-add-line" style="font-size: 16px;"></i>
            </span>
        </div>

        <!-- 【修改】下一页变成箭头图标 -->
        <span class="float-nav-btn" onclick="floatNextPage()" title="下一页">
            <i class="ri-arrow-right-s-line" style="font-size: 18px;"></i>
        </span>
    </div>

    <div class="resize-handle"></div>
</div>

        <!-- 请用这段代码替换你原有的 status-bar 部分 -->
<div class="status-bar">
    <div class="status-left">
        <span id="currentTime">18:29</span>
    </div>
    <div class="status-right">
        <div class="signal-icon">
            <div class="signal-bar"></div>
            <div class="signal-bar"></div>
            <div class="signal-bar"></div>
            <!-- 给第四根信号条增加一个 "inactive" 类 -->
            <div class="signal-bar inactive"></div>
        </div>
        <div class="network-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
            </svg>
        </div>
        <!-- 这是修改后的电池图标结构 -->
     <!-- 这是需要恢复的、包含子元素的电池图标HTML结构 -->
<div class="battery-icon">
    <div class="battery-level"></div>
    <div class="battery-tip"></div>
</div>


    </div>
</div>

        <div class="screen">
<div id="homeScreen" class="page active">
    <!-- 主屏幕总容器 -->
    <div class="home-screen">

        <!-- 滑动区域 (包含两页) -->
        <div id="home-screen-pager">

            <!-- ========================= -->
            <!-- 第1页：个人挂件与常用功能 -->
            <!-- ========================= -->
            <div class="home-screen-page">

                <!-- 1. 顶部个人信息长卡片 -->
                <div class="profile-widget-container" id="profileWidgetContainer">
                    <div class="profile-widget">
                        <div class="profile-avatar-widget" id="widgetAvatar" onclick="changeAvatar()"></div>
                        <div class="widget-info-section">
                            <div class="profile-name-widget" id="widgetName" onclick="changeName()">可点击编辑</div>
                            <div class="profile-signature-widget" id="widgetSignature" onclick="changeSignature()">可点击编辑</div>
                            <div class="profile-location" onclick="changeLocation()">
                                <svg class="location-icon" viewBox="0 0 24 24">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                </svg>
                                <span id="widgetLocation">可点击编辑</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 中部功能区域 -->
                <div class="home-widgets-container">

                    <!-- 左侧：功能按钮 + 消息通知 (垂直排列) -->
                    <div class="left-vertical-stack">
                        <!-- 2x2 按钮网格 -->
                        <div class="app-grid">
                            <div class="app wechat" onclick="openApp('wechat')">
                                <div class="app-icon-container" id="icon-wechat"><i class="ri-wechat-fill"></i></div>
                                <div class="app-label">微信</div>
                            </div>
                            <div class="app settings" onclick="openApp('settings')">
                                <div class="app-icon-container" id="icon-settings"><i class="ri-settings-3-fill"></i></div>
                                <div class="app-label">设置</div>
                            </div>
                            <div class="app worldbook" onclick="openApp('worldbook')">
                                <div class="app-icon-container" id="icon-worldbook"><i class="ri-book-3-fill"></i></div>
                                <div class="app-label">世界书</div>
                            </div>
                            <div class="app theme" onclick="openApp('theme')">
                                <div class="app-icon-container" id="icon-theme"><i class="ri-palette-fill"></i></div>
                                <div class="app-label">主题</div>
                            </div>
                        </div>

                        <!-- 消息通知盒 -->
                        <div class="notification-box" id="homeNotificationBox">
                            <div class="notif-list" id="homeNotificationList">
                                <div style="text-align: center; color: #ccc; font-size: 14px; margin-top: 40px;">暂无新消息</div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：大号自定义挂件 -->
                    <div class="new-widget" id="homeScreenWidget">
                        <div class="widget-header-text" id="widgetHeaderText" onclick="editWidgetText('widgetHeaderText', this)">(:::[♡]:::)..?</div>
                        <div class="widget-bubble">
                            <img id="widgetImage1" src="https://i.imgur.com/example-avatar-1.png" onclick="editWidgetImage('widgetImage1')">
                            <span id="widgetText1" onclick="editWidgetText('widgetText1', this)">have a nice day 🌟</span>
                        </div>
                        <div class="widget-bubble">
                            <span id="widgetText2" onclick="editWidgetText('widgetText2', this)">.o. HAPPY EVERYDAY ☻</span>
                            <img id="widgetImage2" src="https://i.imgur.com/example-avatar-2.png" onclick="editWidgetImage('widgetImage2')">
                        </div>
                    </div>

                </div>
            </div>

            <!-- ========================= -->
            <!-- 第2页：桌面组件与拓展应用 -->
            <!-- ========================= -->
            <div class="home-screen-page" id="desktop-page-2">

                <!-- 音乐/搜索栏 -->
                <div class="music-search-widget">
                    <div class="placeholder music-avatar-placeholder" id="desktop-avatar-2" onclick="openImageUploaderForDesktopAvatar('desktop-avatar-2')"></div>
                    <div class="music-input-area">
                        <textarea id="desktop-music-textarea" placeholder="🎧 ᵔ ıllı|lıll| ♪ 그리워하면 아프다 Search" onchange="saveDesktopTextData()"></textarea>
                        <i class="ri-search-line"></i>
                    </div>
                </div>

                <!-- 三图画廊 -->
                <div class="image-gallery-placeholder">
                    <div class="placeholder placeholder-image" id="desktop-image-1" onclick="openImageUploaderForDesktop('desktop-image-1')">图片1</div>
                    <div class="placeholder placeholder-image" id="desktop-image-2" onclick="openImageUploaderForDesktop('desktop-image-2')">图片2</div>
                    <div class="placeholder placeholder-image" id="desktop-image-3" onclick="openImageUploaderForDesktop('desktop-image-3')">图片3</div>
                </div>

                <!-- 个人简介条 -->
                <div class="user-profile-area">
                    <div class="placeholder placeholder-avatar" id="desktop-avatar-1" onclick="openImageUploaderForDesktopAvatar('desktop-avatar-1')">头像</div>
                    <textarea class="bio-textarea" id="desktop-bio-textarea" placeholder="可点击编辑&#10;🖤&#10;📍 London" onchange="saveDesktopTextData()"></textarea>
                </div>

                <!-- 自定义倒数日/文字条 -->
                <div class="custom-widget">
                    <input type="text" class="widget-input" id="desktop-widget-input" placeholder="宝宝生日☆· ° 还有50天" onchange="saveDesktopTextData()">
                    <div class="widget-icons">
                        <i class="ri-at-line"></i>
                        <i class="ri-chat-3-line"></i>
                        <i class="ri-heart-3-line"></i>
                    </div>
                </div>

                <!-- 拓展应用网格 -->
                <div class="icon-grid-placeholder">
                    <div class="app" onclick="openApp('doujinForum')">
                        <div class="app-icon-container card-style" id="icon-doujin"><i class="ri-quill-pen-line"></i></div>
                        <div class="app-label">同人</div>
                    </div>
                    <div class="app" onclick="openApp('games')">
                        <div class="app-icon-container card-style" id="icon-games"><i class="ri-gamepad-line"></i></div>
                        <div class="app-label">游戏</div>
                    </div>
                    <div class="app" onclick="openApp('store')">
                        <div class="app-icon-container card-style" id="icon-store"><i class="ri-shopping-bag-line"></i></div>
                        <div class="app-label">商店</div>
                    </div>
                    <div class="app" onclick="openApp('lovers')">
                        <div class="app-icon-container card-style" id="icon-lovers"><i class="ri-hearts-line"></i></div>
                        <div class="app-label">情侣空间</div>
                    </div>
                                        <!-- 里世界入口 -->
                    <div class="app" onclick="openApp('innerWorld')">

                        <!-- ↓↓↓ 核心修复：加上了这个 ID ↓↓↓ -->
                        <div class="app-icon-container card-style" id="icon-innerWorld" style="background-color: #2c2c2e;">
                            <i class="ri-planet-line" style="color: #fff; font-size: 30px;"></i>
                        </div>
                        <div class="app-label">里世界</div>
                    </div>


                </div>

                <div class="spacer"></div>
            </div>
        </div>

        <!-- 固定元素：分页指示点 -->
        <div id="home-screen-dots">
            <span class="dot active" onclick="navigateToHomePage(0)"></span>
            <span class="dot" onclick="navigateToHomePage(1)"></span>
        </div>

        <!-- 固定元素：底部 Dock 栏 -->
        <div class="bottom-dock">
            <div class="app" onclick="openApp('phone')">
                <div class="app-icon-container" id="icon-phone"><i class="ri-phone-fill"></i></div>
                <div class="app-label">手机</div>
            </div>
            <div class="app forum-app" onclick="openApp('forum')">
                <div class="app-icon-container" id="icon-forum"><i class="ri-discuss-fill"></i></div>
                <div class="app-label">论坛</div>
            </div>
            <div class="app" onclick="openApp('study')">
                <div class="app-icon-container card-style" id="icon-study" style="background-color: #fff;">
                    <i class="ri-timer-flash-line" style="font-size: 28px; color: #333;"></i>
                </div>
                <div class="app-label">专注</div>
            </div>
        </div>

    </div>
</div>
<!--微信界面-->
<div id="wechatApp" class="page">
    <!-- 全局背景图层 (支持透明度设置) -->
    <div id="wechatAppBackground"></div>

    <!-- 顶部导航栏 -->
    <div class="nav-bar">
        <!-- 左侧：返回主屏幕 -->
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 中间：标题 -->
        <div class="nav-title">消息</div>

        <!-- 右侧：加号菜单按钮 -->
        <div id="navRightButtons">
            <button class="nav-btn nav-right-action-btn" id="addMenuBtn" onclick="toggleAddMenu()">
                <i class="ri-add-line"></i>
            </button>
        </div>
    </div>

    <!-- 右上角下拉菜单 (发起群聊/添加好友) -->
    <div class="add-menu" id="addMenu">
        <div class="add-menu-item" onclick="openGroupChatModal()">发起群聊</div>
        <div class="add-menu-item" onclick="openAddFriend()">添加好友</div>
    </div>

    <!-- 微信内容主容器 -->
    <div class="wechat-content">

        <!-- 1. 消息列表页 -->
        <div id="wechatMessages" class="friend-list">
            <!-- JS 将在这里动态生成聊天列表 -->
        </div>

        <!-- 2. 发现页 (采用整洁的黑白卡片风格) -->
        <div id="wechatDiscover" class="discover-content bw-style" style="display: none;">

            <!-- 第一组：社交动态 -->
            <div class="form-card">
                <div class="form-group-row clickable" onclick="openMoments()">
                    <label class="form-label"><i class="ri-donut-chart-line"></i> 朋友圈</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openCharSpaceSelector()">
                    <label class="form-label"><i class="ri-user-heart-line"></i> Char空间</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <!-- ▼▼▼ 新增：电子邮箱入口 ▼▼▼ -->
<div class="form-group-row clickable" onclick="openEmailApp()">
    <label class="form-label"><i class="ri-mail-send-line"></i> 电子邮箱</label>
    <div class="form-value-display">
        <span style="font-size:12px; color:#999; margin-right:5px;">99+</span>
        <i class="ri-arrow-right-s-line"></i>
    </div>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->
            </div>

            <!-- 第二组：内容与工具 -->
            <div class="form-card">
                <div class="form-group-row clickable" onclick="openDiary()">
                    <label class="form-label"><i class="ri-draft-line"></i> 日记</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openStickerLibrary()">
                    <label class="form-label"><i class="ri-emotion-laugh-line"></i> 表情包库</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openMomentGroupManager()">
                    <label class="form-label"><i class="ri-group-line"></i> 好友分组</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
            </div>
        </div>

        <!-- 3. “我”的个人中心 (采用整洁的黑白卡片风格) -->
        <div id="wechatProfile" class="profile-content bw-style" style="display: none;">

            <!-- 卡片 1：头部个人信息 -->
            <div class="form-card" style="padding: 30px 20px; display: flex; align-items: center;">
                <!-- 头像：点击可更换 -->
                <div class="profile-avatar-large" id="profileAvatar" onclick="changeAvatar()"
                     style="width: 64px; height: 64px; margin: 0 15px 0 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>

                <!-- 昵称与ID：点击可修改昵称 -->
                <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center;" onclick="changeName()">
                    <div class="profile-name" id="profileName" style="text-align: left; font-size: 20px; font-weight: 600; margin-bottom: 4px;">
                        <!-- JS填充名字 -->
                    </div>
                    <div style="font-size: 12px; color: #999;">微信号: wx_id_...</div>
                </div>

                <!-- 右侧箭头 -->
                <i class="ri-arrow-right-s-line" style="color: #ccc; font-size: 20px;"></i>
            </div>

            <!-- 卡片 2：功能菜单 -->
            <div class="form-card">
                <div class="form-group-row clickable" onclick="openPersonaList()">
                    <label class="form-label"><i class="ri-user-star-line"></i> 我的人设</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openWallet()">
                    <label class="form-label"><i class="ri-wallet-3-line"></i> 钱包</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openFavorites()">
                    <label class="form-label"><i class="ri-star-line"></i> 收藏</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
                <div class="form-group-row clickable" onclick="openMySettings()">
                    <label class="form-label"><i class="ri-settings-3-line"></i> 设置</label>
                    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
                </div>
            </div>
        </div>

    </div>

    <!-- 底部 Tab 导航栏 -->
    <div class="wechat-bottom-nav">
        <div class="wechat-tab active" onclick="switchWechatTab('messages')">
            <div class="wechat-tab-icon">
                <i class="ri-chat-3-line"></i>
            </div>
            <div>消息</div>
        </div>
        <div class="wechat-tab" onclick="switchWechatTab('discover')">
            <div class="wechat-tab-icon">
                <i class="ri-compass-3-line"></i>
            </div>
            <div>发现</div>
        </div>
        <div class="wechat-tab" onclick="switchWechatTab('profile')">
            <div class="wechat-tab-icon">
                <i class="ri-user-line"></i>
            </div>
            <div>我</div>
        </div>
    </div>
</div>
<!--聊天界面-->
<div id="chatScreen" class="page">
    <!-- 1. 顶部导航栏 -->
    <div class="nav-bar">
        <!-- 左侧：返回按钮 -->
        <button class="nav-btn" id="navBarBackButton" onclick="backToWechat()">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 左侧：总结按钮 -->
        <button class="nav-btn" onclick="openMemoryScreen()" style="margin-right: auto; margin-left: 0;" title="对话总结">
            <i class="ri-book-read-line"></i>
        </button>

        <!-- 中间：标题 -->
        <div class="nav-title" id="chatTitle">聊天</div>

        <!-- 右侧：功能按钮组 -->
        <div style="display: flex; align-items: center;">
            <!-- 群公告 (群聊显示) -->
            <button class="nav-btn" id="navBarAnnouncementBtn" onclick="openGroupAnnouncementModal()" style="display: none; margin-right: 5px;" title="群公告">
                <i class="ri-megaphone-line"></i>
            </button>
            <!-- 心声 (私聊显示) -->
            <button class="nav-btn" id="navBarHeartsVoiceButton" onclick="openHeartsVoiceModal()" title="心声">
                <i class="ri-heart-pulse-line"></i>
            </button>
            <!-- 更多设置 -->
            <button class="nav-btn nav-right-action-btn" id="navBarMoreButton" onclick="openChatSettings()">⋯</button>
        </div>
    </div>

    <!-- 2. 消息内容区域 -->
    <div class="wechat-content" style="position: relative; z-index: 1;">
        <div class="chat-messages" id="chatMessages">
            <!-- JS 将在这里动态生成聊天气泡 -->
        </div>
    </div>

    <!-- 3. 多选操作工具栏 (默认隐藏) -->
    <div class="multi-select-toolbar" id="multiSelectToolbar">
        <span class="multi-select-count" id="multiSelectCount">已选择 0 条消息</span>
        <div class="multi-select-actions">
            <button class="multi-select-btn delete" onclick="deleteSelectedMessages()">删除</button>
            <button class="multi-select-btn cancel" onclick="exitMultiSelectMode()">取消</button>
        </div>
    </div>

    <!-- 4. 底部输入区域 -->
    <div class="chat-input-area" id="chatInputArea">

        <!-- 输入框主行 -->
        <div class="chat-input">
            <!-- 左侧按钮组 (接收) -->
            <div id="chatDefaultButtons" style="display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
                <button class="chat-btn" id="chatInputReceiveButton" onclick="requestAIResponse()" title="接收消息">
                    <i class="ri-mail-download-line"></i>
                </button>
            </div>

            <!-- 文本输入框 -->
            <textarea id="messageInput" rows="1" placeholder="输入消息..."
                      onkeydown="handleKeyPress(event)"
                      oninput="toggleSendButtonActive(this)"
                      onclick="hideFunctionMenus()"></textarea>

            <!-- 右侧按钮组 (表情 & 更多) -->
            <div id="chatRightButtons" style="display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;">
                 <button class="chat-btn" id="chatInputEmojiButton" onclick="toggleEmojiPicker()" title="表情">
                     <i class="ri-emotion-happy-line"></i>
                 </button>
                 <button class="chat-btn plus-btn" id="chatInputPlusButton" onclick="toggleChatFunctions()" title="更多">
                     <i class="ri-add-line"></i>
                 </button>
            </div>

            <!-- 发送按钮 (初始隐藏) -->
            <button class="chat-btn send-btn" id="chatInputSendButton" onclick="sendMessage()" title="发送消息">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>

        <!-- 5. 更多功能菜单 (初始隐藏) -->
        <div class="chat-functions" id="chatFunctions">
            <div class="function-menu">
                <!-- 基础功能 -->
                <div class="function-item" onclick="selectPhoto()"><div class="function-icon"><i class="ri-image-line"></i></div><div class="function-label">照片</div></div>
                <div class="function-item" onclick="openCameraModal()"><div class="function-icon"><i class="ri-camera-line"></i></div><div class="function-label">拍摄</div></div>
                <div class="function-item" onclick="startVoiceCall()"><div class="function-icon"><i class="ri-phone-line"></i></div><div class="function-label">语音通话</div></div>
                <div class="function-item" onclick="openVoiceModal()"><div class="function-icon"><i class="ri-mic-line"></i></div><div class="function-label">发送语音</div></div>

                <!-- 互动功能 -->
                <div class="function-item" onclick="openTransferModal()"><div class="function-icon"><i class="ri-exchange-cny-line"></i></div><div class="function-label">转账</div></div>
                <div class="function-item" onclick="toggleSpectatorMode()"><div class="function-icon"><i class="ri-movie-2-line"></i></div><div class="function-label">旁观</div></div>
                <div class="function-item" onclick="triggerMenuPatPat()"><div class="function-icon"><i class="ri-notification-3-line"></i></div><div class="function-label">拍一拍</div></div>

                <!-- 场景功能 -->
                <div class="function-item" onclick="openListenTogether()"><div class="function-icon"><i class="ri-music-2-line"></i></div><div class="function-label">一起听</div></div>
                <div class="function-item" onclick="openLocationModal()"><div class="function-icon"><i class="ri-map-pin-line"></i></div><div class="function-label">位置</div></div>
                <div class="function-item" onclick="toggleOfflineMode()"><div class="function-icon"><i class="ri-edit-line"></i></div><div class="function-label">线下模式</div></div>
                <div class="function-item" onclick="openReadTogetherBookshelf()"><div class="function-icon"><i class="ri-book-open-line"></i></div><div class="function-label">一起看书</div></div>
            </div>
        </div>

        <!-- 6. 表情选择器 (初始隐藏) -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-picker-header">
                 <button class="emoji-picker-btn manage" id="manageEmojiBtn" onclick="toggleEmojiManagement()">管理</button>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>
</div>
<!--一起听歌-->
<div id="listenTogetherScreen" class="page">
    <!-- 背景图层 -->
    <div class="listen-bg" id="listenBg"></div>

    <!-- 主内容区域 -->
    <div class="listen-main">

        <!-- 1. 顶部导航栏 -->
        <div class="listen-header">
            <!-- 返回按钮 -->
            <div style="display: flex;">
                 <button class="nav-btn" id="listenBackBtn">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
            </div>

            <!-- 歌曲信息 -->
            <div class="listen-header-title">
                <div id="listenSongTitle" style="font-weight: bold;">一起听</div>
                <div id="listenSongArtist" style="font-size: 12px; color: rgba(255,255,255,0.7);">...</div>
            </div>

            <!-- 右侧功能按钮 -->
            <div style="display: flex; align-items: center;">
                 <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('listenBgInput').click()" title="更换背景">BG</button>
                 <button class="nav-btn" style="font-size: 14px;" onclick="document.getElementById('vinylImageInput').click()" title="更换唱片封面">CD</button>
                 <button class="nav-btn" id="listenCloseBtn" style="color: #ff4d4d;"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
        </div>

        <!-- 2. 耳机连线与头像 -->
        <div class="listen-avatars-container" id="listenAvatarsContainer">
            <div class="headphone-arc"></div>
            <div id="listenFriendAvatar" class="listen-avatar"></div>
            <div id="listenUserAvatar" class="listen-avatar"></div>
        </div>

        <!-- 3. 悬浮聊天气泡层 -->
        <div id="listenTogetherChatOverlay"></div>

        <!-- 4. 黑胶唱片区域 -->
        <div class="vinyl-container">
            <div id="vinylRecord" class="vinyl-record">
                <div id="albumArt" class="album-art"></div>
            </div>
        </div>

        <!-- 5. 底部简易聊天栏 -->
        <div id="listenTogetherChatWrapper">
            <button id="listenTogetherChatToggleBtn" onclick="toggleListenChat()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </button>
             <div id="listenTogetherChatInputContainer">
                 <!-- 接收消息按钮 -->
                 <button class="listen-chat-btn" onclick="requestAIResponse()"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" /></svg></button>
                 <!-- 输入框 -->
                 <input type="text" id="listenTogetherChatInput" placeholder="聊点什么..." onkeypress="handleListenTogetherKeyPress(event)">
                 <!-- 发送按钮 -->
                 <button id="listenTogetherSendBtn" onclick="sendListenTogetherMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
             </div>
        </div>

        <!-- 6. 歌词显示区 -->
        <div id="songLyrics">
             <p class="sub-lyric"></p>
             <p class="active-lyric">... 点击右下角列表添加歌曲 ...</p>
             <p class="sub-lyric"></p>
        </div>
    </div>

    <!-- 7. 底部播放控制栏 -->
    <div class="listen-controls">
        <!-- 进度条 -->
        <div class="listen-progress-bar">
            <span id="currentTimeLabel">00:00</span>
            <input type="range" id="songProgressBar" value="0" step="1" oninput="seekSong(this.value)">
            <span id="durationLabel">00:00</span>
        </div>

        <!-- 播放按钮组 -->
        <div class="listen-buttons">
            <button class="listen-btn" id="repeatBtn" onclick="toggleRepeat()"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
            <button class="listen-btn" onclick="prevSong()"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
            <button class="listen-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
            <button class="listen-btn" onclick="nextSong()"><svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-8.5 6l8.5 6V6z"/></svg></button>
            <button class="listen-btn" onclick="openPlaylistModal()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
        </div>
    </div>
</div>
<!--日记-->
<!-- [新增] 日记正文查看页面 -->
<div id="diaryViewScreen" class="page">
    <!-- 顶部导航栏 -->
    <div class="nav-bar">
        <!-- 左侧：返回按钮 -->
        <button class="nav-btn" id="backToDiaryListBtn">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 中间：标题 -->
        <div class="nav-title">日记正文</div>

        <!-- 右侧：占位符 (保持标题居中) -->
        <div style="width: 40px;"></div>
    </div>

    <!-- 内容区域 -->
    <div class="wechat-content" id="fullDiaryContent">
        <!-- JS 将在这里动态填充日记的全部文字内容 -->
    </div>
</div>
<!-- ========================================= -->
<!-- 1. 通话中界面 (Active Call) -->
<!-- ========================================= -->
<div id="voiceCallScreen" class="page">
    <!-- 全屏模糊背景 -->
    <div class="voice-call-bg" id="voiceCallBg"></div>

    <!-- A. 顶部信息区 (头像/昵称/计时) -->
    <div class="voice-call-header">
        <div class="voice-call-avatar" id="voiceCallAvatar"></div>
        <div class="voice-call-name" id="voiceCallName"></div>
        <div class="voice-call-status" id="voiceCallStatus">00:00</div>
    </div>

    <!-- B. 通话记录区 (显示旁白和对话文本) -->
    <div class="voice-call-log" id="voiceCallLog">
        <!-- JS 动态内容 -->
    </div>

    <!-- C. 底部文字输入区 (模拟语音输入) -->
    <div class="voice-call-input-area" id="voiceCallInputArea">
        <!-- 接收/重试按钮 -->
        <button onclick="requestAICallResponse()" title="让对方说话">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="20" height="20">
                <path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.567L16.5 21.75l-.398-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.183a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.183.398a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
        </button>

        <!-- 输入框 -->
        <input type="text" id="voiceCallUserInput" placeholder="输入你想说的话...">

        <!-- 发送按钮 -->
        <button onclick="sendUserCallMessage()" title="发送">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path d="M3.4 20.4l17.4-8.4c.8-.4.8-1.6 0-2L3.4 1.6c-.8-.4-1.6.4-1.4 1.2l3.6 7.2c.2.4.2 1 0 1.4L2 19.2c-.2.8.6 1.6 1.4 1.2z"/>
            </svg>
        </button>
    </div>

    <!-- D. 底部控制按钮 (挂断/静音) -->
    <div class="voice-call-controls" id="voiceCallControls">
        <!-- 静音按钮 -->
        <button class="voice-call-btn" onclick="showAlert('功能暂未开放')">
            <div class="voice-call-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-1.03.83-1.9 1.9-1.9 1.02 0 1.8.84 1.8 1.9l-.01 6.2c0 1.03-.83 1.9-1.9 1.9s-1.8-.84-1.8-1.9L10.8 4.9zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </div>
            <span>静音</span>
        </button>

        <!-- 挂断按钮 -->
        <button class="voice-call-btn hangup" onclick="endVoiceCall()">
            <div class="voice-call-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
            </div>
            <span>挂断</span>
        </button>

        <!-- 免提按钮 -->
        <button class="voice-call-btn" onclick="showAlert('功能暂未开放')">
            <div class="voice-call-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M3 4l1.41 1.41L12 12.83l7.59-7.59L21 6.64 12 15.64 3.36 7.05 3 7.41V4h.01M3 14v2h18v-2H3z"/></svg>
            </div>
            <span>免提</span>
        </button>
    </div>
</div>

<!--语音通话-->
<div id="incomingCallScreen" class="page">
    <!-- 全屏模糊背景 -->
    <div class="voice-call-bg" id="incomingCallBg"></div>

    <!-- 顶部来电信息 -->
    <div class="voice-call-header">
        <div class="voice-call-avatar" id="incomingCallAvatar"></div>
        <div class="voice-call-name" id="incomingCallName"></div>
        <div class="voice-call-status">邀请你进行语音通话</div>
    </div>

    <!-- 底部操作按钮 (接听/拒绝) -->
    <div class="incoming-call-actions">
        <!-- 拒绝 -->
        <button class="voice-call-btn hangup" onclick="declineCall()">
            <div class="voice-call-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.36 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.47 2.47c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
            </div>
            <span>拒绝</span>
        </button>

        <!-- 接听 -->
        <button class="voice-call-btn accept incoming-call-btn" onclick="acceptCall()">
            <div class="voice-call-btn-icon">
                <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.2c.27-.27.35-.66.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.75 0 .99-.65.99-.99v-3.45c0-.54-.45-.98-.99-.98z"/></svg>
            </div>
            <span>接听</span>
        </button>
    </div>
</div>

            <div id="messageMenu" class="message-menu"></div>

            <div id="recalledMessagePopup" class="recalled-message-popup">
                <div class="recalled-message-title">撤回的消息</div>
                <div class="recalled-message-content" id="recalledMessageContent"></div>
                <button class="recalled-message-close" onclick="closeRecalledMessagePopup()">关闭</button>
            </div>

<div id="chatSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">聊天设置</div>
        <div></div>
    </div>

    <!-- 使用 bw-style 继承黑白风格 -->
    <div class="settings-content bw-style">

        <!-- 卡片 1：常规设置 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openFriendOrGroupSettings()">
                <label class="form-label">聊天详情</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBackgroundSettings()">
                <label class="form-label">聊天背景</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openTokenAnalysis()">
                <label class="form-label"><i class="ri-pie-chart-2-line"></i> Token</label>
                <div class="form-value-display">分析 <i class="ri-arrow-right-s-line"></i></div>
            </div>

            <!-- 足迹设置 (带ID以便JS控制显示) -->
            <div class="form-group-row clickable" id="settings-footprint-row" onclick="forceOpenSpyMap()">
                <label class="form-label">
                    <i class="ri-footprint-line" style="margin-right: 5px;"></i> 足迹
                </label>
                <div class="form-value-display">
                    <i class="ri-arrow-right-s-line"></i>
                </div>
            </div>

            <!-- 续火花设置 (带分隔线) -->
            <div class="form-group-row switch-row" style="border-top: 1px dashed #f0f0f0;">
                <label class="form-label">
                    <i class="ri-fire-line" style="margin-right: 5px;"></i> 续火花
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="chatSparkToggle" onchange="updateSparkSettingsFromChatMenu()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 续火花天数输入 (默认隐藏) -->
            <div id="chatSparkInputGroup" class="form-group-row" style="display: none; justify-content: space-between;">
                 <label class="form-label sub-label" style="font-size: 13px; color: #999;">多少天不聊结冰</label>
                 <div style="display: flex; align-items: center;">
                     <input type="number" id="chatSparkDurationInput" class="form-input"
                            style="width: 60px; text-align: right; height: 30px; padding: 0 5px;"
                            placeholder="3" min="1" onchange="updateSparkSettingsFromChatMenu()">
                     <span style="font-size: 14px; margin-left: 5px;">天</span>
                 </div>
            </div>
        </div>

        <!-- 卡片 2：聊天管理 -->
        <div class="form-card">
            <!-- 置顶聊天 -->
            <div class="form-group-row clickable" onclick="togglePinChat()">
                <label class="form-label">置顶状态</label>
                <div class="form-value-display" id="pinChatText">点击切换</div>
            </div>
            <div class="form-group-row clickable" onclick="openChatSearch()">
                <label class="form-label">查找聊天记录</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
             <!-- 新增：拉黑开关 -->
            <div class="form-group-row switch-row" style="border-top: 1px dashed #eee;">
    <label class="form-label" style="color: #ff3b30;">加入黑名单</label>
    <label class="toggle-switch">
        <input type="checkbox" id="blockUserToggle" onchange="toggleBlockUser()">
        <span class="toggle-slider"></span>
    </label>
</div>


            <div class="form-group-row clickable" onclick="clearChatHistory()">
                <label class="form-label">清空聊天记录</label>
                <div class="form-value-display" style="font-size: 12px;">清空</div>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-delete" onclick="deleteFriend()">删除并退出</button>
        </div>
    </div>
</div>

            <div id="chatSearchScreen" class="page">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
                    <div class="nav-title">查找聊天记录</div>
                    <div></div>
                </div>
                <div class="settings-content" style="position: relative; height: 100%;">
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="form-input" id="searchInput" placeholder="输入关键词搜索..." oninput="searchChatHistory()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
            </div>

<div id="friendSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">好友设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

                <!-- ▼▼▼ 全新设计的：可爱风角色档案卡 (中文版 & 对齐版) ▼▼▼ -->
        <div class="cute-id-card">
            <!-- 卡片顶部装饰条 -->
            <div class="id-card-top-bar">
                <span class="id-card-title">居民身份证</span>
            </div>

            <div class="id-card-main">
                <!-- 左侧：头像区域 -->
                <div class="id-card-left">
                    <div class="avatar-upload id-card-avatar" id="editFriendAvatarUpload">
                        <input type="file" accept="image/*" onchange="handleEditFriendAvatarUpload(event)">
                        <span id="editFriendAvatarPreview">+</span>
                    </div>
                </div>

                <!-- 右侧：信息输入区域 -->
                <div class="id-card-right">
                    <!-- 姓名 -->
                    <div class="id-input-group">
                        <label>姓名</label>
                        <input type="text" id="editFriendName" placeholder="请输入姓名">
                    </div>

                    <!-- 备注 -->
                    <div class="id-input-group">
                        <label>备注</label>
                        <input type="text" id="editFriendRemark" placeholder="设置备注">
                    </div>

                    <!-- 性别 -->
                    <div class="id-input-group">
                        <label>性别</label>
                        <select id="editFriendGenderInput">
                            <option value="">未设置</option>
                            <option value="[性别:男] ">男</option>
                            <option value="[性别:女] ">女</option>
                            <option value="[性别:通用] ">保密</option>
                        </select>
                    </div>

                    <!-- 城市映射 (移到这里，像住址一样) -->
                    <div class="id-input-group address-group">
                        <label>住址</label>
                        <div class="id-city-inputs">
                            <input type="text" id="editFictionalCity" placeholder="虚构地">
                            <span class="link-icon">⇌</span>
                            <input type="text" id="editRealCity" placeholder="现实映射">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ▲▲▲ 档案卡结束 ▲▲▲ -->

        <!-- 下方：其他设置 (保持整洁的列表) -->
        <div class="form-card">
            <!-- 分组 -->
            <div class="form-group-row" style="position: relative;">
                <label class="form-label">列表分组</label>
                <div style="flex: 1; position: relative;">
                    <input type="text" class="form-input" id="editFriendGroupInput"
                           placeholder="点击选择 / 手动输入" autocomplete="off" readonly
                           onclick="toggleFriendGroupDropdown(event)"
                           oninput="filterFriendGroupDropdown(this.value)">
                    <div id="friendGroupDropdownList" class="bw-dropdown" style="width: 100%; text-align: right; max-height: 150px;"></div>
                </div>
            </div>

            <!-- 角色设定 (大文本框) -->
            <div class="form-group-row column-layout" id="editFriendRoleGroup">
                <label class="form-label">详细设定 / Prompt</label>
                <textarea class="form-textarea large-area" id="editFriendRole" placeholder="在此输入详细的人设描述..."></textarea>
            </div>

            <!-- 拍一拍 -->
            <div class="form-group-row" id="editFriendPatGroup">
                <label class="form-label">拍一拍</label>
                <input type="text" class="form-input" id="editFriendPatAction" placeholder="例如：的头">
            </div>
        </div>

        <!-- 高级功能 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openVoiceIdModal()">
                <label class="form-label">音色ID</label>
                <div id="currentCloneVoiceId" class="form-value-display">未设置 <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" id="worldBookBindingGroup" onclick="openWorldBookBindingModal()">
                <label class="form-label">绑定世界书</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" id="selectPersonaItemGroup_Friend" style="display: none;" onclick="openPersonaSelectModal()">
                <label class="form-label">我的人设</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 开关区域 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">显示时间戳</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="timestampToggle" onchange="toggleTimestampOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- 时间戳子选项 -->
            <div id="timestampStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                    <label class="form-label sub-label">样式</label>
                    <select class="form-select arrow-select" id="timestampStyleSelect">
                        <option value="below_bubble">气泡下</option>
                        <option value="below_avatar">头像下</option>
                    </select>
                </div>
            </div>
            <div id="timestampSecondsGroup" style="display: none;">
                 <div class="form-group-row switch-row">
                    <label class="form-label sub-label">显示秒数</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timestampSecondsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">显示已读</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="readReceiptToggle" onchange="toggleReadReceiptOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="readReceiptStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                     <label class="form-label sub-label">样式</label>
                    <select class="form-select arrow-select" id="readReceiptStyleSelect">
                        <option value="below_bubble">气泡下</option>
                        <option value="below_avatar">头像下</option>
                    </select>
                </div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">隐藏头像</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="avatarHidingToggle" onchange="toggleAvatarHidingOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="avatarHidingModeGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                 <div class="form-group-row">
                    <label class="form-label sub-label">模式</label>
                    <select class="form-select arrow-select" id="avatarHidingModeSelect">
                        <option value="both">隐藏双方</option>
                        <option value="received">只隐藏TA</option>
                        <option value="sent">只隐藏我</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveFriendSettings()">保存更改</button>
        </div>
    </div>
</div>

<!--群聊设置页面-->
<div id="groupSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">群聊设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 1. 群头像卡片 -->
        <div class="form-card centered">
            <div class="avatar-upload big-avatar" id="editGroupAvatarUpload">
                <input type="file" accept="image/*" onchange="handleEditGroupAvatarUpload(event)">
                <span id="editGroupAvatarPreview"><i class="ri-group-line"></i></span>
            </div>
            <div class="hint-text">点击更换群头像</div>
        </div>

        <!-- 2. 群名称卡片 -->
        <div class="form-card">
            <div class="form-group-row">
                <label class="form-label">群聊名称</label>
                <input type="text" class="form-input" id="editGroupName" placeholder="必填">
            </div>
        </div>

        <!-- 3. 群成员列表卡片 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label">群成员管理</label>
            </div>
            <!-- 这里的容器样式被优化，适配卡片内部显示 -->
            <div id="groupMembersList" class="bw-member-list">
                <!-- JS 会在这里动态生成成员列表 -->
            </div>
        </div>

        <!-- 4. 高级设置卡片 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openWorldBookBindingModal()">
                <label class="form-label">绑定世界书</label>
                <div class="form-value-display">点击选择 <i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row clickable" id="selectPersonaItemGroup_Group" style="display: none;" onclick="openPersonaSelectModal()">
                <label class="form-label">我的人设</label>
                <div class="form-value-display">点击选择 <i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">记忆互通</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="memorySharingToggle" onchange="toggleMemorySharing()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 主动发言开关 -->
            <div class="form-group-row switch-row">
                <label class="form-label">允许群员主动发言</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="groupProactiveToggle" onchange="toggleGroupProactive()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 主动发言间隔 (默认隐藏) -->
            <div id="groupProactiveIntervalInputGroup" class="form-group-row" style="display: none; justify-content: space-between;">
                 <label class="form-label sub-label" style="font-size: 13px; color: #999;">触发间隔</label>
                 <div style="display: flex; align-items: center;">
                     <input type="number" id="groupProactiveIntervalInput" class="form-input"
                            style="width: 60px; text-align: right; height: 30px; padding: 0 5px;"
                            placeholder="60" min="1">
                     <span style="font-size: 14px; margin-left: 5px;">分钟</span>
                 </div>
            </div>
        </div>

        <!-- 5. 外观显示 (时间戳) -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">显示时间戳</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="groupTimestampToggle" onchange="toggleGroupTimestampOptions(this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div id="groupTimestampStyleGroup" style="display: none; padding: 10px 0; border-top: 1px dashed #eee;">
                <div class="form-group-row">
                    <label class="form-label sub-label">样式选择</label>
                    <select class="form-select arrow-select" id="groupTimestampStyleSelect">
                        <option value="below_bubble">气泡下面</option>
                        <option value="below_avatar">头像下面</option>
                    </select>
                </div>
            </div>
             <div id="groupTimestampSecondsGroup" style="display: none;">
                 <div class="form-group-row switch-row">
                    <label class="form-label sub-label">显示秒数</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="groupTimestampSecondsToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 6. 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveGroupSettings()">保存设置</button>
        </div>
    </div>
</div>

<!-- ↑↑↑ 请在这里结束复制 ↑↑↑ -->

<div id="backgroundSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChatSettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">聊天背景</div>
        <div></div>
    </div>

    <!-- 使用 bw-style 继承统一风格 -->
    <div class="settings-content bw-style">

        <!-- 预览选择卡片 -->
        <div class="form-card">
            <!-- 标题 -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">选择背景图</label>
            </div>

            <!-- 网格容器：增加了 bw-grid 类 -->
            <div class="background-grid bw-grid" id="individualBgGrid">

                <!-- 默认选项 -->
                <div class="background-option default" onclick="selectBackground('default')">
                    <span>默认</span>
                </div>

                <!-- 上传选项 -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleBackgroundUpload(event)">
                    <span>+ 上传</span>
                </div>

                <!-- JS 动态生成的自定义图片会插入到这里 -->
            </div>
        </div>

        <!-- 底部按钮组 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveBackground()">保存设置</button>
            <button class="settings-btn btn-cancel" onclick="backToChatSettings()">取消</button>
        </div>
    </div>
</div>

<div id="personalSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">人设与背景</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">
        <div class="form-card">
            <div class="form-group-row column-layout">
                <label class="form-label">我的人设</label>
                <textarea class="form-textarea large-area" id="userPersonality" placeholder="请描述你的个性、特点、喜好等..."></textarea>
            </div>

            <div class="form-group-row column-layout">
                <label class="form-label">背景设定</label>
                <textarea class="form-textarea large-area" id="userBackground" placeholder="请描述你的背景、经历、职业等..."></textarea>
            </div>

            <div class="form-group-row">
                <label class="form-label">我的拍一拍动作</label>
                <input type="text" class="form-input" id="userPatAction" placeholder="例如：拍了拍">
            </div>
        </div>

        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="savePersonalSettings()">保存设置</button>
        </div>
    </div>
</div>

<div id="mySettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">设置</div>
        <div></div>
    </div>

    <!-- 应用 bw-style 黑白风格 -->
    <div class="settings-content bw-style">

        <!-- 卡片 1：视觉外观 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openGlobalChatBg()">
                <label class="form-label">
                    <i class="ri-image-line"></i> 全局聊天背景
                </label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">
                    <i class="ri-rounded-corner"></i> 圆角模式
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="roundedToggle" onchange="toggleRoundedCorners()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 卡片 2：系统显示 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">
                    <i class="ri-moon-line"></i> 夜间模式
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

    </div>
</div>


<div id="bubbleSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">气泡设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 1. 角色选择卡片 -->
        <div class="form-card">
            <div class="form-group-row">
                <label class="form-label">为谁设置</label>
                <select class="form-select arrow-select" id="characterAppearanceSelect" onchange="loadAppearanceSettingsForSelectedCharacter()">
                    <!-- JS动态生成 -->
                </select>
            </div>
        </div>

        <!-- 2. 实时预览卡片 (放在上面方便看效果) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">实时预览</label>
            </div>
            <!-- 预览容器 -->
            <div class="bubble-preview-box">
                <div class="bubble-preview-area" id="bubblePreviewArea">
                    <!-- 模拟消息 -->
                    <div class="message received">
                        <div class="chat-avatar">TA</div>
                        <div class="message-content">对方的气泡样式</div>
                    </div>
                    <div class="message sent">
                        <div class="message-content">你的气泡样式</div>
                        <div class="chat-avatar">我</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 基础外观 (颜色 & 大小) -->
        <div class="form-card">
            <!-- 对方气泡颜色 -->
            <div class="form-group-row">
                <label class="form-label">对方气泡色</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="receivedBubbleColorInput" placeholder="#E6F2FF" oninput="updateReceivedBubbleColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="receivedBubbleColorPicker" oninput="updateReceivedBubbleColor(this.value)">
                </div>
            </div>
            <!-- 我的气泡颜色 -->
            <div class="form-group-row">
                <label class="form-label">我的气泡色</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="sentBubbleColorInput" placeholder="#FFEEF6" oninput="updateSentBubbleColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="sentBubbleColorPicker" oninput="updateSentBubbleColor(this.value)">
                </div>
            </div>

            <!-- 快捷复制按钮组 -->
            <div class="form-group-row" style="justify-content: flex-start; gap: 10px; overflow-x: auto;">
                <button class="bw-chip-btn" onclick="copyBubbleFormat('bubble_only')">复制气泡格式</button>
                <button class="bw-chip-btn" onclick="copyBubbleFormat('bubble_and_avatar')">复制头像格式</button>
                <button class="bw-chip-btn" onclick="copyInterfaceFormat()">复制界面格式</button>
            </div>

            <!-- 头像大小 -->
            <div class="form-group-row column-layout">
                <div class="slider-label-row">
                    <label>头像大小</label>
                    <span id="avatarSizeValue">45px</span>
                </div>
                <input type="range" class="bw-slider" id="avatarSizeSlider" min="20" max="60" value="45" oninput="updateAvatarSettings('size', this.value)">
            </div>
            <!-- 头像圆角 -->
            <div class="form-group-row column-layout">
                <div class="slider-label-row">
                    <label>头像圆角</label>
                    <span id="avatarRadiusValue">8px</span>
                </div>
                <input type="range" class="bw-slider" id="avatarRadiusSlider" min="0" max="50" value="8" oninput="updateAvatarSettings('radius', this.value)">
            </div>
        </div>

        <!-- 4. 头像框设置 (高级) -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">头像挂件/边框</label>
            </div>

            <div class="form-group-row">
                <label class="form-label">应用对象</label>
                <select class="form-select arrow-select" id="avatarFrameTargetSelect" onchange="switchAvatarFrameTarget()">
                    <option value="both">双方</option>
                    <option value="sent">我</option>
                    <option value="received">对方</option>
                </select>
            </div>

            <!-- 操作按钮 -->
            <div class="form-group-row" style="gap: 10px;">
                <button class="bw-action-btn" onclick="document.getElementById('avatarFrameInput').click()">本地上传</button>
                <button class="bw-action-btn" onclick="openAvatarFrameUrlModal()">输入URL</button>
                <button class="bw-action-btn danger" onclick="resetAvatarFrame()">重置</button>
            </div>

            <!-- 调整滑块 -->
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>边框大小</label><span id="avatarFrameSizeValue">3px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameSizeSlider" min="0" max="20" value="3" oninput="updateAvatarSettings('frameSize', this.value)">
            </div>
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>左右偏移</label><span id="avatarFrameOffsetXValue">0px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameOffsetXSlider" min="-50" max="50" value="0" oninput="updateAvatarSettings('frameOffsetX', this.value)">
            </div>
            <div class="form-group-row column-layout">
                <div class="slider-label-row"><label>上下偏移</label><span id="avatarFrameOffsetYValue">0px</span></div>
                <input type="range" class="bw-slider" id="avatarFrameOffsetYSlider" min="-50" max="50" value="0" oninput="updateAvatarSettings('frameOffsetY', this.value)">
            </div>
        </div>

        <!-- 5. 高级 CSS 代码 -->
        <div class="form-card">
            <div class="form-group-row" style="justify-content: space-between;">
                <label class="form-label">气泡 CSS</label>
                <div style="display: flex; gap: 10px;">
                    <span class="text-link" onclick="saveCssPreset('bubble')">保存预设</span>
                    <span class="text-link" onclick="openPresetSelector('bubble')">选择预设</span>
                </div>
            </div>
            <div class="form-group-row column-layout" style="padding-top: 0;">
                <textarea class="form-textarea code-font" id="bubbleCustomCSS" placeholder="在此输入 CSS..." oninput="applyCustomBubbleCSS(this.value)"></textarea>
            </div>
        </div>

        <div class="form-card">
            <div class="form-group-row" style="justify-content: space-between;">
                <label class="form-label">界面 CSS</label>
                <div style="display: flex; gap: 10px;">
                    <span class="text-link" onclick="saveCssPreset('interface')">保存预设</span>
                    <span class="text-link" onclick="openPresetSelector('interface')">选择预设</span>
                </div>
            </div>
            <div class="form-group-row column-layout" style="padding-top: 0;">
                <textarea class="form-textarea code-font" id="chatInterfaceCSSInput" placeholder="在此输入 CSS..." oninput="applyChatInterfaceCSS(this.value)"></textarea>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveBubbleSettings()">保存设置</button>
            <button class="settings-btn btn-cancel" onclick="cancelBubbleSettings()">取消</button>
        </div>
    </div>
</div>

<div id="globalChatBgScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToMySettings()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">全局聊天背景</div>
        <div></div>
    </div>

    <!-- 应用 bw-style，复用之前的网格样式 -->
    <div class="settings-content bw-style">

        <!-- 背景选择卡片 -->
        <div class="form-card">
            <!-- 标题 -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">选择背景图</label>
            </div>

            <!-- 网格容器：复用 bw-grid 样式 -->
            <div class="background-grid bw-grid" id="globalBgGrid">

                <!-- 默认选项 -->
                <div class="background-option default" onclick="selectGlobalChatBg('default')">
                    <span>默认</span>
                </div>

                <!-- 上传选项 -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleGlobalChatBgUpload(event)">
                    <span>+ 上传</span>
                </div>

                <!-- JS 会自动在这里插入预览图 -->
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveGlobalChatBg()">保存设置</button>
            <button class="settings-btn btn-cancel" onclick="backToMySettings()">取消</button>
        </div>
    </div>
</div>


           <!-- 1. 钱包主界面 (黑白风 + 布局调整) -->
<div id="walletScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">钱包</div>
        <div class="nav-btn" style="width: 40px;"></div> <!-- 占位，保持标题居中 -->
    </div>

    <div class="settings-content bw-style">
        <!-- 余额展示卡片 (改为黑白风格) -->
        <div class="wallet-header-card">
            <div class="wallet-icon"><i class="ri-wechat-pay-fill"></i></div>
            <div class="wallet-balance-label">我的余额</div>
            <div class="wallet-balance-amount" id="balanceAmount">¥ 0.00</div>
        </div>

        <!-- 功能菜单 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openPaymentPasswordModal()">
                <label class="form-label"><i class="ri-lock-password-line" style="color:#333; margin-right:10px;"></i> 支付密码</label>
                <div class="form-value-display" id="paymentPasswordStatus">未设置 <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="rechargeWallet()">
                <label class="form-label"><i class="ri-bank-card-line" style="color:#333; margin-right:10px;"></i> 充值</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="withdrawWallet()">
                <label class="form-label"><i class="ri-hand-coin-line" style="color:#333; margin-right:10px;"></i> 提现</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openFamilyCard()">
                <label class="form-label"><i class="ri-heart-2-line" style="color:#333; margin-right:10px;"></i> 亲属卡</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <!-- 【修改】账单现在移动到了这里 -->
            <div class="form-group-row clickable" onclick="openBillDetail()">
                <label class="form-label"><i class="ri-file-list-3-line" style="color:#333; margin-right:10px;"></i> 账单</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- 2. 账单明细界面 (移除筛选栏) -->
<div id="billDetailScreen" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="backToWallet()"><i class="ri-close-line" style="font-size: 24px;"></i></button>
        <div class="nav-title">账单</div>
        <div class="nav-btn" style="width: 40px;"></div> <!-- 移除三个点，保留占位 -->
    </div>
    <div class="wechat-content" style="background-color: #fff; display: flex; flex-direction: column; padding-top: 74px;">
        <!-- 移除了 .bill-filter-bar -->

        <!-- 账单列表容器 -->
        <div id="billListContainer" style="flex:1; overflow-y: auto;">
            <!-- JS将在这里动态生成月份和账单 -->
        </div>
    </div>
</div>

<div id="familyCardScreen" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="backToWallet()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">亲属卡</div>
        <div class="nav-btn" style="width: 40px;"></div>
    </div>

    <!-- 增加 overflow-y: auto 确保可以滚动 -->
    <div class="wechat-content" style="padding: 15px; padding-top: 74px; background-color: #f7f7f7; height: 100%; overflow-y: auto; box-sizing: border-box;">

        <div style="font-size: 14px; color: #999; margin-bottom: 10px; padding-left: 4px;">我收到的亲属卡</div>

        <!-- 亲属卡列表 -->
        <div id="familyCardList"></div>

        <!-- 消费留言开关 (黑白风，单行布局) -->
        <div class="form-card" style="margin-top: 20px; margin-bottom: 15px; background: #fff; border-radius: 12px; padding: 0 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
            <div class="form-group-row" style="border: none; padding: 18px 0; display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="font-size: 16px; color: #000; font-weight: 500; margin: 0;">消费自动留言</label>
                <!-- 黑白风开关 -->
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="fcMessageToggle" checked onchange="toggleFcMessageSetting()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 赠送按钮 -->
        <div class="form-card" style="background: #fff; border-radius: 12px; padding: 0 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);">
             <div class="form-group-row clickable" style="padding: 18px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: none;" onclick="alert('赠送功能开发中')">
                <label class="form-label" style="color: #000; font-size: 16px; font-weight: 500; margin: 0;">赠送亲属卡</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line" style="color: #ccc; font-size: 18px;"></i></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; padding-bottom: 30px; color: #ccc; font-size: 12px;">
            亲属卡可用于红包、转账及消费代付
        </div>
    </div>
</div>

<!-- 【新增】亲属卡消费详情页 (独立页面，非弹窗) -->
<div id="familyCardDetailScreen" class="page">
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToFamilyCardList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">消费明细</div>
        <div class="nav-btn" style="width: 40px;"></div>
    </div>
    <div class="wechat-content" style="padding-top: 74px; background-color: #fff;">
        <div id="fcDetailContainer" style="height: 100%; overflow-y: auto;">
            <!-- 顶部卡片容器 -->
            <div id="fcDetailHeader" style="padding: 20px 15px; background: #f7f7f7;"></div>
            <!-- 账单+留言 瀑布流 -->
            <div id="fcDetailList" style="padding: 0 15px 40px;"></div>
        </div>
    </div>
</div>

<!-- 4. 新增：支付密码设置弹窗 -->
<div id="paymentPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">设置支付密码</div>
        <input type="password" class="modal-input" id="newPaymentPassword" placeholder="请输入6位数字密码" maxlength="6">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePaymentPasswordModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePaymentPassword()">确定</button>
        </div>
    </div>
</div>
            <div id="favoritesScreen" class="page"><div class="nav-bar"><button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button> <div class="nav-title">收藏</div><button class="nav-btn" onclick="toggleSelectMode()">选择</button>
    </div>
    <div class="wechat-content">
        <!-- ↓↓↓ 把“选择栏”移动到这里来 ↓↓↓ -->
        <div class="select-mode" id="selectMode">
            <span id="selectedCount">已选择 0 项</span>
            <button class="select-btn" onclick="deleteSelectedFavorites()">删除</button>
        </div>
        <div class="favorite-list" id="favoriteList"></div>
    </div>
</div>
            <div id="worldBookScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">世界书</div>
                <div style="display: flex; align-items: center; gap: 5px;">
            <!-- 隐藏的文件输入框，用于导入 -->
            <input type="file" id="importWorldBookInput" accept=".json" style="display: none;" onchange="handleWorldBookImport(this)">

            <!-- 新增：导入按钮 -->
            <button class="nav-btn" onclick="document.getElementById('importWorldBookInput').click()" title="导入世界书">
                <i class="ri-upload-2-line" style="font-size: 22px;"></i>
            </button>

            <!-- 刚才加的：导出按钮 -->
            <button class="nav-btn" onclick="exportWorldBook()" title="导出世界书">
                <i class="ri-download-2-line" style="font-size: 22px;"></i>
            </button>

            <!-- 原有：新建文件夹按钮 -->
            <button class="nav-btn" onclick="openAddWorldBookFolderModal()" title="新建文件夹">
                <i class="ri-folder-add-line" style="font-size: 22px;"></i>
            </button>
            <!-- 原有：新建世界书按钮 -->
            <button class="nav-btn" onclick="openAddWorldBook()" title="新建世界书">
                <i class="ri-file-add-line" style="font-size: 22px;"></i>
            </button>
        </div>


    </div>

    <!-- 使用 bw-style 继承统一的黑白卡片风格 -->
    <div class="settings-content bw-style">
        <div id="worldBookList">
            <!-- JS 将在这里动态生成卡片 -->
        </div>
    </div>
</div>
          <div id="momentsScreen" class="page">
    <div class="nav-bar">
    <button class="nav-btn" onclick="backToDiscover()"><i class="ri-arrow-left-s-line"></i></button>
    <div class="nav-title">朋友圈</div>
    <div class="nav-right-buttons">
        <!-- 原来的加号按钮已经被删除了 -->
        <button class="nav-btn nav-right-action-btn" onclick="openMomentsSideMenu()">
            <i class="ri-settings-3-line"></i>
        </button>
    </div>
</div>

    <div class="wechat-content">
        <div id="momentsList"></div>
    </div>
</div>

<div id="diaryScreen" class="page">
    <!-- 顶部导航栏 -->
    <div class="nav-bar">
        <!-- 左侧：返回按钮 -->
        <button class="nav-btn" onclick="backToDiscover()">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 中间：标题 -->
        <div class="nav-title">日记</div>

        <!-- 右侧：动态功能按钮 (由JS控制显示设置/管理按钮) -->
        <div id="diaryNavFriendName"></div>
    </div>

    <!-- 内容主区域 -->
    <div class="diary-content-view">
        <!-- 好友列表 (第一层) -->
        <div id="diaryFriendList" class="friend-list"></div>

        <!-- 日记列表 (第二层) -->
        <div id="diaryContentArea" class="diary-list"></div>
    </div>

    <!-- 底部批量操作栏 (管理模式下显示) -->
    <div id="diaryBatchBar" class="diary-batch-bar">
        <!-- 全选按钮 -->
        <div class="diary-action-item" onclick="toggleDiarySelectAll()">
            <i class="ri-checkbox-circle-line" id="diarySelectAllIcon"></i>
            <span>全选</span>
        </div>

        <!-- 选中数量提示 -->
        <div class="diary-batch-info">
            SELECTED: <span id="diarySelectCount">0</span>
        </div>

        <!-- 删除按钮 -->
        <div class="diary-action-item" onclick="deleteSelectedDiaries()">
            <i class="ri-delete-bin-fill"></i>
            <span>删除</span>
        </div>
    </div>
</div>

<!--主题-->
<div id="themeApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">主题设置</div>
        <div></div>
    </div>

    <!-- 使用 bw-style 继承统一的黑白卡片风格 -->
    <div class="settings-content bw-style">

        <!-- 卡片 1：基础视觉 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openFontSettings()">
                <label class="form-label">字体设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openWallpaperSettings()">
                <label class="form-label">主屏幕壁纸</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 卡片 2：系统界面 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">显示状态栏</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="statusBarToggle" onchange="toggleStatusBar()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 卡片 3：高级定制 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openIconSettings()">
                <label class="form-label">图标设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openComponentSettings()">
                <label class="form-label">组件设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBeautificationSettings()">
                <label class="form-label">美化设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openBubbleSettings()">
                <label class="form-label">气泡设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

    </div>
</div>

<div id="fontSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">字体设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 卡片 1：字体选择 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">选择字体</label>
            </div>

            <div class="font-options-grid">
                <!-- 系统默认 -->
                <div class="font-option-card system selected" onclick="selectFont('system')">
                    <div class="font-preview-text" style="font-family: sans-serif;">Aa</div>
                    <div class="font-info">
                        <span class="name">系统默认</span>
                        <span class="desc">苹方 / 微软雅黑</span>
                    </div>
                    <div class="check-circle"><i class="ri-check-line"></i></div>
                </div>

                <!-- 自定义 -->
                <div class="font-option-card custom" onclick="selectFont('custom')">
                    <div class="font-preview-text" style="font-family: serif;">Aa</div>
                    <div class="font-info">
                        <span class="name">自定义</span>
                        <span class="desc">使用网络字体</span>
                    </div>
                    <div class="check-circle"><i class="ri-check-line"></i></div>
                </div>
            </div>

            <!-- URL 输入框 -->
            <div class="form-group-row column-layout" style="border-top: 1px dashed #eee; margin-top: 15px; padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px;">
                    <label class="form-label sub-label" style="margin-bottom: 0;">字体链接 (URL)</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="bw-chip-btn" onclick="openFontPresetSelector()">选择预设</button>
                        <button class="bw-chip-btn" onclick="saveFontPreset()">保存</button>
                    </div>
                </div>
                <textarea class="form-textarea" id="fontUrlInput" placeholder="请输入 .ttf, .woff 等字体文件链接..." oninput="applyCustomFont(this.value)" style="min-height: 60px; background: #f9f9f9;"></textarea>
            </div>
        </div>

        <!-- 卡片 2：字号调整 -->
        <div class="form-card">
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;">
                    <label class="form-label">全局字号</label>
                    <span id="fontSizeValue" class="form-value-display" style="font-weight: bold; color: #000;">14px</span>
                </div>
                <div class="slider-container">
                    <span style="font-size: 12px;">A-</span>
                    <input type="range" class="bw-slider" id="fontSizeSlider" min="12" max="24" value="14" oninput="adjustFontSize(this.value)">
                    <span style="font-size: 16px;">A+</span>
                </div>
            </div>
        </div>

        <!-- 卡片 3：颜色设置 -->
        <div class="form-card">
            <!-- 全局字色 -->
            <div class="form-group-row">
                <label class="form-label">全局字色</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="fontColorInput" value="#000000" placeholder="#000000" oninput="updateFontColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="fontColorPicker" value="#000000" onchange="updateFontColor(this.value)">
                </div>
            </div>
            <!-- App标签颜色 -->
            <div class="form-group-row">
                <label class="form-label">图标文字颜色</label>
                <div class="color-picker-group">
                    <input type="text" class="form-input small-hex" id="appLabelColorInput" value="#333333" placeholder="#333333" oninput="updateAppLabelColorFromInput(this.value)">
                    <input type="color" class="circle-color-picker" id="appLabelColorPicker" value="#333333" onchange="updateAppLabelColor(this.value)">
                </div>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveFont()">保存设置</button>
            <button class="settings-btn btn-cancel" onclick="backToTheme()">取消</button>
        </div>
    </div>
</div>

<div id="wallpaperSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">主屏幕壁纸</div>
        <div></div>
    </div>

    <!-- 应用 bw-style 黑白风格 -->
    <div class="settings-content bw-style">

        <!-- 壁纸选择卡片 -->
        <div class="form-card">
            <!-- 标题 -->
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 15px;">
                <label class="form-label">设置壁纸</label>
            </div>

            <!-- 网格容器：添加 bw-grid 类 -->
            <div class="background-grid bw-grid" id="wallpaperGrid">

                <!-- 默认选项 -->
                <div class="background-option default" onclick="selectWallpaper('default')">
                    <span>默认</span>
                </div>

                <!-- 上传选项 -->
                <div class="background-option background-upload">
                    <input type="file" accept="image/*" onchange="handleWallpaperUpload(event)">
                    <span>+ 上传</span>
                </div>

                <!-- JS 会自动把上传的图片插入到这里 -->
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveWallpaper()">保存设置</button>
            <button class="settings-btn btn-cancel" onclick="backToTheme()">取消</button>
        </div>
    </div>
</div>

<div id="iconSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">图标设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 图标宫格卡片 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label">点击图标更换</label>
            </div>
            <!-- 这里的容器将由 JS 填充 -->
            <div id="iconSettingsList" class="bw-icon-grid"></div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="backToTheme()">完成</button>
            <button class="settings-btn btn-cancel" onclick="restoreDefaultIcons()" style="color: #ff3b30; border-color: #ff3b30;">恢复默认图标</button>
        </div>
    </div>
</div>


<div id="componentSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">组件设置</div>
        <div></div>
    </div>

    <!-- 复用 bw-style -->
    <div class="settings-content bw-style">

        <!-- 设置卡片 -->
        <div class="form-card">
            <!-- 个人信息组件开关 -->
            <div class="form-group-row switch-row">
                <label class="form-label">个人信息透明</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="profileWidgetBgToggle" onchange="toggleProfileWidgetBg()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 小组件开关 -->
            <div class="form-group-row switch-row">
                <label class="form-label">小组件透明</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="smallWidgetBgToggle" onchange="toggleSmallWidgetBg()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 底部提示文字 -->
        <div style="padding: 0 20px; text-align: center; color: #999; font-size: 12px; line-height: 1.5;">
            开启透明模式后，组件背景将隐藏，仅显示文字和图片。<br>适合搭配复杂的壁纸使用。
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="backToTheme()">完成</button>
        </div>
    </div>
</div>


<!--设置页面-->
<div id="settingsApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">设置</div>
        <div></div>
    </div>

    <!-- 应用 bw-style 黑白风格，保证对齐 -->
    <div class="settings-content bw-style">

        <!-- 卡片 1：核心接口 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openApiSettings()">
                <label class="form-label">API 设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openCloneApiSettings()">
                <label class="form-label">克隆音色设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 卡片 2：个性化 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openSoundSettings()">
                <label class="form-label">消息提示音</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 卡片 3：主动交互 (包含隐藏项) -->
        <div class="form-card">
                        <!-- 独立设置：后台运行 (保活) -->
            <!-- 放在【开启主动发消息】的上方 -->
            <div class="form-group-row" id="proactiveBackgroundSetting" style="justify-content: space-between;">
                <label class="form-label">后台运行(保活)</label>
                <label class="toggle-switch">
                    <!-- 注意：下面的 id 必须是 proactiveBackgroundToggle -->
                    <input type="checkbox" id="proactiveBackgroundToggle" onchange="toggleProactiveBackground()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 总开关 -->
            <div class="form-group-row switch-row">
                <label class="form-label">开启主动发消息</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="proactiveMessagingToggle" onchange="toggleProactiveMessaging()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 隐藏项：时间间隔 (JS控制显示) -->
            <div class="form-group-row" id="proactiveIntervalSetting" style="display: none; border-top: 1px dashed #f0f0f0; justify-content: space-between;">
                <label class="form-label sub-label">触发间隔</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" id="proactiveIntervalInput" class="form-input" min="1" placeholder="360"
                           style="width: 50px; text-align: center; background: #f9f9f9; border-radius: 4px; height: 28px; padding: 0;"
                           onchange="updateProactiveInterval(this.value)">
                    <span style="font-size: 14px; color: #999;">分钟</span>
                </div>
            </div>

            <!-- 隐藏项：角色选择 (JS控制显示) -->
            <div class="form-group-row clickable" id="proactiveRoleSetting" style="display: none; border-top: 1px dashed #f0f0f0;" onclick="openProactiveRolesModal()">
                <label class="form-label sub-label">选择生效角色</label>
                <div class="form-value-display">点击选择 <i class="ri-arrow-right-s-line"></i></div>
            </div>

        </div>


        <!-- 卡片 4：智能总结 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">开启自动总结</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSummaryToggle" onchange="toggleAutoSummarySetting()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 隐藏项：总结轮数 -->
            <div class="form-group-row" id="summaryTurnsSetting" style="display: none; border-top: 1px dashed #f0f0f0; justify-content: space-between;">
                <label class="form-label sub-label">触发轮数</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" id="memoryGenerationTurnsInput" class="form-input" min="1" placeholder="20"
                           style="width: 50px; text-align: center; background: #f9f9f9; border-radius: 4px; height: 28px; padding: 0;"
                           onchange="memoryGenerationTurns = parseInt(this.value, 10) || 20; saveData(); showToast('总结轮数已保存');">
                    <span style="font-size: 14px; color: #999;">轮</span>
                </div>
            </div>
        </div>

        <!-- 卡片 5：数据管理 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="importData()">
                <label class="form-label">导入数据</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openExportModal()">
                <label class="form-label">导出角色与记录 (部分)</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="exportData()">
                <label class="form-label">导出全部数据 (备份)</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openClearDataConfirm()">
                <label class="form-label" style="color: #ff3b30;">清空所有数据</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

    </div>
</div>

<div id="memoryScreen" class="page">

<!-- 【【【这是我们新增的“总结加载中”提示】】】 -->
<div id="summaryLoadingIndicator" style="display: none;">
    正在生成总结，请稍候...
</div>

  <!-- 【【【这是修改后的正确代码】】】 -->
<div class="nav-bar">
    <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
    <div class="nav-title" id="memoryTitle">对话总结</div>
        <!-- ↓↓↓ 开始替换：将原来的单个按钮替换为下面这个 div 包裹的两个按钮 ↓↓↓ -->
    <div style="display: flex; align-items: center;">
        <!-- 新增：精炼总结按钮 -->
        <button class="nav-btn nav-right-action-btn" onclick="openRefineSummaryModal()" style="margin-right: 5px;" title="精炼所有总结">
             <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/><path d="m15 12-3 3"/><path d="m15 15-3-3"/></svg>
        </button>
        <!-- 原有的：手动总结按钮 -->
        <button class="nav-btn nav-right-action-btn" onclick="openManualSummaryModal()" title="手动添加总结">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </button>
    </div>
    <!-- ↑↑↑ 替换结束 ↑↑↑ -->

</div>
    <div class="wechat-content">
        <div id="memoryList" class="diary-list">
            <!-- 记忆内容将在这里动态生成 -->
        </div>
    </div>
</div>

<div id="apiSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">API 设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 卡片 1：连接配置 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">连接配置</label>
            </div>

            <!-- 预设按钮组 -->
            <div class="form-group-row" style="justify-content: flex-start; gap: 10px; padding-top: 0;">
                <button class="bw-chip-btn" onclick="openApiPresetSelector()">选择预设</button>
                <button class="bw-chip-btn" onclick="saveApiPreset()">保存当前预设</button>
            </div>

            <div class="form-group-row">
                <label class="form-label">API 地址</label>
                <input type="text" class="form-input" id="apiUrl" placeholder="https://...">
            </div>
            <div class="form-group-row">
                <label class="form-label">API Key</label>
                <div style="flex: 1; display: flex; align-items: center;">
                    <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                    <i class="ri-close-circle-fill" style="color: #ccc; margin-left: 8px; cursor: pointer; font-size: 18px;" onclick="document.getElementById('apiKey').value = ''"></i>
                </div>
            </div>


        </div>

        <!-- 卡片 2：模型设置 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">模型选择</label>
            </div>

            <div class="form-group-row">
                <label class="form-label">模型名称</label>
                <!-- 模型选择容器 -->
                <div class="model-select-container" style="flex: 1; position: relative;">
                    <!-- 输入框 -->
                    <input type="text" class="form-input" id="modelName" placeholder="点击选择或输入" readonly onclick="toggleModelDropdown()" style="padding-right: 25px;">

                    <!-- 下拉箭头图标 -->
                    <span class="select-arrow" onclick="toggleModelDropdown()">
                        <i class="ri-arrow-down-s-line"></i>
                    </span>

                    <!-- 下拉列表 -->
                    <div class="model-dropdown bw-dropdown" id="modelDropdown">
                        <!-- JS 填充选项 -->
                    </div>
                </div>
            </div>

            <!-- 拉取按钮 -->
            <div class="form-group-row" style="padding-top: 0; border-bottom: none;">
                <button class="bw-action-btn solid-outline" onclick="fetchModels()">
                    拉取模型列表
                </button>
            </div>
                       <!-- ▼▼▼ 新增：API 轮询设置区域 (可折叠最终版) ▼▼▼ -->
<div class="form-card" style="margin-top: 15px;">
    <!-- 标题栏：点击触发折叠 -->
    <div class="form-group-row" onclick="toggleApiPollingPanel()" style="border-bottom: none; padding: 10px 0; justify-content: space-between; cursor: pointer; user-select: none;">
        <div style="display: flex; align-items: center;">
            <!-- 折叠箭头 -->
            <i id="apiPollingArrow" class="ri-arrow-right-s-line" style="color: #999; margin-right: 5px; transition: transform 0.3s;"></i>

            <label class="form-label" style="font-size: 14px; font-weight: bold; margin: 0; pointer-events: none;">
                <i class="ri-loop-right-line" style="margin-right: 5px;"></i> API 轮询
            </label>
        </div>

        <!-- 开关 (阻止冒泡，防止触发折叠) -->
        <label class="toggle-switch" onclick="event.stopPropagation();">
            <input type="checkbox" id="apiPollingToggle" onchange="toggleApiPollingSwitch()">
            <span class="toggle-slider"></span>
        </label>
    </div>

    <!-- 轮询列表内容 (默认隐藏) -->
    <div id="apiPollingContent" style="display: none; padding-top: 10px; border-top: 1px dashed #eee;">
        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
            当主 API 请求失败时，将自动按顺序尝试以下备用 API。
        </div>

        <!-- 备用 API 列表 -->
        <div id="pollingListContainer" style="display: flex; flex-direction: column; gap: 8px;">
            <!-- JS 会在这里生成列表 -->
        </div>

        <!-- 添加按钮 -->
        <button class="bw-action-btn solid-outline" onclick="addCurrentToPolling()" style="margin-top: 10px; font-size: 12px;">
            <i class="ri-add-circle-line"></i> 将上方填写的配置添加为备用
        </button>
    </div>
</div>
<!-- ▲▲▲ 轮询设置区域结束 ▲▲▲ -->

 <!-- ▼▼▼ 新增：API 日志区域 (可折叠 & 去重版) ▼▼▼ -->
<div class="form-card" style="margin-top: 15px;">
    <!-- 标题栏：点击触发折叠 -->
    <div class="form-group-row" onclick="toggleApiLogPanel()" style="border-bottom: none; padding: 10px 0; justify-content: space-between; cursor: pointer; user-select: none;">
        <div style="display: flex; align-items: center;">
            <i id="apiLogArrow" class="ri-arrow-right-s-line" style="color: #999; margin-right: 5px; transition: transform 0.3s;"></i>
            <label class="form-label" style="font-size: 14px; font-weight: bold; margin: 0; pointer-events: none;">
                <i class="ri-file-list-3-line" style="margin-right: 5px;"></i> 请求日志
            </label>
        </div>
        <!-- 清空按钮 (阻止冒泡，防止触发折叠) -->
        <button class="bw-chip-btn" onclick="event.stopPropagation(); clearApiLogs()" style="color: #ff3b30; border-color: #ff3b30; padding: 2px 8px; font-size: 11px;">
            清空
        </button>
    </div>

    <!-- 日志显示容器 (默认隐藏 style="display: none") -->
    <div id="apiLogList" class="log-container" style="display: none; border-top: 1px dashed #eee; margin-top: 5px;">
        <!-- JS 会在这里生成日志 -->
    </div>
</div>
<!-- ▲▲▲ 日志区域结束 ▲▲▲ -->

        </div>

        <!-- 卡片 3：参数调整 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">高级参数</label>
            </div>

            <!-- 记忆条数 -->
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <label class="form-label">记忆条数</label>
                    <input type="number" class="form-input" id="memoryMessagesCount" placeholder="20">
                </div>
                <div class="form-hint">AI读取的历史消息数量，越多越消耗Token</div>
            </div>

            <!-- 温度设置 -->
            <div class="form-group-row column-layout">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <label class="form-label">温度 (0-2)</label>
                    <input type="number" class="form-input" id="apiTemperature" placeholder="0.9" step="0.1">
                </div>
                <div class="form-hint">越低越稳定，越高越随机</div>
            </div>

            <!-- AI 时间感知 -->
             <div class="form-group-row switch-row">
                <label class="form-label">AI 时间感知</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="aiTimePerceptionToggle" onchange="toggleTimePerception()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveApiSettings()">保存全部设置</button>
        </div>
    </div>
</div>

<div id="beautificationSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToTheme()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">美化设置</div>
        <div></div>
    </div>
    <!-- 核心：加上 bw-style 类，内容由 JS 填充 -->
    <div class="settings-content bw-style" id="beautificationSettingsList">
        <!-- JS 会在这里生成漂亮的卡片 -->
    </div>
</div>

<!-- ============================================== -->
<!-- 粘贴在这里：Char空间页面 (必须放在所有页面容器的外层) -->
<!-- ============================================== -->
<div id="charSpaceScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscoverFromCharSpace()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title" id="charSpaceTitle">Char空间</div>
        <div style="width: 40px;"></div>
    </div>
    <div class="wechat-content" style="padding-top: 74px;">
        <!-- 头部封面区 -->
        <div class="moments-cover" id="charSpaceCover">
            <div class="moments-cover-user">
                <span class="moments-cover-name" id="charSpaceName">Name</span>
                <div class="moments-cover-avatar" id="charSpaceAvatar"></div>
            </div>
        </div>
        <!-- 列表内容区 -->
        <div id="charSpaceList"></div>
    </div>
</div>

<!-- Char空间角色选择弹窗 -->
<div id="charSpaceSelectorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择要查看的角色</div>
        <div id="charSpaceSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS 动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('charSpaceSelectorModal').classList.remove('show')">取消</button>
        </div>
    </div>
</div>


<!-- ↑↑↑ HTML代码复制到这里结束 ↑↑↑ -->
<!-- ========================================= -->
<!-- 1. 邮箱列表主页 (修改版) -->
<div id="emailAppScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscoverFromEmail()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title" id="emailNavTitle">收件箱</div>

        <div style="display: flex; align-items: center; gap: 5px;">
            <!-- 新增：管理按钮 -->
            <button class="nav-btn" id="emailManageBtn" onclick="toggleEmailManageMode()">
                <i class="ri-list-check-2"></i>
            </button>
            <!-- 原有：刷新按钮 -->
            <button class="nav-btn" id="emailRefreshBtn" onclick="refreshEmailList()">
                <i class="ri-refresh-line"></i>
            </button>
        </div>
    </div>

    <div class="wechat-content" style="padding-top: 74px; background-color: #fff;">
        <!-- 邮件列表容器 -->
        <div id="emailListContainer" style="padding-bottom: 60px;"></div>
    </div>

    <!-- 新增：底部批量操作栏 -->
    <div id="emailBatchBar" class="multi-select-toolbar">
        <span class="multi-select-count" id="emailSelectCount">已选 0 封</span>
        <div class="multi-select-actions">
            <button class="multi-select-btn" onclick="selectAllEmails()">全选</button>
            <button class="multi-select-btn delete" onclick="deleteSelectedEmails()">删除</button>
            <button class="multi-select-btn cancel" onclick="toggleEmailManageMode()">取消</button>
        </div>
    </div>
</div>


<!-- 2. 邮件详情页 -->
<div id="emailDetailScreen" class="page">
    <div class="nav-bar" style="border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToEmailList()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">邮件详情</div>
        <div style="width:40px;"></div>
    </div>
    <div class="wechat-content" style="padding: 74px 20px 20px 20px; background-color: #fff;">
        <div id="emailDetailContent">
            <!-- JS会在这里填充邮件内容 -->
        </div>
    </div>
</div>
            <!-- MODIFIED: Phone App Page -->
            <!-- 用这段新代码替换 -->
<div id="phoneApp" class="page">
    <div class="nav-bar" id="phoneAppNavBar">
        <button class="nav-btn" id="navBarGoHomeButton" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">手机</div>
        <!-- 新增了一个重新生成按钮，并给予了ID和点击事件 -->
        <div>
            <button class="nav-btn" id="regenerateSimContentBtn" style="display: none;" onclick="handleSimRegenerateClick()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    <path d="M22 4v4h-4"/>
                </svg>
            </button>
        </div>
    </div>

                <div class="phone-app-container">
    <div id="phoneCharacterListScreen" class="friend-list"></div>
    <div id="simulatedPhoneScreen" style="display: none;">
        <div class="sim-phone-frame">
            <div class="sim-phone-screen">
                <div class="sim-phone-screen-content" id="sim-home-screen-content" onclick="triggerSimGlobalWallpaperUpload(event)"></div>
                <div class="sim-app-view" id="sim-wechat-view"></div>
                <div class="sim-app-view" id="sim-memo-view"></div>
                <div class="sim-app-view" id="sim-phone_call-view"></div>
                <div class="sim-app-view" id="sim-browser-view"></div>
                <div class="sim-app-view" id="sim-shopping-view"></div>
                <div class="sim-app-view" id="sim-wallet-view"></div>
                <div class="sim-app-view" id="sim-photos-view"></div>
                <div class="sim-app-view" id="sim-forum-view"></div>
                <div class="sim-app-view" id="sim-wechat-detail-view"></div>
                <div class="sim-app-view" id="sim-memo-detail-view"></div>
                <div class="sim-app-view" id="sim-browser-detail-view"></div>
                <div class="sim-app-view" id="sim-shopping-detail-view"></div>
                <div class="sim-app-view" id="sim-photos-detail-view"></div>
                <div class="sim-app-view" id="sim-forum-detail-view"></div>

                <div class="sim-app-view" id="sim-sim_music-view"></div>
                <div class="sim-app-view" id="sim-sim_settings-view"></div>

<div class="sim-app-view" id="sim-sim_recorder-view"></div>
<div class="sim-app-view" id="sim-sim_recorder-detail-view"></div>

<div class="sim-app-view" id="sim-sim_videos-view"></div>
<div class="sim-app-view" id="sim-sim_videos-detail-view"></div>


            </div>
        </div>
    </div>
</div>
            </div>

        </div>
    </div>
    <!-- ▼▼▼ 从这里开始是新增的购物App页面 ▼▼▼ -->
<div id="shoppingApp" class="page">
    <!-- 我们只保留购物App的核心内容 -->

    <div class="nav-bar-preview">
    <div class="nav-bar-left"><span class="nav-icon-preview nav-back-btn">←</span></div>
    <div class="nav-bar-center"><div class="nav-logo-preview">MODOU</div></div>
    <div class="nav-bar-right">
        <!-- 【【【新增的刷新按钮】】】 -->
        <span id="shopping-refresh-btn" class="nav-icon-preview" onclick="refreshShoppingProducts()">
            <i class="fa-solid fa-arrows-rotate"></i>
        </span>
        <!-- 【【【新增结束】】】 -->
        <span class="nav-icon-preview nav-more-btn">…</span>
    </div>
</div>

    <!-- 主内容区域 -->
    <div class="app-content-wrapper">
        <div id="home-page" class="app-page"><div class="hero-carousel"><div class="carousel-track"></div><div class="carousel-dots"></div></div><div class="home-content"><h2 class="section-title">LATEST UPDATE</h2><div class="news-feed"></div></div></div>
        <div id="shopping-page" class="app-page"><div class="category-nav"></div><div id="shopping-page-content"><div class="main-view page-view"><div class="product-shelf"></div></div><div class="private-gallery-view page-view"><div class="gallery-archive-list"></div></div></div></div>
        <div id="logistics-page" class="app-page"><div class="logistics-feed"></div></div>

        <!-- 我的页面 -->
        <div id="me-page" class="app-page active">
            <div class="profile-header">
                <label for="avatar-upload-input" class="profile-avatar-wrapper">
                    <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop&q=80" id="profile-avatar-img" class="profile-avatar" alt="User Avatar">
                </label>
                <input type="file" id="avatar-upload-input" accept="image/*">
                <p class="profile-username">MODOU User</p>
            </div>
            <ul class="profile-nav-list">
                <li class="profile-nav-item" data-page="orders-page" data-title="历史订单">
                    <i class="profile-nav-icon fa-solid fa-receipt"></i><span class="profile-nav-text">历史订单</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="pending-page" data-title="待购清单">
                    <i class="profile-nav-icon fa-solid fa-rectangle-list"></i><span class="profile-nav-text">待购清单</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="collection-page" data-title="我的藏品">
                    <i class="profile-nav-icon fa-solid fa-box-archive"></i><span class="profile-nav-text">我的藏品</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
                <li class="profile-nav-item" data-page="api-config-page" data-title="API 配置">
                    <i class="profile-nav-icon fa-solid fa-sliders"></i><span class="profile-nav-text">API 配置</span><i class="profile-nav-arrow fa-solid fa-chevron-right"></i>
                </li>
            </ul>
        </div>

        <!-- 我的子页面 -->
        <div id="pending-page" class="app-page entering"><div class="pending-list-page"><div class="wooden-desk"><div id="pending-items-container" class="pending-items-grid"></div><button class="confirm-collection-btn" id="confirm-btn"><i class="fa-solid fa-stamp"></i> 确认收纳</button></div></div></div>
        <div id="collection-page" class="app-page entering"><div class="placeholder-page"><h2>我的藏品</h2><div id="collection-container" class="collection-grid"></div></div></div>
        <div id="orders-page" class="app-page entering"><div class="placeholder-page"><h2>历史订单</h2><p>这里将展示您的所有历史订单记录。</p></div></div>
        <div id="api-config-page" class="app-page entering">
    <div class="api-config-form">
        <!-- Server Endpoint 输入框 -->
        <div class="config-section">
            <label for="api-url_shopping">Server Endpoint</label>
            <input type="text" id="api-url_shopping" placeholder="https://api.example.com/v1">
        </div>

        <!-- API Key 输入框 -->
        <div class="config-section">
            <label for="api-key_shopping">API Key</label>
            <input type="password" id="api-key_shopping" placeholder="sk-...">
        </div>

        <!-- 【【【新增】】】预设按钮 -->
        <div class="settings-buttons" style="margin-top: 10px; display: flex; gap: 15px;">
            <button class="settings-btn btn-secondary" style="flex: 1;" onclick="openApiPresetSelector_shopping()">选择预设</button>
            <button class="settings-btn btn-primary" style="flex: 1;" onclick="saveApiPreset_shopping()">保存为预设</button>
        </div>

        <!-- API 模型选择器 -->
        <div class="config-section" style="margin-top: 25px; border-top: 1px solid #444; padding-top: 25px;">
            <label>API 模型</label>
            <div class="model-select-container">
                <input type="text" class="model-select" id="modelName_shopping" placeholder="选择或输入模型名称" readonly onclick="toggleModelDropdown_shopping()">
                <span class="dropdown-arrow">▼</span>
                <div class="model-dropdown" id="modelDropdown_shopping"></div>
            </div>
        </div>

        <!-- 拉取模型和保存设置按钮 -->
        <div class="settings-buttons" style="margin-top: 20px; display: flex; gap: 15px;">
             <button class="settings-btn btn-secondary" style="flex: 1;" onclick="fetchModels_shopping()">拉取模型</button>
             <button class="settings-btn btn-primary" style="flex: 1;" onclick="saveApiSettings_shopping()">保存设置</button>
        </div>
    </div>
</div>
    </div>
    <!-- [新增] Char 详情页 -->
    <div id="char-details-page" class="app-page entering">
        <div class="placeholder-page">
            <h2 id="char-page-title">Character's Records</h2>
            <div class="char-records-grid">
                <div class="record-card">
                    <h4>浏览记录</h4>
                    <p>查看该角色的浏览历史</p>
                </div>
                <div class="record-card">
                    <h4>购买记录</h4>
                    <p>查看该角色的购买历史</p>
                </div>
                <div class="record-card">
                    <h4>收藏记录</h4>
                    <p>查看该角色的收藏列表</p>
                </div>
                 <div class="record-card">
                    <h4>历史订单</h4>
                    <p>查看该角色的所有订单</p>
                </div>
            </div>
        </div>
    </div>
    <!-- [新增] 结束 -->
    <!-- [新增] Char 选择浮窗 -->
    <div class="floating-modal" id="char-modal">
        <div class="modal-content">
            <span class="close-btn" id="close-char-modal">&times;</span>
            <h3>Select a Character</h3>
            <ul class="char-list" id="char-list-container">
                <!-- JS 会在这里填充角色列表 -->
            </ul>
        </div>
    </div>
    <!-- [新增] 结束 -->
    <!-- 底部导航栏 -->
    <div class="bottom-tab-bar">
        <div class="tab-item" data-page="home-page"><i class="tab-icon fa-solid fa-house"></i><span>首页</span></div>
        <div class="tab-item" data-page="shopping-page"><i class="tab-icon fa-solid fa-bag-shopping"></i><span>购物</span></div>
        <div class="tab-item" data-page="logistics-page"><i class="tab-icon fa-solid fa-truck-fast"></i><span>物流</span></div>
        <div class="tab-item active" data-page="me-page"><i class="tab-icon fa-solid fa-circle-user"></i><span>我的</span></div>
    </div>

<!-- ▼▼▼ 请将这个全新的页面代码块粘贴到购物App的其他页面旁边 ▼▼▼ -->
<div id="char-records-detail-page" class="app-page entering">
    <!-- 页面内容将由JS动态生成 -->
</div>
<!-- ▲▲▲ 新增代码到此结束 ▲▲▲ -->

<!-- ▼▼▼ 从这里开始是新增的“加入购物车”弹窗 ▼▼▼ -->
<div class="letter-modal" id="addToCartModal">
    <div class="letter-content">
        <div class="letter-header">
            <!-- 标题改为了“加入购物车” -->
            <h3 class="letter-title">加入购物车</h3>
        </div>
        <!-- 这个div用来显示商品信息 -->
        <div class="letter-product-preview" id="cart-product-preview"></div>

        <!-- 这里移除了密信的输入框 -->

        <div class="letter-actions">
            <!-- 按钮功能和文字都已修改 -->
            <button class="letter-btn letter-cancel-btn" onclick="closeAddToCartModal()">取消</button>
            <button class="letter-btn letter-send-btn" onclick="confirmAddToCart()">
                <i class="fa-solid fa-cart-plus"></i> 确认加入
            </button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新增代码到此结束 ▲▲▲ -->

    <!-- 密信弹窗 -->
    <div class="letter-modal" id="letter-modal"><div class="letter-content"><div class="letter-header"><h3 class="letter-title">传递密信</h3></div><div class="letter-product-preview" id="letter-product"></div><textarea class="letter-message" id="letter-message" placeholder="见此珍品，不忍错过，望君成全。"></textarea><input type="text" class="letter-recipient" id="letter-recipient" placeholder="收信人"><div class="letter-actions"><button class="letter-btn letter-cancel-btn" id="letter-cancel">取消</button><button class="letter-btn letter-send-btn" id="letter-send"><i class="fa-solid fa-paper-plane"></i> 寄出</button></div></div></div>
</div>
<!-- ▲▲▲ 新增的购物App页面到此结束 ▲▲▲ -->

<!-- ▼▼▼ 同人论坛App - 完整HTML结构 ▼▼▼ -->
<div id="doujinForumApp" class="page">

    <!-- 顶部导航容器 -->
    <div class="top-header">
        <div class="header-top">
            <div class="logo"><i class="fas fa-feather-alt"></i> 同人论坛</div>
            <div class="header-actions">
                <button class="search-btn" onclick="doujinOpenCharSelectModal()"><i class="fas fa-search"></i></button>
                <button class="refresh-btn" onclick="doujinRefreshContent()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
        <div class="top-nav">
            <div class="top-nav-content">
                <a class="tag-item active" data-category="推荐">推荐</a>
                <a class="tag-item" data-category="磕CP">磕CP</a>
                <a class="tag-item" data-category="都市">都市</a>
                <a class="tag-item" data-category="校园">校园</a>
                <a class="tag-item" data-category="末世">末世</a>
                <a class="tag-item" data-category="ABO">ABO</a>
                <a class="tag-item" data-category="年代">年代</a>
                <a class="tag-item" data-category="无限流">无限流</a>
                <a class="tag-item" data-category="R18">R18</a>
                <button class="add-tag-btn" onclick="doujinShowAddTagModal()"><i class="fas fa-bars"></i><span>管理</span></button>
            </div>
        </div>
    </div>

    <!-- 首页内容区域 -->
    <div class="page-container active" id="home-page" style="padding-top: 105px; padding-bottom: 70px;">
       <div class="content" id="doujin-timelines-wrapper">
            <div class="post-card" data-category="都市" data-characters="角色A,角色C" data-fulltext="夜幕降临，繁星点点。他站在天台上，等待着那个约定的身影。城市的霓虹在脚下流淌，而他的心却只为一人跳动... 这是文章的完整内容部分，比摘要更长，可以包含很多细节。">
                <div class="post-header">
                    <div class="avatar">梦</div>
                    <div class="user-info">
                        <div class="username">梦幻写手</div>
                        <div class="post-time"><i class="far fa-clock"></i> <span>2小时前</span></div>
                    </div>
                    <div class="more-btn"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="post-content">
                    <div class="post-title">【原创】星河之约 第一章</div>
                    <div class="post-text">夜幕降临，繁星点点。他站在天台上，等待着那个约定的身影。城市的霓虹在脚下流淌...</div>
                    <div class="post-tags"><span class="tag">#原创</span><span class="tag">#都市</span><span class="tag">#甜文</span></div>
                </div>
                <div class="post-actions">
                    <div class="action-btn"><i class="far fa-heart"></i> <span>328</span></div>
                    <div class="action-btn"><i class="far fa-comment"></i> <span>56</span></div>
                    <div class="action-btn"><i class="far fa-star"></i> <span>128</span></div>
                </div>
            </div>
            <div class="post-card" data-category="校园" data-characters="角色B" data-fulltext="Alpha的信息素在空气中弥漫，Omega少年的身体不由自主地颤抖。这是命运的安排，还是爱情的召唤... 完整内容在这里展示，这是一个ABO校园题材的故事，讲述了命中注定的相遇。">
                <div class="post-header">
                    <div class="avatar" style="background: linear-gradient(135deg, #8ba89d 0%, #a3bfb3 100%);">二</div>
                    <div class="user-info">
                        <div class="username">二次元爱好者</div>
                        <div class="post-time"><i class="far fa-clock"></i> <span>5小时前</span></div>
                    </div>
                    <div class="more-btn"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="post-content">
                    <div class="post-title">【ABO】注定的命运</div>
                    <div class="post-text">Alpha的信息素在空气中弥漫，Omega少年的身体不由自主地颤抖。这是命运的安排...</div>
                    <div class="post-tags"><span class="tag">#ABO</span><span class="tag">#校园</span><span class="tag">#HE</span></div>
                </div>
                <div class="post-actions">
                    <div class="action-btn active"><i class="fas fa-heart"></i> <span>562</span></div>
                    <div class="action-btn"><i class="far fa-comment"></i> <span>89</span></div>
                    <div class="action-btn"><i class="far fa-star"></i> <span>245</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 我的页面容器 -->
    <div class="page-container" id="my-page" style="padding-top: 30px; padding-bottom: 70px;">
        <div class="content">
            <div class="profile-header">
                <label for="avatar-upload" class="profile-avatar-wrapper">
                    <div class="profile-avatar"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iI2VlZSIvPjxwYXRoIGQ9Ik01MCAxNUMzMy40MyAxNSA1MCAzMy40MyA1MCA1MFM2Ni41NyA4NSA1MCA4NVMzMy40MyA2Ni41NyA1MCA1MFoiIGZpbGw9IiNhYWEiLz48cGF0aCBkPSJNNTAgNTBDNTggMzUgODAgMzAgODUgNTBDODAgNzAgNjAgNzUgNTAgNTBaIiBmaWxsPSIjYWFhIi8+PC9zdmc+" alt="Avatar" id="avatar-preview"></div>
                    <div class="profile-avatar-upload-icon"><i class="fas fa-camera"></i></div>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                </label>
                <div class="profile-info">
                    <div class="profile-nickname" id="doujin-profile-nickname-display">你的昵称</div>
        <!-- 修改 -->
        <div class="profile-id" id="doujin-profile-id">ID: 12345678</div>
    </div>
    <button class="profile-edit-btn" onclick="doujinShowEditProfileModal()">编辑资料</button>
</div>
<div class="profile-stats">
    <div class="stat-item">
        <!-- 修改 -->
        <div class="stat-value" id="doujin-heat-value">1.2M</div>
        <div class="stat-label">热度</div>
    </div>
    <div class="stat-item">
        <!-- 修改 -->
        <div class="stat-value" id="doujin-fans-value">35.6k</div>
        <div class="stat-label">粉丝</div>
    </div>
    <div class="stat-item">
        <!-- 修改 -->
        <div class="stat-value" id="doujin-following-value">128</div>
        <div class="stat-label">关注</div>
    </div>
</div>
            <div class="profile-nav-cards">
                <div class="nav-card" onclick="doujinNavigateToPage('my-posts-page'); renderMyPostsPage();">
                    <div class="nav-card-icon posts"><i class="fas fa-book-open"></i></div>
                    <div class="nav-card-info">
                        <span class="nav-card-title">我发布的</span>
                        <span class="nav-card-meta">查看您创作的所有作品</span>
                    </div>
                    <i class="fas fa-chevron-right nav-card-arrow"></i>
                </div>
                <div class="nav-card" onclick="doujinNavigateToPage('cp-list-page')">
                    <div class="nav-card-icon cp"><i class="fas fa-heart"></i></div>
                    <div class="nav-card-info">
                        <span class="nav-card-title">磕CP选择</span>
                        <span class="nav-card-meta">管理您关注的CP</span>
                    </div>
                    <i class="fas fa-chevron-right nav-card-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="page-container" id="my-posts-page">
    <div class="subpage-header with-back-btn">
        <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
        <h2>我发布的</h2>
        <!-- 新增：右上角的发布按钮 -->
        <button class="nav-btn" onclick="doujinNavigateToPage('publish-page')" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background:none; border:none; font-size: 18px; color: #333;">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    <div class="content" id="my-posts-list"></div>
    </div>


    <!-- CP选择子页面 -->
<div class="page-container" id="cp-list-page">
    <div class="subpage-header">
        <!-- 左侧：返回按钮 -->
        <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>

        <!-- 中间：标题 -->
        <h2>磕CP选择</h2>

        <!-- 右侧：按钮组 (加号在前，设定在后) -->
        <div style="display: flex; align-items: center; gap: 15px; z-index: 10;">
            <!-- 加号按钮 -->
            <button class="nav-btn" onclick="doujinOpenCpCreatePage()" style="background:none; border:none; font-size: 18px; color: #555;">
                <i class="fas fa-plus"></i>
            </button>
            <!-- 设定/选择按钮 -->
            <button class="nav-btn" onclick="doujinOpenCpRunModal()" title="CP设定" style="background:none; border:none; font-size: 18px; color: #555;">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
    <div class="content" id="cp-cards-container"></div>
</div>

    <!-- CP创建/编辑页面 -->
<div class="page-container" id="cp-edit-page">
    <div class="subpage-header with-back-btn">
        <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
        <h2 id="cp-edit-page-title">创建新CP</h2>
    </div>
    <div class="content">
        <input type="hidden" id="editing-cp-id">

        <!-- 左位 (原角色) -->
        <div class="character-editor">
            <h3>左位 (攻/男主/女攻)</h3>
            <label for="char-avatar-upload" class="char-avatar-wrapper">
                <img src="..." id="char-avatar-preview" class="char-avatar-preview">
                <div class="char-avatar-upload-icon"><i class="fas fa-camera"></i></div>
            </label>
            <input type="file" id="char-avatar-upload" class="char-avatar-upload-input" accept="image/*">
            <!-- 第一个框：昵称 -->
            <!-- ▼▼▼ 请插入这段新代码 (左位性别) ▼▼▼ -->
<select id="char-gender-select" class="char-input" style="appearance: auto; -webkit-appearance: auto; background: #f9f9f9;">
    <option value="">请选择性别 (必选)</option>
    <option value="[性别:男] ">男</option>
    <option value="[性别:女] ">女</option>
</select>
<!-- ▲▲▲ 插入结束 ▲▲▲ -->
            <input type="text" id="char-name" class="char-input" placeholder="左位昵称 (例如：顾魏)">
            <!-- 第二个框：人设和背景 -->
            <textarea id="char-bio" class="char-textarea" placeholder="左位人设、背景设定..." style="height: 120px;"></textarea>
        </div>

        <!-- 分割图标 -->
        <div class="cp-vs-icon"><i class="fas fa-times"></i></div>

        <!-- 右位 (原用户) -->
        <div class="character-editor">
            <h3>右位 (受/女主/男受)</h3>
            <label for="user-avatar-upload" class="char-avatar-wrapper">
                <img src="..." id="user-avatar-preview" class="char-avatar-preview">
                <div class="char-avatar-upload-icon"><i class="fas fa-camera"></i></div>
            </label>
            <input type="file" id="user-avatar-upload" class="char-avatar-upload-input" accept="image/*">
            <!-- 第一个框：昵称 -->
            <!-- ▼▼▼ 请插入这段新代码 (右位性别) ▼▼▼ -->
<select id="user-gender-select" class="char-input" style="appearance: auto; -webkit-appearance: auto; background: #f9f9f9;">
    <option value="">请选择性别 (必选)</option>
    <option value="[性别:男] ">男</option>
    <option value="[性别:女] ">女</option>
</select>
<!-- ▲▲▲ 插入结束 ▲▲▲ -->

            <input type="text" id="user-name" class="char-input" placeholder="右位昵称 (例如：林之校)">
            <!-- 第二个框：人设和背景 -->
            <textarea id="user-bio" class="char-textarea" placeholder="右位人设、背景设定..." style="height: 120px;"></textarea>
        </div>
    </div>
    <div class="publish-footer">
        <button class="publish-submit-btn" onclick="doujinSaveCpData()">保 存</button>
    </div>
</div>

    <!-- 帖子详情 子页面 -->
    <div class="page-container" id="post-detail-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()" style="color: #333;"><i class="ri-arrow-left-line"></i></button>
            <h2>帖子详情</h2>
        </div>
        <div class="content" style="padding-bottom: 80px;">
            <div id="detail-post-header-container"></div>
            <h1 class="detail-post-title" id="detail-post-title"></h1>
            <div class="detail-post-full-text" id="detail-post-full-text"></div>
            <div class="detail-post-tags post-tags" id="detail-post-tags"></div>
            <div class="comments-section">
                <h3>评论</h3>
                <div class="comments-list" id="comments-list"></div>
            </div>
        </div>
        <div class="comment-form hidden">
            <input type="text" id="comment-input" class="comment-input" placeholder="留下你的评论吧...">
            <button class="comment-submit-btn" onclick="doujinSubmitComment('post-detail-page')">发送</button>
        </div>
    </div>

<!-- 书架页面 -->
<div class="page-container" id="bookshelf-page" style="padding-bottom: 70px;">
    <div class="subpage-header">
        <!-- 左侧占位，保持标题居中 -->
        <div style="width: 40px;"></div>
        <h2>我的书架</h2>
        <!-- 【修改】管理按钮改为图标样式 -->
        <button class="nav-btn" id="doujinBookshelfManageBtn" onclick="doujinToggleBookshelfManageMode()" style="font-size: 20px; color: #333;">
            <i class="ri-list-check-2"></i>
        </button>
    </div>

    <div class="bookshelf-grid" id="bookshelf-grid">
        <!-- 书籍列表将由JS渲染 -->
    </div>

    <!-- 【重构】美化后的底部批量操作栏 -->
    <div id="doujinBookshelfBatchBar" class="doujin-batch-bar">
        <!-- 左侧：全选 -->
        <div class="batch-action-item" onclick="doujinToggleSelectAll()">
            <i class="ri-checkbox-circle-line" id="doujinSelectAllIcon"></i>
            <span>全选</span>
        </div>

        <!-- 中间：数量提示 -->
        <div class="batch-info">
            已选 <span id="doujinBookSelectCount" style="color: #7d9d8f; font-weight: bold;">0</span> 本
        </div>

        <!-- 右侧：删除 -->
        <div class="batch-action-item delete" onclick="doujinDeleteSelectedBooks()">
            <i class="ri-delete-bin-line"></i>
            <span>删除</span>
        </div>
    </div>
</div>

    <!-- 小说详情/目录页 -->
    <div class="page-container" id="novel-detail-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>书籍详情</h2>
        </div>
        <div class="content">
            <div class="novel-detail-header">
                <div class="novel-detail-cover"><img id="novel-detail-cover" src=""></div>
                <div class="novel-detail-info">
                    <h1 id="novel-detail-title"></h1>
                    <p class="novel-detail-meta" id="novel-detail-author"></p>
                    <span class="novel-detail-status" id="novel-detail-status"></span>
                </div>
            </div>
            <div class="chapters-list" id="chapters-list"></div>
        </div>
    </div>

    <!-- 章节阅读页 -->
    <div class="page-container" id="chapter-reading-page">
        <div class="subpage-header with-back-btn">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2 id="chapter-title-header"></h2>
        </div>
        <div class="content" style="padding-bottom: 80px;">
            <div class="chapter-body-content"><p id="chapter-body-text"></p></div>
            <div class="comments-section">
                <h3>本章评论</h3>
                <div class="comments-list" id="chapter-comments-list"></div>
            </div>
        </div>
        <div class="comment-form hidden">
            <input type="text" id="chapter-comment-input" class="comment-input" placeholder="发表你的评论...">
            <button class="comment-submit-btn" onclick="doujinSubmitComment('chapter-reading-page')">发送</button>
        </div>
    </div>

    <!-- 发布页面 -->
    <div class="page-container" id="publish-page">
        <div class="publish-header">
            <button class="back-btn" onclick="doujinGoBack()"><i class="fas fa-chevron-left"></i></button>
            <h2>创建新作品</h2>
            <button class="publish-draft-btn" onclick="alert('草稿已保存')">存草稿</button>
        </div>
      <div class="publish-main">
    <input type="text" id="publish-title" class="publish-title-input" placeholder="请输入标题...">

    <!-- 正文输入框 -->
    <textarea id="publish-content" class="publish-content-textarea" placeholder="尽情挥洒你的创意吧..." style="height: 30vh;"></textarea>

    <!-- 【新增】作者有话说输入区域 -->
    <div style="margin-top: 10px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px dashed #e0e0e0;">
        <div style="font-size: 13px; color: #7d9d8f; font-weight: 600; margin-bottom: 8px;">
            <i class="fas fa-comment-alt"></i> 作者有话说
        </div>
        <textarea id="publish-author-words"
                  style="width: 100%; border: none; background: transparent; outline: none; font-size: 14px; resize: none; height: 60px;"
                  placeholder="和读者聊两句，或者预告一下剧情..."></textarea>
    </div>

    <div class="word-count" id="word-count">0 字</div>
</div>
        <div class="publish-options">
            <div class="publish-tags-section">
                <label class="publish-option-item-label" style="margin-bottom: 15px; display: block;">添加标签</label>
                <div class="publish-tags-container" id="publish-tags-container"></div>
                <div class="publish-tag-input-wrapper">
                    <input type="text" id="publish-tag-input-field" placeholder="输入后按Enter添加标签">
                </div>
            </div>
            <!-- 修改：给这一行添加点击事件 -->
<div class="publish-option-item" onclick="doujinOpenCategorySelectModal()">
    <span class="publish-option-item-label">文章分类</span>
    <div>
        <!-- 修改：给这个 span 添加 ID -->
        <span class="publish-option-item-value" id="selected-publish-category">未选择</span>
        <i class="fas fa-chevron-right publish-option-item-arrow"></i>
    </div>
</div>
        </div>
        <div class="publish-footer">
            <button class="publish-submit-btn" onclick="doujinSubmitPost()">发 布</button>
        </div>
    </div>

    <!-- 排行页面容器 -->
    <div class="page-container" id="ranking-page" style="padding-bottom: 70px;">
        <div class="subpage-header">
            <h2 style="flex-grow: 1; text-align: center;">排行榜</h2>
            <button class="ranking-refresh-btn" onclick="doujinRefreshRankings()"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="ranking-tabs">
            <div class="ranking-tab-item active" data-tab="heat">热度榜</div>
            <div class="ranking-tab-item" data-tab="new">新作榜</div>
            <div class="ranking-tab-item" data-tab="collection">收藏榜</div>
        </div>
        <div class="ranking-content">
            <div class="ranking-panel active" id="heat-panel">
                <div class="ranking-list">
                    <div class="ranking-item">
                        <div class="rank-number rank-1">1</div>
                        <div class="ranking-item-info">
                            <div class="ranking-item-title">【ABO】注定的命运</div>
                            <div class="ranking-item-meta"><span>作者: 二次元爱好者</span><span>热度: 1.5M</span></div>
                            <div class="ranking-item-tags"><span class="tag">#ABO</span><span class="tag">#校园</span></div>
                        </div>
                    </div>
                    <div class="ranking-item">
                        <div class="rank-number rank-2">2</div>
                        <div class="ranking-item-info">
                            <div class="ranking-item-title">【年代文】七十年代的那些事</div>
                            <div class="ranking-item-meta"><span>作者: 时光写手</span><span>热度: 1.2M</span></div>
                            <div class="ranking-item-tags"><span class="tag">#年代</span><span class="tag">#知青</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ranking-panel" id="new-panel"><div class="ranking-list"></div></div>
            <div class="ranking-panel" id="collection-panel"><div class="ranking-list"></div></div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <a class="nav-item active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">首页</div></a>
        <a class="nav-item" data-page="bookshelf-page"><div class="nav-icon"><i class="fas fa-book-open"></i></div><div class="nav-label">书架</div></a>

        <a class="nav-item" data-page="ranking-page"><div class="nav-icon"><i class="fas fa-trophy"></i></div><div class="nav-label">排行</div></a>
        <a class="nav-item" data-page="my-page"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">我的</div></a>
    </div>



    <!-- 弹窗容器 -->
    <div class="modal" id="addTagModal">
        <div class="modal-content">
            <div class="modal-title">添加自定义标签</div>
            <input type="text" class="modal-input" id="tagInput">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="doujinHideAddTagModal()">取消</button>
                <button class="modal-btn confirm" onclick="doujinAddCustomTag()">确定</button>
            </div>
        </div>
    </div>
    <!-- 修改后：编辑资料弹窗 -->
<div class="modal" id="editProfileModal">
    <div class="modal-content">
        <div class="modal-title">编辑个人资料</div>
        <input type="text" class="modal-input" id="doujin-edit-nickname" placeholder="昵称">
        <input type="text" class="modal-input" id="doujin-edit-id" placeholder="ID">
        <input type="text" class="modal-input" id="doujin-edit-heat" placeholder="热度值">
        <input type="text" class="modal-input" id="doujin-edit-fans" placeholder="粉丝数">
        <input type="text" class="modal-input" id="doujin-edit-following" placeholder="关注数">
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinHideEditProfileModal()">取消</button>
            <button class="modal-btn confirm" onclick="doujinSaveProfile()">保存</button>
        </div>
    </div>
</div>
    <div class="modal" id="editStatModal">
        <div class="modal-content">
            <div class="modal-title" id="editStatModalTitle">修改数值</div>
            <input type="text" class="modal-input" id="statInput">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="doujinHideEditStatModal()">取消</button>
                <button class="modal-btn confirm" onclick="doujinSaveStat()">保存</button>
            </div>
        </div>
    </div>
    <div class="modal" id="charSelectModal">
        <div class="modal-content">
            <div class="modal-title">按角色筛选</div>
            <!-- 新增：篇数设置滑块 -->
<div class="doujin-modal-setting-group">
    <label for="fic-count-slider">生成篇数: <span id="fic-count-value">3</span></label>
    <input type="range" id="fic-count-slider" min="1" max="10" value="3" class="doujin-slider">
</div>

<!-- 新增：同人梗选择区域 -->
<div class="doujin-modal-setting-group">
    <label>
        选择同人梗
        <i class="fas fa-pencil-alt" id="edit-trope-toggle-btn" style="cursor:pointer; color:#999; font-size:14px; margin-left:8px;" onclick="doujinToggleTropeEditMode(this)" title="点击切换编辑模式"></i>
    </label>
    <div class="trope-selection-area" id="trope-selection-area">
        <!-- “无”和“+”按钮将由JS动态生成 -->
    </div>
</div>
            <!-- ▼▼▼ 新增：文风选择区域 ▼▼▼ -->
<div class="doujin-modal-setting-group">
    <label>选择文风</label>
    <div class="trope-selection-area" id="doujin-style-select-container">
        <!-- JS 将在这里动态生成文风标签 -->
    </div>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->
            <div class="char-select-container" id="char-select-container"></div>
            <div class="modal-buttons" style="margin-top: 25px;">
                <button class="modal-btn cancel" onclick="doujinResetCharFilter()">重置</button>
                <button class="modal-btn confirm" onclick="doujinApplyCharacterFilter()">确定</button>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ 同人论坛App - 完整HTML结构结束 ▲▲▲ -->

    <div id="addGroupChatModal" class="modal"><div class="modal-content"><div class="modal-title">选择联系人</div><div id="groupChatFriendList" class="multi-select-list" style="max-height: 300px;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeGroupChatModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="createGroupChat()">确定</button></div></div></div>
    <div id="addFriendModal" class="modal"><div class="modal-content"><div class="modal-title">添加好友</div><div class="avatar-upload" id="friendAvatarUpload"><input type="file" accept="image/*"

onchange="handleFriendAvatarUpload(event)"><span id="friendAvatarPreview">+</span></div><input type="text" class="modal-input" id="friendNameInput" placeholder="好友昵称（必填）"><input type="text" class="modal-input" id="friendRemarkInput" placeholder="备注名称（可选）"><textarea class="modal-textarea" id="friendRoleInput" placeholder="角色设定（可选）...&#10;例如：你是一个可爱的猫娘，性格活泼开朗，喜欢用'喵'结尾说话..."></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddFriendModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewFriend()">添加</button></div></div></div>
<!-- ▼▼▼ 请插入这段新代码 (添加时的性别选择) ▼▼▼ -->
<select id="newFriendGenderInput" class="modal-input" style="appearance: auto; -webkit-appearance: auto; color: #333; margin-bottom: 10px;">
    <option value="">请选择TA的性别 (AI参考用)</option>
    <option value="[性别:男] ">男</option>
    <option value="[性别:女] ">女</option>
    <option value="[性别:通用] ">通用/保密</option>
</select>
<!-- ▲▲▲ 插入结束 ▲▲▲ -->

<div id="nameModal" class="modal"><div class="modal-content"><div class="modal-title">修改昵称</div><input type="text" class="modal-input" id="newNameInput" placeholder="请输入新昵称"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeNameModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeName()">确定</button></div></div></div>
    <div id="textEditModal" class="modal"><div class="modal-content"><div class="modal-title" id="textEditTitle">编辑文字</div><input type="text" class="modal-input" id="newTextInput" placeholder="请输入新内容"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTextEditModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmTextEdit()">确定</button></div></div></div>
    <div id="avatarModal" class="modal"><div class="modal-content"><div class="modal-title">更换头像</div><div class="avatar-upload" id="userAvatarUpload"><input type="file" accept="image/*" onchange="handleUserAvatarUpload(event)"><span id="userAvatarPreview">+</span></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAvatarModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeAvatar()">确定</button></div></div></div>
    <div id="addWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">添加世界书</div><input type="text" class="modal-input" id="worldBookNameInput" placeholder="世界书昵称"><div class="form-group"><select class="form-select" id="worldBookFolderSelect"></select></div><textarea class="modal-textarea" id="worldBookContentInput" placeholder="世界书内容..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBook()">添加</button></div></div></div>
    <div id="editWorldBookModal" class="modal"><div class="modal-content"><div class="modal-title">编辑世界书</div><input type="text" class="modal-input" id="editWorldBookNameInput" placeholder="世界书昵称"><div class="form-group"><select class="form-select" id="editWorldBookFolderSelect"></select></div><textarea class="modal-textarea" id="editWorldBookContentInput" placeholder="世界书内容..." style="min-height: 120px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeEditWorldBookModal()">取消</button><button class="modal-btn modal-btn-confirm" id="saveWorldBookEditBtn">保存</button></div></div></div>
    <div id="addWorldBookFolderModal" class="modal"><div class="modal-content"><div class="modal-title">新建文件夹</div><input type="text" class="modal-input" id="worldBookFolderNameInput" placeholder="文件夹名称"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeAddWorldBookFolderModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="addNewWorldBookFolder()">创建</button></div></div></div>
    <div id="signatureModal" class="modal"><div class="modal-content"><div class="modal-title">修改个性签名</div><input type="text" class="modal-input" id="newSignatureInput" placeholder="请输入新的个性签名"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeSignatureModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeSignature()">确定</button></div></div></div>
    <div id="locationModal" class="modal"><div class="modal-content"><div class="modal-title">修改地区</div><input type="text" class="modal-input" id="newLocationInput" placeholder="请输入地区"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmChangeLocation()">确定</button></div></div></div>
    <div id="cameraModal" class="modal"><div class="modal-content"><div class="modal-title">AI拍摄</div><textarea class="modal-textarea" id="cameraDescInput" placeholder="请描述你要拍摄的内容...&#10;例如：一只可爱的小猫正在阳台上晒太阳" style="min-height: 100px;"></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeCameraModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmCamera()">拍摄</button></div></div></div>
   <div id="addMomentModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">发布朋友圈</div>

        <!-- 1. 文本输入框 -->
        <textarea class="modal-textarea" id="momentContentInput" placeholder="这一刻的想法..." style="min-height: 120px;"></textarea>

        <!-- 2. 预览区域 (图片或描述占位图都会显示在这里) -->
        <div id="momentMediaPreviewBox" class="moment-preview-box">
            <div class="moment-media-remove" onclick="removeMomentMedia()">×</div>
        </div>

        <!-- 3. 操作工具栏 (两个并列的图标按钮) -->
        <div class="moment-toolbar">
            <!-- 按钮 A: 上传图片 -->
            <label class="media-action-btn" id="btnUploadImage">
                <i class="ri-image-2-line"></i>
                <span>上传图片</span>
                <!-- 隐藏的文件输入框 -->
                <input type="file" accept="image/*" style="display:none;" onchange="handleMomentImageUpload(event)">
            </label>

            <!-- 按钮 B: 描述图片 -->
            <div class="media-action-btn" id="btnDescribeImage" onclick="openMomentDescriptionInput()">
                <i class="ri-camera-lens-line"></i>
                <span>描述图片</span>
            </div>

<!-- 在 .moment-toolbar 内部，btnDescribeImage 后面添加 -->
<div class="media-action-btn" style="position: relative;">
    <i class="ri-group-2-line"></i>
    <span>谁可以看</span>
    <!-- 一个覆盖在上面的透明下拉框，实现点击选择 -->
    <select id="momentPostGroupSelect" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;" onchange="updateGroupSelectLabel(this)">
        <option value="public">所有人</option>
        <!-- 分组选项由JS动态填入 -->
    </select>
    <div id="momentPostGroupLabel" style="font-size: 10px; color: #007aff; margin-top: -2px;">所有人</div>
</div>

</div>

        <!-- 4. 底部按钮 -->
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeAddMomentModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="postNewMoment()">发布</button>
        </div>
    </div>
</div>
    <div id="alertModal" class="modal"><div class="modal-content"><div class="modal-title">提示</div><div id="alertMessage"></div><div class="modal-buttons"><button class="modal-btn modal-btn-confirm" onclick="closeAlertModal()">确定</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-title">请确认</div><div id="confirmMessage" style="text-align: center; margin-bottom: 20px; line-height: 1.5;"></div><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" id="confirmCancelBtn">取消</button><button class="modal-btn modal-btn-confirm" id="confirmOkBtn">确定</button></div></div></div>
        <div id="momentCommentInputArea"><input type="text" id="momentCommentInput" placeholder="评论..."><button id="momentCommentSendBtn">发送</button></div>
    <div id="transferModal" class="modal"><div class="modal-content"><div class="modal-title">转账</div><input type="number" class="modal-input" id="transferAmountInput" placeholder="¥ 0.00"><input type="text" class="modal-input" id="transferRemarkInput" placeholder="添加备注 (可选)"><div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeTransferModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="sendTransfer()">转账</button></div></div></div>
    <div id="worldBookBindingModal" class="modal"><div class="modal-content"><div class="modal-title">绑定世界书</div><div id="worldBookBindingList" class="multi-select-list" style="max-height: 40vh; text-align: left;"></div><div class="modal-buttons" style="margin-top: 15px;"><button class="modal-btn modal-btn-cancel" onclick="closeWorldBookBindingModal()">取消</button><button class="modal-btn modal-btn-confirm" onclick="confirmWorldBookBinding()">确定</button></div></div></div>

    <!-- NEW: Location Input Modal -->
    <div id="sendLocationModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">发送位置</div>
        <!-- 位置名称 (如：东方明珠) -->
        <input type="text" class="modal-input" id="locationNameInput" placeholder="位置名称 (必填)">
        <!-- 详细地址 (如：世纪大道1号) -->
        <input type="text" class="modal-input" id="locationAddressInput" placeholder="详细地址 (选填，不填则不显示)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLocationModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmSendLocation()">确定</button>
        </div>
    </div>
</div>

    <!-- NEW: Image Description Modal -->
    <div id="imageDescriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">图片描述</div>
            <div id="imageDescriptionContent"></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-btn modal-btn-confirm" onclick="closeImageDescriptionModal()">确定</button>
            </div>
        </div>
    </div>

    <!-- [MODIFIED] New Emoji Modal -->
    <div id="addEmojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-title"> 添加自定义表情</div>
            <div class="emoji-modal-tabs">
                <button class="emoji-modal-tab active" onclick="switchEmojiAddMode(this, 'single')">单个添加</button>
                <button class="emoji-modal-tab" onclick="switchEmojiAddMode(this, 'batch')">批量添加</button>
            </div>

            <!-- Single Add View -->
            <div id="emojiSingleAddView" class="emoji-modal-content-view active">
                <input type="text" class="modal-input" id="singleEmojiNameInput" placeholder="表情名称 (必填)">
                <input type="text" class="modal-input" id="singleEmojiUrlInput" placeholder="表情URL链接">
                <label for="singleEmojiUploadInput" class="emoji-modal-upload-btn">本地上传</label>
            </div>

            <!-- Batch Add View -->
            <div id="emojiBatchAddView" class="emoji-modal-content-view">
                <textarea id="batchEmojiInput" class="modal-textarea" placeholder="在此处粘贴表情信息，格式为：&#10;表情名1：URL1&#10;表情名2：URL2 (URL可换行)"></textarea>
                <label for="batchEmojiUploadInput" class="emoji-modal-upload-btn">本地上传</label>
            </div>

            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddEmojiModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmAddEmoji()">添加</button>
            </div>
        </div>
    </div>


     <div id="addMusicModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">添加新歌曲</div>
                <input type="text" class="modal-input" id="songTitleInput" placeholder="歌曲名 (自动读取或手动填写)">
                <input type="text" class="modal-input" id="songArtistInput" placeholder="歌手 (自动读取或手动填写)">
                <button class="modal-btn" onclick="document.getElementById('songFileInput').click()">添加歌曲文件</button>
                <span id="songFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">未选择文件</span>
                <button class="modal-btn" style="margin-top: 10px;" onclick="document.getElementById('lrcFileInput').click()">添加歌词文件 (.lrc)</button>
                <span id="lrcFileName" style="font-size: 12px; color: #666; display: block; text-align: center; margin-top: 5px;">未选择文件</span>
                 <div class="modal-buttons" style="margin-top: 20px;">
                    <button class="modal-btn modal-btn-cancel" onclick="closeAddMusicModal()">取消</button>
                    <button class="modal-btn modal-btn-confirm" onclick="confirmAddSong()">完成</button>
                </div>
            </div>
        </div>


    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <div class="playlist-header">
                <span id="playlistTitle">播放列表 (0)</span>
                <button id="openAddMusicBtn" onclick="openAddMusicModal()">+</button>
            </div>
            <div class="playlist-list" id="playlistList"></div>
        </div>
    </div>

    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">发送语音</div>
            <textarea class="modal-textarea" id="voiceInputText" placeholder="在此输入语音的文字内容..." style="min-height: 120px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick ="closeVoiceModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="sendVoiceMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- ↓↓↓ 第1步：从这里开始复制 ↓↓↓ -->

    <!-- 新增：发红包的弹窗 -->
    <div id="redEnvelopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">发红包</div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <label style="width: 80px;">总金额</label>
                <input type="number" class="modal-input" id="redEnvelopeAmount" placeholder="0.00" style="margin-bottom: 0;">
                <span style="margin-left: 10px;">元</span>
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <label style="width: 80px;">红包个数</label>
                <input type="number" class="modal-input" id="redEnvelopeCount" placeholder="填写个数" style="margin-bottom: 0;">
                <span style="margin-left: 10px;">个</span>
            </div>
             <input type="text" class="modal-input" id="redEnvelopeRemark" placeholder="恭喜发财，大吉大利">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeRedEnvelopeModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" style="background-color: #E64340;" onclick="sendGroupRedEnvelope()">塞钱进红包</button>
            </div>
        </div>
    </div>

       <!-- 新增：开红包的动画弹窗 -->
    <div id="openRedEnvelopeModal" class="modal">
        <div id="redEnvelopeOpenCard">
            <div id="openRedEnvelopeButton"> <!-- 看，我们把“Red”加回来了！ -->
                开
            </div>
        </div>
    </div>

<!-- ↑↑↑ 第2步：在这里结束复制 ↑↑↑ -->

    <!-- 新增：查看红包详情的弹窗 -->
    <div id="redEnvelopeDetailsModal" class="modal">
        <div class="modal-content" style="background-color: #F7F7F7; padding: 0;">
            <div style="background-color: #E64340; color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center;">
                <div id="redEnvelopeDetailsRemark" style="font-size: 20px; margin-bottom: 5px;"></div>
                <div id="redEnvelopeDetailsFrom"></div>
            </div>
            <div id="redEnvelopeDetailsStatus" style="padding: 10px 15px; font-size: 14px; color: #888; border-bottom: 1px solid #eee;"></div>
            <div id="redEnvelopeClaimList" style="max-height: 50vh; overflow-y: auto;">
                <!-- 领取记录将在这里动态生成 -->
            </div>
             <div class="modal-buttons" style="padding: 15px;">
                <button class="modal-btn modal-btn-confirm" onclick="closeRedEnvelopeDetailsModal()">关闭</button>
            </div>
        </div>
    </div>

<!-- ↑↑↑ 第1步：在这里结束复制 ↑↑↑ -->

<!-- ↓↓↓ 第一步：将这两段代码粘贴到 <body> 标签的末尾 ↓↓↓ -->

<!-- 这是新增的“发起投票”功能的弹窗 -->
<div id="pollModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">发起投票</div>
        <input type="text" class="modal-input" id="pollTitleInput" placeholder="投票标题">
        <div id="pollOptionsContainer">
            <!-- 投票选项会动态添加到这里 -->
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="text" class="form-input poll-option-input" placeholder="选项 1">
                <!-- 第一个选项不允许删除 -->
            </div>
            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="text" class="form-input poll-option-input" placeholder="选项 2">
                <!-- 第二个选项也不允许删除 -->
            </div>
        </div>
        <button class="modal-btn modal-btn-cancel" onclick="addPollOption()" style="margin-top: 10px; background: var(--bg-hover);">+ 添加选项</button>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closePollModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="sendPoll()">发起投票</button>
        </div>
    </div>
</div>

<!-- 这是聊天界面里的“投票”按钮 -->
<!-- 注意：这段代码我们稍后会用JavaScript动态添加到“+”菜单里，你先不用动 -->
<!-- <div class="function-item" onclick="openPollModal()">
    <div class="function-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-4h2v4zm4 0h-2v-2h2v2zm0-4h-2V7h2v5z"/>
        </svg>
    </div>
    <div class="function-label">投票</div>
</div> -->

<!-- ↑↑↑ 第一步：代码粘贴到此结束 ↑↑↑ -->


    <!-- [MODIFIED] Heart's Voice Modal -->
<div id="heartsVoiceModal" class="modal">
    <div class="modal-content">
        <!-- 面板内容将由 JavaScript 动态生成在这里 -->
    </div>
</div>
    <!-- ↓↓↓ 第2步：从这里开始复制所有新增的HTML代码 ↓↓↓ -->

<!-- 新增：人设列表页面 -->
<div id="personaListScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToProfile()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">我的人设</div>
        <button class="nav-btn" onclick="openPersonaEditModal(null)">+</button>
    </div>
    <div class="wechat-content">
        <div id="personaListContainer" class="friend-list">
            <!-- 人设列表将在这里动态生成 -->
        </div>
    </div>
</div>

<!-- 新增：添加/编辑人设的弹窗 -->
<div id="personaEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="personaEditTitle">添加新人设</div>
        <div class="avatar-upload" id="personaAvatarUpload">
            <input type="file" accept="image/*" onchange="handlePersonaAvatarUpload(event)">
            <span id="personaAvatarPreview">+</span>
        </div>
        <input type="text" class="modal-input" id="personaNameInput" placeholder="昵称 (必填)">
        <textarea class="modal-textarea" id="personaPersonalityInput" placeholder="个性、特点、喜好等..."></textarea>
        <textarea class="modal-textarea" id="personaBackgroundInput" placeholder="背景、经历、职业等..."></textarea>
        <input type="text" class="modal-input" id="personaPatActionInput" placeholder="“拍了拍”后缀，如：的头说“你好”">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePersonaEditModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePersona()">保存</button>
        </div>
        <div style="margin-top: 20px;">
             <button class="settings-btn btn-danger" id="deletePersonaBtn" style="display: none;" onclick="deletePersona()">删除这个人设</button>
        </div>
    </div>
</div>

<!-- 新增：为人设选择的弹窗 -->
<div id="personaSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">为当前聊天选择“我”的人设</div>
        <div id="personaSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 可选的人设列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
             <button class="modal-btn modal-btn-cancel" onclick="closePersonaSelectModal()">取消</button>
        </div>
    </div>
</div>

    <!-- 【【【全新的总结编辑弹窗】】】 -->
    <div id="summaryEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">对话总结</div>
            <textarea id="summaryEditTextarea" class="modal-textarea" style="min-height: 250px;"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeSummaryEditModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveSummaryFromModal()">存入总结</button>
            </div>
        </div>
    </div>

<!-- 【【【新增的“手动总结”弹窗】】】 -->
<div id="manualSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">手动生成总结</div>
        <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">请输入需要总结的最新对话轮数：</p>
        <input type="number" class="modal-input" id="manualSummaryTurnsInput" placeholder="例如：20">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeManualSummaryModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmManualSummary()">开始总结</button>
        </div>
    </div>
</div>
<!-- ↓↓↓ 请复制插入这段“精炼设置弹窗”代码 ↓↓↓ -->
<div id="refineSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">✨ 精炼所有总结</div>
        <p style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">
            将当前角色的所有历史记忆片段，合并重写为一条连贯的总结。<br>
            <span style="font-size:12px; opacity:0.8;">(生成新总结后，你可以手动删除旧的碎片记忆)</span>
        </p>
        <div style="margin-bottom: 15px;">
            <p style="margin-bottom: 5px; font-size: 13px; font-weight: bold;">期望字数（大约）：</p>
            <input type="number" class="modal-input" id="refineSummaryWordCount" placeholder="例如：500" value="500">
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeRefineSummaryModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmRefineSummary()">开始精炼</button>
        </div>
    </div>
</div>
<!-- ↑↑↑ 插入结束 ↑↑↑ -->


<!-- 【【【新增的“编辑总结”弹窗】】】 -->
<div id="memoryEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">编辑记忆</div>
        <textarea id="memoryEditTextarea" class="modal-textarea" style="min-height: 250px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeMemoryEditModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveEditedMemory()">保存</button>
        </div>
    </div>
</div>

<!-- 新增：HTML卡片编辑弹窗 -->
<div id="htmlCardEditModal" class="modal">
    <div class="modal-content" style="max-width: 90%; width: 600px;">
        <div class="modal-title">编辑HTML卡片代码</div>
        <textarea id="htmlCardEditTextarea" class="modal-textarea" style="min-height: 60vh; font-family: monospace; font-size: 13px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeHtmlCardEditor()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveHtmlCardEdit()">保存并更新</button>
        </div>
    </div>
</div>

<div id="avatarFrameUrlModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">输入头像框URL</div>
        <input type="text" class="modal-input" id="avatarFrameUrlInput" placeholder="请粘贴图片URL链接...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeAvatarFrameUrlModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAvatarFrameUrl()">确定</button>
        </div>
    </div>
</div>

<!-- 新增：编辑消息的弹窗 -->
<div id="messageEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">编辑消息</div>
        <textarea class="modal-textarea" id="messageEditInput" style="min-height: 120px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeMessageEditor()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmMessageEdit()">确定</button>
        </div>
    </div>
</div>
<!-- 新增：自动发朋友圈角色选择弹窗 -->
<div id="momentAutoPostRolesModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择允许自动发圈的角色</div>
        <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-align: center;">只有被选中的角色才会自动发布朋友圈</div>

        <div id="momentAutoPostRolesList" class="multi-select-list" style="max-height: 40vh;">
            <!-- 角色列表会动态生成在这里 -->
        </div>

        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeMomentAutoPostRolesModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveMomentAutoPostRolesSelection()">确定</button>
        </div>
    </div>
</div>

<!-- 新增：主动发消息的角色选择弹窗 -->
<div id="proactiveRolesModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择主动发消息的角色</div>
        <div id="proactiveRolesList" class="multi-select-list" style="max-height: 40vh;">
            <!-- 角色列表会动态生成在这里 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeProactiveRolesModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveProactiveRolesSelection()">确定</button>
        </div>
    </div>
</div>

<!-- ↓↓↓ 新增：通用的名称输入弹窗 ↓↓↓ -->
<div id="nameInputModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="nameInputTitle">请输入名称</div>
        <input type="text" class="modal-input" id="nameInputValue" placeholder="在此输入...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeNameInputModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" id="nameInputConfirmBtn">确定</button>
        </div>
    </div>
</div>
<!-- ↑↑↑ 新增代码结束 ↑↑↑ -->

<!-- ↓↓↓ 新增：样式选择弹窗 ↓↓↓ -->
<div id="presetSelectorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="presetSelectorTitle">选择样式</div>
        <div id="presetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 样式列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closePresetSelector()">关闭</button>
        </div>
    </div>
</div>
<!-- ↑↑↑ 新增代码结束 ↑↑↑ -->

<!-- ▼▼▼ 将这段新代码粘贴到 <body> 的末尾 ▼▼▼ -->

<!-- 新增：API预设选择弹窗 -->
<div id="apiPresetSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择API预设</div>
        <div id="apiPresetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 预设列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeApiPresetSelector()">关闭</button>
        </div>
    </div>
</div>

<!-- ▲▲▲ 新增代码到此结束 ▲▲▲ -->

<!-- ▼▼▼ 您需要剪切下面这段完整的代码 ▼▼▼ -->
<div id="exportDataModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">导出角色与记录</div>

        <!-- 全选/全不选的复选框 -->
        <div style="padding: 10px; border-bottom: 1px solid var(--border-light, #f0f0f0); margin-bottom: 10px; display: flex; align-items: center;">
            <input type="checkbox" id="exportSelectAllToggle" onchange="toggleSelectAllExport(this.checked)" style="margin-right: 10px;">
            <label for="exportSelectAllToggle">全选 / 全不选</label>
        </div>

        <!-- 角色列表容器 -->
        <div id="exportCharacterList" class="multi-select-list" style="max-height: 50vh;">
            <!-- 角色列表将由JS动态生成在这里 -->
        </div>

        <!-- 操作按钮 -->
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeExportModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="exportSelectedData()">导出选中项</button>
        </div>
    </div>
    </div>
<!-- ▲▲▲ 剪切到这里结束 ▲▲▲ -->


                <div id="toggle-panel-btn" class="control-btn"><i class="ri-arrow-up-s-line"></i></div>
            </div>
        </div>
        <div id="input-controls">
            <button id="open-bg-modal-btn" class="control-btn" title="更换背景"><i class="ri-image-add-line"></i></button>
            <button id="clear-btn" class="control-btn" title="清除所有内容"><i class="ri-delete-bin-line"></i></button>
            <button id="open-drawing-btn" class="control-btn" title="画画"><i class="ri-edit-2-line"></i></button>
            <!-- ▼▼▼ 新增的设置按钮就粘贴在这里 ▼▼▼ -->
    <button id="open-mars-settings-btn" class="control-btn" title="设置"><i class="ri-user-settings-fill"></i></button>
        </div>
    </div>

    <div id="bg-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">设置背景</div>
            <ul>
                <li id="upload-top-bg"><i class="ri-upload-cloud-2-line"></i><span>为对方的面板上传背景</span></li>
                <li id="upload-bottom-bg"><i class="ri-upload-cloud-line"></i><span>为我的面板上传背景</span></li>
            </ul>
        </div>
    </div>
    <!-- ▼▼▼ 这是新增的“设置”弹窗 ▼▼▼ -->
<div id="mars-settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">显示设置</div>
        <ul>
            <!-- 字体颜色设置 -->
            <li style="justify-content: space-between;">
                <span>字体颜色</span>
                <input type="color" id="mars-font-color-picker" style="border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
            </li>
            <!-- 字体大小设置 -->
            <li style="flex-direction: column; align-items: stretch; gap: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>字体大小</span>
                    <span id="mars-font-size-value">22px</span>
                </div>
                <input type="range" id="mars-font-size-slider" min="14" max="32" value="22" style="width: 100%;">
            </li>
        </ul>
    </div>
</div>
<!-- ▲▲▲ 新增代码结束 ▲▲▲ -->
    <div id="drawing-modal" class="modal-overlay">
        <div id="drawing-board">
            <canvas id="drawing-canvas"></canvas>
            <div class="drawing-controls">
                <button id="clear-canvas-btn">清空</button>
                <button id="send-drawing-btn">画好了，发给TA</button>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ 步骤一代码结束 ▲▲▲ -->

<div id="cloneApiSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">克隆音色设置</div>
        <div></div>
    </div>

    <div class="settings-content bw-style">

        <!-- 卡片 1：功能开关 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">开启克隆音色</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="voiceCloneToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 卡片 2：MiniMax 配置 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">MiniMax 平台配置</label>
            </div>

            <!-- 【新增】跳转官网按钮 -->
            <div class="form-group-row clickable" onclick="window.open('https://platform.minimaxi.com/', '_blank')">
                <label class="form-label" style="color: #000;">前往开放平台注册/获取</label>
                <div class="form-value-display"><i class="ri-external-link-line"></i></div>
            </div>

            <div class="form-group-row">
                <label class="form-label">Group ID</label>
                <input type="text" class="form-input" id="minimaxGroupId" placeholder="请输入 Group ID">
            </div>

            <div class="form-group-row">
                <label class="form-label">API Key</label>
                <div style="flex: 1; display: flex; align-items: center;">
                    <input type="password" class="form-input" id="minimaxApiKey" placeholder="请输入 API Key">
                    <i class="ri-close-circle-fill" style="color: #ccc; margin-left: 8px; cursor: pointer; font-size: 18px;" onclick="document.getElementById('minimaxApiKey').value = ''"></i>
                </div>
            </div>
        </div>

        <!-- 底部说明文字 -->
        <div style="padding: 0 20px; text-align: center; color: #999; font-size: 12px; line-height: 1.5; margin-top: -10px;">
            本功能基于 MiniMax T2A 接口。<br>配置后可让 AI 使用指定的音色发送语音。
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveCloneApiSettings()">保存设置</button>
        </div>
    </div>
</div>

    <!-- ↓↓↓ 第1步：将以下所有新增的HTML代码粘贴到 <body> 的末尾 ↓↓↓ -->

<!-- 新增：用于添加/编辑同人梗的弹窗 -->
<div class="modal" id="addTropeModal">
    <div class="modal-content">
        <div class="modal-title" id="trope-modal-title">创建新同人梗</div>
        <input type="text" class="modal-input" id="trope-name-input" placeholder="同人梗名称 (例如：信息素错乱)">
        <textarea class="modal-textarea" id="trope-content-input" placeholder="同人梗的具体内容/设定..." style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinCloseAddTropeModal()">取消</button>
            <button class="modal-btn confirm" onclick="doujinSaveTrope()">保存</button>
        </div>
    </div>
</div>

<!-- 新增：分享帖子到好友的弹窗 -->
<div id="sharePostModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">分享给好友</div>
        <div id="shareFriendList" class="multi-select-list" style="max-height: 300px;">
            <!-- 好友列表将由JS动态生成在这里 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeSharePostModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="sharePostConfirm()">分享</button>
        </div>
    </div>
</div>

<!-- ▼▼▼ 新增的公告弹窗 ▼▼▼ -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="announcementTitle"></div>
        <div id="announcementContent" style="font-size: 15px; line-height: 1.8; margin-bottom: 25px; white-space: pre-wrap;"></div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="closeAnnouncement()">我已知晓</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 公告弹窗结束 ▲▲▲ -->```

<!-- [新增] 同人App催更弹窗 -->

<!-- [修改] 同人App催更弹窗 (带剧情输入和付费提示) -->
<div class="modal" id="doujinUrgeUpdateModal">
    <div class="modal-content">
        <div class="modal-title">催更</div>

        <!-- 章节数滑块 -->
        <div class="doujin-modal-setting-group">
            <label for="chapter-count-slider">
                催更章节数: <span id="chapter-count-value" style="color: #7d9d8f; font-weight: bold;">1</span> 章
            </label>
            <!-- 注意：这里添加了 oninput 事件来实时更新价格 -->
            <input type="range" id="chapter-count-slider" min="1" max="10" value="1" class="doujin-slider" oninput="updateUrgePriceDisplay(this.value)">
        </div>

        <!-- [新增] 剧情走向输入框 -->
        <div class="doujin-modal-setting-group" style="border-bottom: none; padding-bottom: 0;">
            <label style="margin-bottom: 8px;">指定剧情走向 (可选)</label>
            <textarea class="modal-textarea" id="urgePlotInput" placeholder="例如：让他们解开误会、男二出场、发生意外..." style="min-height: 80px; font-size: 14px; background: #f9f9f9;"></textarea>
        </div>

        <!-- [新增] 价格提示 -->
        <div style="text-align: center; font-size: 12px; color: #999; margin-bottom: 15px;">
            需支付 <span id="urgeTotalPrice" style="color: #ff4d4d; font-weight: bold; font-size: 16px;">5.00</span> 元 (虚拟货币)
            <br>请确认好再支付
        </div>

        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="doujinCloseUrgeUpdateModal()">取消</button>
            <!-- 按钮文字改为“去支付” -->
            <button class="modal-btn confirm" onclick="doujinPayForUpdate()">去支付</button>
        </div>
    </div>
</div>

<!-- 段评半屏弹窗 -->
<div id="paragraphModalOverlay" class="paragraph-modal-overlay" onclick="closeParagraphModal()"></div>
<div id="paragraphModal" class="paragraph-modal">
    <div class="paragraph-modal-header">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span>段落评论</span>
        <!-- 新增刷新按钮 -->
        <i class="fas fa-sync-alt" id="refreshParaBtn" style="font-size: 14px; color: #999; cursor: pointer;" onclick="refreshCurrentParagraphComments()"></i>
    </div>
    <span onclick="closeParagraphModal()" style="cursor: pointer; padding: 5px;">✕</span>
</div>
    <div class="paragraph-modal-content" id="paragraphCommentsList">
        <!-- 评论内容将在这里生成 -->
    </div>
</div>

<!-- 表情包库主界面 -->
<div id="stickerLibraryScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToDiscover()"><i class="ri-arrow-left-s-line"></i></button>
        <!-- 点击标题触发绑定弹窗 -->
        <div class="nav-title" onclick="openStickerBindingModal()" style="cursor: pointer;">
            <span id="stickerLibraryTitle">绑定角色 (0)</span> <i class="ri-arrow-down-s-fill" style="font-size: 12px;"></i>
        </div>
        <!-- 【修改】这里换成了图标按钮 -->
        <button class="nav-btn nav-right-action-btn" id="stickerManageBtn" onclick="toggleStickerManageMode()">
            <i class="ri-list-settings-line" style="font-size: 22px;"></i>
        </button>
    </div>
    <div class="wechat-content" style="padding-bottom: 60px;"> <!-- 增加底部内边距，防止挡住内容 -->
        <!-- 表情网格容器 -->
        <div id="stickerLibraryGrid" class="sticker-library-grid"></div>
    </div>

    <!-- 【新增】底部批量删除栏 -->
    <div id="stickerBottomBar" class="multi-select-toolbar">
        <span class="multi-select-count" id="stickerSelectCount">已选 0 张</span>
        <div class="multi-select-actions">
            <button class="multi-select-btn delete" onclick="deleteSelectedStickers()">删除</button>
        </div>
    </div>
</div>

<!-- 绑定角色的多选弹窗 -->
<div id="stickerBindingModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择使用表情库的角色</div>
        <div id="stickerBindingList" class="multi-select-list" style="max-height: 300px;">
            <!-- 角色列表由JS生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeStickerBindingModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveStickerBindings()">确定</button>
        </div>
    </div>
</div>


<!-- 表情包添加弹窗 -->
<div id="stickerAddModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">添加表情包</div>

        <!-- 顶部切换 Tab -->
        <div class="emoji-modal-tabs">
            <button id="tab-sticker-local" class="emoji-modal-tab active" onclick="switchStickerTab('local')">本地上传</button>
            <button id="tab-sticker-url" class="emoji-modal-tab" onclick="switchStickerTab('url')">URL链接</button>
        </div>

        <!-- 内容区域：本地上传 -->
        <div id="view-sticker-local" class="sticker-view-container">
            <div class="avatar-upload" style="width: 100px; height: 100px; margin: 30px auto; border-radius: 8px;" onclick="triggerLocalStickerUpload()">
                <span>+</span>
            </div>
            <p style="text-align: center; color: #999; font-size: 13px;">点击上方加号，选择本地图片（支持多选）</p>
        </div>

        <!-- 内容区域：URL上传 -->
        <div id="view-sticker-url" class="sticker-view-container" style="display: none;">
            <textarea id="stickerUrlTextarea" class="modal-textarea" placeholder="在此粘贴图片链接...&#10;支持批量添加，请每行输入一个链接" style="min-height: 150px; white-space: pre;"></textarea>
        </div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeStickerAddModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmStickerAdd()">确定</button>
        </div>
    </div>
</div>

<!-- 小说书架页面 -->
<div id="readTogetherBookshelfScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToChat()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">共读饭堂</div>
        <button class="nav-btn nav-right-action-btn" onclick="document.getElementById('uploadNovelInput').click()">
            <i class="ri-upload-cloud-2-line"></i>
        </button>
    </div>
    <div class="wechat-content">
        <!-- 书架网格 -->
        <div id="readTogetherGrid" class="bookshelf-grid" style="padding: 15px;"></div>
    </div>
</div>

<!-- 小说阅读页面 (重构版) -->
<div id="readTogetherReaderScreen" class="page">

    <!-- 1. 阅读内容层 -->
    <div class="wechat-content">
        <!-- 【修改】给内容层添加点击事件，用于唤出菜单，同时删除下方的点击感应层 -->
        <div id="readerContent" onclick="toggleReaderMenu()">
            <!-- 小说正文 -->
        </div>
    </div>

<div class="reader-nav-btn prev" onclick="prevPage()"><i class="ri-arrow-left-s-line"></i></div>
    <div class="reader-nav-btn next" onclick="nextPage()"><i class="ri-arrow-right-s-line"></i></div>

    <!-- 【修改】已删除原本在这里的 3个 reader-click-zone div -->

    <!-- 3. 顶部菜单栏 -->

    <div class="reader-menu-bar reader-top-bar" id="readerTopBar">
        <i class="ri-arrow-left-s-line" style="font-size: 24px; cursor: pointer;" onclick="backToBookshelf()"></i>
        <span id="readerTitle" style="margin-left: 15px; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">小说阅读</span>
        <div style="flex: 1;"></div>
        <i class="ri-subtract-line" style="font-size: 24px; cursor: pointer;" onclick="minimizeReaderToFloat()"></i>
    </div>

    <!-- 4. 底部菜单栏 (一级) -->
    <div class="reader-menu-bar reader-bottom-bar" id="readerBottomBar">
        <!-- 进度控制 -->
        <div class="reader-progress-container">
            <span onclick="prevPage()" style="cursor: pointer;">上一章</span>
            <input type="range" class="reader-slider" id="readerProgressSlider" min="0" max="100" value="0" oninput="handleSliderSeek(this.value)">
            <span onclick="nextPage()" style="cursor: pointer;">下一章</span>
        </div>
        <div style="text-align: center; font-size: 10px; color: #999;">
            <span id="pageIndicator">第 1 页</span>
        </div>

        <!-- 功能按钮 -->
        <div class="reader-controls-row">
            <div class="reader-btn" onclick="openReaderCatalog()">
                <i class="ri-list-check"></i>
                <span>目录</span>
            </div>
            <div class="reader-btn" onclick="toggleReaderNightMode()">
                <i class="ri-moon-line" id="nightModeIcon"></i>
                <span id="nightModeText">夜间</span>
            </div>
            <div class="reader-btn" onclick="openReaderSettingsPanel()">
                <i class="ri-font-size"></i>
                <span>设置</span>
            </div>
        </div>
    </div>

    <!-- 5. 详细设置面板 (二级) -->
    <div id="readerSettingsPanel">
        <!-- 亮度 (模拟，调整背景透明度) -->
        <div class="setting-row">
            <span class="setting-label">亮度</span>
            <div class="setting-options">
                 <i class="ri-sun-line" style="font-size: 14px;"></i>
                 <input type="range" class="reader-slider" style="margin: 0 10px;" oninput="adjustReaderBrightness(this.value)">
                 <i class="ri-sun-fill" style="font-size: 18px;"></i>
            </div>
        </div>
        <!-- 字号 -->
        <div class="setting-row">
            <span class="setting-label">字号</span>
            <div class="setting-options">
                <button class="font-size-btn" onclick="changeReaderFontSize(-2)">A-</button>
                <span id="currentFontSizeDisplay" style="font-size: 14px;">18</span>
                <button class="font-size-btn" onclick="changeReaderFontSize(2)">A+</button>
            </div>
        </div>
        <!-- === 字体颜色设置行 (原生直连版) === -->
<div class="setting-row">
    <span class="setting-label">字色</span>
    <div class="setting-options">
        <!-- 黑色按钮 -->
        <div class="bg-color-btn" style="background: #333; border: 1px solid #555;" onclick="changeReaderFontColor('#333333', this)"></div>

        <!-- 白色按钮 -->
        <div class="bg-color-btn" style="background: #ffffff; border: 1px solid #ccc;" onclick="changeReaderFontColor('#ffffff', this)"></div>

        <!-- 调色盘 (直接是一个 Input，没有任何套路) -->
        <input type="color"
               class="bg-color-btn"
               style="padding: 0; border: 1px solid #ccc; background: none; cursor: pointer;"
               onchange="changeReaderFontColor(this.value, this)">
    </div>
</div>
        <!-- 背景 -->
        <!-- 背景设置行 (已修改) -->
<div class="setting-row">
    <span class="setting-label">背景</span>
    <div class="setting-options">
        <div class="bg-color-btn active" style="background: #ffffff;" onclick="changeReaderBg('#ffffff', this)"></div>
        <div class="bg-color-btn" style="background: #f6f4ec;" onclick="changeReaderBg('#f6f4ec', this)"></div> <!-- 羊皮纸 -->
        <div class="bg-color-btn" style="background: #cce8cf;" onclick="changeReaderBg('#cce8cf', this)"></div> <!-- 护眼绿 -->

        <!-- 修改：将最后一个按钮改成加号，并绑定上传事件 -->
        <div class="bg-color-btn" style="background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="document.getElementById('readerBgUpload').click()">
            <i class="ri-add-line" style="color: white; font-size: 16px;"></i>
        </div>
    </div>
</div>
        <!-- 翻页模式 -->
        <div class="setting-row">
            <span class="setting-label">翻页</span>
            <div class="setting-options">
                <button class="turn-mode-btn" id="btnModeScroll" onclick="setPageTurnMode('vertical')">上下滑动</button>
                <button class="turn-mode-btn active" id="btnModePage" onclick="setPageTurnMode('horizontal')">平移翻页</button>
            </div>
        </div>
        <!-- === [修改] 编码切换：改为下拉菜单以容纳更多选项 === -->
<div class="setting-row">
    <span class="setting-label">编码</span>
    <div class="setting-options">
        <!-- 使用下拉框，样式复用之前的 form-select -->
        <select id="readerEncodingSelect" class="form-select arrow-select"
                style="background-color: rgba(0,0,0,0.05); border-radius: 8px; padding: 5px 10px; width: 100%; color: inherit; border: 1px solid rgba(128,128,128,0.3);"
                onchange="changeReaderEncoding(this.value)">

            <optgroup label="常用中文">
                <option value="utf-8">UTF-8 (国际通用)</option>
                <option value="gb18030">GB18030 (简体增强)</option>
                <option value="gbk">GBK (简体通用)</option>
                <option value="big5">Big5 (繁体通用)</option>
            </optgroup>

            <optgroup label="日韩/其他">
                <option value="shift_jis">Shift_JIS (日文)</option>
                <option value="euc-jp">EUC-JP (日文)</option>
                <option value="euc-kr">EUC-KR (韩文)</option>
                <option value="windows-1252">Windows-1252 (西欧/ANSI)</option>
            </optgroup>

            <optgroup label="Unicode变体">
                <option value="utf-16le">UTF-16 LE</option>
                <option value="utf-16be">UTF-16 BE</option>
            </optgroup>
        </select>
    </div>
</div>
        <!-- === 新增：每页字数设置 === -->
<div class="setting-row">
    <span class="setting-label">每页字数</span>
    <div class="setting-options">
        <input type="number"
               id="pageSizeInput"
               style="width: 100%; background: transparent; border: 1px solid #555; color: #fff; border-radius: 4px; padding: 5px 10px; text-align: center;"
               placeholder="默认800"
               onchange="changeReaderPageSize(this.value)">
    </div>
</div>
    </div>
</div>

<!-- 新增：图片描述输入弹窗 -->
<div id="momentDescriptionInputModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">图片描述</div>
        <p style="font-size:13px; color:#999; margin-bottom:10px;">请输入你想“拍摄”的画面内容，系统将生成一张占位图。</p>
        <textarea class="modal-textarea" id="momentDescTempInput" placeholder="例如：此时此刻的晚霞，绚丽多彩..." style="min-height: 100px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('momentDescriptionInputModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmMomentDescription()">确定</button>
        </div>
    </div>
</div>

<!-- 分组管理页面 -->
<div id="momentGroupManageScreen" class="page">
    <div class="nav-bar" style="background: #fff;">
        <button class="nav-btn" onclick="backToMomentsFromGroup()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">好友分组</div>
        <div></div>
    </div>
    <div class="wechat-content" style="background: #fff;">
        <!-- 顶部控制栏 -->
        <div class="group-control-bar">
            <select id="momentGroupSelect" class="group-select" onchange="switchMomentGroup(this.value)">
                <option value="default">默认 (全部)</option>
            </select>
            <div class="add-group-btn-icon" onclick="openCreateGroupModal()">
                <i class="fas fa-plus"></i>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div id="groupActionArea" style="display: none;">
            <div class="group-section-title">添加成员</div>
            <div class="member-add-actions">
                <div class="action-btn-bw" onclick="openGroupAddFriendModal()">
                    <i class="fas fa-user-plus"></i> 好友
                </div>
                <div class="action-btn-bw" onclick="openAddNpcModal()">
                    <i class="fas fa-robot"></i> NPC
                </div>
            </div>

            <div class="group-section-title">当前成员列表</div>
            <div id="groupMemberList" style="padding-bottom: 50px;">
                <!-- 成员列表动态生成 -->
            </div>



        <div id="groupEmptyState" style="text-align: center; padding: 50px; color: #999;">
            请选择或新建一个分组<br>选择后将只显示该分组的动态
        </div>
    </div>
</div>
    </div>

<!-- 新建分组弹窗 -->
<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">新建分组</div>
        <input type="text" class="modal-input" id="newGroupNameInput" placeholder="输入分组名称 (如: 狗狗分组)">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('createGroupModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmCreateGroup()">创建</button>
        </div>
    </div>
</div>

<!-- 添加/编辑 NPC 弹窗 (带头像上传版) -->
<div id="addNpcModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="npcModalTitle">添加 NPC 成员</div>

        <!-- 头像上传区域 -->
        <div class="avatar-upload" id="npcAvatarUpload" style="margin: 0 auto 20px;">
            <input type="file" accept="image/*" onchange="handleNpcAvatarUpload(event)">
            <span id="npcAvatarPreview">+</span>
        </div>

        <input type="text" class="modal-input" id="npcNameInput" placeholder="NPC 名字">
        <textarea class="modal-textarea" id="npcRoleInput" placeholder="NPC 性格/人设 (AI评论会参考此设定)" style="min-height: 80px;"></textarea>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('addNpcModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmAddNpc()">保存</button>
        </div>
    </div>
</div>


<!-- 添加好友到分组的选择弹窗 -->
<div id="groupAddFriendModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择好友</div>
        <div id="groupFriendSelectList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('groupAddFriendModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmGroupAddFriends()">确定</button>
        </div>
    </div>
</div>

<!-- 朋友圈侧滑设置菜单 (右侧滑出版) -->
<div id="momentsSideMenu" class="forum-side-menu right-side">

    <!-- 1. 顶部标题栏 -->
    <div class="side-menu-header">
        <span class="side-menu-title">朋友圈设置</span>
        <div class="close-btn-wrapper" onclick="closeMomentsSideMenu()">
            <i class="ri-close-line"></i>
        </div>
    </div>

    <!-- 2. 内容区域 (复用 bw-style 黑白风格) -->
    <div class="settings-content bw-style" style="padding: 10px 15px !important; height: auto; background: transparent;">

        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">自动化</label>
            </div>

            <!-- 自动评论用户 -->
            <div class="form-group-row switch-row">
                <label class="form-label">自动评论我的动态</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoCommentUserToggle" onchange="toggleMomentSetting('autoCommentUser')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 自动发朋友圈 -->
            <div class="form-group-row switch-row">
                <label class="form-label">角色自动发朋友圈</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoPostAiToggle" onchange="toggleMomentSetting('autoPostAi')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- 【新增】选择允许发圈的角色 (默认隐藏，只有开关开启时显示) -->
            <div class="form-group-row clickable" id="momentAutoPostRoleSetting" style="display: none;" onclick="openMomentAutoPostRolesModal()">
                <label class="form-label" style="font-size: 14px; color: #666; padding-left: 20px;">选择允许发圈的角色</label>
                <div class="form-value-display">点击选择 <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <!-- ▼▼▼ 请将这段【新代码】粘贴在它下面 ▼▼▼ -->
<div class="form-group-row" id="momentFreqConfigRow" style="display: none; justify-content: space-between; align-items: center; padding-left: 20px;">
    <label class="form-label sub-label" style="font-size: 14px; color: #666;">发布频率</label>

    <div style="display: flex; align-items: center; gap: 5px;">
        <!-- 每多少天 -->
        <span style="font-size: 13px; color: #333;">每</span>
        <input type="number" id="momentFreqDaysInput" class="form-input"
               style="width: 40px; text-align: center; height: 30px; background: #fff; border: 1px solid #ddd; border-radius: 4px;"
               placeholder="1" min="1" value="1" onchange="saveMomentFreqConfig()">

        <span style="font-size: 13px; color: #333;">天</span>

        <!-- 发多少条 -->
        <input type="number" id="momentFreqCountInput" class="form-input"
               style="width: 40px; text-align: center; height: 30px; background: #fff; border: 1px solid #ddd; border-radius: 4px;"
               placeholder="1" min="1" value="1" onchange="saveMomentFreqConfig()">
        <span style="font-size: 13px; color: #333;">条</span>
    </div>
</div>

            <!-- 自动评论角色 -->
            <div class="form-group-row switch-row">
                <label class="form-label">角色间自动互动</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="momentAutoCommentAiToggle" onchange="toggleMomentSetting('autoCommentAi')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

<!-- 新增：手动催更卡片 -->
        <div class="form-card" style="margin-top: 15px;">
            <div class="form-group-row" style="border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">手动生成 (指定角色发朋友圈)</label>
            </div>

            <!-- 数量滑块 -->
            <div class="form-group-row column-layout">
                 <div style="display: flex; justify-content: space-between; width: 100%;">
                    <label class="form-label">每人生成篇数</label>
                    <span id="manualMomentCountDisplay" style="font-size: 12px; color: #666;">1 篇</span>
                 </div>
                 <input type="range" class="bw-slider" id="manualMomentCount" min="1" max="3" value="1"
                        oninput="document.getElementById('manualMomentCountDisplay').textContent = this.value + ' 篇'">
            </div>

            <!-- 角色选择列表 -->
            <div style="margin: 10px 0;">
                <label class="form-label" style="margin-bottom: 8px; display: block;">选择角色 (可多选)</label>
                <div id="manualMomentCharList" class="multi-select-list" style="max-height: 180px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fff;">
                    <!-- JS 将在这里生成列表 -->
                </div>
            </div>

            <!-- 确认按钮 -->
            <!-- 确认按钮 (去掉了图标) -->
            <button class="settings-btn btn-black" onclick="triggerManualMomentsGeneration()">
                开始生成
            </button>
        </div>

    </div>
</div>

<!-- 朋友圈菜单遮罩 (点击空白关闭) -->
<div id="momentsMenuOverlay" class="forum-menu-overlay" onclick="closeMomentsSideMenu()"></div>

<!-- 新增：字体预设选择弹窗 -->
<div id="fontPresetSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择字体预设</div>
        <div id="fontPresetListContainer" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 列表由 JS 生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeFontPresetSelector()">关闭</button>
        </div>
    </div>
</div>

<!-- [新增] 线下模式圆形悬浮窗 -->
<div id="offlineModeFloat" style="display: none;">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/></svg>
</div>

<!-- ▼▼▼ 新增代码 ▼▼▼ -->
<div id="characterProfileSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">编辑角色主页信息</div>
        <!-- 封面图上传 -->
        <div class="form-group">
            <label class="form-label">封面图</label>
            <div class="avatar-upload" id="charCoverUpload" style="width: 100%; height: 120px; border-radius: 8px;">
                <input type="file" accept="image/*" onchange="handleCharCoverUpload(event)">
                <span id="charCoverPreview">+</span>
            </div>
        </div>
        <!-- 头像上传 -->
        <div class="form-group">
            <label class="form-label">头像</label>
            <div class="avatar-upload" id="charAvatarUpload" style="width: 80px; height: 80px; margin: 0;">
                <input type="file" accept="image/*" onchange="handleCharAvatarUpload(event)">
                <span id="charAvatarPreview">+</span>
            </div>
        </div>
        <!-- 其他信息输入框 -->
        <input type="text" class="modal-input" id="charEditName" placeholder="昵称">
        <input type="text" class="modal-input" id="charEditHandle" placeholder="@id (Handle)">
        <textarea class="modal-textarea" id="charEditBio" placeholder="个人简介"></textarea>
        <input type="number" class="modal-input" id="charEditFollowing" placeholder="正在关注数量">
        <input type="number" class="modal-input" id="charEditFollowers" placeholder="关注者数量">
        <input type="text" class="modal-input" id="charEditJoined" placeholder="加入时间 (例如: 2025年1月)">
<!-- ▼▼▼ 新增：角色认证类型选择 ▼▼▼ -->
<div class="form-group" style="margin-top: 15px;">
    <select id="charEditVerified" class="modal-input">
        <option value="none">无认证</option>
        <option value="blue">🔵 个人/公众人物 (蓝标)</option>
        <option value="gold">🟡 官方/企业 (金标)</option>
        <option value="gray">⚪ 媒体/其他 (灰标)</option>
    </select>
    <!-- 新增：认证说明输入框 -->
<div class="form-group" style="margin-top: 10px;">
    <label style="display:block; margin-bottom:5px; font-size:12px; color:#666;">认证说明 (选填)</label>
    <input type="text" id="charEditVerifiedInfo" class="modal-input" placeholder="例如：反抗军领袖">
</div>

</div>



        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeCharacterProfileSettings()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveCharacterProfileSettings()">保存</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 新增结束 ▲▲▲ -->

<!-- ↓↓↓ 第2步 A：用这个新代码块替换旧的 offlineModeSettingsScreen ↓↓↓ -->

<!-- [修改] 线下模式设置页面 -> 弹窗 -->
<div id="offlineModeSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">线下模式设置</div>

        <!-- 1. 输出字符数滑块 -->
        <div class="form-group">
            <label class="form-label" for="offlineCharCountSlider">输出字符数: <span id="offlineCharCountValue">1000</span>字</label>
            <input type="range" class="font-size-slider" id="offlineCharCountSlider" min="1" max="5000" value="5000" oninput="document.getElementById('offlineCharCountValue').textContent = this.value">
        </div>

        <!-- 【【【新增代码块：文风选择】】】 -->
<div class="form-group">
    <label class="form-label">文风选择</label>
    <div id="currentWritingStyle" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openWritingStyleList()">
        未选择文风
    </div>
</div>

        <!-- 2. 开场白设置 -->
        <div class="form-group">
            <label class="form-label">开场白设置</label>
            <div id="currentOpeningStatement" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openOpeningStatementList()">
                未选择开场白
            </div>
        </div>

        <!-- ▼▼▼ 从这里开始，粘贴下面的新代码 ▼▼▼ -->
        <div class="form-group">
            <label class="form-label">小剧场设置</label>
            <div id="currentSkit" class="form-input" style="line-height: 2.5; cursor: pointer;" onclick="openSkitList()">
                不使用小剧场
            </div>
        </div>
        <!-- ▲▲▲ 粘贴到这里结束 ▲▲▲ -->

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeOfflineSettingsModal()">关闭</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveOfflineSettings()">保存</button>
        </div>
    </div>
</div>

<!-- ↑↑↑ 替换到此结束 ↑↑↑ -->

<!-- [新增] 开场白选择弹窗 -->
<div id="openingStatementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>选择开场白</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditOpeningStatementModal(null)">+</button>
        </div>
        <div id="openingStatementList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 开场白列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeOpeningStatementList()">关闭</button>
        </div>
    </div>
</div>

<!-- [新增] 新建/编辑开场白弹窗 -->
<div id="editOpeningStatementModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="editOpeningStatementTitle">新建开场白</div>
        <input type="text" class="modal-input" id="openingStatementTitleInput" placeholder="开场白标题 (必填)">
        <textarea class="modal-textarea" id="openingStatementContentInput" placeholder="开场白内容..." style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeEditOpeningStatementModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveOpeningStatement()">保存</button>
        </div>
    </div>
</div>

<!-- ↑↑↑ HTML代码到此结束 ↑↑↑ -->

<!-- 【【【新增代码块：文风选择弹窗】】】 -->
<div id="writingStyleModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>选择文风</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditWritingStyleModal(null)">+</button>
        </div>
        <div id="writingStyleList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 文风列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeWritingStyleList()">关闭</button>
        </div>
    </div>
</div>

<!-- 【【【新增代码块：新建/编辑文风弹窗】】】 -->
<div id="editWritingStyleModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="editWritingStyleTitle">新建文风</div>
        <input type="text" class="modal-input" id="writingStyleTitleInput" placeholder="文风标题 (必填)">
        <textarea class="modal-textarea" id="writingStyleContentInput" placeholder="文风的具体指令... 例如：请使用细腻、华丽的辞藻，多用比喻和排比。" style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeEditWritingStyleModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveWritingStyle()">保存</button>
        </div>
    </div>
</div>


<!-- 【【【新增代码块：小剧场选择弹窗】】】 -->
<div id="skitModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>选择小剧场</span>
            <!-- 这里暂时不做“新增”功能，所以注释掉按钮
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openEditSkitModal(null)">+</button>
            -->
        </div>
        <div id="skitList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 小剧场列表将在这里动态生成 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-confirm" onclick="closeSkitList()">关闭</button>
        </div>
    </div>
</div>

<!-- ▼▼▼ 用这个新结构替换旧的 forumTrendDetailView ▼▼▼ -->
<div id="forumTrendDetailView" class="page">
    <div class="nav-bar">
        <button class="nav-btn" id="trendDetailBackBtn"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title" id="trendDetailTitle">热搜详情</div>
        <div style="width: 40px;"></div> <!-- 占位，确保标题居中 -->
    </div>
    <div class="wechat-content" id="trendDetailContent" style="padding-top: 74px; overflow-y: auto;">
        <!-- 帖子列表将在这里显示 -->
    </div>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->

<!-- 在 <body> 内, </div id="forumScreen"> 之前 -->

<!-- 新增：帖子详情页 -->
<div id="forumDetailView" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToForumTimeline()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">帖子</div>

    </div>
    <div class="wechat-content" id="forumDetailContent" style="padding-top: 74px; overflow-y: auto;">
        <!-- 帖子详情和评论将在这里动态生成 -->
    </div>
</div>

<div id="forumCharacterProfileView" class="page">
    <!-- 顶部导航栏 -->
    <div class="nav-bar">
        <!-- 返回按钮：去掉了 onclick，由 JS 动态绑定 -->
        <button class="nav-btn" id="charProfileBackBtn">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 标题 -->
        <div class="nav-title" id="charProfileNavTitle">角色主页</div>

        <!-- 右侧按钮组 -->
        <div class="nav-right-actions">
            <!-- 刷新按钮 -->
            <button class="nav-btn" id="refreshCharProfileBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/><path d="M22 4v4h-4"/></svg>
            </button>
            <!-- 设置按钮 -->
            <button class="nav-btn" onclick="openCharacterProfileSettings()">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </div>

    <!-- 页面主要内容容器 -->
    <div class="wechat-content" style="padding-top: 74px; overflow-y: auto;">
         <div class="forum-profile-container">
            <!-- 封面图 -->
            <div class="forum-profile-header" id="charProfileCoverHeader"></div>
            <!-- 头像和编辑按钮区域 -->
            <div class="forum-profile-top-actions">
                <div class="forum-profile-avatar-container">
                    <div class="forum-profile-avatar" id="charProfileAvatar"></div>
                </div>
            </div>
            <!-- 角色信息区 -->
            <div class="forum-profile-info">
                <h3 id="charProfileName"></h3>
                <p id="charProfileHandle"></p>
                <p id="charProfileBio" style="margin-bottom: 10px;"></p>
                <p id="charProfileJoined"></p>
                <div class="forum-profile-stats">
                    <span class="forum-profile-stat-item"><strong id="charProfileFollowing">0</strong><span>正在关注</span></span>
                    <span class="forum-profile-stat-item"><strong id="charProfileFollowers">0</strong><span>关注者</span></span>
                </div>
            </div>
            <!-- Tab 切换 -->
            <div class="forum-profile-tabs" id="charProfileTabs">
                <div class="forum-profile-tab active" data-tab="posts">帖子</div>
                <div class="forum-profile-tab" data-tab="replies">回复</div>
                <div class="forum-profile-tab" data-tab="likes">喜欢</div>
            </div>
            <!-- 帖子列表 -->
            <div id="charProfileTimeline" class="post-list-container">
                <!-- 帖子/回复/喜欢的内容将在这里动态生成 -->
            </div>
        </div>
    </div>
</div>

<!-- ▲▲▲ 新增结束 ▲▲▲ -->
<!-- ▼▼▼ 把这段代码粘贴到 <div id="forumScreen" class="page"> 的上面 ▼▼▼ -->

<div id="forumFollowingListView" class="page">
    <div class="nav-bar">
        <!-- 返回按钮 -->
        <button class="nav-btn" onclick="backToMyProfile()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">正在关注</div>
        <div style="width: 40px;"></div>
    </div>
    <!-- 列表内容容器 -->
    <div id="followingListContent"></div>
</div>

<!-- ▲▲▲ 粘贴结束 ▲▲▲ -->

<!-- 新增：模仿 Twitter/X 的论坛页面 -->
<!-- [整合版] 论坛 App 主界面 (Forum App) -->
<div id="forumScreen" class="page">
           <!-- 1. 顶部导航栏 (只在“帖子”页显示，其他页会自动隐藏) -->
    <div class="nav-bar forum-nav-bar" id="forumTopNavBar">
        <!-- 左侧菜单按钮 -->
        <div id="forumMenuBtn" class="nav-btn" onclick="openForumSideMenu()" style="display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </div>

        <!-- 中间标题 (改为头像容器) -->
        <!-- 【核心修改】：添加了 onclick 事件，并且加了 cursor: pointer 让鼠标变成手型 -->
        <div class="nav-title" onclick="refreshForumTimeline()" style="display: flex; justify-content: center; align-items: center; cursor: pointer;">
             <!-- 我们给里面的头像加了一个过渡效果，让它旋转时更丝滑 -->
             <div id="forumCenterAvatar" style="width: 34px; height: 34px; border-radius: 50%; background-size: cover; background-position: center; background-color: #f0f0f0; transition: transform 0.5s ease;"></div>
        </div>

        <!-- 右侧按钮组 -->
        <div class="nav-right-actions">
            <!-- 【已删除】：这里原来的刷新按钮已被删除 -->

            <!-- 退出按钮 -->
            <button class="nav-btn" onclick="goHome()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <!-- 2. 视图 A: 主页 (包含 关注/推荐/同城) -->
    <div class="forum-content-view active" id="forumHomeView">
        <!-- 子版块切换 -->
        <div class="trends-tabs" style="position: sticky; top: 0; z-index: 10;">
            <div class="trends-tab" onclick="switchForumSubTab('following', this)">关注</div>
            <div class="trends-tab active" onclick="switchForumSubTab('recommended', this)">推荐</div>
            <div class="trends-tab" onclick="switchForumSubTab('city', this)">同城</div>
        </div>
        <!-- 内容容器 -->
        <div id="followingTimeline" class="forum-timeline-container"></div>
        <div id="recommendedTimeline" class="forum-timeline-container active"></div>
        <div id="cityTimeline" class="forum-timeline-container"></div>
    </div>

    <!-- 3. 视图 B: 搜索/热搜 -->
    <div class="forum-content-view" id="forumSearchView">
        <div class="trends-header">
            <div class="trends-header-avatar" id="trendsAvatar"></div>
            <div class="trends-search-bar">
                <svg viewBox="0 0 24 24"><g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.417-.727 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.83-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.432 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g></svg>
                <input type="text" placeholder="搜索热搜" id="trendSearchInput" oninput="filterTrends(this.value)">
            </div>
            <!-- 修改后的代码 -->
        <button class="trends-header-refresh" id="refreshTrendsBtn" onclick="refreshTrends()">
                <svg viewBox="0 0 24 24"><g><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></g></svg>
            </button>
        </div>
        <div class="trends-tabs">
            <div class="trends-tab active" onclick="filterTrendsByCategory('all', this)">全部</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('社会', this)">社会</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('娱乐', this)">娱乐</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('生活', this)">生活</div>
            <div class="trends-tab" onclick="filterTrendsByCategory('科技', this)">科技</div>
        </div>
        <div class="trends-list-container" id="trendsListContainer"></div>
    </div>

    <!-- 4. 视图 C: 论坛私信列表 (带批量删除功能版) -->
<div class="forum-content-view" id="forumMessagesView">
    <!-- 顶部标题栏 -->
    <div class="trends-header" style="position: sticky; top: 0; z-index: 10;">
        <div style="font-size: 18px; font-weight: 800; padding-left: 10px;">消息箱</div>
        <div style="flex:1;"></div>

        <!-- 新增：管理按钮 (图标) -->
        <button class="trends-header-refresh" id="forumDMManageBtn" onclick="toggleForumDMManageMode()" style="margin-right: 5px;">
            <i class="ri-list-check-2" style="font-size: 20px;"></i>
        </button>

        <!-- 生成新私信的按钮 -->
        <button class="trends-header-refresh" onclick="openForumDMGenerator()">
            <i class="ri-mail-add-line" style="font-size: 20px;"></i>
        </button>
    </div>

    <!-- 列表容器 -->
    <div id="forumDMListContainer" style="padding-bottom: 80px;"></div>

    <!-- 新增：底部批量操作栏 (带全选版) -->
<div id="forumDMBatchBar" class="multi-select-toolbar">
    <span class="multi-select-count" id="forumDMSelectCount">已选 0 条</span>
    <div class="multi-select-actions">
        <!-- 新增: 全选/取消全选 按钮 -->
        <button id="forumDMSelectAllBtn" class="multi-select-btn" onclick="selectAllDMs()">全选</button>

        <button class="multi-select-btn delete" onclick="deleteSelectedDMs()">删除</button>
        <button class="multi-select-btn cancel" onclick="toggleForumDMManageMode()">取消</button>
    </div>
</div>

</div>




    <!-- 5. 视图 D: 我 (个人主页) -->
    <div class="forum-content-view" id="forumMeView">
        <div class="forum-profile-container">
            <div class="forum-profile-header" id="forumCoverHeader">
                <div class="forum-profile-cover-upload" onclick="handleForumCoverUpload()"></div>
            </div>
            <div class="forum-profile-top-actions">
                <div class="forum-profile-avatar-container">
                    <div class="forum-profile-avatar" id="forumProfileAvatar" onclick="handleForumAvatarUpload()"></div>
                </div>
                <button class="forum-edit-profile-btn" onclick="openForumEditProfileModal()">编辑资料</button>
            </div>
            <div class="forum-profile-info">
                <h3 id="forumProfileName"></h3>
                <p id="forumProfileHandle"></p>
                <p id="forumProfileBio" style="margin-bottom: 10px;"></p>
                <p id="forumProfileJoined"></p>
                <div class="forum-profile-stats">
                    <span class="forum-profile-stat-item" onclick="openFollowingList()">
                        <strong id="forumProfileFollowing">0</strong><span>正在关注</span>
                    </span>
                    <span class="forum-profile-stat-item">
                        <strong id="forumProfileFollowers">0</strong><span>关注者</span>
                    </span>
                </div>
            </div>
            <div class="forum-profile-tabs">
                <div class="forum-profile-tab active" data-tab="posts">帖子</div>
                <div class="forum-profile-tab" data-tab="replies">回复</div>
                <div class="forum-profile-tab" data-tab="likes">喜欢</div>
            </div>
            <div id="forumProfileTimeline" class="post-list-container"></div>
        </div>
    </div>

    <!-- 6. 悬浮发布按钮 -->
    <button id="newPostFab" onclick="openNewPostModal()">+</button>

        <!-- 论坛编辑资料弹窗 (圆润手账风 v6.0) -->
    <div class="modal" id="forumEditProfileModal">
        <div class="stationery-modal-content">

            <!-- 装饰：彩色胶带 -->
            <div class="deco-tape tape-yellow"></div>
            <div class="deco-tape tape-blue"></div>

            <!-- 装饰：回形针 -->
            <div class="deco-clip">
                <svg viewBox="0 0 24 24" width="45" height="45" stroke="#FF6B6B" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
            </div>

            <!-- 装饰：图钉 -->
            <div class="deco-pin">
                <svg viewBox="0 0 24 24" width="30" height="30" fill="#4ECDC4" stroke="#333" stroke-width="1.5">
                    <path d="M16 4v1l-2 3v7l2 2v1h-5v5l-1 1-1-1v-5h-5v-1l2-2v-7l-2-3v-1h10z"></path>
                </svg>
            </div>

            <!-- 头部 -->
            <div class="stationery-header">
                <h3>编辑资料</h3>
                <span class="close-round-btn" onclick="closeForumEditProfileModal()">×</span>
            </div>

            <!-- 内容区 -->
            <div class="stationery-body">
                <div class="round-input-group">
                    <label>昵称</label>
                    <input type="text" id="forumEditName" placeholder="Nickname">
                </div>

                <div class="round-input-group">
                    <label>ID</label>
                    <input type="text" id="forumEditHandle" placeholder="Handle">
                </div>

                <div class="round-input-group">
                    <label>简介</label>
                    <textarea id="forumEditBio" rows="3" placeholder="写点什么..."></textarea>
                </div>
                <!-- ▼▼▼ 新增：用户认证类型选择 ▼▼▼ -->
<div class="round-input-group">
    <label>认证类型</label>
    <select id="forumEditVerified" style="width: 100%; padding: 10px; border-radius: 12px; border: none; background: #f7f7f7; outline: none; color: #333;">
        <option value="none">无认证</option>
        <option value="blue">🔵 个人/公众人物 (蓝标)</option>
        <option value="gold">🟡 官方/企业 (金标)</option>
        <option value="gray">⚪ 媒体/其他 (灰标)</option>
    </select>
    <!-- 新增：认证说明输入框 -->
<div class="round-input-group" style="margin-top: 10px;">
    <label>认证说明 (选填)</label>
    <input type="text" id="forumEditVerifiedInfo" placeholder="例如：知名科技博主 / 官方账号"
           style="width: 100%; padding: 10px; border-radius: 12px; border: none; background: #f7f7f7; outline: none;">
</div>

</div>



                <!-- 标签区域 -->
                <div class="round-input-group">
                    <label>个性标签 (全员可见)</label>
                    <div class="round-tag-row">
                        <input type="text" id="newTagInput" placeholder="输入标签...">
                        <div class="color-picker-round">
                            <input type="color" id="newTagColor" value="#ffeb3b">
                        </div>
                        <button onclick="addForumTag()" class="round-add-btn">＋</button>
                    </div>

                    <div id="editTagsContainer" class="round-tags-area">
                        <!-- 标签生成位置 -->
                    </div>
                </div>
            </div>

            <!-- 底部 -->
            <div class="stationery-footer">
                <button class="round-btn cancel" onclick="closeForumEditProfileModal()">取消</button>
                <button class="round-btn save" onclick="saveForumProfile()">保存</button>
            </div>
        </div>
    </div>





        <!-- 7. 底部导航栏 (已修改为4个) -->
    <div class="forum-bottom-nav">
        <!-- 首页 -->
        <div class="forum-tab active" onclick="switchForumTab('home', this)">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor"><path d="M12.92 22.49h7.32c.45 0 .81-.36.81-.81V10.37a.81.81 0 0 0-.4-.7l-8.13-7.1a.81.81 0 0 0-1.02 0l-8.13 7.1a.81.81 0 0 0-.4.7v11.31c0 .45.36.81.81.81h7.32v-7.32h2.44v7.32z"></path></svg>
        </div>
        <!-- 搜索 -->
        <div class="forum-tab" onclick="switchForumTab('search', this)">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <!-- 私信 (新增) -->
        <div class="forum-tab" onclick="switchForumTab('messages', this)">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
        </div>
        <!-- 我 -->
        <div class="forum-tab" onclick="switchForumTab('me', this)">
            <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M4.93 19.07l14.14-14.14"></path></svg>
        </div>
    </div>

</div>

<div id="soundSettingsScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToSettingsMenu()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">提示音设置</div>
        <div></div>
    </div>

    <!-- 使用 bw-style 继承统一风格 -->
    <div class="settings-content bw-style">

        <!-- 1. 接收消息提示音 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">接收消息 (AI发消息时)</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">开启提示音</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="receivedSoundToggle" onchange="toggleSoundSetting('received')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group-row" id="receivedSoundUploadRow" style="display:none;">
                <label class="form-label">音频文件</label>
                <div style="display: flex; gap: 10px;">
                    <!-- 试听按钮 -->
                    <button class="bw-chip-btn" onclick="previewSound('received')">
                        <i class="ri-play-fill"></i> 试听
                    </button>
                    <!-- 上传按钮 -->
                    <button class="bw-chip-btn" onclick="document.getElementById('receivedSoundInput').click()">
                        <i class="ri-upload-2-line"></i> 上传
                    </button>
                </div>
            </div>
            <div class="form-hint" id="receivedSoundName" style="text-align: right; padding-bottom: 10px; display:none;">未设置音频</div>
        </div>

        <!-- 2. 发送消息提示音 -->
        <div class="form-card">
            <div class="form-group-row" style="border-bottom: none; padding-bottom: 10px;">
                <label class="form-label" style="color: #999; font-size: 12px;">发送消息 (我发消息时)</label>
            </div>

            <div class="form-group-row switch-row">
                <label class="form-label">开启提示音</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="sentSoundToggle" onchange="toggleSoundSetting('sent')">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-group-row" id="sentSoundUploadRow" style="display:none;">
                <label class="form-label">音频文件</label>
                <div style="display: flex; gap: 10px;">
                    <button class="bw-chip-btn" onclick="previewSound('sent')">
                        <i class="ri-play-fill"></i> 试听
                    </button>
                    <button class="bw-chip-btn" onclick="document.getElementById('sentSoundInput').click()">
                        <i class="ri-upload-2-line"></i> 上传
                    </button>
                </div>
            </div>
            <div class="form-hint" id="sentSoundName" style="text-align: right; padding-bottom: 10px; display:none;">未设置音频</div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-black" onclick="saveSoundSettings()">保存设置</button>
        </div>
    </div>
</div>

<!-- 游戏中心主页 (黑白极简版) -->
<div id="gamesApp" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">游戏中心</div>
        <div></div>
    </div>

    <!-- 使用 bw-style 继承统一的黑白风格 -->
    <div class="settings-content bw-style">

        <!-- 游戏卡片：你演我猜 -->
        <div class="game-card" onclick="openCharadesGameSelect()">
            <div class="game-card-icon">
                <i class="ri-tv-2-line"></i>
            </div>
            <div class="game-card-title">你演我猜</div>
            <div class="game-card-desc">考验默契的时刻，一人描述一人猜</div>
        </div>

        <!-- 可以在这里添加更多游戏卡片 (占位) -->
        <!--
        <div class="game-card" onclick="showAlert('敬请期待')">
            <div class="game-card-icon"><i class="ri-gamepad-line"></i></div>
            <div class="game-card-title">新游戏开发中</div>
            <div class="game-card-desc">更多精彩即将上线</div>
        </div>
        -->

    </div>
</div>

</div>

<!-- “你演我猜” 游戏界面 -->
<div id="charadesGameScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="exitCharadesGame()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">你演我猜</div>
        <div style="display: flex; align-items: center; gap: 5px; z-index: 20;">
        <button class="nav-btn" onclick="toggleCharadesRole()" title="切换角色">
            <i class="ri-exchange-line" style="font-size: 20px;"></i>
        </button>
        <button class="nav-btn" onclick="startNewCharadesRound()" title="重开">
            <i class="ri-refresh-line" style="font-size: 20px;"></i>
        </button>
    </div>
    </div>

    <!-- 游戏主区域 -->
    <div class="wechat-content" style="display: flex; flex-direction: column; background: #fdfbf5;">

        <!-- 1. 顶部游戏面板 (模仿图片样式) -->
        <div class="charades-top-panel">

            <!-- 左侧：答题方 (AI) -->
            <div class="player-badge ai-side">
                <div class="badge-label">答题方</div>
                <div class="game-avatar" id="charadesAiAvatar"></div>
            </div>

            <!-- 中间：电视机题目显示 -->
            <div class="tv-container">
                <div class="tv-antenna-left"></div>
                <div class="tv-antenna-right"></div>
                <div class="tv-frame">
                    <div class="tv-screen">
                        <div id="charadesTargetWord">题目加载中...</div>
                    </div>
                    <div class="tv-controls">
                        <div class="tv-knob"></div>
                        <div class="tv-knob"></div>
                        <div class="tv-speaker">|||</div>
                    </div>
                </div>
                <div class="tv-legs">
                    <div class="tv-leg-left"></div>
                    <div class="tv-leg-right"></div>
                </div>
            </div>

            <!-- 右侧：表演方 (我) -->
            <div class="player-badge user-side">
                <div class="badge-label">表演方</div>
                <div class="game-avatar" id="charadesUserAvatar"></div>
            </div>
        </div>

        <!-- 提示栏 -->
        <div class="charades-status-bar">
            <span id="charadesStatusText">请描述，让对方猜出屏幕上的词</span>
        </div>

        <!-- ... 上面的 .charades-status-bar 保持不变 ... -->

<!-- 2. 中间聊天猜词区 (保持原ID，后面用CSS去背景) -->
<div id="charadesChatArea" class="chat-messages">
    <!-- 游戏记录将在这里显示 -->
</div>

<!-- 3. 底部输入框 (修改版) -->
<div class="chat-input" id="charadesInputBar">
     <!-- 接收/让AI猜按钮 -->
     <!-- 找到 id="charadesGuessBtn" -->
<button class="chat-btn" id="charadesGuessBtn" onclick="handleCharadesLightbulbClick()" title="提示/让TA猜">
    <i class="ri-lightbulb-flash-line"></i>
</button>

     <!-- 输入框 -->
     <textarea id="charadesInput" rows="1" placeholder="描述这个词..."></textarea>

     <!-- 发送按钮 (换成图标) -->
     <!-- 发送按钮 (透明背景，纯图标) -->
<button class="chat-btn" onclick="sendCharadesMessage()" style="color: #333; padding: 0 10px;">
   <i class="ri-send-plane-2-fill" style="font-size: 24px;"></i>
</button>
</div>
    </div>
</div>

<!-- 游戏好友选择弹窗 -->
<div id="gameFriendSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择一位好友一起玩</div>
        <div id="gameFriendList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('gameFriendSelectModal').classList.remove('show')">取消</button>
        </div>
    </div>
</div>

<!-- 补全缺失的音色ID输入弹窗 -->
<div id="voiceIdModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">设置音色ID</div>
        <input type="text" class="modal-input" id="voiceIdInput" placeholder="请输入MiniMax音色ID">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeVoiceIdModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveVoiceId()">保存</button>
        </div>
    </div>
</div>

<!-- 支付密码半屏弹窗 -->
<div id="paymentInputModal" class="payment-modal-overlay">
    <div class="payment-modal-content">
        <div class="pay-header">
            <div class="pay-close" onclick="closePaymentModal()"><i class="ri-close-line"></i></div>
            <div class="pay-title">请输入支付密码</div>
        </div>
        <div class="pay-info">
            <div class="pay-to-user" id="payTargetName">向某人转账</div>
            <div class="pay-amount" id="payDisplayAmount">¥ 0.00</div>
        </div>
        <div class="pay-method-row" onclick="openPaymentMethodSelect()">
            <div class="pay-method-label">付款方式</div>
            <div class="pay-method-value" id="currentPayMethodName">
                <i class="ri-wallet-3-fill" style="color:#f2c353; margin-right:5px;"></i>零钱
            </div>
            <i class="ri-arrow-right-s-line" style="color:#ccc;"></i>
        </div>

        <!-- 6位密码框 -->
        <div class="pay-pwd-box">
            <div class="pwd-dot" id="pwd-1"></div>
            <div class="pwd-dot" id="pwd-2"></div>
            <div class="pwd-dot" id="pwd-3"></div>
            <div class="pwd-dot" id="pwd-4"></div>
            <div class="pwd-dot" id="pwd-5"></div>
            <div class="pwd-dot" id="pwd-6"></div>
        </div>

        <!-- 数字键盘 -->
        <div class="pay-keypad">
            <div class="key" onclick="pressPayKey(1)">1</div>
            <div class="key" onclick="pressPayKey(2)">2</div>
            <div class="key" onclick="pressPayKey(3)">3</div>
            <div class="key" onclick="pressPayKey(4)">4</div>
            <div class="key" onclick="pressPayKey(5)">5</div>
            <div class="key" onclick="pressPayKey(6)">6</div>
            <div class="key" onclick="pressPayKey(7)">7</div>
            <div class="key" onclick="pressPayKey(8)">8</div>
            <div class="key" onclick="pressPayKey(9)">9</div>
            <div class="key bg-grey"></div>
            <div class="key" onclick="pressPayKey(0)">0</div>
            <div class="key bg-grey" onclick="pressPayKey('del')"><i class="ri-delete-back-line"></i></div>
        </div>
    </div>
</div>

<!-- 选择付款方式弹窗 -->
<div id="paymentMethodModal" class="modal">
    <div class="modal-content" style="position: absolute; bottom: 0; width: 100%; border-radius: 16px 16px 0 0; padding: 0; max-height: 60vh; overflow-y: auto;">
        <div class="modal-title" style="padding: 15px; border-bottom: 1px solid #eee; margin:0;">选择付款方式</div>
        <div id="paymentMethodList" class="friend-list">
            <!-- JS 动态生成 -->
        </div>
        <div class="modal-buttons" style="padding: 15px;">
             <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('paymentMethodModal').classList.remove('show')">取消</button>
        </div>
    </div>
</div>

<!-- 新增：亲属卡消费反馈弹窗 -->
<div id="fcReactionModal" class="modal">
    <div class="fc-reaction-card">
        <!-- 装饰背景 -->
        <div class="fc-reaction-bg"></div>

        <!-- 头像 -->
        <div class="fc-reaction-avatar" id="fcReactionAvatar"></div>

        <!-- 标题 -->
        <div class="fc-reaction-title">
            <span id="fcReactionName">对方</span> 留意到了你的消费
        </div>

        <!-- 消费金额提示 -->
        <div class="fc-reaction-meta" id="fcReactionMeta">
            消费 ¥0.00
        </div>

        <!-- 留言内容 (核心) -->
        <div class="fc-reaction-content">
            <i class="ri-double-quotes-l quote-icon-left"></i>
            <span id="fcReactionText">...</span>
            <i class="ri-double-quotes-r quote-icon-right"></i>
        </div>

        <!-- 按钮 -->
        <button class="fc-reaction-btn" onclick="document.getElementById('fcReactionModal').classList.remove('show')">
            我知道了
        </button>
    </div>
</div>

<!-- 美化后的发布分类选择弹窗 -->
<div id="doujinCategorySelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择发布板块</div>

        <!-- 使用 flex 布局的标签容器 -->
        <div id="doujinCategoryList" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 50vh; overflow-y: auto; padding: 5px;">
            <!-- JS 动态生成漂亮的标签 -->
        </div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="document.getElementById('doujinCategorySelectModal').classList.remove('show')">取消</button>
        </div>
    </div>
</div>

<!-- 送礼物弹窗 -->
<div id="doujinGiftModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 450px;">
        <div class="modal-title">打赏作者</div>
        <div class="gift-tip">该礼物打赏的金额会进作者的账户</div>
        <div id="giftListContainer" class="gift-grid-container">
            <!-- JS生成礼物列表 -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closeDoujinGiftModal()">取消</button>
            <button class="modal-btn confirm" onclick="confirmDoujinGiftSelection()">确认支付</button>
        </div>
    </div>
</div>

<!-- 丢鸡蛋弹窗 -->
<div id="doujinEggModal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 450px;">
        <div class="modal-title">砸场子</div>
        <div class="gift-tip" style="color: #ff4d4d;">该金额全部归平台所有，不会给作者</div>
        <div id="eggListContainer" class="gift-grid-container">
            <!-- JS生成道具列表 -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn cancel" onclick="closeDoujinEggModal()">取消</button>
            <button class="modal-btn confirm" onclick="confirmDoujinEggSelection()">确认支付</button>
        </div>
    </div>
</div>

<!-- 礼物动画层 -->
<div id="giftAnimationOverlay"></div>

<!-- 新增：磕CP设定弹窗 -->
<div class="modal" id="cpRunSettingsModal">
    <div class="modal-content">
        <div class="modal-title">选择CP与设定</div>

        <!-- 1. CP选择区域 -->
        <div class="doujin-modal-setting-group">
            <label>选择一对CP (单选)</label>
            <div id="cpRunSelectContainer" class="char-select-container" style="max-height: 150px;">
                <!-- JS 动态生成 -->
            </div>
        </div>

        <!-- 2. 同人梗选择区域 (复用已有样式) -->
        <div class="doujin-modal-setting-group">
            <label>
                选择同人梗
                <i class="fas fa-pencil-alt" style="cursor:pointer; color:#999; font-size:14px; margin-left:8px;" onclick="doujinToggleTropeEditMode(this)"></i>
            </label>
            <div id="cpRunTropeContainer" class="trope-selection-area">
                <!-- JS 动态生成，与主页互通 -->
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="document.getElementById('cpRunSettingsModal').classList.remove('show')">取消</button>
            <button class="modal-btn confirm" onclick="doujinConfirmCpRunSettings()">确定</button>
        </div>
    </div>
</div>

<!-- 商店App (Store App) -->
<div id="storeApp" class="page">
    <!-- A. 首页视图 -->
    <div id="storeHomeView" class="store-page-view active">
        <!-- 顶部搜索栏 -->
       <div class="store-top-bar">
    <!-- 【新增】返回按钮在这里 -->
    <button class="store-back-btn" onclick="goHome()">
        <i class="ri-arrow-left-s-line"></i>
    </button>

    <!-- 原有的搜索框 -->
    <div class="store-search-box">
    <i class="ri-search-line" style="font-size: 16px;"></i>
    <!-- 这里的 onkeydown 绑定了下面的新函数 -->
    <input type="text" id="storeSearchInput" class="store-search-input" placeholder="搜索宝贝..." onkeydown="handleStoreSearchKey(event)">
    <i class="ri-close-circle-fill" id="storeSearchClearBtn" onclick="clearStoreSearch()" style="display:none; color:#ccc; cursor:pointer;"></i>
</div>

    <!-- 原有的刷新按钮 -->
    <button class="store-refresh-btn" onclick="refreshStoreGoods()">
        <i class="ri-refresh-line"></i>
    </button>
</div>

        <!-- 分类导航 -->
        <div class="store-category-tabs">
            <div class="store-cat-item active" onclick="switchStoreCategory(this, '推荐')">推荐</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '外卖')">外卖</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '服饰')">服饰</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '美妆')">美妆</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '数码')">数码</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '家具')">家具</div>
            <div class="store-cat-item" onclick="switchStoreCategory(this, '出行')">出行</div>
    <div class="store-cat-item" onclick="switchStoreCategory(this, '情趣')">情趣</div>
        </div>

        <!-- 商品瀑布流容器 -->
        <div class="store-waterfall" id="storeGoodsList">
            <!-- JS将在这里生成卡片 -->
        </div>
    </div>

<!-- B. 购物车视图 -->
    <div id="storeCartView" class="store-page-view">
        <!-- 1. 顶部导航栏 -->
        <div class="nav-bar" style="background: #fff; border-bottom: 1px solid #eee;">
            <div class="nav-title" style="font-weight: bold;">购物车 (0)</div>
            <!-- 新增：分享代付按钮 -->
            <button class="nav-btn" style="position: absolute; right: 15px; color: #333;" onclick="openCartShareModal()">
                <i class="ri-share-forward-line" style="font-size: 24px;"></i>
            </button>
        </div>

        <!-- 2. 列表容器 -->
        <div class="store-cart-list" id="storeCartList">
            <!-- 购物车为空 -->
            <div style="text-align: center; padding: 50px; color: #999;">
                <i class="ri-shopping-cart-2-line" style="font-size: 40px;"></i>
                <p>购物车空空如也</p>
            </div>
        </div>

        <!-- 3. 底部结算栏 -->
        <div class="store-cart-footer">
            <div style="display:flex; align-items:center; gap:8px; font-size:13px;">
                <div class="store-check-circle"></div> 全选
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:14px;">合计: <b>¥0.00</b></span>
                <div class="store-checkout-btn">结算 (0)</div>
            </div>
        </div>
    </div>

    <!-- C. 我的视图 -->
    <div id="storeMeView" class="store-page-view">
        <!-- 头部 -->
        <div class="store-me-header">
            <div class="store-me-avatar" id="storeUserAvatar" style="background-image: url(''); background-size: cover;"></div>
            <div class="store-me-name" id="storeUserName">用户名</div>
        </div>

        <!-- 订单状态 -->
        <div class="store-me-grid">
            <div><i class="store-me-icon ri-wallet-3-line"></i><span class="store-me-label">待付款</span></div>
            <!-- 添加 onclick="openStorePendingShipment()" -->
<div onclick="openStorePendingShipment()" style="cursor: pointer;">
    <i class="store-me-icon ri-box-3-line"></i>
    <span class="store-me-label">待发货</span>
</div>
<div onclick="openStoreShippedOrders()" style="cursor: pointer;">
    <i class="store-me-icon ri-truck-line"></i>
    <span class="store-me-label">待收货</span>
</div>
<div onclick="openStorePendingReview()" style="cursor: pointer;">
    <i class="store-me-icon ri-message-2-line"></i>
    <span class="store-me-label">待评价</span>
</div>


        </div>

        <!-- 工具栏 -->
        <div class="store-me-grid" style="margin-top: 10px;">
            <div><i class="store-me-icon ri-star-line"></i><span class="store-me-label">收藏夹</span></div>
            <div><i class="store-me-icon ri-footprint-line"></i><span class="store-me-label">足迹</span></div>
            <div><i class="store-me-icon ri-coupon-2-line"></i><span class="store-me-label">红包卡券</span></div>
            <div><i class="store-me-icon ri-customer-service-2-line"></i><span class="store-me-label">客服</span></div>
        </div>
    </div>

<!-- D. 新增：待发货视图 -->
    <div id="storePendingShipmentView" class="store-page-view">
        <div class="store-top-bar">
            <button class="store-back-btn" onclick="switchStoreTab('me', document.querySelector('.store-tab-item[onclick*=\'me\']'))">
                <i class="ri-arrow-left-s-line"></i>
            </button>
            <div style="flex:1; text-align:center; font-weight:bold; font-size:16px;">待发货</div>
            <div style="width: 30px;"></div> <!-- 占位，保持标题居中 -->
        </div>

        <div class="store-cart-list" id="storePendingShipmentList" style="background: #f5f5f5;">
            <!-- JS 将在这里生成订单卡片 -->
        </div>
    </div>
    <!-- F. 新增：待评价视图 -->
<div id="storePendingReviewView" class="store-page-view">
    <div class="store-top-bar">
        <button class="store-back-btn" onclick="switchStoreTab('me', document.querySelector('.store-tab-item:nth-child(3)'))">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div style="flex:1; text-align:center; font-weight:bold; font-size:16px;">待评价</div>
        <div style="width: 30px;"></div>
    </div>

    <div class="store-cart-list" id="storePendingReviewList" style="background: #f5f5f5;">
        <!-- JS 将在这里生成待评价卡片 -->
    </div>
</div>


    <!-- 底部导航栏 -->
    <div class="store-bottom-bar">
        <div class="store-tab-item active" onclick="switchStoreTab('home', this)">
            <i class="store-tab-icon ri-home-smile-2-line"></i>
            <span class="store-tab-label">首页</span>
        </div>
        <div class="store-tab-item" onclick="switchStoreTab('cart', this)">
            <i class="store-tab-icon ri-shopping-cart-2-line"></i>
            <span class="store-tab-label">购物车</span>
        </div>
        <div class="store-tab-item" onclick="switchStoreTab('me', this)">
            <i class="store-tab-icon ri-user-smile-line"></i>
            <span class="store-tab-label">我的</span>
        </div>
    </div>
</div>

<!-- 日记设置弹窗 -->

<!-- 日记设置弹窗 (支持频率设置版) -->
<div id="diarySettingsModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 30px 25px;">
        <div class="modal-title" style="color: #000; font-weight: 700;">日记设置</div>

        <!-- 自动写日记开关 -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">开启自动写日记</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="diaryAutoWriteToggle" onchange="toggleDiaryAutoWrite()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.4;">
                开启后，角色会根据你设定的频率自动生成日记。
            </div>
        </div>

        <!-- 【新增】频率设置 (默认隐藏，开启开关后显示) -->
        <div class="form-group" id="diaryFreqGroup" style="display: none; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <label class="form-label" style="color: #000; font-weight: 500; margin-bottom: 8px; display:block;">生成频率 (天/篇)</label>
            <input type="number" class="modal-input" id="diaryFreqInput" placeholder="例如：1 (代表每天一篇)" min="1" style="background-color: #f7f7f7;">
        </div>
         <!-- ▼▼▼ 插入开始：自定义时间和周记开关 ▼▼▼ -->

        <!-- 设定每天几点写日记 -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <label class="form-label" style="color: #000; font-weight: 500; margin-bottom: 8px; display:block;">生成时间 (每日/周)</label>
            <input type="time" class="modal-input" id="diaryTimeInput" style="background-color: #f7f7f7;">
            <div style="font-size: 12px; color: #999; margin-top: 5px;">如果不设置，将由系统随机决定。</div>
        </div>

        <!-- 开启周记模式 -->
        <div class="form-group" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">开启周记模式</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="diaryWeeklyToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.4;">
                开启后，每周日晚上会额外生成一篇“本周总结”。
            </div>
        </div>

        <!-- ▲▲▲ 插入结束 ▲▲▲ -->
 <!-- ▼▼▼ 新增：自动日记角色选择 (插入在这里) ▼▼▼ -->
        <div class="form-group" id="diaryRoleSelectGroup" style="display: none; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="openDiaryRoleSelectModal()">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500; cursor: pointer;">选择允许写日记的角色</label>
                <div class="form-value-display">点击选择 <i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                选中后，只有这些角色在满足聊天频率条件时才会写日记。
            </div>
        </div>
        <!-- ▲▲▲ 新增结束 ▲▲▲ -->
        <!-- 文风选择 -->
        <div class="form-group" style="margin-bottom: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 500;">全局日记文风</label>
                <button class="nav-btn" style="font-size: 14px; color: #000; font-weight: bold;" onclick="openDiaryStyleAddModal()">+ 添加</button>
            </div>
            <div id="currentDiaryStyleDisplay" class="form-input" style="line-height: 2.5; cursor: pointer; text-align: center; background: #f7f7f7; border-radius: 12px; color: #333; border: none;" onclick="openDiaryStyleSelectModal()">
                无 (默认)
            </div>
        </div>

        <div class="modal-buttons" style="margin-top: 25px;">
            <button class="modal-btn modal-btn-confirm" onclick="saveAndCloseDiarySettings()" style="background-color: #000; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">保存设置</button>
        </div>
    </div>
</div>


<!-- 文风选择列表弹窗 -->
<div id="diaryStyleSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择文风</div>
        <div id="diaryStyleList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS生成列表 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryStyleSelectModal').classList.remove('show')">关闭</button>
        </div>
    </div>
</div>

<!-- 添加/编辑文风弹窗 -->
<div id="diaryStyleEditModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">编辑文风</div>
        <input type="text" class="modal-input" id="diaryStyleTitleInput" placeholder="文风名称 (例如：发疯文学)">
        <textarea class="modal-textarea" id="diaryStyleContentInput" placeholder="具体的文风指令... 例如：多使用感叹号，情绪激动，逻辑跳跃。" style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('diaryStyleEditModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveDiaryStyle()">保存</button>
        </div>
    </div>
</div>

<!-- 情侣空间主页 -->
<div id="loversSpaceScreen" class="page">
    <div class="nav-bar">
       <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">情侣空间</div>
        <button class="nav-btn nav-right-action-btn" onclick="openLoversInviteModal()">+</button>
    </div>
    <div class="wechat-content" style="background: #f7f7f7; padding: 15px; padding-top: 88px;">
        <!-- 这里将动态渲染已结成的情侣卡片 -->
        <div id="loversListContainer" style="display: flex; flex-direction: column; gap: 15px;"></div>
    </div>
</div>

<!-- 邀请好友的弹窗 -->
<div id="loversInviteModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">邀请开启情侣空间</div>
        <div id="loversInviteFriendList" class="multi-select-list" style="max-height: 300px;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('loversInviteModal').classList.remove('show')">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmLoversInvite()">发送邀请</button>
        </div>
    </div>
</div>

<!-- 情侣空间详情页 (标准导航栏版) -->
<div id="loversDetailScreen" class="page">

    <!-- 1. 标准顶部导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <!-- 返回按钮 -->
        <button class="nav-btn" onclick="backToLoversList()">
            <i class="ri-arrow-left-s-line"></i>
        </button>

        <!-- 标题 (JS会自动修改这里的名字) -->
        <div class="nav-title" id="loversDetailTitle">情侣空间</div>

        <!-- 右侧占位，保持标题居中 -->
        <div style="width: 40px;"></div>
    </div>

    <!-- 2. 内容区域 (包含背景图和头像) -->
    <!-- 增加 padding-top: 74px 确保不被导航栏挡住 -->
    <div class="wechat-content" style="padding-top: 74px; background-color: #fff;">

        <!-- 顶部背景图区域 -->
        <div class="lovers-header-bg" onclick="document.getElementById('lovers-bg-input').click()" style="margin-top: 0;">
            <img src="https://via.placeholder.com/500x220/ffb6d9/ffffff?text=点击更换背景" alt="背景封面" id="lovers-home-bg-img">
            <input type="file" id="lovers-bg-input" accept="image/*" style="display: none;" onchange="handleLoversBgUpload(event)">

            <div class="lovers-avatar-section">
                <div class="lovers-avatar-wrapper">
                    <!-- 对方头像 -->
                    <div id="lovers-friend-avatar" class="lovers-avatar" style="background-color: #eee;"></div>
                </div>
                <div class="lovers-avatar-wrapper">
                    <!-- 我的头像 -->
                    <div id="lovers-user-avatar" class="lovers-avatar" style="background-color: #eee;"></div>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="lovers-main-content">
            <div class="lovers-couple-row">
                <div class="lovers-couple-info">
                    <span class="lovers-together-text">在一起</span>
                    <span class="lovers-days-count" id="lovers-total-days">0</span>
                    <span class="lovers-days-text">天</span>
                </div>
                <button class="lovers-check-in-btn" onclick="alert('打卡成功！甜蜜值+1')">
                    <i class="fas fa-heart"></i> 打卡
                </button>
            </div>

            <!-- 功能菜单 -->
            <div class="lovers-function-menu">
                <div class="lovers-function-item" onclick="openLoversAnniversary()">
                    <div class="lovers-function-icon"><i class="far fa-calendar-alt"></i></div>
                    <div class="lovers-function-title">纪念日</div>
                    <div class="lovers-function-desc">重要时刻</div>
                </div>
                <div class="lovers-function-item" onclick="openLoversLetterList()">
                    <div class="lovers-function-icon"><i class="far fa-envelope"></i></div>
                    <div class="lovers-function-title">情书</div>
                    <div class="lovers-function-desc">写给TA</div>
                </div>
                <div class="lovers-function-item" onclick="openLoversAccountPage()">
                    <div class="lovers-function-icon"><i class="fas fa-wallet"></i></div>
                    <div class="lovers-function-title">记账本</div>
                    <div class="lovers-function-desc">记录花销</div>
                </div>
                <div class="lovers-function-item" onclick="openLoversMoodScreen()">
                    <div class="lovers-function-icon" style="color: #333;"><i class="far fa-calendar-check"></i></div>
                    <div class="lovers-function-title">心情日历</div>
                    <div class="lovers-function-desc">交换心情</div>
                </div>
                <div class="lovers-function-item" onclick="openLoversWhisperScreen()">
                    <div class="lovers-function-icon"><i class="fas fa-comment-dots"></i></div>
                    <div class="lovers-function-title">悄悄话</div>
                    <div class="lovers-function-desc">私密消息</div>
                </div>

            </div>

            <div class="lovers-tabs">
                <div class="lovers-tab active">动态</div>
            </div>

            <!-- 情侣空间动态内容区 -->
            <div class="lovers-content-home">
                <!-- 动态列表容器 -->
                <div id="lovers-moments-list"></div>
                <!-- 悬浮发布按钮 -->
                <button class="lovers-fab" onclick="openLoversPostModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 情侣空间发布动态弹窗 -->
<div class="modal" id="loversPostModal">
    <div class="modal-content">
        <div class="modal-title">发布甜蜜日常</div>

        <!-- 文本输入框 -->
        <div class="form-group">
            <textarea id="lovers-post-text" class="lovers-post-textarea" placeholder="这一刻的想法..."></textarea>
        </div>

        <!-- 图片上传区域 -->
        <div class="lovers-post-image-upload" onclick="document.getElementById('lovers-post-file').click()">
            <i class="fas fa-camera"></i>
            <span id="lovers-post-file-text">添加图片 (可选)</span>
        </div>

        <!-- 图片预览区域 -->
        <div id="lovers-post-img-preview-box" style="display:none; margin-top:10px; text-align: center;">
            <img id="lovers-post-img-preview" src="" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size: 12px; color: #ff4d4d; margin-top: 5px; cursor: pointer;" onclick="clearLoversPostImage()">删除图片</div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversPostModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" style="background: #ff69b4; color: white;" onclick="submitLoversPost()">发布</button>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- 1. 纪念日列表页 (复刻 29.txt Page 2) -->
<!-- ========================================= -->
<div id="loversAnniversaryScreen" class="page">
    <!-- 标准导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToLoversHome()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">纪念日</div>
        <div style="width: 40px;"></div>
    </div>

    <!-- 内容区域：padding-top: 74px 避开导航栏 -->
    <div class="wechat-content" style="padding-top: 74px;">
        <div class="lovers-anni-header">
            <div class="lovers-avatars-small">
                <div id="anni-header-avatar-friend" class="lovers-avatar-s"></div>
                <div id="anni-header-avatar-user" class="lovers-avatar-s"></div>
            </div>
            <div class="lovers-days-header-info">
                <div class="lovers-days-header-title">已相恋 <span class="lovers-days-header-num" id="anni-total-days">0</span> 天</div>
                <div class="lovers-days-header-date" id="anni-start-date">----.--.--</div>
            </div>
        </div>

        <div class="lovers-content-anni">
            <div class="lovers-add-row" onclick="openLoversAnniModal()">
                <div class="lovers-anniversary-info">
                    <h3>添加纪念日</h3>
                    <p>记录每一个特别的日子</p>
                </div>
                <button class="lovers-add-circle-btn"><i class="fas fa-plus"></i></button>
            </div>
            <div id="lovers-anniversary-list"></div>
        </div>
    </div>
</div>

<!-- ========================================= -->
<!-- 2. 倒数日详情页 (复刻 29.txt Page 3) -->
<!-- ========================================= -->
<div id="loversAnniDetailScreen" class="page">
    <div class="lovers-dm-nav">
        <button class="lovers-dm-btn" onclick="backToAnniversaryList()">返回</button>
        <div class="lovers-dm-nav-title">Days Matter</div>
        <button class="lovers-dm-btn" onclick="editCurrentAnniversary()">编辑</button>
    </div>

    <div class="lovers-dm-card">
        <div class="lovers-dm-card-header" id="dm-card-header">
            <span id="dm-title">Title</span> <span id="dm-suffix">还有</span>
        </div>
        <div class="lovers-dm-card-body">
            <div class="lovers-dm-big-number" id="dm-number">0</div>
        </div>
        <div class="lovers-dm-card-footer">
            目标日：<span id="dm-date-str">2025-01-01 星期X</span>
        </div>
    </div>

    <div class="lovers-dm-tools">
        <button class="lovers-dm-tool-btn" onclick="changeDmCardColor()">
            <i class="fas fa-palette"></i> 换肤
        </button>
        <button class="lovers-dm-tool-btn secondary" onclick="deleteCurrentAnniversary()">
            <i class="far fa-trash-alt"></i> 删除
        </button>
    </div>
</div>

<!-- ========================================= -->
<!-- 3. 添加/编辑纪念日弹窗 -->
<!-- ========================================= -->
<div class="modal" id="loversAnniInputModal">
    <div class="modal-content">
        <div class="modal-title" id="anniInputModalTitle">添加纪念日</div>
        <div class="form-group">
            <label class="form-label">名称</label>
            <input type="text" class="modal-input" id="anni-input-name" placeholder="例如：我的生日">
        </div>
        <div class="form-group">
            <label class="form-label">日期</label>
            <input type="date" class="modal-input" id="anni-input-date">
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversAnniModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" style="background:#ff69b4;" onclick="saveLoversAnniversary()">确定</button>
        </div>
    </div>
</div>

<div id="loversLetterListScreen" class="page">
    <!-- 标准导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToLoversDetail()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">我们的情书</div>
        <!-- 右侧按钮组 -->
        <div style="display: flex; gap: 10px;">
            <button class="nav-btn" onclick="openLetterWriteModal()">
                <i class="ri-add-line" style="font-size: 24px;"></i>
            </button>
            <button class="nav-btn" onclick="openLoversLetterSettings()">
                <i class="ri-settings-3-line" style="font-size: 22px;"></i>
            </button>
        </div>
    </div>

    <div class="wechat-content" style="padding-top: 74px;">
        <div class="timeline-container" id="letterTimelineList">
            <!-- JS 动态生成 -->
        </div>
    </div>
</div>


<!-- 拆信动画与阅读页 -->
<div id="loversLetterAnimationScreen" class="page" style="background: #fff;">
    <!-- 悬浮返回按钮 -->
    <div class="back-btn-float" onclick="closeLetterAnimation()"><i class="fas fa-chevron-left"></i></div>

    <!-- 大信封动画容器 -->
    <div class="big-envelope-container" id="anim-envelope">
        <div class="env-back"></div>
        <div class="anim-paper"></div>
        <div class="env-body"></div>
        <div class="env-flap"></div>
        <div class="env-seal"></div>
    </div>

    <!-- 读信内容区 -->
    <div class="letter-read-view" id="read-view">
        <div class="paper-content">
            <h2 id="letter-title-display">标题</h2>
            <div id="letter-body-display"></div>
        </div>
    </div>
</div>

<!-- 4. 情侣记账本页面 (移植版) -->
<div id="account-page" class="page">
    <!-- 标准导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToLoversDetail()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title" id="acc-page-title">恋爱账本</div>
        <button class="nav-btn" onclick="toggleLoversAccountTheme()" title="换肤">
            <i class="ri-palette-line" style="font-size: 22px;"></i>
        </button>
    </div>

    <!-- 内容区域 -->
    <div class="wechat-content" style="padding-top: 74px; padding-bottom: 0;">
        <!-- 视图1：账单明细 -->
        <div id="acc-bill-view">
            <div class="account-card">
                <div class="acc-total-label">资产结余</div>
                <div class="acc-total-amount" id="acc-balance">0.00</div>
                <div class="acc-row">
                    <div class="acc-col">
                        <div class="acc-sub-label">本月收入</div>
                        <div class="acc-sub-amount" id="acc-month-income">0.00</div>
                    </div>
                    <div class="acc-col">
                        <div class="acc-sub-label">本月支出</div>
                        <div class="acc-sub-amount" id="acc-month-expense">0.00</div>
                    </div>
                </div>
            </div>
            <div class="account-list" id="account-transaction-list"></div>
            <!-- 悬浮按钮 -->
            <button class="acc-fab-add" onclick="openLoversAccountModal()"><i class="fas fa-plus"></i></button>
        </div>

        <!-- 视图2：统计报表 -->
        <div id="acc-stats-view">
            <div class="stats-header">
                <div class="stats-month-selector" style="position: relative; display: inline-flex; align-items: center;">
                    <span id="stat-month-display">2025年11月</span>
                    <i class="fas fa-chevron-down" style="font-size:12px; color:#999; margin-left: 5px;"></i>
                    <input type="month" id="stat-month-input" onchange="onLoversMonthChange(this)" style="position: absolute; top:0; left:0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                </div>
                <div class="stats-type-switch">
                    <div class="type-switch-item active" id="stat-btn-exp" onclick="switchLoversStatType('expense')">支出</div>
                    <div class="type-switch-item" id="stat-btn-inc" onclick="switchLoversStatType('income')">收入</div>
                </div>
            </div>
            <div class="chart-container">
                <div id="main-chart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="rank-list" id="stat-rank-list"></div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="acc-bottom-nav">
        <div class="acc-nav-item active" id="nav-bill" onclick="switchLoversAccTab('bill')">
            <i class="fas fa-file-invoice"></i>
            <span>账单</span>
        </div>
        <div class="acc-nav-item" id="nav-stats" onclick="switchLoversAccTab('stats')">
            <i class="fas fa-chart-pie"></i>
            <span>报表</span>
        </div>
    </div>
</div>


<!-- 记账弹窗 (独立ID) -->
<div class="modal" id="lovers-account-modal">
    <div class="modal-content">
        <!-- 1. 顶部标题栏 -->
        <div class="acc-modal-header">
            <button class="acc-close-btn" onclick="closeLoversAccountModal()"><i class="fas fa-times"></i></button>
            <div class="acc-tabs">
                <div class="acc-tab-item active" id="tab-expense" onclick="setLoversAccountType('expense')">支出</div>
                <div class="acc-tab-item" id="tab-income" onclick="setLoversAccountType('income')">收入</div>
            </div>
            <div style="width: 30px;"></div>
        </div>

        <!-- 2. 中间图标区域 -->
        <div class="category-scroll-area">
            <div class="category-grid" id="category-grid">
                <!-- JS 生成分类图标 -->
            </div>
        </div>

        <!-- 3. 底部输入区域 -->
        <div class="acc-input-panel">
            <!-- 金额行 -->
            <div class="acc-amount-display" id="acc-amount-wrap">
                <span style="font-size: 24px; margin-right: 5px;">¥</span>
                <input type="number" id="acc-input-amount" class="acc-amount-input" placeholder="0.00" inputmode="decimal" step="0.01">
            </div>

            <!-- 日期和备注行 -->
            <div class="acc-meta-row">
                <input type="date" class="acc-meta-input" id="acc-input-date">
                <input type="text" class="acc-meta-input acc-note-input" id="acc-input-note" placeholder="点击填写备注...">
            </div>

            <!-- 按钮 -->
            <button class="acc-save-btn" onclick="submitLoversAccountForm()">完成</button>
        </div>

        <input type="hidden" id="acc-input-type" value="expense">
        <input type="hidden" id="acc-input-category" value="">
    </div>
</div>

<!-- 情侣空间：视奸/足迹页面 (Lovers Spy Screen) -->
<div id="loversSpyScreen" class="page">
    <div class="spy-header">
        <!-- ↓↓↓ 确保 onclick 是 backFromSpyScreen() ↓↓↓ -->
        <button class="lovers-icon-btn-round" onclick="forceBackFromSpy()">
            <i class="fas fa-arrow-left" style="color: #000;"></i>
        </button>
        <h2 style="font-weight: 800; letter-spacing: 1px; font-size: 18px;">TA的动态</h2>
        <div class="spy-status-dot"></div> <!-- 在线状态点 -->
    </div>

    <div class="spy-container">
        <!-- 头部概览 -->
        <div class="spy-overview">
            <div class="spy-avatar-box">
                <!-- 头像将由JS动态填充 -->
                <div id="spy-page-avatar" class="spy-avatar" style="background-color: #eee; background-size: cover; background-position: center;"></div>
                <div class="spy-online-badge">Online</div>
            </div>
            <p class="spy-intro">上次活跃于 <span style="font-weight:bold;">1 分钟前</span><br>iPhone 16 Pro Max · 5G</p>
        </div>

        <!-- 时间轴列表容器 -->
        <div id="spy-timeline-list" class="spy-list-wrap">
            <!-- JS 自动生成内容 -->
        </div>
    </div>
</div>

<!-- 1. 心情日历页面 -->
<div id="loversMoodScreen" class="page">
    <!-- 标准导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToLoversDetail()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">心情日历</div>
        <button class="nav-btn" onclick="openLoversMoodSummary()">
            <i class="ri-bar-chart-box-line" style="font-size: 22px;"></i>
        </button>
    </div>

    <div class="wechat-content" style="padding-top: 74px; background: #fff;">
        <!-- 将月份切换器移到内容区顶部 -->
        <div class="mood-month-switcher" style="justify-content: center; margin-bottom: 20px; margin-top: 10px;">
            <button class="month-nav-btn" onclick="changeLoversMoodMonth(-1)">
                <i class="ri-arrow-left-s-line" style="font-size: 20px;"></i>
            </button>
            <div class="mood-month-title" id="mood-month-display" style="font-size: 18px;">2025年12月</div>
            <button class="month-nav-btn" onclick="changeLoversMoodMonth(1)">
                <i class="ri-arrow-right-s-line" style="font-size: 20px;"></i>
            </button>
        </div>

        <div class="mood-calendar-container">
            <div class="week-header">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div class="days-grid" id="mood-days-grid"></div>
        </div>

        <div class="mood-legend">
            <div class="legend-item"><span class="legend-dot" style="background:#ffb6d9"></span> 我</div>
            <div class="legend-item"><span class="legend-dot" style="background:#81d4fa"></span> TA</div>
            <div class="legend-item"><span class="legend-dot" style="background:#ffcdd2"></span> 生理期</div>
        </div>
    </div>
</div>


<!-- 2. 心情总结/罐子页面 -->
<div id="loversMoodSummaryScreen" class="page">
    <div class="mood-header">
        <button class="lovers-icon-btn-round" onclick="backToLoversMoodCalendar()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="mood-month-title">本月心情罐头</div>
        <div style="width: 40px;"></div> <!-- 占位保持平衡 -->
    </div>

    <div class="summary-scroll-content">
        <!-- 1. 心情罐子区域 -->
        <div class="jar-section">
            <div class="mood-jar-container">
                <div class="jar-lid"></div>
                <div class="jar-body" id="jar-content">
                    <!-- JS 会在这里生成随机散落的心情图标 -->
                </div>
                <div class="jar-bottom-shine"></div>
            </div>
        </div>

        <!-- 2. 最多心情统计 -->
        <div class="summary-section-title">本月最多心情</div>
        <div class="most-frequent-card">
            <!-- 我的统计 -->
            <div class="freq-item">
                <div class="freq-avatar" id="summary-my-avatar"></div>
                <div class="freq-info">
                    <img src="" id="summary-my-top-mood-img" class="freq-mood-icon">
                    <span class="freq-count" id="summary-my-top-mood-count">x0</span>
                </div>
            </div>
            <!-- 分割线 -->
            <div style="width: 1px; height: 40px; background: #eee;"></div>
            <!-- TA的统计 -->
            <div class="freq-item">
                <div class="freq-avatar" id="summary-ta-avatar"></div>
                <div class="freq-info">
                    <img src="" id="summary-ta-top-mood-img" class="freq-mood-icon">
                    <span class="freq-count" id="summary-ta-top-mood-count">x0</span>
                </div>
            </div>
        </div>

        <!-- 底部提示 -->
        <div style="text-align: center; color: #ccc; font-size: 12px; margin-top: 20px;">
            收集了我们点点滴滴的情绪
        </div>
    </div>
    <!-- 生理期提醒设置入口 -->
<div class="period-setting-entry" onclick="openPeriodSettingsModal()">
    <i class="fas fa-bell"></i> 设置生理期贴心提醒
</div>
</div>

<!-- 3. 心情签到弹窗 -->
<div id="loversMoodCheckInModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-title">今日心情</div>

        <div class="mood-grid-select" id="mood-selector">
            <!-- JS 生成心情选项 -->
        </div>

        <div class="period-toggle" onclick="toggleLoversPeriodSwitch()">
            <span><i class="fas fa-tint"></i> 记录生理期</span>
            <div class="period-toggle-switch" id="lovers-period-switch"></div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeLoversMoodCheckInModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" style="background: #ff69b4;" onclick="saveLoversMood()">打卡</button>
        </div>
    </div>
</div>

<!-- 情侣空间：悄悄话页面 (修改版) -->
<div id="loversWhisperScreen" class="page">
    <!-- 标准导航栏 -->
    <div class="nav-bar" style="background-color: #fff; border-bottom: 1px solid #f0f0f0;">
        <button class="nav-btn" onclick="backToLoversDetail()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">悄悄话</div>
        <div style="display: flex; gap: 10px;">
            <button class="nav-btn" onclick="openWriteWhisperScreen()">
                <i class="ri-add-line" style="font-size: 24px;"></i>
            </button>
            <button class="nav-btn" onclick="openLoversWhisperSettings()">
                <i class="ri-settings-3-line" style="font-size: 22px;"></i>
            </button>
        </div>
    </div>

    <div class="wechat-content" style="padding-top: 74px;">
        <div class="whisper-board" id="lovers-whisper-list">
            <!-- JS 生成便签 -->
        </div>
    </div>
</div>


<!-- 情书设置弹窗 -->
<div id="loversLetterSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">情书设置</div>

        <!-- 自动生成开关 -->
        <div class="form-group" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin:0;">自动写情书</label>
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="autoLetterToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">开启后，TA会不定期给你写信。</div>
        </div>

        <!-- 频率设置 -->
        <div class="form-group" id="autoLetterFreqGroup" style="display: none;">
            <label class="form-label">生成频率 (天/篇)</label>
            <input type="number" class="modal-input" id="autoLetterFreqInput" placeholder="例如：7" min="1">
        </div>

<!-- 【新增】字体设置 -->
        <div class="form-group" style="border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
            <label class="form-label">信纸字体</label>
            <select class="form-select arrow-select" id="letterFontSelect" onchange="toggleLetterCustomFontInput(this.value)">
                <option value="auto">🎲 智能/随机分配 (默认)</option>
                <option value="font-mashanzheng">马善政 (标准毛笔)</option>
                <option value="font-zhimangxing">志莽行 (霸气行书)</option>
                <option value="font-longcang">龙苍 (狂草)</option>
                <option value="font-liujianmaocao">流光毛草 (潦草)</option>
                <option value="font-zcoolkuaile">站酷快乐 (可爱)</option>
                <option value="font-xiaowei">小薇体 (温柔)</option>
                <option value="font-notoserif">思源细宋 (高冷)</option>
                <option value="custom">🔗 自定义字体 (URL)</option>
            </select>

            <!-- 自定义字体URL输入框 (默认隐藏) -->
            <input type="text" class="modal-input" id="letterCustomFontUrlInput" placeholder="粘贴字体文件URL (.ttf/.woff)" style="display: none; margin-top: 10px;">
        </div>

        <!-- 手动生成 -->
        <div class="doujin-modal-setting-group">
            <label>手动生成 (立即收到)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="manualLetterCountSlider" min="1" max="3" value="1" class="doujin-slider" style="flex:1;" oninput="document.getElementById('manualLetterCountDisplay').innerText = this.value">
                <span id="manualLetterCountDisplay" style="width: 30px; text-align: center;">1</span> 篇
            </div>
            <button class="settings-btn btn-black" style="margin-top: 10px; height: 36px; font-size: 14px;" onclick="triggerManualLetterGeneration()">开始生成</button>

</div>



        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="saveLoversLetterSettings()">保存设置</button>
        </div>
    </div>
</div>

<!-- 用户写情书页面 -->
<div id="loversWriteLetterScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToLetterList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">写情书</div>
        <button class="nav-btn" onclick="submitUserLetter()" style="font-weight: bold; color: #ff69b4;">发送</button>
    </div>

    <!-- 注意：这里去掉了 style="padding: 20px;"，交由上面的 CSS 控制 -->
    <div class="wechat-content">
        <div class="write-letter-container">
            <!-- 这里就是那个之前被挡住的标题框 -->
            <input type="text" id="userLetterTitle" class="write-letter-title" placeholder="请输入信件标题 (必填)">

            <div class="write-letter-paper">
                <textarea id="userLetterContent" class="write-letter-body" placeholder="最爱的周遇：&#10;&#10;在这里写下你想对TA说的话..."></textarea>
                <div class="write-letter-footer">
                    <span>From: 我</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 悄悄话设置弹窗 (黑白极简风 & 上限10条) -->
<div id="loversWhisperSettingsModal" class="modal">
    <div class="modal-content" style="background-color: #fff; border-radius: 24px; padding: 30px 25px; width: 85%; max-width: 360px;">
        <div class="modal-title" style="color: #000; font-weight: 700; font-size: 20px; margin-bottom: 25px; text-align: center;">悄悄话设置</div>

        <!-- 1. 自动生成开关 -->
        <div class="form-group" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f5f5f5;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label class="form-label" style="margin: 0; color: #000; font-weight: 600; font-size: 15px;">聊天自动生成</label>
                <!-- 黑白风格开关 -->
                <label class="toggle-switch bw-switch">
                    <input type="checkbox" id="autoWhisperToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 8px; line-height: 1.5;">
                开启后，角色会在与你聊天时，根据聊天内容自动触发内心独白。<br>
                (每日上限 5 条)
            </div>
        </div>

        <!-- 2. 手动生成区域 -->
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label" style="color: #000; font-weight: 600; font-size: 15px; display: block; margin-bottom: 15px;">手动生成 (立即查看)</label>

            <!-- 滑动条区域 -->
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <!-- 核心修改：将 max 改为 10，并添加 accent-color: #000 强制黑色 -->
                <input type="range" id="manualWhisperCountSlider" min="1" max="10" value="1"
                       style="flex: 1; height: 4px; background: #eee; border-radius: 2px; outline: none; accent-color: #000;"
                       oninput="document.getElementById('manualWhisperCountDisplay').innerText = this.value">

                <span style="font-weight: bold; color: #000; font-size: 16px; min-width: 40px; text-align: right;">
                    <span id="manualWhisperCountDisplay">1</span> 条
                </span>
            </div>

            <!-- 黑色生成按钮 -->
            <button class="settings-btn btn-black" style="
                background-color: #000;
                color: #fff;
                border-radius: 30px;
                height: 44px;
                font-weight: 600;
                font-size: 14px;
                width: 100%;
                border: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                cursor: pointer;
                transition: transform 0.1s;"
                onclick="triggerManualWhisperGeneration()"
                onmousedown="this.style.transform='scale(0.98)'"
                onmouseup="this.style.transform='scale(1)'">
                立即生成
            </button>
        </div>

        <!-- 3. 底部保存按钮 -->
        <div class="modal-buttons" style="margin-top: 30px;">
            <!-- 这里的保存按钮主要用于保存自动生成的开关状态 -->
            <button class="modal-btn modal-btn-confirm" onclick="saveLoversWhisperSettings()"
                    style="background-color: #f7f7f7; color: #333; border-radius: 30px; font-weight: 600; border: none;">
                保存设置
            </button>
        </div>
    </div>
</div>

<!-- 新增：悄悄话详情页 (传纸条模式) -->
<div id="loversWhisperDetailScreen" class="page">
    <div class="nav-bar" style="background: transparent; z-index: 100;">
        <button class="nav-btn" onclick="backToWhisperList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">纸条</div>
        <div style="width: 40px;"></div>
    </div>

    <!-- 纸条容器：用于居中显示放大版便签 -->
    <div class="whisper-detail-container">
        <div id="bigWhisperNote" class="note-paper big-note">
            <!-- 原始内容 -->
            <div id="bigWhisperContent" class="note-content original-text"></div>
            <!-- 后续对话将在这里动态生成 -->
            <div id="whisperDialogueContainer"></div>
        </div>
    </div>

    <!-- 底部输入框 -->
    <div class="whisper-reply-bar">
        <input type="text" id="whisperReplyInput" placeholder="写下你的回复..." onkeydown="handleWhisperReplyEnter(event)">
        <button class="whisper-send-btn" onclick="sendWhisperReply()">
            <i class="ri-pencil-fill"></i>
        </button>
    </div>
</div>

<!-- 写悄悄话页面 -->
<div id="loversWriteWhisperScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="backToWhisperList()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">写悄悄话</div>
        <button class="nav-btn" onclick="submitUserWhisper()" style="font-weight: bold; color: #ff69b4;">贴上</button>
    </div>

  <div class="wechat-content" style="background-color: #f2f2f2; padding-top: 84px; padding-left: 20px; padding-right: 20px; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center;">

        <!-- 样式选择区 -->
        <div style="width: 100%; margin-bottom: 20px;">
            <div style="font-size: 14px; color: #999; margin-bottom: 10px; padding-left: 5px;">选择便签样式</div>
            <div id="whisperStyleSelector" style="display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none;">
                <!-- JS 会在这里生成样式选项 -->
            </div>
        </div>

        <!-- 写作区域 (实时预览) -->
        <div id="whisperWritePreview" class="note-paper big-note note-pink" style="width: 90%; min-height: 300px; cursor: default; transform: none;">
            <textarea id="whisperWriteInput"
                style="width: 100%; height: 100%; background: transparent; border: none; outline: none; resize: none; font-family: inherit; font-size: 24px; text-align: center; color: inherit;"
                placeholder="写下你想对TA说的话..."></textarea>
        </div>

    </div>
</div>

<!-- 视奸详情弹窗 (美化版) -->
<div id="spyDetailModal" class="spy-modal-overlay" onclick="closeSpyDetailModal()">
    <div class="spy-detail-card" onclick="event.stopPropagation()">
        <!-- 关闭按钮 -->
        <div class="spy-close-btn" onclick="closeSpyDetailModal()">×</div>

        <!-- 头部：图标与时间 -->
        <div class="spy-card-header">
            <div class="spy-card-icon" id="spyModalIcon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="spy-card-meta">
                <div class="spy-card-time" id="spyModalTime">12:00</div>
                <div class="spy-card-summary" id="spyModalSummary">摘要</div>
            </div>
        </div>

        <!-- 正文：详细动作描写 -->
        <div class="spy-card-content" id="spyModalDetail" style="margin-bottom: 20px; min-height: 60px;">
            这里是详细的动作描写...
        </div>

        <!-- 底部元数据区域 (位置) -->
        <div style="width: 100%; display: flex; align-items: center; margin-bottom: 10px;">
            <div id="spyModalLocationContainer" style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #888; background: transparent; padding: 0;">
                <i class="ri-map-pin-2-fill" style="color: #999;"></i>
                <span id="spyModalLocationText">未知地点</span>
            </div>
        </div>

        <!-- 心声区域 (美化后) -->
        <div id="spyModalThought" class="spy-thought-area">
            <!-- 装饰性左引号 -->
            <i class="ri-double-quotes-l spy-thought-icon"></i>
            <!-- 心声内容 -->
            <span id="spyModalThoughtContent" class="spy-thought-text">...</span>
        </div>
    </div>
</div>

<!-- 设置弹窗：选择日期和角色 -->
<div id="periodSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">生理期提醒设置</div>

        <div class="form-group">
            <label class="form-label">选择提醒日 (每月)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="font-size:14px;">第</span>
                <input type="number" id="periodDay1" class="modal-input" style="text-align:center; margin:0;" placeholder="1-31" min="1" max="31">
                <span style="font-size:14px;">日 和 第</span>
                <input type="number" id="periodDay2" class="modal-input" style="text-align:center; margin:0;" placeholder="1-31" min="1" max="31">
                <span style="font-size:14px;">日</span>
            </div>
            <div class="form-hint">提示：请选择生理期预计到来的前2天。</div>
        </div>

        <div class="form-group">
            <label class="form-label">选择提醒你的角色</label>
            <div id="periodRoleList" class="multi-select-list" style="max-height: 200px;">
                <!-- JS 动态生成 -->
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closePeriodSettingsModal()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="savePeriodSettings()">保存</button>
        </div>
    </div>
</div>

<!-- 提醒弹窗：黑白风展示生成的内容 -->
<div id="periodReminderModal" class="modal" style="z-index: 11000;">
    <div class="period-popup-content">
        <div class="period-popup-header">
            MONTHLY REMINDER
        </div>
        <!-- 头像栏 -->
        <div class="period-avatar-bar" id="periodPopupAvatars">
            <!-- JS 动态插入头像 -->
        </div>
        <!-- 内容区 -->
        <div class="period-message-area">
            <span class="period-role-name" id="periodPopupName">Role Name</span>
            <div id="periodPopupText">Loading...</div>
        </div>
        <div class="period-popup-footer">
            <button class="period-confirm-btn" onclick="closePeriodReminderModal()">我 收 到 了</button>
        </div>
    </div>
</div>

<!-- 生理期提醒的悬浮加载球 -->
<div id="periodFloatingLoader">
    <div class="spinner"></div>
</div>

<!-- 情侣空间批量删除操作栏 -->
<div id="loversSelectionToolbar" class="multi-select-toolbar">
    <span class="multi-select-count" id="loversSelectCount">已选择 0 项</span>
    <div class="multi-select-actions">
        <button class="multi-select-btn delete" onclick="confirmDeleteLoversItems()">删除</button>
        <button class="multi-select-btn cancel" onclick="exitLoversMultiSelectMode()">取消</button>
    </div>
</div>
<!-- 里世界 App (独立页面版) -->
<div id="innerWorldAppScreen" class="page">
    <div class="nav-bar">
        <button class="nav-btn" onclick="goHome()">
            <i class="ri-arrow-left-s-line"></i>
        </button>
        <div class="nav-title">里世界控制台</div>
        <div style="width: 40px;"></div>
    </div>

    <!-- 内容区域：使用黑白风格 -->
    <div class="settings-content bw-style">

        <!-- 1. 状态卡片 -->
        <div class="form-card" id="iw-status-card">
            <!-- JS 会在这里动态生成状态信息 -->
        </div>
                <!-- [新增] 全局广播记录仪 -->
        <div class="form-card" id="iw-broadcast-card" style="background: #222 !important; border: 1px solid #444 !important; color: #fff !important;">
                        <!-- 1. 最新一条广播 (改为折叠式) -->
            <details id="iw-latest-details" open style="border-bottom: 1px dashed #555; margin-bottom: 10px;">
                <summary id="iw-latest-summary" style="padding: 10px 0; cursor: pointer; outline: none; font-size: 12px; color: #00e5ff; font-weight: bold;">
                    ⚡ 最新情报 <span style="font-size: 10px; opacity: 0.7; font-weight: normal;">(点击收起/展开)</span>
                </summary>

                <!-- 内容容器 -->
                <div id="iw-latest-content" style="padding-bottom: 10px; padding-top: 5px;">
                    <div style="font-size: 14px; line-height: 1.5; color: #666;">暂无广播...</div>
                </div>
            </details>


            <!-- 2. 历史广播 (折叠区) -->
            <details class="iw-history-details">
                <summary style="font-size: 12px; color: #999; cursor: pointer; outline: none;">
                    查看历史广播记录 <i class="ri-arrow-down-s-line"></i>
                </summary>
                <div id="iw-history-list" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; color: #ccc;">
                    <!-- JS 动态生成 -->
                </div>
            </details>
        </div>

        <!-- 2. 核心功能菜单 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openInnerWorldConfig()">
                <label class="form-label">
                    <i class="ri-edit-2-line"></i> 构建/重构世界
                </label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <!-- 在里世界App的菜单里添加这个按钮 -->
<div class="form-group-row clickable" onclick="openInnerWorldMissionModal()">
    <label class="form-label">
        <i class="ri-skull-line"></i> 查看生存任务
    </label>
    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
</div>
<!-- [插入] 打开雷达地图的按钮 -->
<div class="form-group-row clickable" onclick="openIwMapModal()">
    <label class="form-label">
        <i class="ri-radar-line"></i> 区域雷达地图
    </label>
    <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
</div>


                        <div class="form-group-row clickable" onclick="advanceInnerWorldPlot()">
                <label class="form-label">
                    <i class="ri-movie-line"></i> 推进剧情
                </label>
                <!-- ↓↓↓ 修改了下面这一行，加了 ID ↓↓↓ -->
                <div class="form-value-display" id="iw-plot-btn-text">
                    AI 推演 <i class="ri-arrow-right-s-line"></i>
                </div>
            </div>

        </div>

        <!-- 3. 存档管理 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openWorldArchiveModal('save')">
                <label class="form-label">
                    <i class="ri-save-3-line"></i> 保存当前存档
                </label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openWorldArchiveModal('load')">
                <label class="form-label">
                    <i class="ri-folder-open-line"></i> 读取历史存档
                </label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 4. 退出选项 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-delete" onclick="exitInnerWorld()">回到现实世界</button>
        </div>
    </div>
</div>

<!-- 学习专注 App -->
<div id="studyApp" class="page">
    <div class="nav-bar" style="background-color: #fff;">
        <button class="nav-btn" onclick="goHome()"><i class="ri-arrow-left-s-line"></i></button>
        <div class="nav-title">专注时刻</div>
        <div style="width: 40px;"></div>
    </div>

        <!-- 视图1：番茄钟 (升级版) -->
    <div id="studyTimerView" class="study-view active">
        <div class="study-content-center">

            <!-- 新增：模式切换 -->
            <div class="study-mode-switch">
                <div id="modeBtnCountdown" class="mode-btn active" onclick="switchStudyMode('countdown')">倒计时</div>
                <div id="modeBtnCountup" class="mode-btn" onclick="switchStudyMode('countup')">正计时</div>
            </div>

            <!-- 进度环 -->
            <div class="timer-ring-container">
                <div class="timer-ring" id="studyTimerRing"></div>
                <div class="timer-inner">
                    <div class="timer-time" id="studyTimeDisplay">25:00</div>
                    <div class="timer-label" id="studyStatusLabel">准备专注</div>
                </div>
            </div>

            <!-- 任务输入 -->
            <div class="study-input-box">
                <input type="text" id="studyTaskInput" placeholder="本次专注的目标是..." class="study-task-input">
            </div>

            <!-- 控制按钮 -->
            <div class="study-controls">
                <button class="study-btn-main" id="studyStartBtn" onclick="toggleStudyTimer()">开始专注</button>
                <!-- 这里的按钮文字和逻辑稍后由JS控制 -->
                <div style="display:flex; gap:10px; margin-top:10px;">
                     <button class="study-btn-sub" id="studyResetBtn" onclick="resetStudyTimer()" style="display:none; flex:1;">放弃</button>
                     <button class="study-btn-sub" id="studyFinishBtn" onclick="manualFinishStudy()" style="display:none; flex:1; border-color:#000; color:#000; font-weight:bold;">完成</button>
                </div>
            </div>

            <!-- 时长选择 (仅倒计时显示) -->
            <div class="study-duration-select" id="studyDurationSelect">
                <span onclick="setStudyDuration(10)" class="duration-pill">10分钟</span>
                <span onclick="setStudyDuration(25)" class="duration-pill active">25分钟</span>
                <span onclick="setStudyDuration(45)" class="duration-pill">45分钟</span>
                <span onclick="setStudyDuration(60)" class="duration-pill">60分钟</span>
            </div>
        </div>
    </div>


        <!-- 视图2：统计记录 (含热力图) -->
    <div id="studyStatsView" class="study-view" style="display: none;">
        <div class="wechat-content" style="padding-top: 0; background: #f7f7f7;">

            <!-- 顶部统计卡 -->
            <div class="study-stat-header">
                <div class="stat-box">
                    <div class="stat-num" id="studyTotalTime">0</div>
                    <div class="stat-label">总专注(分钟)</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-box">
                    <div class="stat-num" id="studyTotalCount">0</div>
                    <div class="stat-label">完成次数</div>
                </div>
            </div>

            <!-- 新增：学习月历热力图 -->
            <div style="margin: 0 15px 15px 15px; background: #fff; border-radius: 16px; padding: 15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; font-weight:bold; color:#333;">
                    <span id="heatmapMonthLabel">本月热力图</span>
                </div>
                <!-- 星期头 -->
                <div class="heatmap-week-header">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <!-- 日期格子 -->
                <div id="studyHeatmapGrid" class="heatmap-grid"></div>
                <!-- 图例 -->
                <div class="heatmap-legend">
                    <span>少</span>
                    <div class="legend-dot l1"></div>
                    <div class="legend-dot l2"></div>
                    <div class="legend-dot l3"></div>
                    <span>多</span>
                </div>
            </div>
<!-- ▼▼▼ 新增：习惯坚持榜 (插入在这里) ▼▼▼ -->
            <div style="margin: 0 15px 15px 15px; background: #fff; border-radius: 16px; padding: 15px;">
                <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:10px; border-bottom:1px solid #f5f5f5; padding-bottom:8px;">
                    习惯坚持榜
                </div>
                <div id="studyHabitStatsList">
                    <!-- JS将在这里生成数据 -->
                </div>
            </div>
            <!-- ▲▲▲ 新增结束 ▲▲▲ -->
            <div style="padding: 0 15px 10px; font-size: 14px; font-weight: bold; color: #333;">最近记录</div>
            <!-- 记录列表 -->
            <div id="studyRecordsList" style="padding-bottom: 20px;"></div>
        </div>
    </div>
        <!-- 视图3：日常打卡 (新增) -->
    <div id="studyHabitsView" class="study-view" style="display: none;">
        <div class="wechat-content" style="padding-top: 0; background: #f7f7f7;">

            <!-- 头部添加区 -->
            <div style="background: #fff; padding: 20px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">日常习惯</div>
                <div class="study-add-habit-row">
                    <input type="text" id="newHabitName" placeholder="习惯名称 (如: 喝水)" class="habit-input">
                    <input type="number" id="newHabitTarget" placeholder="次数" class="habit-input-num" value="1">
                    <button class="habit-add-btn" onclick="addStudyHabit()">
                        <i class="ri-add-line"></i>
                    </button>
                </div>
            </div>

            <!-- 习惯列表 -->
            <div id="studyHabitsList" style="padding: 10px 15px; padding-bottom: 30px;">
                <!-- JS生成 -->
            </div>
        </div>
    </div>


        <!-- 底部导航 (更新版) -->
    <div class="store-bottom-bar" style="height: 70px; padding-top: 10px;">
        <div class="store-tab-item active" onclick="switchStudyTab('timer', this)">
            <i class="ri-time-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">计时</span>
        </div>
        <div class="store-tab-item" onclick="switchStudyTab('habits', this)">
            <i class="ri-checkbox-circle-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">打卡</span>
        </div>
        <div class="store-tab-item" onclick="switchStudyTab('stats', this)">
            <i class="ri-bar-chart-box-line" style="font-size: 24px; margin-bottom: 2px;"></i>
            <span style="font-size: 10px;">统计</span>
        </div>
    </div>

</div>
<!-- ▼▼▼ 论坛侧滑菜单 (重构版 - 黑白卡片风) ▼▼▼ -->
<div id="forumMenuOverlay" class="forum-menu-overlay" onclick="closeForumSideMenu()"></div>
<div id="forumSideMenu" class="forum-side-menu">
    <!-- 1. 菜单头部 (个人信息区) -->
    <div style="padding: 40px 20px 20px; background: #fff; border-bottom: 1px solid #f0f0f0;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <div id="forumMenuAvatar" style="width: 60px; height: 60px; border-radius: 50%; background-color: #ddd; background-size: cover; background-position: center; margin-right: 15px; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);"></div>
            <div>
                <div id="forumMenuName" style="font-size: 20px; font-weight: 800; color: #000;">用户名</div>
                <div id="forumMenuHandle" style="font-size: 13px; color: #999; margin-top: 2px;">@userid</div>
            </div>
        </div>
        <div style="display: flex; gap: 20px; font-size: 14px;">
            <div><strong id="forumMenuFollowing" style="color:#000; font-weight:700;">0</strong> <span style="color:#999; font-size:12px;">关注</span></div>
            <div><strong id="forumMenuFollowers" style="color:#000; font-weight:700;">0</strong> <span style="color:#999; font-size:12px;">粉丝</span></div>
        </div>
    </div>

    <!-- 2. 功能菜单区域 (使用 bw-style 继承好友设置页面的风格) -->
    <div class="settings-content bw-style" style="padding-top: 20px !important; padding-bottom: 20px !important; background-color: #f7f7f7;">

        <!-- 卡片 1：基础设置 -->
        <div class="form-card">
            <div class="form-group-row clickable" onclick="openForumCharacterSelect()">
                <label class="form-label">角色选择</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openWorldviewManagement()">
                <label class="form-label">世界观设置</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
            <div class="form-group-row clickable" onclick="openForumRules()">
                <label class="form-label">论坛规则</label>
                <div class="form-value-display"><i class="ri-arrow-right-s-line"></i></div>
            </div>
        </div>

        <!-- 卡片 2：自动化设置 -->
        <div class="form-card">
            <!-- 自动刷新总开关 -->
            <div class="form-group-row switch-row">
                <label class="form-label">自动刷新论坛</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="forumGlobalAutoRefreshToggle" onchange="toggleForumGlobalAutoRefresh()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 自动刷新子选项 (默认隐藏，JS控制显示) -->
            <div id="forumAutoRefreshSubMenu" style="display: none; padding-top: 0;">
                <!-- 推荐版块 -->
                <div class="form-group-row" style="border-top: 1px dashed #eee; justify-content: space-between;">
                    <label class="form-label sub-label">推荐版块</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="subRefreshRecInput" class="form-input" value="30" min="1"
                               style="width: 40px; text-align: center; background: #f0f0f0; border-radius: 4px; height: 28px;"
                               onchange="saveSubRefreshSettings()">
                        <span style="font-size: 12px; color: #999;">分</span>
                                                <label class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="subRefreshRecToggle" onchange="toggleSubAutoRefresh('recommended')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <!-- [新增] 推荐版块更新时间 -->
                <div style="text-align: right; padding-right: 5px; margin-top: -8px; margin-bottom: 8px;">
                     <span style="font-size: 10px; color: #bbb;" id="subRefreshRecTimeLabel">更新于: 从未</span>
                </div>



                <!-- 同城版块 -->
                <div class="form-group-row" style="border-top: 1px dashed #eee; justify-content: space-between;">
                    <label class="form-label sub-label">同城版块</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="subRefreshCityInput" class="form-input" value="60" min="5"
                               style="width: 40px; text-align: center; background: #f0f0f0; border-radius: 4px; height: 28px;"
                               onchange="saveSubRefreshSettings()">
                        <span style="font-size: 12px; color: #999;">分</span>
                                                <label class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="subRefreshCityToggle" onchange="toggleSubAutoRefresh('city')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <!-- [新增] 同城版块更新时间 -->
                <div style="text-align: right; padding-right: 5px; margin-top: -8px; margin-bottom: 8px;">
                     <span style="font-size: 10px; color: #bbb;" id="subRefreshCityTimeLabel">更新于: 从未</span>
                </div>

            </div>

            <!-- 角色自动发帖 -->
            <div class="form-group-row switch-row" style="border-top: 1px solid #f2f2f2;">
                <label class="form-label">角色自动发帖</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="forumAutoPostToggle" onchange="toggleForumAutoPost()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 发帖频率设置 (默认隐藏) -->
            <div id="forumFreqConfigRow" class="form-group-row" style="display: none; border-top: 1px dashed #eee; justify-content: space-between;">
                <label class="form-label sub-label">发帖频率</label>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: #666;">
                    <span>每</span>
                    <input type="number" id="forumFreqDaysInput" value="1" min="1"
                           style="width: 30px; text-align: center; background: #f0f0f0; border: none; border-radius: 4px;"
                           onchange="saveForumFreqConfig()">
                    <span>天发</span>
                    <input type="number" id="forumFreqCountInput" value="1" min="1"
                           style="width: 30px; text-align: center; background: #f0f0f0; border: none; border-radius: 4px;"
                           onchange="saveForumFreqConfig()">
                    <span>帖</span>
                </div>
            </div>
        </div>
                <!-- 卡片 3：世界运转大事件 (布局优化版) -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">
                    <div>世界运转模式</div>

                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="forumWorldEventToggle" onchange="toggleForumWorldEvents()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- 事件详情展示区 -->
            <div id="worldEventConfigRow" style="display: none; padding: 0 15px 15px; flex-direction: column; gap: 10px;">
                <div style="font-size: 12px; color: #555; background: #f2f3f5; padding: 10px; border-radius: 8px; line-height: 1.5;" id="currentWorldEventDisplay">
                    <div style="text-align: center; color: #999;">暂无大事件数据<br>请点击下方按钮推演</div>
                </div>
                <!-- 按钮和时间控制区域 -->
<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">

    <!-- 自动刷新设置 -->
    <div style="display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 4px 8px; border-radius: 6px;">
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="font-size: 11px; color: #666;">自动频率:</span>
            <input type="number" id="worldAdvanceMinutes" value="5" style="width: 35px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; padding: 2px;">
            <span style="font-size: 11px; color: #666;">分钟</span>
        </div>

        <!-- 自动开关 -->
        <button id="btnAutoAdvance" class="settings-btn" style="font-size: 11px; padding: 2px 8px; background: #ddd; color: #333; height: 24px;" onclick="window.toggleAutoAdvance()">
            <i class="ri-play-circle-line"></i> 开启自动
        </button>
    </div>

    <div style="display: flex; gap: 8px;">
        <!-- 手动同步 [已修改：添加了id] -->
        <button id="btnSyncRealTime" class="settings-btn btn-black" style="flex: 1; font-size: 12px; height: 32px; padding: 0;" onclick="window.advanceWorldEvent(false)">
            <i class="ri-time-line"></i> 同步现实时间
        </button>

        <!-- 立即重演 [已修改：添加了id] -->
        <button id="btnForceUpdate" class="settings-btn btn-black" style="flex: 1; font-size: 12px; height: 32px; padding: 0;" onclick="forceUpdateWorldEvent()">
            <i class="ri-refresh-line"></i> 立即重演
        </button>
    </div>


    <!-- 状态显示 -->
    <div style="text-align: center; display: flex; flex-direction: column; gap: 2px;">
        <span style="font-size: 10px; color: #bbb;" id="worldEventTimeLabel">上次更新: 从未</span>
        <span style="font-size: 10px; color: #4caf50; display: none;" id="autoAdvanceStatusLabel">● 自动同步中...</span>
    </div>
</div>


            </div>
        </div>

        <!-- 卡片 4：其他 -->
        <div class="form-card">
            <div class="form-group-row switch-row">
                <label class="form-label">匿名模式</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="forumAnonymousToggle" onchange="toggleForumAnonymity()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="settings-buttons">
            <button class="settings-btn btn-delete" onclick="clearForumHistoryConfirm()">清空所有帖子</button>
        </div>

    </div>
</div>
<!-- ▲▲▲ 侧滑菜单代码结束 ▲▲▲ -->


<!-- ▼▼▼ 1. 角色入驻选择弹窗 ▼▼▼ -->
<div id="forumCharacterSelectModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">选择入驻角色</div>
        <div id="forumCharacterSelectList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- JS会自动填充 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeForumCharacterSelect()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveForumCharacterSelect()">保存</button>
        </div>
    </div>
</div>

<!-- ▼▼▼ 2. 世界观列表弹窗 ▼▼▼ -->
<div id="worldviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display:flex; justify-content:space-between; align-items:center;">
            <span>世界观管理</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openWorldviewEditor(null)">+</button>
        </div>
        <div id="worldviewList" class="friend-list" style="max-height: 50vh; overflow-y: auto;"></div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('worldviewModal').classList.remove('show')">关闭</button>
        </div>
    </div>
</div>
<!-- 世界观编辑器 -->
<div id="worldviewEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="worldviewEditorTitle">新建世界观</div>
        <input type="text" class="modal-input" id="worldviewNameInput" placeholder="世界观名称 (如: 赛博朋克)">
        <textarea class="modal-textarea" id="worldviewDescInput" placeholder="详细描述..." style="min-height: 200px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeWorldviewEditor()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveWorldview()">保存</button>
        </div>
    </div>
</div>

<!-- 论坛规则管理列表弹窗 (修复代码) -->
<div id="forumRulesModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" style="display:flex; justify-content:space-between; align-items:center;">
            <span>论坛规则管理</span>
            <button class="nav-btn" style="padding: 4px 8px;" onclick="openForumRuleEditor(null)">+</button>
        </div>
        <div id="forumRulesList" class="friend-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 规则列表将由 JS 自动渲染到这里 -->
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
            <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('forumRulesModal').classList.remove('show')">关闭</button>
        </div>
    </div>
</div>

<!-- 规则编辑器 -->
<div id="forumRuleEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-title" id="forumRuleEditorTitle">新建规则</div>
        <input type="text" class="modal-input" id="forumRuleNameInput" placeholder="规则名称 (如: 禁止刷屏)">
        <textarea class="modal-textarea" id="forumRuleDescInput" placeholder="规则详情..." style="min-height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeForumRuleEditor()">取消</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveForumRule()">保存</button>
        </div>
    </div>
</div>
//1. 工具函数
<script src="utils.js"></script>
//2. 头像库
<script src="avatars.js"></script>
//3. 静态数据
<script src="data.js"></script>
<script src="spy.js"></script>
<script src="script.js"></script>

 <script src="https://unpkg.com/pinyin-pro"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

</body>
</html>
